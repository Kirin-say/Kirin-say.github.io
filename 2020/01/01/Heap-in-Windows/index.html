<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="Heap details in WindowsMainly from Angelboy‘s analysis and Some details When I Debugging Back-EndStruct_heap12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505">
<meta property="og:type" content="article">
<meta property="og:title" content="Heap in Windows">
<meta property="og:url" content="http://yoursite.com/2020/01/01/Heap-in-Windows/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="Heap details in WindowsMainly from Angelboy‘s analysis and Some details When I Debugging Back-EndStruct_heap12345678910111213141516171819202122232425262728293031323334353637383940414243444546474849505">
<meta property="article:published_time" content="2020-01-01T15:02:46.000Z">
<meta property="article:modified_time" content="2020-01-01T15:23:20.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Heap in Windows</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        
        <li><a class="icon" href="/2019/12/30/KCTF-2019-Finals/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/01/01/Heap-in-Windows/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&text=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&is_video=false&description=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Heap in Windows&body=Check out this article: http://yoursite.com/2020/01/01/Heap-in-Windows/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&name=Heap in Windows&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Back-End"><span class="toc-number">1.</span> <span class="toc-text">Back-End</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct"><span class="toc-number">1.1.</span> <span class="toc-text">Struct</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#heap"><span class="toc-number">1.1.1.</span> <span class="toc-text">_heap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HEAP-ENTRY-chunk"><span class="toc-number">1.1.2.</span> <span class="toc-text">_HEAP_ENTRY (chunk)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk"><span class="toc-number">1.1.3.</span> <span class="toc-text">_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-example"><span class="toc-number">1.1.4.</span> <span class="toc-text">For example:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attention"><span class="toc-number">1.2.</span> <span class="toc-text">Attention</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BlocksIndex-HEAP-LIST-LOOKUP"><span class="toc-number">1.2.1.</span> <span class="toc-text">BlocksIndex(_HEAP_LIST_LOOKUP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-Example"><span class="toc-number">1.2.2.</span> <span class="toc-text">For Example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alloc"><span class="toc-number">1.3.</span> <span class="toc-text">Alloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-lt-0x4000"><span class="toc-number">1.3.1.</span> <span class="toc-text">Size&lt;&#x3D;0x4000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x4000-lt-size-lt-0xﬀ000"><span class="toc-number">1.3.2.</span> <span class="toc-text">0x4000&lt;size&lt;&#x3D;0xﬀ000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-gt-0xﬀ000"><span class="toc-number">1.3.3.</span> <span class="toc-text">Size&gt;0xﬀ000</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free-RtlpFreeHeap"><span class="toc-number">1.4.</span> <span class="toc-text">Free(RtlpFreeHeap)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-lt-0xﬀ000"><span class="toc-number">1.4.1.</span> <span class="toc-text">Size&lt;&#x3D;0xﬀ000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-gt-0xﬀ000-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">Size&gt;0xﬀ000</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Front-End-LFH"><span class="toc-number">2.</span> <span class="toc-text">Front-End (LFH)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-1"><span class="toc-number">2.1.</span> <span class="toc-text">Struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Header-Encoding-in-LFH"><span class="toc-number">2.2.</span> <span class="toc-text">Header Encoding in LFH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alloc-1"><span class="toc-number">2.3.</span> <span class="toc-text">Alloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free"><span class="toc-number">2.4.</span> <span class="toc-text">Free</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation-in-Windows"><span class="toc-number">3.</span> <span class="toc-text">Exploitation in Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unlink-in-Back-End"><span class="toc-number">3.1.</span> <span class="toc-text">Unlink in Back-End</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UAF-in-LFH"><span class="toc-number">3.2.</span> <span class="toc-text">UAF in LFH</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Heap in Windows
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-01-01T15:02:46.000Z" itemprop="datePublished">2020-01-01</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><strong>Heap details in Windows</strong><br><strong>Mainly from Angelboy‘s analysis and Some details When I Debugging</strong></p>
<h2 id="Back-End"><a href="#Back-End" class="headerlink" title="Back-End"></a>Back-End</h2><h3 id="Struct"><a href="#Struct" class="headerlink" title="Struct"></a>Struct</h3><h4 id="heap"><a href="#heap" class="headerlink" title="_heap"></a>_heap</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _heap</span><br><span class="line">ntdll!_HEAP</span><br><span class="line">   +0x000 Segment          : _HEAP_SEGMENT</span><br><span class="line">   +0x000 Entry            : _HEAP_ENTRY</span><br><span class="line">   +0x010 SegmentSignature : Uint4B</span><br><span class="line">   +0x014 SegmentFlags     : Uint4B</span><br><span class="line">   +0x018 SegmentListEntry : _LIST_ENTRY</span><br><span class="line">   +0x028 Heap             : Ptr64 _HEAP</span><br><span class="line">   +0x030 BaseAddress      : Ptr64 Void</span><br><span class="line">   +0x038 NumberOfPages    : Uint4B</span><br><span class="line">   +0x040 FirstEntry       : Ptr64 _HEAP_ENTRY</span><br><span class="line">   +0x048 LastValidEntry   : Ptr64 _HEAP_ENTRY</span><br><span class="line">   +0x050 NumberOfUnCommittedPages : Uint4B</span><br><span class="line">   +0x054 NumberOfUnCommittedRanges : Uint4B</span><br><span class="line">   +0x058 SegmentAllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +0x05a Reserved         : Uint2B</span><br><span class="line">   +0x060 UCRSegmentList   : _LIST_ENTRY</span><br><span class="line">   +0x070 Flags            : Uint4B</span><br><span class="line">   +0x074 ForceFlags       : Uint4B</span><br><span class="line">   +0x078 CompatibilityFlags : Uint4B</span><br><span class="line">   +0x07c EncodeFlagMask   : Uint4B</span><br><span class="line">   +0x080 Encoding         : _HEAP_ENTRY</span><br><span class="line">   +0x090 Interceptor      : Uint4B</span><br><span class="line">   +0x094 VirtualMemoryThreshold : Uint4B</span><br><span class="line">   +0x098 Signature        : Uint4B</span><br><span class="line">   +0x0a0 SegmentReserve   : Uint8B</span><br><span class="line">   +0x0a8 SegmentCommit    : Uint8B</span><br><span class="line">   +0x0b0 DeCommitFreeBlockThreshold : Uint8B</span><br><span class="line">   +0x0b8 DeCommitTotalFreeThreshold : Uint8B</span><br><span class="line">   +0x0c0 TotalFreeSize    : Uint8B</span><br><span class="line">   +0x0c8 MaximumAllocationSize : Uint8B</span><br><span class="line">   +0x0d0 ProcessHeapsListIndex : Uint2B</span><br><span class="line">   +0x0d2 HeaderValidateLength : Uint2B</span><br><span class="line">   +0x0d8 HeaderValidateCopy : Ptr64 Void</span><br><span class="line">   +0x0e0 NextAvailableTagIndex : Uint2B</span><br><span class="line">   +0x0e2 MaximumTagIndex  : Uint2B</span><br><span class="line">   +0x0e8 TagEntries       : Ptr64 _HEAP_TAG_ENTRY</span><br><span class="line">   +0x0f0 UCRList          : _LIST_ENTRY</span><br><span class="line">   +0x100 AlignRound       : Uint8B</span><br><span class="line">   +0x108 AlignMask        : Uint8B</span><br><span class="line">   +0x110 VirtualAllocdBlocks : _LIST_ENTRY</span><br><span class="line">   +0x120 SegmentList      : _LIST_ENTRY</span><br><span class="line">   +0x130 AllocatorBackTraceIndex : Uint2B</span><br><span class="line">   +0x134 NonDedicatedListLength : Uint4B</span><br><span class="line">   +0x138 BlocksIndex      : Ptr64 Void</span><br><span class="line">   +0x140 UCRIndex         : Ptr64 Void</span><br><span class="line">   +0x148 PseudoTagEntries : Ptr64 _HEAP_PSEUDO_TAG_ENTRY</span><br><span class="line">   +0x150 FreeLists        : _LIST_ENTRY</span><br><span class="line">   +0x160 LockVariable     : Ptr64 _HEAP_LOCK</span><br><span class="line">   +0x168 CommitRoutine    : Ptr64     long </span><br><span class="line">   +0x170 StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +0x178 CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +0x198 FrontEndHeap     : Ptr64 Void</span><br><span class="line">   +0x1a0 FrontHeapLockCount : Uint2B</span><br><span class="line">   +0x1a2 FrontEndHeapType : UChar</span><br><span class="line">   +0x1a3 RequestedFrontEndHeapType : UChar</span><br><span class="line">   +0x1a8 FrontEndHeapUsageData : Ptr64 Wchar</span><br><span class="line">   +0x1b0 FrontEndHeapMaximumIndex : Uint2B</span><br><span class="line">   +0x1b2 FrontEndHeapStatusBitmap : [129] UChar</span><br><span class="line">   +0x238 Counters         : _HEAP_COUNTERS</span><br><span class="line">   +0x2b0 TuningParameters : _HEAP_TUNING_PARAMETERS</span><br></pre></td></tr></table></figure>
<p>管理heap的结构，一般在每个heap段开头位置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">EncodeFlagMask: Heap 初始化设置为0x100000,用于判断是否encode该heap的chunk中的header</span><br><span class="line">Encoding: 用于encode(xor)的cookie</span><br><span class="line">BlocksIndex (_HEAP_LIST_LOOKUP_)：用来管理Back-End中的chunk</span><br><span class="line">FreeList (_HEAP_ENTRY)：串接 Back-End 中的所有 free chunk，类似unsorted bin</span><br><span class="line">FrontEndHeap:指向管理 FrontEnd 的 Heap 的结构</span><br><span class="line">FrontEndHeapUsageData：指向⼀个对应各⼤⼩ chunk 的阵列&#x2F;记录各种⼤⼩ chunk 的使⽤次数，到达某种程度则 enable 该对应⼤</span><br><span class="line">⼩ chunk 的 Front-End allocator</span><br></pre></td></tr></table></figure>
<p><strong>For example:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _heap 00af0000</span><br><span class="line">ntdll!_HEAP</span><br><span class="line">   +0x000 Segment          : _HEAP_SEGMENT</span><br><span class="line">   +0x000 Entry            : _HEAP_ENTRY</span><br><span class="line">   +0x010 SegmentSignature : 0xffeeffee</span><br><span class="line">   +0x014 SegmentFlags     : 2</span><br><span class="line">   +0x018 SegmentListEntry : _LIST_ENTRY [ 0x00000000&#96;00af0120 - 0xaf0120 ]</span><br><span class="line">   +0x028 Heap             : 0x00000000&#96;00af0000 _HEAP</span><br><span class="line">   +0x030 BaseAddress      : 0x00000000&#96;00af0000 Void</span><br><span class="line">   +0x038 NumberOfPages    : 0xf</span><br><span class="line">   +0x040 FirstEntry       : 0x00000000&#96;00af0740 _HEAP_ENTRY</span><br><span class="line">   +0x048 LastValidEntry   : 0x00000000&#96;00aff000 _HEAP_ENTRY</span><br><span class="line">   +0x050 NumberOfUnCommittedPages : 8</span><br><span class="line">   +0x054 NumberOfUnCommittedRanges : 1</span><br><span class="line">   +0x058 SegmentAllocatorBackTraceIndex : 0</span><br><span class="line">   +0x05a Reserved         : 0</span><br><span class="line">   +0x060 UCRSegmentList   : _LIST_ENTRY [ 0x00000000&#96;00af6fe0 - 0xaf6fe0 ]</span><br><span class="line">   +0x070 Flags            : 0x40001062</span><br><span class="line">   +0x074 ForceFlags       : 0x40000060</span><br><span class="line">   +0x078 CompatibilityFlags : 0</span><br><span class="line">   +0x07c EncodeFlagMask   : 0x100000</span><br><span class="line">   +0x080 Encoding         : _HEAP_ENTRY</span><br><span class="line">   +0x090 Interceptor      : 0</span><br><span class="line">   +0x094 VirtualMemoryThreshold : 0xff00</span><br><span class="line">   +0x098 Signature        : 0xeeffeeff</span><br><span class="line">   +0x0a0 SegmentReserve   : 0x100000</span><br><span class="line">   +0x0a8 SegmentCommit    : 0x2000</span><br><span class="line">   +0x0b0 DeCommitFreeBlockThreshold : 0x100</span><br><span class="line">   +0x0b8 DeCommitTotalFreeThreshold : 0x1000</span><br><span class="line">   +0x0c0 TotalFreeSize    : 0x25e</span><br><span class="line">   +0x0c8 MaximumAllocationSize : 0x7fff&#96;fffdefff</span><br><span class="line">   +0x0d0 ProcessHeapsListIndex : 3</span><br><span class="line">   +0x0d2 HeaderValidateLength : 0x2c0</span><br><span class="line">   +0x0d8 HeaderValidateCopy : (null) </span><br><span class="line">   +0x0e0 NextAvailableTagIndex : 0</span><br><span class="line">   +0x0e2 MaximumTagIndex  : 0</span><br><span class="line">   +0x0e8 TagEntries       : (null) </span><br><span class="line">   +0x0f0 UCRList          : _LIST_ENTRY [ 0x00000000&#96;00af6fd0 - 0xaf6fd0 ]</span><br><span class="line">   +0x100 AlignRound       : 0x2f</span><br><span class="line">   +0x108 AlignMask        : 0xffffffff&#96;fffffff0</span><br><span class="line">   +0x110 VirtualAllocdBlocks : _LIST_ENTRY [ 0x00000000&#96;00af0110 - 0xaf0110 ]</span><br><span class="line">   +0x120 SegmentList      : _LIST_ENTRY [ 0x00000000&#96;00af0018 - 0xaf0018 ]</span><br><span class="line">   +0x130 AllocatorBackTraceIndex : 0</span><br><span class="line">   +0x134 NonDedicatedListLength : 0</span><br><span class="line">   +0x138 BlocksIndex      : 0x00000000&#96;00af02e8 Void</span><br><span class="line">   +0x140 UCRIndex         : (null) </span><br><span class="line">   +0x148 PseudoTagEntries : (null) </span><br><span class="line">   +0x150 FreeLists        : _LIST_ENTRY [ 0x00000000&#96;00af1430 - 0xaf5760 ]</span><br><span class="line">   +0x160 LockVariable     : 0x00000000&#96;00af02c0 _HEAP_LOCK</span><br><span class="line">   +0x168 CommitRoutine    : 0x6cb01100&#96;6bd136b5     long  +6cb011006bd136b5</span><br><span class="line">   +0x170 StackTraceInitVar : _RTL_RUN_ONCE</span><br><span class="line">   +0x178 CommitLimitData  : _RTL_HEAP_MEMORY_LIMIT_DATA</span><br><span class="line">   +0x198 FrontEndHeap     : (null) </span><br><span class="line">   +0x1a0 FrontHeapLockCount : 0</span><br><span class="line">   +0x1a2 FrontEndHeapType : 0 &#39;&#39;</span><br><span class="line">   +0x1a3 RequestedFrontEndHeapType : 0 &#39;&#39;</span><br><span class="line">   +0x1a8 FrontEndHeapUsageData : 0x00000000&#96;00af0750  &quot;&quot;</span><br><span class="line">   +0x1b0 FrontEndHeapMaximumIndex : 0x80</span><br><span class="line">   +0x1b2 FrontEndHeapStatusBitmap : [129]  &quot;&quot;</span><br><span class="line">   +0x238 Counters         : _HEAP_COUNTERS</span><br><span class="line">   +0x2b0 TuningParameters : _HEAP_TUNING_PARAMETERS</span><br></pre></td></tr></table></figure>
<h4 id="HEAP-ENTRY-chunk"><a href="#HEAP-ENTRY-chunk" class="headerlink" title="_HEAP_ENTRY (chunk)"></a>_HEAP_ENTRY (chunk)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;&#x2F;有些偏移处值不一定??（多套成员??）</span><br><span class="line">0:001&gt; dt _HEAP_ENTRY </span><br><span class="line">ntdll!_HEAP_ENTRY</span><br><span class="line">   +0x000 UnpackedEntry    : _HEAP_UNPACKED_ENTRY</span><br><span class="line">   +0x000 PreviousBlockPrivateData : Ptr64 Void</span><br><span class="line">   +0x008 Size             : Uint2B</span><br><span class="line">   +0x00a Flags            : UChar</span><br><span class="line">   +0x00b SmallTagIndex    : UChar</span><br><span class="line">   +0x008 SubSegmentCode   : Uint4B</span><br><span class="line">   +0x00c PreviousSize     : Uint2B</span><br><span class="line">   +0x00e SegmentOffset    : UChar</span><br><span class="line">   +0x00e LFHFlags         : UChar</span><br><span class="line">   +0x00f UnusedBytes      : UChar</span><br><span class="line">   +0x008 CompactHeader    : Uint8B</span><br><span class="line">   +0x000 ExtendedEntry    : _HEAP_EXTENDED_ENTRY</span><br><span class="line">   +0x000 Reserved         : Ptr64 Void</span><br><span class="line">   +0x008 FunctionIndex    : Uint2B</span><br><span class="line">   +0x00a ContextValue     : Uint2B</span><br><span class="line">   +0x008 InterceptorValue : Uint4B</span><br><span class="line">   +0x00c UnusedBytesLength : Uint2B</span><br><span class="line">   +0x00e EntryOffset      : UChar</span><br><span class="line">   +0x00f ExtendedBlockSignature : UChar</span><br><span class="line">   +0x000 ReservedForAlignment : Ptr64 Void</span><br><span class="line">   +0x008 Code1            : Uint4B</span><br><span class="line">   +0x00c Code2            : Uint2B</span><br><span class="line">   +0x00e Code3            : UChar</span><br><span class="line">   +0x00f Code4            : UChar</span><br><span class="line">   +0x00c Code234          : Uint4B</span><br><span class="line">   +0x008 AgregateCode     : Uint8B</span><br></pre></td></tr></table></figure>
<p>Member:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">PreviousBlockPrivateData: 前一个chunk的date(0x10对齐)</span><br><span class="line">size(2bytes): chunk_size&gt;&gt;4</span><br><span class="line">Flag: 当前chunk是否inused</span><br><span class="line">SmallTagIndex: checksum(xor) of previous 3 bytes</span><br><span class="line">PreviousSize: 相邻前一块chunk 的 size(&gt;&gt;4)</span><br><span class="line">SegmentOﬀset: 有些情况下用于寻找segment</span><br><span class="line">Unusedbyte: 记录malloc后所剩chunk的空间大小，可以⽤来判断chunk是FrontEnd or BackEnd</span><br><span class="line">freed:</span><br><span class="line">Flink: 指向linkedlist中下⼀块chunk</span><br><span class="line">Blink: 指向linkedlist中上⼀块chunk</span><br><span class="line">Unusedbyte&#x3D;&#x3D;&#x3D;0</span><br></pre></td></tr></table></figure>
<h4 id="HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk"><a href="#HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk" class="headerlink" title="_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)"></a>_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">Flink</span><br><span class="line">Blink</span><br><span class="line">_HEAP_ENTRY</span><br><span class="line">user_date</span><br><span class="line"></span><br><span class="line">Flink: 指向下⼀块VirtualAlloc出来的chunk</span><br><span class="line">Blink: 指向上⼀块VirtualAlloc出来的chunk</span><br><span class="line">size: 这里指的是unusedsize，且无需shift</span><br><span class="line">Unusedbyte&#x3D;&#x3D;&#x3D;4</span><br></pre></td></tr></table></figure>
<h4 id="For-example"><a href="#For-example" class="headerlink" title="For example:"></a><strong>For example:</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">0:002&gt; dq 007a0000+0x80</span><br><span class="line">00000000&#96;007a0080  00000000&#96;00000000 0000a2f8&#96;03506ab9</span><br><span class="line">00000000&#96;007a0090  0000ff00&#96;00000000 00000000&#96;eeffeeff</span><br><span class="line">00000000&#96;007a00a0  00000000&#96;00100000 00000000&#96;00002000</span><br><span class="line">00000000&#96;007a00b0  00000000&#96;00000100 00000000&#96;00001000</span><br><span class="line">00000000&#96;007a00c0  00000000&#96;00000258 00007fff&#96;fffdefff</span><br><span class="line">00000000&#96;007a00d0  00000000&#96;02c00003 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a00e0  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a00f0  00000000&#96;007a6fd0 00000000&#96;007a6fd0</span><br><span class="line">0:002&gt; dq 0x00000000007A13F0-0x10</span><br><span class="line">00000000&#96;007a13e0  00000000&#96;00000000 3c00a2eb&#96;0e576ab3</span><br><span class="line">00000000&#96;007a13f0  ba0a0a61&#96;61616161 baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1400  baadf00d&#96;baadf00d baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1410  baadf00d&#96;baadf00d baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1420  baadf00d&#96;baadf00d baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1430  baadf00d&#96;baadf00d baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1440  baadf00d&#96;baadf00d baadf00d&#96;baadf00d</span><br><span class="line">00000000&#96;007a1450  abababab&#96;baadf00d abababab&#96;abababab</span><br><span class="line">0:002&gt; ? 0000a2f8&#96;03506ab9^1</span><br><span class="line">Evaluate expression: 179186091190968 &#x3D; 0000a2f8&#96;03506ab8</span><br><span class="line">0:002&gt; ? 0000a2f8&#96;03506ab9^3c00a2eb&#96;0e576ab3</span><br><span class="line">Evaluate expression: 4323455724098617354 &#x3D; 3c000013&#96;0d07000a</span><br><span class="line"></span><br><span class="line">size&#x3D;000a (little endian)</span><br><span class="line">0a^00^07&#x3D;0d</span><br></pre></td></tr></table></figure>
<h3 id="Attention"><a href="#Attention" class="headerlink" title="Attention"></a>Attention</h3><p>所有header都会encode(xor)后存入<br>验证时先用cookie decode，而后前三位校验checksum==第四位<br>FreeList: Flink-&gt;从小到大插入（Blink从大到小），相同大小，后free的chunk在前，并更新ListHint(LIFO)<br>BlocksIndex(_HEAP_LIST_LOOKUP): 主要⽤来管理各种不同⼤⼩的freedchunk的结构，⽅便快速找到合适大小的chunk<br>对齐方式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">size size&amp;0xF&#x3D;&#x3D;0? size:(((size&gt;&gt;4)&lt;&lt;4)+0x10)</span><br><span class="line">chunksize&#x3D;size+0x30 (Windows10)</span><br></pre></td></tr></table></figure>
<h4 id="BlocksIndex-HEAP-LIST-LOOKUP"><a href="#BlocksIndex-HEAP-LIST-LOOKUP" class="headerlink" title="BlocksIndex(_HEAP_LIST_LOOKUP)"></a>BlocksIndex(_HEAP_LIST_LOOKUP)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:002&gt; dt _HEAP_LIST_LOOKUP</span><br><span class="line">ntdll!_HEAP_LIST_LOOKUP</span><br><span class="line">   +0x000 ExtendedLookup   : Ptr64 _HEAP_LIST_LOOKUP</span><br><span class="line">   +0x008 ArraySize        : Uint4B</span><br><span class="line">   +0x00c ExtraItem        : Uint4B</span><br><span class="line">   +0x010 ItemCount        : Uint4B</span><br><span class="line">   +0x014 OutOfRangeItems  : Uint4B</span><br><span class="line">   +0x018 BaseIndex        : Uint4B</span><br><span class="line">   +0x020 ListHead         : Ptr64 _LIST_ENTRY</span><br><span class="line">   +0x028 ListsInUseUlong  : Ptr64 Uint4B</span><br><span class="line">   +0x030 ListHints        : Ptr64 Ptr64 _LIST_ENTRY</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ExtendedLookup(_HEAP_LIST_LOOKUP):指向下⼀个ExtendedLookup，通常下⼀个会管理更⼤块chunk所⽤的结构</span><br><span class="line">ArraySize：该结构管理的，最⼤chunk的⼤⼩，通常为0x80(实际为0x800)</span><br><span class="line">ItemCount：目前该结构管理的chunk数目</span><br><span class="line">OutofRangeItems：超出该结构所管理⼤⼩的chunk的数量</span><br><span class="line">ListHead(_HEAP_ENTRY)：FreeList的Head</span><br><span class="line">ListsInUseUlong：⽤在判断ListHint中是否有合适⼤⼩的chunk，是⼀个bitmap</span><br><span class="line">ListHint：重要结构，⽤来指向相对应⼤⼩的chunk array，其⽬的就在于更快速找到合适⼤⼩的chunk (0x10 size为一个间隔)</span><br></pre></td></tr></table></figure>
<h4 id="For-Example"><a href="#For-Example" class="headerlink" title="For Example"></a>For Example</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">+0x150 FreeLists        : _LIST_ENTRY [ 0x00000000&#96;007a1490 - 0x7a5760 ]</span><br><span class="line"></span><br><span class="line">0:002&gt; dq  007a0000+0x150</span><br><span class="line">00000000&#96;007a0150  00000000&#96;007a1490 00000000&#96;007a5760</span><br><span class="line"></span><br><span class="line">FreeLists: Flink（007a0150）-&gt;007a1490-&gt;007a5760-&gt;007a0150</span><br><span class="line">Blink(007a0150)-&gt;07a5760-&gt;007a1490-&gt;007a0150</span><br><span class="line"></span><br><span class="line">007a1490:</span><br><span class="line">Evaluate expression: 46523482321 &#x3D; 0000000a&#96;d50400d1</span><br><span class="line">007a5760:</span><br><span class="line">Evaluate expression: 1114577830279 &#x3D; 00000103&#96;82040187</span><br><span class="line"></span><br><span class="line">size：0xd10-&gt;0x1870</span><br><span class="line"></span><br><span class="line">BlocksIndex:</span><br><span class="line">0:002&gt; dq  007a0000+0x138</span><br><span class="line">00000000&#96;007a0138  00000000&#96;007a02e8</span><br><span class="line"></span><br><span class="line">0:002&gt; dt _HEAP_LIST_LOOKUP  00000000&#96;007a02e8</span><br><span class="line">ntdll!_HEAP_LIST_LOOKUP</span><br><span class="line">   +0x000 ExtendedLookup   : (null) </span><br><span class="line">   +0x008 ArraySize        : 0x80</span><br><span class="line">   +0x00c ExtraItem        : 0</span><br><span class="line">   +0x010 ItemCount        : 2</span><br><span class="line">   +0x014 OutOfRangeItems  : 2</span><br><span class="line">   +0x018 BaseIndex        : 0</span><br><span class="line">   +0x020 ListHead         : 0x00000000&#96;007a0150 _LIST_ENTRY [ 0x00000000&#96;007a1490 - 0x7a5760 ]</span><br><span class="line">   +0x028 ListsInUseUlong  : 0x00000000&#96;007a0320  -&gt; 0</span><br><span class="line">   +0x030 ListHints        : 0x00000000&#96;007a0330  -&gt; (null) </span><br><span class="line">因为ArraySize为0x80-&gt; FreeLists中没有小于0x800大小的chunk，所以ListsInUseUlong和ListHints中为空</span><br><span class="line"></span><br><span class="line">此时free掉一个100大小的chunk:</span><br><span class="line">0:002&gt; ? 00a2f8&#96;03506ab9^0000a2eb&#96;0d546ab3</span><br><span class="line">Evaluate expression: 81839521802 &#x3D; 00000013&#96;0e04000a</span><br><span class="line">0:002&gt; dt _HEAP_LIST_LOOKUP  00000000&#96;007a02e8</span><br><span class="line">ntdll!_HEAP_LIST_LOOKUP</span><br><span class="line">   +0x000 ExtendedLookup   : (null) </span><br><span class="line">   +0x008 ArraySize        : 0x80</span><br><span class="line">   +0x00c ExtraItem        : 0</span><br><span class="line">   +0x010 ItemCount        : 3</span><br><span class="line">   +0x014 OutOfRangeItems  : 2</span><br><span class="line">   +0x018 BaseIndex        : 0</span><br><span class="line">   +0x020 ListHead         : 0x00000000&#96;007a0150 _LIST_ENTRY [ 0x00000000&#96;007a13f0 - 0x7a5760 ]</span><br><span class="line">   +0x028 ListsInUseUlong  : 0x00000000&#96;007a0320  -&gt; 0x400</span><br><span class="line">   +0x030 ListHints        : 0x00000000&#96;007a0330  -&gt; (null) </span><br><span class="line"></span><br><span class="line">0x400-&gt;0b10000000000：ListsInUseUlong对应0xa0的位为1</span><br><span class="line">0:002&gt; dq 007a0330</span><br><span class="line">00000000&#96;007a0330  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0340  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0350  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0360  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0370  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0380  00000000&#96;007a13f0 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a0390  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">00000000&#96;007a03a0  00000000&#96;00000000 00000000&#96;00000000</span><br><span class="line">ListHints对应0xa0位置存在chunk 007a13f0</span><br></pre></td></tr></table></figure>
<h3 id="Alloc"><a href="#Alloc" class="headerlink" title="Alloc"></a>Alloc</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Size&lt;&#x3D;0x4000</span><br><span class="line">0x4000&lt;size&lt;&#x3D;0xﬀ000</span><br><span class="line">Size&gt;0xﬀ000</span><br></pre></td></tr></table></figure>
<h4 id="Size-lt-0x4000"><a href="#Size-lt-0x4000" class="headerlink" title="Size&lt;=0x4000"></a>Size&lt;=0x4000</h4><p>1-&gt;基本上主要分配都会在RtlpAllocateHeap<br>2-&gt;接着查看size对应到的FrontEndHeapStatusBitmap使否有启用LFH<br>3-&gt;有的话会对对应到的FrontEndHeapUsageData加上0x21<br>并且检查值是否超过0xﬀ00或者 &amp;0x1f 后超过0x10 : 超过则启用LFH</p>
<p>1: 下面首先查看对应的ListHint中是否有chunk，有则优先分配<br>2: 如果有大小合适的chunk在ListHint上则移除ListHint，并且查看chunk的Flink⼤⼩是否size与此chunk相同(注意FreeLists按大小排序)：<br><strong>为空则清空<br>否则将LintHint填上Flink<br>最后则unlink该chunk，把此chunk从linkedlist中移除返回给user，并将header xor回去(返回时header被encode)</strong><br>3: 若没有大小合适的chunk: 则从比较⼤的ListHint中找，有找到比较大的chunk后，同样查看下⼀块chunk的size是不是一样大小，有则填上，并且unlink该chunk, 从freelist移除。最后将chunk做切割，剩下的⼤⼩重新加入Freelist，如果可以放进ListHint就会放进去，将切割好的chunk返回给使用者(chunk header同样encode)</p>
<p>如果FreeList中没有可以操作的chunk，则尝试ExtendHeap来加大heap空间，再从extend出来的heap取chunk，接着像上面一样分割返回(chunk header encode)，剩下的放回ListHint</p>
<h4 id="0x4000-lt-size-lt-0xﬀ000"><a href="#0x4000-lt-size-lt-0xﬀ000" class="headerlink" title="0x4000&lt;size&lt;=0xﬀ000"></a>0x4000&lt;size&lt;=0xﬀ000</h4><p>Allocate(RtlpAllocateHeap)<br>除了没有对LFH的相关操作外，其他都跟0x4000相同</p>
<h4 id="Size-gt-0xﬀ000"><a href="#Size-gt-0xﬀ000" class="headerlink" title="Size&gt;0xﬀ000"></a>Size&gt;0xﬀ000</h4><p>Allocate(RtlpAllocateHeap)<br>Size&gt;0xﬀ000(VirtualMemoryThreshold&lt;&lt;4)<br><strong>直接使⽤ZwAllocateVirtualMemory，类似直接mmap一大块空间，并且会插入到_HEAP-&gt;VirtualAllocdBlocks这个linked list中(这个linked list用来串接该HeapVirtualAllocate出来的区段)</strong></p>
<h3 id="Free-RtlpFreeHeap"><a href="#Free-RtlpFreeHeap" class="headerlink" title="Free(RtlpFreeHeap)"></a>Free(RtlpFreeHeap)</h3><h4 id="Size-lt-0xﬀ000"><a href="#Size-lt-0xﬀ000" class="headerlink" title="Size&lt;=0xﬀ000"></a>Size&lt;=0xﬀ000</h4><p>1：首先检查alignment，利⽤unusedbyte判断该chunk状态<br>如果是非LFH模式下，会对对应到的FrontEndHeapUsageData减1<br>2：接下来会判断前后的chunk是否为freed，是的话就合并<br>此时会把可以合并的chunk unlink，并从ListHint移除(移除⽅式与前⾯相同，查看下一个chunk是不是相同⼤⼩，是则补上ListHint)<br>3：合并之后，update size&amp;prevsize，然后查看是不是最前跟最后，是就插入，否则就从ListHint中插入，并且update ListHint，插入 时也会对linked list进行检查(此检查不会abort，其原因主要是因为不做unlink写入)</p>
<p><strong>For example:</strong><br>free chunk<br>-&gt;find prev_chunk<br>-&gt;decode prev_chunk_header<br>-&gt;checksum(SmallTagInex==(size&amp;0xﬀ)^(size&gt;&gt;8)^flag)<br>-&gt;check linked list(prevchunk-&gt;Flink-&gt;Blink==prevchunk-&gt;Blink-&gt;Flink==prevchunk)<br>-&gt;Find BlocksIndex<br>-&gt;Find suitable BlocksIndex<br>-&gt;check ListHint(==prevchunk)(不等就可以直接合并，无需更新)<br>-&gt;equ: Check prevchunk-&gt;Flink==ListHead (相等说明后面没有chunk，直接更新ListHint)<br>-&gt;上个判断 !=ListHead :则decode prevchunk-&gt;Flink &amp;&amp; check checksum<br>-&gt; 判断prevchunk-&gt;Flink的size和prevchunk的size是否相等，如果相等，直接换掉对应ListHint位置,否则置空<br>-&gt; unlink prevchunk(Prevchunk-&gt;Blink-&gt;Flink=Prevchunk-&gt;Flink &amp;&amp; Prevchunk-&gt;Flink-&gt;Blink=Prevchunk-&gt;Blink)<br>-&gt; update prevchunk &amp; next chunk: Prevchunk-&gt;size &amp;&amp; next chunk-&gt;prevsize<br>-&gt; check next chunk,若freed，则继续上面操作来合并<br>-&gt; Find suitable BlocksIndex: Check prevchunk-&gt;Size&lt;ArraySize<br>-&gt; search insert point:按照大小排序<strong>(size前同-&gt;LIFO并更新ListHint)</strong><br>-&gt; insert: 检测对应位置Check S-&gt;Blink-&gt;Flink==S<strong>(check linked list or just check chunk-&gt;blink-&gt;flink???—&gt;这里没有具体调)(不满足-&gt;不会abort，但是不会insert进linked list，并且依然会update ListHint)</strong><br>-&gt; update ListHint：若对应位置为Null，则填入<br>-&gt; update header: 根据checksum填充SmallTagIndex<br>-&gt; encode header<br>-&gt; Finish<br>(unlink顺序:chunk-&gt;Bink-&gt;Flink=chunk-&gt;Flink;then chunk-&gt;Flink-&gt;Blink=chunk-&gt;Blink)</p>
<h4 id="Size-gt-0xﬀ000-1"><a href="#Size-gt-0xﬀ000-1" class="headerlink" title="Size&gt;0xﬀ000"></a>Size&gt;0xﬀ000</h4><p>检查该chunk的linkedlist并从_HEAP-&gt;VirtualAllocdBlocks移除<br>接着使⽤RtlpSecMemFreeVirtualMemory将chunk整个munmap掉</p>
<h2 id="Front-End-LFH"><a href="#Front-End-LFH" class="headerlink" title="Front-End (LFH)"></a>Front-End (LFH)</h2><p>Windows 10:LowFragmentationHeap<br>非Debug下Enable<br>Size &lt; 0x4000</p>
<h3 id="Struct-1"><a href="#Struct-1" class="headerlink" title="Struct"></a>Struct</h3><p><strong>_LFH_HEAP</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _LFH_HEAP</span><br><span class="line">ntdll!_LFH_HEAP</span><br><span class="line">   +0x000 Lock             : _RTL_SRWLOCK</span><br><span class="line">   +0x008 SubSegmentZones  : _LIST_ENTRY</span><br><span class="line">   +0x018 Heap             : Ptr64 Void</span><br><span class="line">   +0x020 NextSegmentInfoArrayAddress : Ptr64 Void</span><br><span class="line">   +0x028 FirstUncommittedAddress : Ptr64 Void</span><br><span class="line">   +0x030 ReservedAddressLimit : Ptr64 Void</span><br><span class="line">   +0x038 SegmentCreate    : Uint4B</span><br><span class="line">   +0x03c SegmentDelete    : Uint4B</span><br><span class="line">   +0x040 MinimumCacheDepth : Uint4B</span><br><span class="line">   +0x044 CacheShiftThreshold : Uint4B</span><br><span class="line">   +0x048 SizeInCache      : Uint8B</span><br><span class="line">   +0x050 RunInfo          : _HEAP_BUCKET_RUN_INFO</span><br><span class="line">   +0x060 UserBlockCache   : [12] _USER_MEMORY_CACHE_ENTRY</span><br><span class="line">   +0x2a0 MemoryPolicies   : _HEAP_LFH_MEM_POLICIES</span><br><span class="line">   +0x2a4 Buckets          : [129] _HEAP_BUCKET</span><br><span class="line">   +0x4a8 SegmentInfoArrays : [129] Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +0x8b0 AffinitizedInfoArrays : [129] Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +0xcb8 SegmentAllocator : Ptr64 _SEGMENT_HEAP</span><br><span class="line">   +0xcc0 LocalData        : [1] _HEAP_LOCAL_DATA</span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">Heap指向对应的_Heap结构</span><br><span class="line">Buckets (_HEAP_BUCKET):用来寻找配置⼤⼩对应到 Block ⼤⼩的阵列</span><br><span class="line">SegmentInfoArray(_HEAP_LOCAL_SEGMENT_INFO)：_HEAP_LOCAL_SEGMENT_INFO array，不同⼤⼩对应到不同的 Segment_info 结构，主要管理对应到的 Subsegment 的信息</span><br><span class="line">LocalData (_HEAP_LOCAL_DATA)：其中有一个栏位指向 LFH 本⾝，通常⽤于找回 LFH</span><br></pre></td></tr></table></figure>
<p><strong>Buckets (_HEAP_BUCKET)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _HEAP_BUCKET</span><br><span class="line">ntdll!_HEAP_BUCKET</span><br><span class="line">   +0x000 BlockUnits       : Uint2B</span><br><span class="line">   +0x002 SizeIndex        : UChar</span><br><span class="line">   +0x003 UseAffinity      : Pos 0, 1 Bit</span><br><span class="line">   +0x003 DebugFlags       : Pos 1, 2 Bits</span><br><span class="line">   +0x003 Flags            : UChar</span><br><span class="line"></span><br><span class="line">BlockUnits:分配block大小&gt;&gt;4</span><br><span class="line">SizeIndex:使用者需要大小&gt;&gt;4</span><br></pre></td></tr></table></figure>
<p><strong>SegmentInfoArray (_HEAP_LOCAL_SEGMENT_INFO)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">ntdll!_HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +0x000 LocalData        : Ptr64 _HEAP_LOCAL_DATA</span><br><span class="line">   +0x008 ActiveSubsegment : Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +0x010 CachedItems      : [16] Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +0x090 SListHeader      : _SLIST_HEADER</span><br><span class="line">   +0x0a0 Counters         : _HEAP_BUCKET_COUNTERS</span><br><span class="line">   +0x0a8 LastOpSequence   : Uint4B</span><br><span class="line">   +0x0ac BucketIndex      : Uint2B</span><br><span class="line">   +0x0ae LastUsed         : Uint2B</span><br><span class="line">   +0x0b0 NoThrashCount    : Uint2B</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">LocalData (_HEAP_LOCAL_DATA):对应 _LFH_HEAP-&gt;LocalData ，便于从 SegmentInfo 找回 _LFH_HEAP</span><br><span class="line">BucketIndex:指向对应BucketIndex</span><br><span class="line"></span><br><span class="line">ActiveSubsegment (_HEAP_SUBSEGMENT):</span><br><span class="line">对应已分配的Subsegment</span><br><span class="line">用于管理Userblock：记录剩余chunk  &amp;&amp; 该Userblock 最大分配数</span><br><span class="line"></span><br><span class="line">CachedItems (_HEAP_SUBSEGMENT)：_HEAP_SUBSEGMENT array</span><br><span class="line">存放对应此SegmentInfo且还有可以分配chunk给user的Subsegment </span><br><span class="line">当ActiveSubsegment⽤完时，将从这里填充，并置换掉ActiveSubsegment</span><br></pre></td></tr></table></figure>
<p><strong>ActiveSubsegment (_HEAP_SUBSEGMENT)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _HEAP_SUBSEGMENT</span><br><span class="line">ntdll!_HEAP_SUBSEGMENT</span><br><span class="line">   +0x000 LocalInfo        : Ptr64 _HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line">   +0x008 UserBlocks       : Ptr64 _HEAP_USERDATA_HEADER</span><br><span class="line">   +0x010 DelayFreeList    : _SLIST_HEADER</span><br><span class="line">   +0x020 AggregateExchg   : _INTERLOCK_SEQ</span><br><span class="line">   +0x024 BlockSize        : Uint2B</span><br><span class="line">   +0x026 Flags            : Uint2B</span><br><span class="line">   +0x028 BlockCount       : Uint2B</span><br><span class="line">   +0x02a SizeIndex        : UChar</span><br><span class="line">   +0x02b AffinityIndex    : UChar</span><br><span class="line">   +0x024 Alignment        : [2] Uint4B</span><br><span class="line">   +0x02c Lock             : Uint4B</span><br><span class="line">   +0x030 SFreeListEntry   : _SINGLE_LIST_ENTRY</span><br><span class="line"></span><br><span class="line">LocalInfo:指回对应的_HEAP_LOCAL_SEGMENT_INFO</span><br><span class="line"></span><br><span class="line">UserBlock (_HEAP_USERDATA_HEADER)：</span><br><span class="line">记录要分配出去的 Chunk (Block) 所在位置</span><br><span class="line">在开头存在一些metadata管理这些chunk</span><br><span class="line"></span><br><span class="line">AggregateExchg (_INTERLOCK_SEQ)：</span><br><span class="line">用来管理对应的 UserBlock 中还有多少 freed chunk</span><br><span class="line">LFH⽤以此判断是否继续从此UserBlock分配</span><br><span class="line">同时也有 Lock 的作⽤</span><br><span class="line"></span><br><span class="line">BlockSize：此UserBlock中每个Block(chunk)的⼤⼩</span><br><span class="line">BlockCount：此UserBlock中Block总数</span><br><span class="line">SizeIndex：该UserBlock对应到的SizeIndex</span><br></pre></td></tr></table></figure>
<p><strong>AggregateExchg (_INTERLOCK_SEQ)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _INTERLOCK_SEQ</span><br><span class="line">ntdll!_INTERLOCK_SEQ</span><br><span class="line">   +0x000 Depth            : Uint2B</span><br><span class="line">   +0x002 Hint             : Pos 0, 15 Bits</span><br><span class="line">   +0x002 Lock             : Pos 15, 1 Bit</span><br><span class="line">   +0x002 Hint16           : Uint2B</span><br><span class="line">   +0x000 Exchg            : Int4B</span><br><span class="line"></span><br><span class="line">Depth:该UserBlock 所剩余Freed chunk数量</span><br><span class="line">Lock: 用于Lock</span><br></pre></td></tr></table></figure>
<p><strong>UserBlock (_HEAP_USERDATA_HEADER)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _HEAP_USERDATA_HEADER</span><br><span class="line">ntdll!_HEAP_USERDATA_HEADER</span><br><span class="line">   +0x000 SFreeListEntry   : _SINGLE_LIST_ENTRY</span><br><span class="line">   +0x000 SubSegment       : Ptr64 _HEAP_SUBSEGMENT</span><br><span class="line">   +0x008 Reserved         : Ptr64 Void</span><br><span class="line">   +0x010 SizeIndexAndPadding : Uint4B</span><br><span class="line">   +0x010 SizeIndex        : UChar</span><br><span class="line">   +0x011 GuardPagePresent : UChar</span><br><span class="line">   +0x012 PaddingBytes     : Uint2B</span><br><span class="line">   +0x014 Signature        : Uint4B</span><br><span class="line">   +0x018 EncodedOffsets   : _HEAP_USERDATA_OFFSETS</span><br><span class="line">   +0x020 BusyBitmap       : _RTL_BITMAP_EX</span><br><span class="line">   +0x030 BitmapData       : [1] Uint8B</span><br><span class="line"></span><br><span class="line">SubSegment：指回对应的SubSegment</span><br><span class="line">EncodeOﬀsets： check chunk header</span><br><span class="line">BusyBitmap: bitmap,用于记录该UserBlock中正在使用的chunk</span><br><span class="line">下面区域为Block (chunk)</span><br></pre></td></tr></table></figure>
<p><strong>LFH中的_HEAP_ENTRY (chunk)</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0:001&gt; dt _HEAP_ENTRY</span><br><span class="line">ntdll!_HEAP_ENTRY</span><br><span class="line">   +0x000 UnpackedEntry    : _HEAP_UNPACKED_ENTRY</span><br><span class="line">   +0x000 PreviousBlockPrivateData : Ptr64 Void</span><br><span class="line">   +0x008 Size             : Uint2B</span><br><span class="line">   +0x00a Flags            : UChar</span><br><span class="line">   +0x00b SmallTagIndex    : UChar</span><br><span class="line">   +0x008 SubSegmentCode   : Uint4B</span><br><span class="line">   +0x00c PreviousSize     : Uint2B</span><br><span class="line">   +0x00e SegmentOffset    : UChar</span><br><span class="line">   +0x00e LFHFlags         : UChar</span><br><span class="line">   +0x00f UnusedBytes      : UChar</span><br><span class="line">   +0x008 CompactHeader    : Uint8B</span><br><span class="line">   +0x000 ExtendedEntry    : _HEAP_EXTENDED_ENTRY</span><br><span class="line">   +0x000 Reserved         : Ptr64 Void</span><br><span class="line">   +0x008 FunctionIndex    : Uint2B</span><br><span class="line">   +0x00a ContextValue     : Uint2B</span><br><span class="line">   +0x008 InterceptorValue : Uint4B</span><br><span class="line">   +0x00c UnusedBytesLength : Uint2B</span><br><span class="line">   +0x00e EntryOffset      : UChar</span><br><span class="line">   +0x00f ExtendedBlockSignature : UChar</span><br><span class="line">   +0x000 ReservedForAlignment : Ptr64 Void</span><br><span class="line">   +0x008 Code1            : Uint4B</span><br><span class="line">   +0x00c Code2            : Uint2B</span><br><span class="line">   +0x00e Code3            : UChar</span><br><span class="line">   +0x00f Code4            : UChar</span><br><span class="line">   +0x00c Code234          : Uint4B</span><br><span class="line">   +0x008 AgregateCode     : Uint8B</span><br><span class="line"></span><br><span class="line">其结构为:</span><br><span class="line">PreviousBlockPrivateData （8）</span><br><span class="line">SubSegmentCode （4）</span><br><span class="line">PreviousSize (2)</span><br><span class="line">SegmentOffset (1)</span><br><span class="line">Unusedbyte (1)</span><br><span class="line">User Data</span><br><span class="line">SubSegmentCode：Encode 过的 metadata 用于推回userblock 的位置</span><br><span class="line">PreviousSize：该chunk 在 UserBlock 中对应的 index</span><br><span class="line">Unusedbyte:</span><br><span class="line">inuse:Unusedbyte &amp; 0x80 is true</span><br><span class="line">freed:恒为0x80，⽤于判断是否为 LFH 的 Free chunk</span><br></pre></td></tr></table></figure>
<h3 id="Header-Encoding-in-LFH"><a href="#Header-Encoding-in-LFH" class="headerlink" title="Header Encoding in LFH"></a>Header Encoding in LFH</h3><p>XOR with:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">_HEAP address</span><br><span class="line">LFHkey</span><br><span class="line">Chunk address &gt;&gt; 4</span><br><span class="line">((chunk address) - (UserBlock address)) &lt;&lt; 12</span><br></pre></td></tr></table></figure>
<h3 id="Alloc-1"><a href="#Alloc-1" class="headerlink" title="Alloc"></a>Alloc</h3><p>首先注意到这些结构的组织方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">_heap-&gt;FrontEndHeap指向_LFH_HEAP</span><br><span class="line">_LFH_HEAP-&gt;Buckets[x]指向_HEAP_BUCKET</span><br><span class="line">_LFH_HEAP-&gt;SegmentInfoArray[x]指向SegmentInfoArray(_HEAP_LOCAL_SEGMRNT_INFO)</span><br><span class="line">_HEAP_LOCAL_SEGMRNT_INFO-&gt;ActiveSubsegment指向segment(_HEAP_SUBSEGMENT)</span><br><span class="line">_HEAP_SUBSEGMENT-&gt;UserBlock指向UserBlock</span><br></pre></td></tr></table></figure>
<p>何时使用LFH:<br>注意上述Back-End中:<br>分配过程中会在对应FrontEndHeapUsageData位置加上0x21，free后减一，当对应位置FrontEndHeapUsageData[x]&gt;0xFF00或者FrontEndHeapUsageData[x]&amp;0x1F&gt;0x10时初始化<br><strong>Init:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">当满足条件时，下一次alloc时就会对LFH初始化</span><br><span class="line">会先ExtendFrontEndUsageData及增加更⼤的 BlocksIndex (0x80-0x400)，并设置对应bitmap</span><br><span class="line">-- 在 FrontEndHeapUsageData 写上对应的index，此时 enable LFH 范围变为 (idx: 0-0x400)</span><br><span class="line">-- FrontEndHeapUsageData中分为两部分：对应用于判断LFH是否需要初始化的map以及已经enable LFH的chunk size (例如enable malloc 0x50大小的chunk，则写入0x50&gt;&gt;4&#x3D;5)</span><br><span class="line">-- 原BlocksIndex进行扩展，即新建一个BlocksIndex，写入原BlocksIndex-&gt;ExtendedLookup，进行扩展</span><br><span class="line">建立 FrontEndHeap</span><br><span class="line">初始化对应的SegmentInfoArrays[idx]</span><br><span class="line">-- 在 SegmentInfoArrays[BucketIndex] 填上 segmentInfo </span><br><span class="line">接下来再alloc相同大小chunk就会使用LFH</span><br><span class="line"></span><br><span class="line">Example:</span><br><span class="line">17次时&amp;0x1F&gt;0x10：enable LFH</span><br><span class="line">18次时初始化FrontEndHeapUsageData和 BlocksIndex和SegmentInfoArrays[idx]</span><br><span class="line">19次时Userblock初始化，设置对应的chunk和ActiviteSubsegment，并从中返回一块chunk</span><br></pre></td></tr></table></figure>
<p><strong>Alloc After Init:</strong><br>Allocate (RtlpLowFragHeapAllocFromContext)<br>-&gt;首先尝试从当前ActiveSubsegment分配(by  ActiveSubsegment-&gt;depth)<br>-&gt;失败则从CachedItem中分配<br>-&gt;分配成功则将ActiveSubsegment换为对应CachedItem中的SubSegment</p>
<p><strong>Details:</strong><br>如何选取UserBlock中的chunk:<br>RtlpLowFragHeapRandomData为一个random(0&lt;=x&lt;=0x7F) 256 byte序列<br>-&gt;首先取得 RtlpLowFragHeapRandomData[x] 上的值<br>-&gt;下⼀次会从RtlpLowFragHeapRandomData[x+1] 取值<br>-&gt;x(0~255),下次一个循环: x=rand()%256<br>-&gt;取RtlpLowFragHeapRandomData[x]*maxidx &gt;&gt; 7<br>-&gt;如果已分配则向后搜索最近的可分配的（检查对应的BusyBitmap-&gt;是0直接返回，非0则继续向下搜索）<br>-&gt; check chunk((unused byte &amp; 0x3f) !=0 (chunk freed)<br>-&gt;最后设置好index 及 unused byte并返回给使用者<br>(检测过程中更新bitmap和AggregateExchg(Depth信息))</p>
<h3 id="Free"><a href="#Free" class="headerlink" title="Free"></a>Free</h3><p>-&gt; Update unused byte in chunk header<br>-&gt; Find the index of the Chunk and reset Userblock-&gt;BusyBitmap<br>-&gt; Update ActiveSubsegment-&gt;AggregateExchg<br>-&gt; if  chunk freed not belong to current ActiveSubsegment-&gt;try into  cachedItems</p>
<p><strong>Details:</strong><br>-&gt; chunk header中保存了在UserBlock中的index-&gt;get addr of UserBlock<br>-&gt; UserBlock-&gt;SubSegment找到当前SubSegment<br>-&gt; 设置chunk-&gt;unused byte = 0x80<br>-&gt; 更新chunk-&gt; bitmap<br>-&gt; 更新此SubSegment对应的AggregateExchg(Depth)<br>-&gt; chunk不在当前ActiveSubsegment，尝试放进CachedItems</p>
<h2 id="Exploitation-in-Windows"><a href="#Exploitation-in-Windows" class="headerlink" title="Exploitation in Windows"></a>Exploitation in Windows</h2><h3 id="Unlink-in-Back-End"><a href="#Unlink-in-Back-End" class="headerlink" title="Unlink in Back-End"></a>Unlink in Back-End</h3><p><strong>Tips:<br>Blink&amp;&amp;Flink直接指向user data域，因此与Linux下不同的是无需伪造一个fake chunk即可完成unlink获得指向自身的指针从而任意地址读写(前提需要知道保存堆指针的地址)<br>同时unlink后的chunk重新insert的过程中由于linked链被破坏，无法pass最后一个check of Flink&amp;&amp;Blink-&gt;幸运的是，这里windows只会放弃insert，并且更新ListHint(without crash)</strong></p>
<h3 id="UAF-in-LFH"><a href="#UAF-in-LFH" class="headerlink" title="UAF in LFH"></a>UAF in LFH</h3><p><strong>Tips:<br>注意到从UserBlock来Alloc chunk过程：<br>会通过一个随机序列决定分配位置<br>导致UAF无法像Linux下LIFO利用<br>可以先将UserBlock填满，下一步Free后再次malloc即可获得目标chunk</strong></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Back-End"><span class="toc-number">1.</span> <span class="toc-text">Back-End</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct"><span class="toc-number">1.1.</span> <span class="toc-text">Struct</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#heap"><span class="toc-number">1.1.1.</span> <span class="toc-text">_heap</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HEAP-ENTRY-chunk"><span class="toc-number">1.1.2.</span> <span class="toc-text">_HEAP_ENTRY (chunk)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#HEAP-VIRTUAL-ALLOC-ENTRY-mmap-chunk"><span class="toc-number">1.1.3.</span> <span class="toc-text">_HEAP_VIRTUAL_ALLOC_ENTRY(mmap chunk)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-example"><span class="toc-number">1.1.4.</span> <span class="toc-text">For example:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Attention"><span class="toc-number">1.2.</span> <span class="toc-text">Attention</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#BlocksIndex-HEAP-LIST-LOOKUP"><span class="toc-number">1.2.1.</span> <span class="toc-text">BlocksIndex(_HEAP_LIST_LOOKUP)</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#For-Example"><span class="toc-number">1.2.2.</span> <span class="toc-text">For Example</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alloc"><span class="toc-number">1.3.</span> <span class="toc-text">Alloc</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-lt-0x4000"><span class="toc-number">1.3.1.</span> <span class="toc-text">Size&lt;&#x3D;0x4000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x4000-lt-size-lt-0xﬀ000"><span class="toc-number">1.3.2.</span> <span class="toc-text">0x4000&lt;size&lt;&#x3D;0xﬀ000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-gt-0xﬀ000"><span class="toc-number">1.3.3.</span> <span class="toc-text">Size&gt;0xﬀ000</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free-RtlpFreeHeap"><span class="toc-number">1.4.</span> <span class="toc-text">Free(RtlpFreeHeap)</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-lt-0xﬀ000"><span class="toc-number">1.4.1.</span> <span class="toc-text">Size&lt;&#x3D;0xﬀ000</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Size-gt-0xﬀ000-1"><span class="toc-number">1.4.2.</span> <span class="toc-text">Size&gt;0xﬀ000</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Front-End-LFH"><span class="toc-number">2.</span> <span class="toc-text">Front-End (LFH)</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Struct-1"><span class="toc-number">2.1.</span> <span class="toc-text">Struct</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Header-Encoding-in-LFH"><span class="toc-number">2.2.</span> <span class="toc-text">Header Encoding in LFH</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Alloc-1"><span class="toc-number">2.3.</span> <span class="toc-text">Alloc</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Free"><span class="toc-number">2.4.</span> <span class="toc-text">Free</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Exploitation-in-Windows"><span class="toc-number">3.</span> <span class="toc-text">Exploitation in Windows</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Unlink-in-Back-End"><span class="toc-number">3.1.</span> <span class="toc-text">Unlink in Back-End</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#UAF-in-LFH"><span class="toc-number">3.2.</span> <span class="toc-text">UAF in LFH</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2020/01/01/Heap-in-Windows/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&text=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&is_video=false&description=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Heap in Windows&body=Check out this article: http://yoursite.com/2020/01/01/Heap-in-Windows/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&title=Heap in Windows" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2020/01/01/Heap-in-Windows/&name=Heap in Windows&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


